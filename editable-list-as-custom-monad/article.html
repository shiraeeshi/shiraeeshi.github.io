<!DOCTYPE html>
<html>
<head>
    <title>
      Creating Custom Monads in Haskell: Console List GUI 
    </title>

    <style>
.column {
  float: left;
}

.left {
  width: 50%;
}

.right {
  width: 47%;
}

/* Clear floats after the columns */
.row:after {
  content: "";
  display: table;
  clear: both;
}
    </style>

    <style>

#text-wrapper, #code-wrapper {
  overflow-y: auto;
  height: 98vh;
}

#code-wrapper {
  position: relative;
  font-size: xx-small;
}

.code-fragment {
  cursor: pointer;
}

img.diagram {
  max-width: 100%;
  max-height: 100%;
  height: auto;
}

img.diagram.with-pointer {
  cursor: pointer;
}

    </style>

    <link rel="stylesheet" href="page-style.css">
    <script type="text/javascript" src="interactive-project-navigation.js"></script>
</head>
<body>
    <div class="row">
    <div id="text-wrapper" class="main-wrapper column left">

      <h2 class="centered">
      Creating Custom Monads in Haskell: Console List GUI 
      </h2>

<p class="centered">
        <img src="editable-list-screen-recording.gif">
        </img>
      </p>

<p>
In the <a href="https://shiraeeshi.github.io/editable-list/article.html">previous post</a> I described several architectures of console strings list application.
</p>
<p>


One of the options is creating a custom monad, which will work as a context for running effects and listeners in.
</p>
<p>


There are various approaches we can follow when creating custom monads, there are three styles: final, initial and operational.
</p>
<p>


If you apply some improvements to initial style - you'll get free monads.
<br/>
Likewise, if you apply some improvements to operational style - you'll get freer monads.
</p>
<p>

We have five variations of how to create a monad.
</p>
<p>


If we look at monad styles from the perspective of comparing them with OOP design patterns:
<br/>
&nbsp;-&nbsp;final style resembles interfaces and implementations.
<br/>
&nbsp;-&nbsp;initial and operational styles resemble the interpreter pattern.
<br/>
&nbsp;-&nbsp;constructing descriptions of actions in operational style resembles the composite pattern.
</p>















<p class="centered section-delimiter">
      <a name="final-style" class="inner-anchor grey">
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
      </a>
      </p>
















<p class="centered">
Final style
      </p>

      <p class="centered">
        <img id="diagram-observer-in-final-style-monad" class="diagram" src="final-style-monad.png">
        </img>
      </p>


      <p>
Let's recall what we started with: we had primitive proto-listeners that we needed to invoke manually. They worked in IO-context, and the data types representing application state looked like this:
      </p>

<!-- HTML generated using hilite.me --><div id="code-fragment---observer-primitive---state-adt" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #007020; font-weight: bold">data</span> <span style="color: #902000">AppStateData</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">AppState</span>
  { rows <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">RowData</span>]
  , activeCellY <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span>
  , debugMessages <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">String</span>]
  , listeners <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">AppStateListenersData</span>
  }

<span style="color: #007020; font-weight: bold">data</span> <span style="color: #902000">AppStateListenersData</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">AppStateListeners</span>
  { rowsListeners <span style="color: #007020; font-weight: bold">::</span> [[<span style="color: #902000">RowData</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">IO</span> <span style="color: #007020">()</span>]
  , activeCellYListeners <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">IO</span> <span style="color: #007020">()</span>]
  , debugMessagesListeners <span style="color: #007020; font-weight: bold">::</span> [[<span style="color: #902000">String</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">IO</span> <span style="color: #007020">()</span>]
  }
</pre></div>


      <p>
In the previous approach a list observer had a type [RowData] -&gt; IO (), now it's going to have a type (Monad m, EditableListApp m) =&gt; [RowData] -&gt; m (), it means that previously we invoked our listeners directly in IO monad, but now we're going to invoke them in the context of some abstract monad with the EditableListApp interface.
      </p>
      <p>






Data types that hold the state and listeners look like this. They are parameterized by the type of the monad that we're going to use as a context for running listeners.
      </p>

<!-- HTML generated using hilite.me --><div id="code-fragment---observer-in-final-style-monad---state-adt" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #007020; font-weight: bold">data</span> <span style="color: #902000">AppStateData</span> m <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">AppState</span>
  { rows <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">RowData</span>]
  , activeCellY <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span>
  , debugMessages <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">String</span>]
  , listeners <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">AppStateListenersData</span> m
  }

<span style="color: #007020; font-weight: bold">data</span> <span style="color: #902000">AppStateListenersData</span> m <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">AppStateListeners</span>
  { rowsListeners <span style="color: #007020; font-weight: bold">::</span> [[<span style="color: #902000">RowData</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>]
  , activeCellYListeners <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span> <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>]
  , debugMessagesListeners <span style="color: #007020; font-weight: bold">::</span> [[<span style="color: #902000">String</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>]
  }
</pre></div>




      <p>
Helper functions that add listeners:
      </p>


<!-- HTML generated using hilite.me --><div id="code-fragment---observer-in-final-style-monad---adding-listeners" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #06287e">addRowsListener</span> <span style="color: #007020; font-weight: bold">::</span> (<span style="color: #902000">Monad</span> m, <span style="color: #902000">EditableListApp</span> m) <span style="color: #007020; font-weight: bold">=&gt;</span> ([<span style="color: #902000">RowData</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>) <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span> m <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span> m
<span style="color: #06287e">addActiveCellYListener</span> <span style="color: #007020; font-weight: bold">::</span> (<span style="color: #902000">Monad</span> m, <span style="color: #902000">EditableListApp</span> m) <span style="color: #007020; font-weight: bold">=&gt;</span> (<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span> <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>) <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span> m <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span> m
<span style="color: #06287e">addDebugMessagesListener</span> <span style="color: #007020; font-weight: bold">::</span> (<span style="color: #902000">Monad</span> m, <span style="color: #902000">EditableListApp</span> m) <span style="color: #007020; font-weight: bold">=&gt;</span> ([<span style="color: #902000">String</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>) <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span> m <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span> m
</pre></div>

      <p>
These functions declare that the m type should be a monad and should be an instance of EditableListApp typeclass. That's our custom monad.
      </p>
      <p>


You might wonder why we didn't add (Monad m, EditableListApp m) constraints to the AppStateData and AppStateListenersData data types and not just to functions that add listeners. The answer is I don't know how to do that, and since the code works without those constraints I'm not sure whether we should do that at all.
      </p>
      <p>



Creating a custom monad is like creating a new sub-language inside a language.
      </p>
      <p>




In order to create a language we need a syntax and semantics.
<br/>
Syntax is a structure of our instructions.
<br/>
Semantics is how we interpret that structure.
      </p>
      <p>





To put it more bluntly, we need to define words of our new language and a dictionary to translate to other languages.
<br/>
(It means that we have a lexicon and syntax on one side, and semantics, or interpretation, on the other side)
      </p>
      <p>

On the other hand, it looks like a good old story about an interface and an implementation, so familiar to us from OOP.
      </p>
      <p>


We define a typeclass that declares monad's functions (new words of our new language):
      </p>

<!-- HTML generated using hilite.me --><div id="code-fragment---observer-in-final-style-monad---descriptive-adt" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #007020; font-weight: bold">class</span> <span style="color: #902000">EditableListApp</span> m <span style="color: #007020; font-weight: bold">where</span>
  getList <span style="color: #007020; font-weight: bold">::</span> m [<span style="color: #902000">RowData</span>]
  getActiveCellY <span style="color: #007020; font-weight: bold">::</span> m (<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span>)
  getLogs <span style="color: #007020; font-weight: bold">::</span> m [<span style="color: #902000">String</span>]

  updateList <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">RowData</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>
  updateActiveCellY <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span> <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>
  log <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">String</span> <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>
</pre></div>

      <p>
What do the signatures of the functions we just listed mean?
      </p>
      <p>

Operations that return results, return results in the context of m monad:
      </p>

<!-- HTML generated using hilite.me --><div id="code-fragment---observer-in-final-style-monad---descriptive-adt-getters" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%">  getList <span style="color: #007020; font-weight: bold">::</span> m [<span style="color: #902000">RowData</span>]
  getActiveCellY <span style="color: #007020; font-weight: bold">::</span> m (<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span>)
  getLogs <span style="color: #007020; font-weight: bold">::</span> m [<span style="color: #902000">String</span>]
</pre></div>

      <p>
Operations that perform effects, perform those effects in the context of m monad:
      </p>


<!-- HTML generated using hilite.me --><div id="code-fragment---observer-in-final-style-monad---descriptive-adt-setters" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%">  updateList <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">RowData</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>
  updateActiveCellY <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span> <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>
  log <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">String</span> <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>
</pre></div>


      <p>
Interpretation
      </p>

      <p class="centered">
        <img id="diagram-final-style-target-monad" class="diagram" src="StateHolder.png">
        </img>
      </p>
      <p>


We need another language to translate our words to. Here it is: the IO monad wrapped (or transformed) with StateT monad transformer. We're going to interpret actions from the custom monad to this monad:
      </p>


<!-- HTML generated using hilite.me --><div id="code-fragment---observer-in-final-style-monad---target-monad" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #007020; font-weight: bold">newtype</span> <span style="color: #902000">StateHolder</span> a <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">StateHolder</span> (<span style="color: #902000">StateT</span> (<span style="color: #902000">AppStateData</span> <span style="color: #902000">StateHolder</span>) <span style="color: #902000">IO</span> a)
  <span style="color: #007020; font-weight: bold">deriving</span> (<span style="color: #902000">Functor</span>, <span style="color: #902000">Applicative</span>, <span style="color: #902000">Monad</span>, <span style="color: #902000">MonadIO</span>)
</pre></div>








      <p>
The interpretation (looks more like a definition of words) is declared as an instance of a typeclass:
      </p>

<!-- HTML generated using hilite.me --><div id="code-fragment---observer-in-final-style-monad---target-monad-instance-of-descriptive-monad" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #007020; font-weight: bold">instance</span> <span style="color: #902000">EditableListApp</span> <span style="color: #902000">StateHolder</span> <span style="color: #007020; font-weight: bold">where</span>
  getList <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> rows <span style="color: #666666">&lt;$&gt;</span> get
  getActiveCellY <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> activeCellY <span style="color: #666666">&lt;$&gt;</span> get
  getLogs <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> debugMessages <span style="color: #666666">&lt;$&gt;</span> get

  updateList l <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
    <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> modify <span style="color: #666666">$</span> <span style="color: #06287e">\</span>s <span style="color: #007020; font-weight: bold">-&gt;</span> s { rows <span style="color: #007020; font-weight: bold">=</span> l }
    reacts <span style="color: #007020; font-weight: bold">&lt;-</span> <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> (rowsListeners <span style="color: #666666">.</span> listeners) <span style="color: #666666">&lt;$&gt;</span> get
    forM_ reacts (<span style="color: #666666">$</span> l) <span style="color: #60a0b0; font-style: italic">-- same as forM_ reacts $ \react -&gt; react l</span>
  updateActiveCellY y <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
    <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> modify <span style="color: #666666">$</span> <span style="color: #06287e">\</span>s <span style="color: #007020; font-weight: bold">-&gt;</span> s { activeCellY <span style="color: #007020; font-weight: bold">=</span> y }
    s <span style="color: #007020; font-weight: bold">&lt;-</span> <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> get
    <span style="color: #007020; font-weight: bold">let</span> reacts <span style="color: #007020; font-weight: bold">=</span> activeCellYListeners (listeners s)
    forM_ reacts (<span style="color: #666666">$</span> y) <span style="color: #60a0b0; font-style: italic">-- same as forM_ reacts $ \react -&gt; react y</span>
  log msg <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
    <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> modify <span style="color: #666666">$</span> <span style="color: #06287e">\</span>s <span style="color: #007020; font-weight: bold">-&gt;</span> s { debugMessages <span style="color: #007020; font-weight: bold">=</span> take debugLinesCount (msg<span style="color: #902000">:</span>(debugMessages s)) }
    logs <span style="color: #007020; font-weight: bold">&lt;-</span> <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> debugMessages <span style="color: #666666">&lt;$&gt;</span> get
    reacts <span style="color: #007020; font-weight: bold">&lt;-</span> <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> (debugMessagesListeners <span style="color: #666666">.</span> listeners) <span style="color: #666666">&lt;$&gt;</span> get
    forM_ reacts (<span style="color: #666666">$</span> logs) <span style="color: #60a0b0; font-style: italic">-- same as forM_ reacts $ \react -&gt; react logs</span>
</pre></div>


      <p>
From the OOP perspective this design resembles an interface and an implementation, from our linguistic analogy perspective it looks like a dictionary or an interpreter that helps us translate (interpret) operations from the language of one monad (let's call it a descriptive monad) to the language of another monad (let's call it a target monad).
      </p>
      <p>








The performStateAction function translates the actions further to the IO monads language. We can imagine that it takes actions described in StateT monad's context and invokes them in the IO monad's context (actually, it doesn't really invoke them in IO-context, but merely translates them to IO-context, although I'm not sure about whether it invokes them or not. See my question about the perform-recursive-monadic-loop example):
      </p>

<!-- HTML generated using hilite.me --><div id="code-fragment---observer-in-final-style-monad---performStateAction" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #06287e">performStateAction</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">AppStateData</span> <span style="color: #902000">StateHolder</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">StateHolder</span> a <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">IO</span> <span style="color: #007020">()</span>
<span style="color: #06287e">performStateAction</span> state (<span style="color: #902000">StateHolder</span> action) <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
  runStateT action state
  return <span style="color: #007020">()</span>
</pre></div>


      <p>
The main function clears the screen, creates an initial state (and listeners), invokes, wrapping with performStateAction function call, the initRows and the loop function:
      </p>

<!-- HTML generated using hilite.me --><div id="code-fragment---observer-in-final-style-monad---main-func" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #06287e">main</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">IO</span> <span style="color: #007020">()</span>
<span style="color: #06287e">main</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
  hSetBuffering stdin <span style="color: #902000">NoBuffering</span>
  hSetBuffering stdout <span style="color: #902000">NoBuffering</span>
  hSetEcho stdin <span style="color: #902000">False</span>
  clearScreen
  performStateAction initialState <span style="color: #666666">$</span> <span style="color: #007020; font-weight: bold">do</span>
    initRows
    loop
  <span style="color: #007020; font-weight: bold">where</span> <span style="color: #666666">...</span>
</pre></div>



      <p>
There is one thing in the performStateAction function's behavior that is not clear to me: seems like it doesn't wait for the loop function to return from recursion and runs the runStateT function on it's result, which shouldn't be ready yet because we're still in the recursion. How does that work?
      </p>
      <p>


I've isolated a minimalistic example of this behavior in this project: perform-recursive-monadic-loop (https://github.com/shiraeeshi/hs-perform-recursive-monadic-loop).
      </p>
      <p>

----------------------------------
      </p>
      <p>

 - creating an initial state
      </p>

<!-- HTML generated using hilite.me --><div id="code-fragment---observer-in-final-style-monad---initialState" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%">    initialState <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">AppStateData</span> <span style="color: #902000">StateHolder</span>
    initialState <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">AppState</span> <span style="color: #902000">[]</span> <span style="color: #902000">Nothing</span> <span style="color: #902000">[]</span> initListeners
</pre></div>




      <p>
----------------------------------
      </p>
      <p>

 - creating listeners:
      </p>


<!-- HTML generated using hilite.me --><div id="code-fragment---observer-in-final-style-monad---creating-listeners" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%">    initListeners <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">AppStateListenersData</span> <span style="color: #902000">StateHolder</span>
    <span style="color: #60a0b0; font-style: italic">-- initListeners =</span>
    <span style="color: #60a0b0; font-style: italic">--     addRowsListener mainRowsListener</span>
    <span style="color: #60a0b0; font-style: italic">--     (addActiveCellYListener activeCellYListener</span>
    <span style="color: #60a0b0; font-style: italic">--     (addDebugMessagesListener debugMessagesListener</span>
    <span style="color: #60a0b0; font-style: italic">--     (empty)))</span>
    initListeners <span style="color: #007020; font-weight: bold">=</span>
        addRowsListener mainRowsListener
        <span style="color: #666666">$</span> addActiveCellYListener activeCellYListener
        <span style="color: #666666">$</span> addDebugMessagesListener debugMessagesListener
        <span style="color: #666666">$</span> empty
      <span style="color: #007020; font-weight: bold">where</span>
        empty <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">AppStateListeners</span> <span style="color: #902000">[]</span> <span style="color: #902000">[]</span> <span style="color: #902000">[]</span>

    mainRowsListener <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">RowData</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">StateHolder</span> <span style="color: #007020">()</span>
    mainRowsListener rows <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
      activeCellCoords <span style="color: #007020; font-weight: bold">&lt;-</span> fmap (<span style="color: #06287e">\</span>y <span style="color: #007020; font-weight: bold">-&gt;</span> (<span style="color: #40a070">0</span>, y)) <span style="color: #666666">&lt;$&gt;</span> getActiveCellY
      liftIO <span style="color: #666666">$</span> showInGrid
                 xUpperLeft
                 yUpperLeft
                 columnCount
                 columnWidth
                 activeCellCoords
                 (map (<span style="color: #06287e">\</span>row <span style="color: #007020; font-weight: bold">-&gt;</span> [smth row]) rows)
      log <span style="color: #4070a0">&quot;updated rows&quot;</span>

    activeCellYListener <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">StateHolder</span> <span style="color: #007020">()</span>
    activeCellYListener activeCellY <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
      <span style="color: #007020; font-weight: bold">let</span> activeCellCoords <span style="color: #007020; font-weight: bold">=</span> fmap (<span style="color: #06287e">\</span>y <span style="color: #007020; font-weight: bold">-&gt;</span> (<span style="color: #40a070">0</span>, y)) activeCellY
      liftIO <span style="color: #666666">$</span> drawGrid xUpperLeft yUpperLeft columnWidth columnCount rowCount
      <span style="color: #007020; font-weight: bold">case</span> activeCellCoords <span style="color: #007020; font-weight: bold">of</span>
        <span style="color: #902000">Nothing</span> <span style="color: #007020; font-weight: bold">-&gt;</span> return <span style="color: #007020">()</span>
        <span style="color: #902000">Just</span> coordsPair <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span>
          liftIO <span style="color: #666666">$</span> highlightCell xUpperLeft yUpperLeft columnWidth columnCount rowCount coordsPair
          log <span style="color: #4070a0">&quot;highlighted cell&quot;</span>

    debugMessagesListener <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">String</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">StateHolder</span> <span style="color: #007020">()</span>
    debugMessagesListener debugMessages <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
      liftIO <span style="color: #666666">$</span> printFromBottom
                 xUpperLeft
                 (yUpperLeft<span style="color: #666666">+</span><span style="color: #40a070">12</span><span style="color: #666666">+</span>debugLinesCount)
                 debugMessages
</pre></div>










      <p>
----------------------------------
      </p>
      <p>

 - the strings list initialization:
      </p>

<!-- HTML generated using hilite.me --><div id="code-fragment---observer-in-final-style-monad---initRows" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%">    initRows <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">StateHolder</span> <span style="color: #007020">()</span>
    initRows <span style="color: #007020; font-weight: bold">=</span> updateList initialRows
</pre></div>


      <p>
When initializing the list, we invoke updateList function, which in turn invokes its listeners.
      </p>
      <p>
----------------------------------
      </p>
      <p>

 - the loop function:
      </p>
      <p>

The loop function doesn't take any parameters, because the state is passed implicitly through the context, the context here is StateHolder monad.
      </p>
      <p>


Since the loop function is defined in the StateHolder monad's context, not in IO context, we can't directly invoke IO actions from here, but we made StateHolder an instance of MonadIO, so we can invoke IO actions using liftIO function.
      </p>



<!-- HTML generated using hilite.me --><div id="code-fragment---observer-in-final-style-monad---loop" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%">    loop <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">StateHolder</span> <span style="color: #007020">()</span>
    loop <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
      key <span style="color: #007020; font-weight: bold">&lt;-</span> liftIO <span style="color: #666666">$</span> getKey
      when (key <span style="color: #666666">/=</span> <span style="color: #4070a0">&quot;</span><span style="color: #4070a0; font-weight: bold">\ESC</span><span style="color: #4070a0">&quot;</span>) <span style="color: #666666">$</span> <span style="color: #007020; font-weight: bold">do</span>
        <span style="color: #007020; font-weight: bold">case</span> key <span style="color: #007020; font-weight: bold">of</span>
          <span style="color: #4070a0">&quot;</span><span style="color: #4070a0; font-weight: bold">\ESC</span><span style="color: #4070a0">[A&quot;</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span> <span style="color: #60a0b0; font-style: italic">-- up</span>
              activeCellY <span style="color: #007020; font-weight: bold">&lt;-</span> getActiveCellY
              <span style="color: #007020; font-weight: bold">let</span>
                newActiveCellY <span style="color: #007020; font-weight: bold">=</span>
                  <span style="color: #007020; font-weight: bold">case</span> activeCellY <span style="color: #007020; font-weight: bold">of</span>
                    <span style="color: #902000">Just</span> y <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Just</span> <span style="color: #666666">$</span> max <span style="color: #40a070">0</span> (y<span style="color: #666666">-</span><span style="color: #40a070">1</span>)
                    <span style="color: #902000">Nothing</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Just</span> <span style="color: #40a070">0</span>
              updateActiveCellY newActiveCellY
              log <span style="color: #666666">$</span> <span style="color: #4070a0">&quot;up, &quot;</span> <span style="color: #666666">++</span> show(newActiveCellY)
              loop
</pre></div>

























<p class="centered section-delimiter">
      <a name="initial-style" class="inner-anchor grey">
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
      </a>
      </p>
















<p class="centered">
Initial style
      </p>

      <p class="centered">
        <img id="diagram-initial-style" class="diagram" src="initial-style-monad.png">
        </img>
      </p>













      <p>
Linguistic parallels become even more obvious in initial and operational styles: interpretation becomes a step (a function call) in the execution flow. We can see interpretation as translating the description of action from the language of one monad (let's call it the descriptive monad) to the language of another monad (let's call it a target monad).
      </p>
      <p>


Data types that represent application state are the same types as in the final style.
      </p>

<!-- HTML generated using hilite.me --><div id="code-fragment---initial-style---state-adt" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #007020; font-weight: bold">data</span> <span style="color: #902000">AppStateData</span> m <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">AppState</span>
  { rows <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">RowData</span>]
  , activeCellY <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span>
  , debugMessages <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">String</span>]
  , listeners <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">AppStateListenersData</span> m
  }

<span style="color: #007020; font-weight: bold">data</span> <span style="color: #902000">AppStateListenersData</span> m <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">AppStateListeners</span>
  { rowsListeners <span style="color: #007020; font-weight: bold">::</span> [[<span style="color: #902000">RowData</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>]
  , activeCellYListeners <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span> <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>]
  , debugMessagesListeners <span style="color: #007020; font-weight: bold">::</span> [[<span style="color: #902000">String</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>]
  }
</pre></div>


      <p>
Helper functions that add listeners, now we only have to list one constraint (Monad m).
      </p>

<!-- HTML generated using hilite.me --><div id="code-fragment---initial-style---functions-that-add-listeners" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #06287e">addRowsListener</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Monad</span> m <span style="color: #007020; font-weight: bold">=&gt;</span> ([<span style="color: #902000">RowData</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>) <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span> m <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span> m
<span style="color: #06287e">addActiveCellYListener</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Monad</span> m <span style="color: #007020; font-weight: bold">=&gt;</span> (<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span> <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>) <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span> m <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span> m
<span style="color: #06287e">addDebugMessagesListener</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Monad</span> m <span style="color: #007020; font-weight: bold">=&gt;</span> ([<span style="color: #902000">String</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>) <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span> m <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span> m
</pre></div>

      </p>
      <p>
We create a monad in initial style like this:
<br/>
&nbsp;-&nbsp;we declare monad's operations as ADT
<br/>
&nbsp;-&nbsp;we make that ADT a monad
<br/>
&nbsp;-&nbsp;for our convenience, we create smart-constructors for operations
      </p>
      <p>

Here is how to use a monad in initial style:
<br/>
&nbsp;-&nbsp;we describe some actions in terms of the descriptive monad
<br/>
&nbsp;-&nbsp;we declare some target monad
<br/>
&nbsp;-&nbsp;we create an interpreter function that translates from descriptive monad to the target monad
      </p>
      <p>







      <p>
Declaring monad's operations as ADT:
      </p>


<!-- HTML generated using hilite.me --><div id="code-fragment---initial-style---declaring-monad-operations-as-adt" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #007020; font-weight: bold">data</span> <span style="color: #902000">EditableListOps</span> a <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">GetList</span>                          ([<span style="color: #902000">RowData</span>]   <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">EditableListOps</span> a)
                       <span style="color: #666666">|</span> <span style="color: #902000">GetActiveCellY</span>                   ((<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span>) <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">EditableListOps</span> a)
                       <span style="color: #666666">|</span> <span style="color: #902000">GetLogs</span>                          ([<span style="color: #902000">String</span>]    <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">EditableListOps</span> a)
                       <span style="color: #666666">|</span> <span style="color: #902000">UpdateList</span>           [<span style="color: #902000">RowData</span>]   (<span style="color: #902000">EditableListOps</span> a)
                       <span style="color: #666666">|</span> <span style="color: #902000">UpdateActiveCellY</span>    (<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span>) (<span style="color: #902000">EditableListOps</span> a)
                       <span style="color: #666666">|</span> <span style="color: #902000">Log</span>                  <span style="color: #902000">String</span>      (<span style="color: #902000">EditableListOps</span> a)
                       <span style="color: #666666">|</span> forall b<span style="color: #666666">.</span> <span style="color: #902000">LiftIO</span>     (<span style="color: #902000">IO</span> b)      (b <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">EditableListOps</span> a)
                       <span style="color: #666666">|</span> <span style="color: #902000">Done</span>                 a
</pre></div>



      <p>
Here is how to determine a type signature for a constructor:
<br/>
&nbsp;-&nbsp;operations that return a result - for those operations we declare a continuation function that gets that result as a parameter:
      </p>


<!-- HTML generated using hilite.me --><div id="code-fragment---initial-style---getters-in-decriptive-adt" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%">                         <span style="color: #902000">GetList</span>                          ([<span style="color: #902000">RowData</span>]   <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">EditableListOps</span> a)
                       <span style="color: #666666">|</span> <span style="color: #902000">GetActiveCellY</span>                   ((<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span>) <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">EditableListOps</span> a)
                       <span style="color: #666666">|</span> <span style="color: #902000">GetLogs</span>                          ([<span style="color: #902000">String</span>]    <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">EditableListOps</span> a)
</pre></div>


      <p>
&nbsp;-&nbsp;operations that don't return a result, because we're interested in their side-effects, not in the results. For those operations we declare a field with a type EditableListOps a. That field is equivalent to a continuation that takes an empty result as a parameter like this: () -> EditableListOps a.
      </p>


<!-- HTML generated using hilite.me --><div id="code-fragment---initial-style---setters-in-decriptive-adt" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%">                       <span style="color: #666666">|</span> <span style="color: #902000">UpdateList</span>           [<span style="color: #902000">RowData</span>]   (<span style="color: #902000">EditableListOps</span> a)
                       <span style="color: #666666">|</span> <span style="color: #902000">UpdateActiveCellY</span>    (<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span>) (<span style="color: #902000">EditableListOps</span> a)
                       <span style="color: #666666">|</span> <span style="color: #902000">Log</span>                  <span style="color: #902000">String</span>      (<span style="color: #902000">EditableListOps</span> a)
</pre></div>


      <p>
Making an ADT a monad (these functions build a new continuation that call the old continuation and recursively call the same function):
      </p>

<!-- HTML generated using hilite.me --><div id="code-fragment---initial-style---making-descriptive-adt-a-monad" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #007020; font-weight: bold">instance</span> <span style="color: #902000">Functor</span> <span style="color: #902000">EditableListOps</span> <span style="color: #007020; font-weight: bold">where</span>
  fmap f (<span style="color: #902000">GetList</span> k)              <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">GetList</span>        <span style="color: #666666">$</span> <span style="color: #06287e">\</span>lst      <span style="color: #007020; font-weight: bold">-&gt;</span> fmap f (k lst)
  fmap f (<span style="color: #902000">GetActiveCellY</span> k)       <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">GetActiveCellY</span> <span style="color: #666666">$</span> <span style="color: #06287e">\</span>maybeInt <span style="color: #007020; font-weight: bold">-&gt;</span> fmap f (k maybeInt)
  fmap f (<span style="color: #902000">GetLogs</span> k)              <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">GetLogs</span>        <span style="color: #666666">$</span> <span style="color: #06287e">\</span>logs     <span style="color: #007020; font-weight: bold">-&gt;</span> fmap f (k logs)
  fmap f (<span style="color: #902000">UpdateList</span> lst op)      <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">UpdateList</span>        lst (fmap f op)
  fmap f (<span style="color: #902000">UpdateActiveCellY</span> y op) <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">UpdateActiveCellY</span> y   (fmap f op)
  fmap f (<span style="color: #902000">Log</span> msg op)             <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">Log</span>               msg (fmap f op)
  fmap f (<span style="color: #902000">LiftIO</span> a op)            <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">LiftIO</span>            a   (<span style="color: #06287e">\</span>k <span style="color: #007020; font-weight: bold">-&gt;</span> fmap f (op k))
  fmap f (<span style="color: #902000">Done</span> a)                 <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">Done</span> (f a)

<span style="color: #007020; font-weight: bold">instance</span> <span style="color: #902000">Applicative</span> <span style="color: #902000">EditableListOps</span> <span style="color: #007020; font-weight: bold">where</span>
  pure <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">Done</span>

  (<span style="color: #902000">GetList</span> h)             <span style="color: #666666">&lt;*&gt;</span> g <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">GetList</span>        <span style="color: #666666">$</span> <span style="color: #06287e">\</span>lst  <span style="color: #007020; font-weight: bold">-&gt;</span> (h  lst) <span style="color: #666666">&lt;*&gt;</span> g
  (<span style="color: #902000">GetActiveCellY</span> h)      <span style="color: #666666">&lt;*&gt;</span> g <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">GetActiveCellY</span> <span style="color: #666666">$</span> <span style="color: #06287e">\</span>y    <span style="color: #007020; font-weight: bold">-&gt;</span> (h    y) <span style="color: #666666">&lt;*&gt;</span> g
  (<span style="color: #902000">GetLogs</span> h)             <span style="color: #666666">&lt;*&gt;</span> g <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">GetLogs</span>        <span style="color: #666666">$</span> <span style="color: #06287e">\</span>logs <span style="color: #007020; font-weight: bold">-&gt;</span> (h logs) <span style="color: #666666">&lt;*&gt;</span> g
  (<span style="color: #902000">UpdateList</span> lst h)      <span style="color: #666666">&lt;*&gt;</span> g <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">UpdateList</span>        lst (h <span style="color: #666666">&lt;*&gt;</span> g)
  (<span style="color: #902000">UpdateActiveCellY</span> y h) <span style="color: #666666">&lt;*&gt;</span> g <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">UpdateActiveCellY</span>   y (h <span style="color: #666666">&lt;*&gt;</span> g)
  (<span style="color: #902000">Log</span> msg h)             <span style="color: #666666">&lt;*&gt;</span> g <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">Log</span>               msg (h <span style="color: #666666">&lt;*&gt;</span> g)
  (<span style="color: #902000">LiftIO</span> a h)            <span style="color: #666666">&lt;*&gt;</span> g <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">LiftIO</span>              a (<span style="color: #06287e">\</span>k <span style="color: #007020; font-weight: bold">-&gt;</span> (h k) <span style="color: #666666">&lt;*&gt;</span> g)
  (<span style="color: #902000">Done</span> a)                <span style="color: #666666">&lt;*&gt;</span> g <span style="color: #007020; font-weight: bold">=</span> fmap a g

<span style="color: #007020; font-weight: bold">instance</span> <span style="color: #902000">Monad</span> <span style="color: #902000">EditableListOps</span> <span style="color: #007020; font-weight: bold">where</span>
  return <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">Done</span>
  (<span style="color: #902000">GetList</span> h)             <span style="color: #666666">&gt;&gt;=</span> f <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">GetList</span>        <span style="color: #666666">$</span> <span style="color: #06287e">\</span>lst  <span style="color: #007020; font-weight: bold">-&gt;</span> (h  lst) <span style="color: #666666">&gt;&gt;=</span> f
  (<span style="color: #902000">GetActiveCellY</span> h)      <span style="color: #666666">&gt;&gt;=</span> f <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">GetActiveCellY</span> <span style="color: #666666">$</span> <span style="color: #06287e">\</span>y    <span style="color: #007020; font-weight: bold">-&gt;</span> (h    y) <span style="color: #666666">&gt;&gt;=</span> f
  (<span style="color: #902000">GetLogs</span> h)             <span style="color: #666666">&gt;&gt;=</span> f <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">GetLogs</span>        <span style="color: #666666">$</span> <span style="color: #06287e">\</span>logs <span style="color: #007020; font-weight: bold">-&gt;</span> (h logs) <span style="color: #666666">&gt;&gt;=</span> f
  (<span style="color: #902000">UpdateList</span> lst h)      <span style="color: #666666">&gt;&gt;=</span> f <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">UpdateList</span>        lst (h <span style="color: #666666">&gt;&gt;=</span> f)
  (<span style="color: #902000">UpdateActiveCellY</span> y h) <span style="color: #666666">&gt;&gt;=</span> f <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">UpdateActiveCellY</span>   y (h <span style="color: #666666">&gt;&gt;=</span> f)
  (<span style="color: #902000">Log</span> msg h)             <span style="color: #666666">&gt;&gt;=</span> f <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">Log</span>               msg (h <span style="color: #666666">&gt;&gt;=</span> f)
  (<span style="color: #902000">LiftIO</span> a h)            <span style="color: #666666">&gt;&gt;=</span> f <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">LiftIO</span>              a (<span style="color: #06287e">\</span>k <span style="color: #007020; font-weight: bold">-&gt;</span> (h k) <span style="color: #666666">&gt;&gt;=</span> f)
  (<span style="color: #902000">Done</span> x)                <span style="color: #666666">&gt;&gt;=</span> f <span style="color: #007020; font-weight: bold">=</span> f x
</pre></div>


      <p>
We need to make the desciptive monad an instance of MonadIO to be able to call IO-actions using liftIO.
      </p>

<!-- HTML generated using hilite.me --><div id="code-fragment---initial-style---making-descriptive-adt-monadio" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #007020; font-weight: bold">instance</span> <span style="color: #902000">MonadIO</span> <span style="color: #902000">EditableListOps</span> <span style="color: #007020; font-weight: bold">where</span>
  <span style="color: #60a0b0; font-style: italic">-- liftIO a = LiftIO a $ \k -&gt; return k</span>
  liftIO a <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">LiftIO</span> a return
</pre></div>


      <p>
Creating smart constructors for operations
      </p>

<!-- HTML generated using hilite.me --><div id="code-fragment---initial-style---smart-constructors" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #06287e">getList</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">EditableListOps</span> [<span style="color: #902000">RowData</span>]
<span style="color: #06287e">getList</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">GetList</span> return

<span style="color: #06287e">getActiveCellY</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">EditableListOps</span> (<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span>)
<span style="color: #06287e">getActiveCellY</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">GetActiveCellY</span> return

<span style="color: #06287e">getLogs</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">EditableListOps</span> [<span style="color: #902000">String</span>]
<span style="color: #06287e">getLogs</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">GetLogs</span> return

<span style="color: #06287e">updateList</span> <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">RowData</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">EditableListOps</span> <span style="color: #007020">()</span>
<span style="color: #06287e">updateList</span> l <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">UpdateList</span> l <span style="color: #666666">$</span> return <span style="color: #007020">()</span>

<span style="color: #06287e">updateActiveCellY</span> <span style="color: #007020; font-weight: bold">::</span> (<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span>) <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">EditableListOps</span> <span style="color: #007020">()</span>
<span style="color: #06287e">updateActiveCellY</span> y <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">UpdateActiveCellY</span> y <span style="color: #666666">$</span> return <span style="color: #007020">()</span>

<span style="color: #06287e">log</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">String</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">EditableListOps</span> <span style="color: #007020">()</span>
<span style="color: #06287e">log</span> msg <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">Log</span> msg <span style="color: #666666">$</span> return <span style="color: #007020">()</span>
</pre></div>




      <p>
Declaring a target monad
      </p>

<!-- HTML generated using hilite.me --><div id="code-fragment---initial-style---declaring-a-target-monad" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #007020; font-weight: bold">newtype</span> <span style="color: #902000">StateHolder</span> a <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">StateHolder</span> (<span style="color: #902000">StateT</span> (<span style="color: #902000">AppStateData</span> <span style="color: #902000">StateHolder</span>) <span style="color: #902000">IO</span> a)
  <span style="color: #007020; font-weight: bold">deriving</span> (<span style="color: #902000">Functor</span>, <span style="color: #902000">Applicative</span>, <span style="color: #902000">Monad</span>, <span style="color: #902000">MonadIO</span>)
</pre></div>


      <p>
Creating an interpreter function that translates from descriptive monad to the target monad
      </p>

<!-- HTML generated using hilite.me --><div id="code-fragment---initial-style---interpreter-function" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #06287e">interpret</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">EditableListOps</span> a <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">StateHolder</span> a
<span style="color: #06287e">interpret</span> (<span style="color: #902000">Done</span> x) <span style="color: #007020; font-weight: bold">=</span> return x
<span style="color: #06287e">interpret</span> (<span style="color: #902000">GetList</span> k) <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span> lst <span style="color: #007020; font-weight: bold">&lt;-</span> rows <span style="color: #666666">&lt;$&gt;</span> (<span style="color: #902000">StateHolder</span> get)
                           interpret (k lst)
<span style="color: #06287e">interpret</span> (<span style="color: #902000">GetActiveCellY</span> k) <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span> y <span style="color: #007020; font-weight: bold">&lt;-</span> activeCellY <span style="color: #666666">&lt;$&gt;</span> (<span style="color: #902000">StateHolder</span> get)
                                  interpret (k y)
<span style="color: #06287e">interpret</span> (<span style="color: #902000">GetLogs</span> k) <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span> logs <span style="color: #007020; font-weight: bold">&lt;-</span> debugMessages <span style="color: #666666">&lt;$&gt;</span> (<span style="color: #902000">StateHolder</span> get)
                           interpret (k logs)
<span style="color: #06287e">interpret</span> (<span style="color: #902000">UpdateList</span> l k) <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span> <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> modify <span style="color: #666666">$</span> <span style="color: #06287e">\</span>s <span style="color: #007020; font-weight: bold">-&gt;</span> s { rows <span style="color: #007020; font-weight: bold">=</span> l }
                                reacts <span style="color: #007020; font-weight: bold">&lt;-</span> (rowsListeners <span style="color: #666666">.</span> listeners) <span style="color: #666666">&lt;$&gt;</span> (<span style="color: #902000">StateHolder</span> get)
                                forM_ reacts (<span style="color: #666666">$</span> l) <span style="color: #60a0b0; font-style: italic">-- forM_ reacts $ \react -&gt; react l</span>
                                interpret k
<span style="color: #06287e">interpret</span> (<span style="color: #902000">UpdateActiveCellY</span> y k) <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span> <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> modify <span style="color: #666666">$</span> <span style="color: #06287e">\</span>s <span style="color: #007020; font-weight: bold">-&gt;</span> s { activeCellY <span style="color: #007020; font-weight: bold">=</span> y }
                                       reacts <span style="color: #007020; font-weight: bold">&lt;-</span> (activeCellYListeners <span style="color: #666666">.</span> listeners) <span style="color: #666666">&lt;$&gt;</span> (<span style="color: #902000">StateHolder</span> get)
                                       forM_ reacts (<span style="color: #666666">$</span> y) <span style="color: #60a0b0; font-style: italic">-- forM_ reacts $ \react -&gt; react y</span>
                                       interpret k
<span style="color: #06287e">interpret</span> (<span style="color: #902000">Log</span> msg k) <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span> <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> modify <span style="color: #666666">$</span> <span style="color: #06287e">\</span>s <span style="color: #007020; font-weight: bold">-&gt;</span> s { debugMessages <span style="color: #007020; font-weight: bold">=</span> take debugLinesCount (msg<span style="color: #902000">:</span>(debugMessages s)) }
                           logs <span style="color: #007020; font-weight: bold">&lt;-</span> debugMessages <span style="color: #666666">&lt;$&gt;</span> (<span style="color: #902000">StateHolder</span> get)
                           reacts <span style="color: #007020; font-weight: bold">&lt;-</span> (debugMessagesListeners <span style="color: #666666">.</span> listeners) <span style="color: #666666">&lt;$&gt;</span> (<span style="color: #902000">StateHolder</span> get)
                           forM_ reacts (<span style="color: #666666">$</span> logs) <span style="color: #60a0b0; font-style: italic">-- forM_ reacts $ \react -&gt; react log</span>
                           interpret k
<span style="color: #06287e">interpret</span> (<span style="color: #902000">LiftIO</span> a k) <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span> v <span style="color: #007020; font-weight: bold">&lt;-</span> liftIO a
                            interpret (k v)
</pre></div>



      <p>
The performStateAction function translates actions from target monad further to IO-monad. We can imagine that it executes those actions.
      </p>

<!-- HTML generated using hilite.me --><div id="code-fragment---initial-style---perform-state-action" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #06287e">performStateAction</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">AppStateData</span> <span style="color: #902000">StateHolder</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">StateHolder</span> a <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">IO</span> <span style="color: #007020">()</span>
<span style="color: #06287e">performStateAction</span> state (<span style="color: #902000">StateHolder</span> action) <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
  runStateT action state
  return <span style="color: #007020">()</span>
</pre></div>



      <p>
The main function clears the screen, creates an initial state (and listeners), invokes, wrapping with performStateAction function call, the initRows and the loop function:
      </p>

<!-- HTML generated using hilite.me --><div id="code-fragment---initial-style---main" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #06287e">main</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">IO</span> <span style="color: #007020">()</span>
<span style="color: #06287e">main</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
  hSetBuffering stdin <span style="color: #902000">NoBuffering</span>
  hSetBuffering stdout <span style="color: #902000">NoBuffering</span>
  hSetEcho stdin <span style="color: #902000">False</span>
  clearScreen
  <span style="color: #60a0b0; font-style: italic">-- performStateAction initialState (interpret (do ...))</span>
  performStateAction initialState <span style="color: #666666">$</span> interpret <span style="color: #666666">$</span> <span style="color: #007020; font-weight: bold">do</span>
    initRows
    loop
  <span style="color: #007020; font-weight: bold">where</span>
    <span style="color: #666666">...</span>
</pre></div>

      <p>
----------------------------------
      </p>

      <p>
 - creating an initial state
      </p>

<!-- HTML generated using hilite.me --><div id="code-fragment---initial-style---initial-state" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%">    initialState <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">AppStateData</span> <span style="color: #902000">StateHolder</span>
    initialState <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">AppState</span> <span style="color: #902000">[]</span> <span style="color: #902000">Nothing</span> <span style="color: #902000">[]</span> initListeners
</pre></div>

      <p>
----------------------------------
      </p>

      <p>
 - creating listeners:
      </p>

<!-- HTML generated using hilite.me --><div id="code-fragment---initial-style---initListeners" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%">    initListeners <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">AppStateListenersData</span> <span style="color: #902000">StateHolder</span>
    <span style="color: #60a0b0; font-style: italic">-- initListeners =</span>
    <span style="color: #60a0b0; font-style: italic">--     addRowsListener (interpret . mainRowsListener)</span>
    <span style="color: #60a0b0; font-style: italic">--     (addActiveCellYListener (interpret . activeCellYListener)</span>
    <span style="color: #60a0b0; font-style: italic">--     (addDebugMessagesListener (interpret . debugMessagesListener)</span>
    <span style="color: #60a0b0; font-style: italic">--     (empty)))</span>
    initListeners <span style="color: #007020; font-weight: bold">=</span>
        addRowsListener (interpret <span style="color: #666666">.</span> mainRowsListener)
        <span style="color: #666666">$</span> addActiveCellYListener (interpret <span style="color: #666666">.</span> activeCellYListener)
        <span style="color: #666666">$</span> addDebugMessagesListener (interpret <span style="color: #666666">.</span> debugMessagesListener)
        <span style="color: #666666">$</span> empty
      <span style="color: #007020; font-weight: bold">where</span>
        empty <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">AppStateListeners</span> <span style="color: #902000">[]</span> <span style="color: #902000">[]</span> <span style="color: #902000">[]</span>

    mainRowsListener <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">RowData</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">EditableListOps</span> <span style="color: #007020">()</span>
    mainRowsListener rows <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
      activeCellCoords <span style="color: #007020; font-weight: bold">&lt;-</span> fmap (<span style="color: #06287e">\</span>y <span style="color: #007020; font-weight: bold">-&gt;</span> (<span style="color: #40a070">0</span>, y)) <span style="color: #666666">&lt;$&gt;</span> getActiveCellY
      liftIO <span style="color: #666666">$</span> showInGrid
                 xUpperLeft
                 yUpperLeft
                 columnCount
                 columnWidth
                 activeCellCoords
                 (map (<span style="color: #06287e">\</span>row <span style="color: #007020; font-weight: bold">-&gt;</span> [smth row]) rows)
      log <span style="color: #4070a0">&quot;updated rows&quot;</span>

    activeCellYListener <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">EditableListOps</span> <span style="color: #007020">()</span>
    activeCellYListener activeCellY <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
      <span style="color: #007020; font-weight: bold">let</span> activeCellCoords <span style="color: #007020; font-weight: bold">=</span> fmap (<span style="color: #06287e">\</span>y <span style="color: #007020; font-weight: bold">-&gt;</span> (<span style="color: #40a070">0</span>, y)) activeCellY
      liftIO <span style="color: #666666">$</span> drawGrid xUpperLeft yUpperLeft columnWidth columnCount rowCount
      <span style="color: #007020; font-weight: bold">case</span> activeCellCoords <span style="color: #007020; font-weight: bold">of</span>
        <span style="color: #902000">Nothing</span> <span style="color: #007020; font-weight: bold">-&gt;</span> return <span style="color: #007020">()</span>
        <span style="color: #902000">Just</span> coordsPair <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span>
          liftIO <span style="color: #666666">$</span> highlightCell xUpperLeft yUpperLeft columnWidth columnCount rowCount coordsPair
          log <span style="color: #4070a0">&quot;highlighted cell&quot;</span>

    debugMessagesListener <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">String</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">EditableListOps</span> <span style="color: #007020">()</span>
    debugMessagesListener debugMessages <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
      liftIO <span style="color: #666666">$</span> printFromBottom
                 xUpperLeft
                 (yUpperLeft<span style="color: #666666">+</span><span style="color: #40a070">12</span><span style="color: #666666">+</span>debugLinesCount)
                 debugMessages
</pre></div>

      <p>
----------------------------------
      </p>

      <p>
 - the strings list initialization:
      </p>

<!-- HTML generated using hilite.me --><div id="code-fragment---initial-style---initRows" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%">    initRows <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">EditableListOps</span> <span style="color: #007020">()</span>
    initRows <span style="color: #007020; font-weight: bold">=</span> updateList initialRows
</pre></div>

      <p>
When initializing the list, we invoke updateList function, which in turn invokes its listeners.
      </p>

      <p>
----------------------------------
      </p>

      <p>
 - the loop function:
      </p>

      <p>
The loop function doesn't take any parameters, because the state is passed implicitly through the context, the context here is EditableListOps monad.
      </p>

      <p>
Since the loop function is defined in the StateHolder monad's context, not in IO context, we can't directly invoke IO actions from here, but we made StateHolder an instance of MonadIO, so we can invoke IO actions using liftIO function.
      </p>

<!-- HTML generated using hilite.me --><div id="code-fragment---initial-style---loop" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%">    loop <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">EditableListOps</span> <span style="color: #007020">()</span>
    loop <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
      key <span style="color: #007020; font-weight: bold">&lt;-</span> liftIO <span style="color: #666666">$</span> getKey
      when (key <span style="color: #666666">/=</span> <span style="color: #4070a0">&quot;</span><span style="color: #4070a0; font-weight: bold">\ESC</span><span style="color: #4070a0">&quot;</span>) <span style="color: #666666">$</span> <span style="color: #007020; font-weight: bold">do</span>
        <span style="color: #007020; font-weight: bold">case</span> key <span style="color: #007020; font-weight: bold">of</span>
          <span style="color: #4070a0">&quot;</span><span style="color: #4070a0; font-weight: bold">\ESC</span><span style="color: #4070a0">[A&quot;</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span> <span style="color: #60a0b0; font-style: italic">-- up</span>
              activeCellY <span style="color: #007020; font-weight: bold">&lt;-</span> getActiveCellY
              <span style="color: #007020; font-weight: bold">let</span>
                newActiveCellY <span style="color: #007020; font-weight: bold">=</span>
                  <span style="color: #007020; font-weight: bold">case</span> activeCellY <span style="color: #007020; font-weight: bold">of</span>
                    <span style="color: #902000">Just</span> y <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Just</span> <span style="color: #666666">$</span> max <span style="color: #40a070">0</span> (y<span style="color: #666666">-</span><span style="color: #40a070">1</span>)
                    <span style="color: #902000">Nothing</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Just</span> <span style="color: #40a070">0</span>
              updateActiveCellY newActiveCellY
              log <span style="color: #666666">$</span> <span style="color: #4070a0">&quot;up, &quot;</span> <span style="color: #666666">++</span> show(newActiveCellY)
              loop
</pre></div>



























<p class="centered section-delimiter">
      <a name="free-monads" class="inner-anchor grey">
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
      </a>
      </p>
















<p class="centered">
Free monads
      </p>

      <p class="centered">
        <img id="diagram-free" class="diagram" src="free-monad.png">
        </img>
      </p>













      <p>
Free monads make it easier to create initial style monads: we make our operations into a functor using deriving mechanism, and then we get a monad by wrapping that functor with a Free construction.
<br/>
Free monads design is a result of extracting common abstractions from initial style monads into a module.
      </p>











      <p>
I'm going to omit the Free module's contents for now, so let's just assume that we have a module called Free that helps us to magically create a monad out of a functor (there are only 30 lines of code in the Free module, the code is shown at the end of this part):
      </p>

<!-- HTML generated using hilite.me --><div style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #007020; font-weight: bold">module</span> <span style="color: #0e84b5; font-weight: bold">Free</span> (<span style="color: #902000">Free</span>(<span style="color: #666666">..</span>), <span style="color: #06287e">liftF</span>, <span style="color: #06287e">foldFree</span>) <span style="color: #007020; font-weight: bold">where</span> <span style="color: #666666">...</span>
</pre></div>


      <p>
The module declares a Free datatype, which is a result of extracting a common abstraction from initial style monads.
      </p>

<!-- HTML generated using hilite.me --><div style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #007020; font-weight: bold">data</span> <span style="color: #902000">Free</span> f a <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">Free</span> (f (<span style="color: #902000">Free</span> f a))
              <span style="color: #666666">|</span> <span style="color: #902000">Pure</span> a
</pre></div>

      <p>
In the initial style we added a Done constructor to the ADT. Now we don't have to do that, because it is already done for us, it is declared in Free datatype as Pure.
      </p>


      <p>
liftF function is used with constructors (it takes as an input ADT constructors that describe actions, and produces the same operations represented with Free datatype, that wraps the original constructor)
<br/>
foldFree function is used to build interpreter functions (in the initial style we built recursive interpreter functions. Now we don't have to make them recursive, because the foldFree function takes care of recursion)
      </p>



      <p>
We had to make an ADT a monad when using initial style, now it is already taken care of, we only need to make our ADT a functor, and even that we can do automatically using the deriving mechanism.
<br/>
That's why this approach is called free monads: all we do is we list operations, and we get a monad for free.
      </p>








      <p>
custom monad operations are declared as an ADT:
      </p>


<!-- HTML generated using hilite.me --><div id="code-fragment---free-monads---declaring-operations-as-adt" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #007020; font-weight: bold">data</span> <span style="color: #902000">EditableListOpsF</span> r <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">GetList</span>                          ([<span style="color: #902000">RowData</span>]   <span style="color: #007020; font-weight: bold">-&gt;</span> r)
                        <span style="color: #666666">|</span> <span style="color: #902000">GetActiveCellY</span>                   ((<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span>) <span style="color: #007020; font-weight: bold">-&gt;</span> r)
                        <span style="color: #666666">|</span> <span style="color: #902000">GetLogs</span>                          ([<span style="color: #902000">String</span>]    <span style="color: #007020; font-weight: bold">-&gt;</span> r)
                        <span style="color: #666666">|</span> <span style="color: #902000">UpdateList</span>           [<span style="color: #902000">RowData</span>]   r
                        <span style="color: #666666">|</span> <span style="color: #902000">UpdateActiveCellY</span>    (<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span>) r
                        <span style="color: #666666">|</span> <span style="color: #902000">Log</span>                  <span style="color: #902000">String</span>      r
                        <span style="color: #666666">|</span> forall b<span style="color: #666666">.</span> <span style="color: #902000">LiftIO</span>     (<span style="color: #902000">IO</span> b)      (b <span style="color: #007020; font-weight: bold">-&gt;</span> r)
                        <span style="color: #60a0b0; font-style: italic">--deriving Functor</span>
<span style="color: #007020; font-weight: bold">deriving</span> <span style="color: #007020; font-weight: bold">instance</span> <span style="color: #902000">Functor</span> (<span style="color: #902000">EditableListOpsF</span>)
</pre></div>

      <p>
Here is how to determine a type signature for a constructor (it's the same as in initial style, but a little more abstract: the continuation returns a type which the ADT was parameterized with):
<br/>
&nbsp;-&nbsp;operations that return a result - for those operations we declare a continuation function that gets that result as a parameter:
      </p>

<!-- HTML generated using hilite.me --><div id="code-fragment---free-monads---getters-in-adt" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%">                         <span style="color: #902000">GetList</span>                          ([<span style="color: #902000">RowData</span>]   <span style="color: #007020; font-weight: bold">-&gt;</span> r)
                       <span style="color: #666666">|</span> <span style="color: #902000">GetActiveCellY</span>                   ((<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span>) <span style="color: #007020; font-weight: bold">-&gt;</span> r)
                       <span style="color: #666666">|</span> <span style="color: #902000">GetLogs</span>                          ([<span style="color: #902000">String</span>]    <span style="color: #007020; font-weight: bold">-&gt;</span> r)
</pre></div>

      <p>
&nbsp;-&nbsp;operations that don't return a result, because we're interested in their side-effects, not in the results. For those operations we declare a field with a type r. That field is equivalent to a continuation that takes an empty result as a parameter like this: () -&gt; r.
      </p>

<!-- HTML generated using hilite.me --><div id="code-fragment---free-monads---setters-in-adt" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%">                       <span style="color: #666666">|</span> <span style="color: #902000">UpdateList</span>           [<span style="color: #902000">RowData</span>]   r
                       <span style="color: #666666">|</span> <span style="color: #902000">UpdateActiveCellY</span>    (<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span>) r
                       <span style="color: #666666">|</span> <span style="color: #902000">Log</span>                  <span style="color: #902000">String</span>      r
</pre></div>






      <p>
smart-constructors:
      </p>

<!-- HTML generated using hilite.me --><div id="code-fragment---free-monads---smart-constructors" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #06287e">getList</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Free</span> <span style="color: #902000">EditableListOpsF</span> [<span style="color: #902000">RowData</span>]
<span style="color: #06287e">getList</span> <span style="color: #007020; font-weight: bold">=</span> liftF (<span style="color: #902000">GetList</span> id) <span style="color: #60a0b0; font-style: italic">-- or Free (GetList return)</span>

<span style="color: #06287e">getActiveCellY</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Free</span> <span style="color: #902000">EditableListOpsF</span> (<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span>)
<span style="color: #06287e">getActiveCellY</span> <span style="color: #007020; font-weight: bold">=</span> liftF (<span style="color: #902000">GetActiveCellY</span> id) <span style="color: #60a0b0; font-style: italic">-- or Free (GetActiveCellY return)</span>

<span style="color: #06287e">getLogs</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Free</span> <span style="color: #902000">EditableListOpsF</span> [<span style="color: #902000">String</span>]
<span style="color: #06287e">getLogs</span> <span style="color: #007020; font-weight: bold">=</span> liftF (<span style="color: #902000">GetLogs</span> id) <span style="color: #60a0b0; font-style: italic">-- or Free (GetLogs return)</span>

<span style="color: #06287e">updateList</span> <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">RowData</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Free</span> <span style="color: #902000">EditableListOpsF</span> <span style="color: #007020">()</span>
<span style="color: #06287e">updateList</span> l <span style="color: #007020; font-weight: bold">=</span> liftF (<span style="color: #902000">UpdateList</span> l <span style="color: #007020">()</span>) <span style="color: #60a0b0; font-style: italic">-- or Free (UpdateList l ())</span>

<span style="color: #06287e">updateActiveCellY</span> <span style="color: #007020; font-weight: bold">::</span> (<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span>) <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Free</span> <span style="color: #902000">EditableListOpsF</span> <span style="color: #007020">()</span>
<span style="color: #06287e">updateActiveCellY</span> y <span style="color: #007020; font-weight: bold">=</span> liftF (<span style="color: #902000">UpdateActiveCellY</span> y <span style="color: #007020">()</span>) <span style="color: #60a0b0; font-style: italic">-- or Free (UpdateActiveCellY y ())</span>

<span style="color: #06287e">log</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">String</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Free</span> <span style="color: #902000">EditableListOpsF</span> <span style="color: #007020">()</span>
<span style="color: #06287e">log</span> msg <span style="color: #007020; font-weight: bold">=</span> liftF (<span style="color: #902000">Log</span> msg <span style="color: #007020">()</span>) <span style="color: #60a0b0; font-style: italic">-- or Free (Log msg ())</span>
</pre></div>


      <p>
A MonadIO instance for our monad:
      </p>

<!-- HTML generated using hilite.me --><div id="code-fragment---free-monads---monadio-instance" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #007020; font-weight: bold">instance</span> <span style="color: #902000">MonadIO</span> (<span style="color: #902000">Free</span> <span style="color: #902000">EditableListOpsF</span>) <span style="color: #007020; font-weight: bold">where</span>
  liftIO a <span style="color: #007020; font-weight: bold">=</span> liftF (<span style="color: #902000">LiftIO</span> a id) <span style="color: #60a0b0; font-style: italic">-- or Free (LiftIO a id)</span>
</pre></div>



      <p>
The target monad is the same as was previously:
      </p>


<!-- HTML generated using hilite.me --><div id="code-fragment---free-monads---declaring-target-monad" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #007020; font-weight: bold">newtype</span> <span style="color: #902000">StateHolder</span> a <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">StateHolder</span> (<span style="color: #902000">StateT</span> (<span style="color: #902000">AppStateData</span> <span style="color: #902000">StateHolder</span>) <span style="color: #902000">IO</span> a)
  <span style="color: #007020; font-weight: bold">deriving</span> (<span style="color: #902000">Functor</span>, <span style="color: #902000">Applicative</span>, <span style="color: #902000">Monad</span>, <span style="color: #902000">MonadIO</span>)
</pre></div>




      <p>
The interpreter function is built using foldFree:
      </p>

<!-- HTML generated using hilite.me --><div id="code-fragment---free-monads---interpreter-function-foldFree" class="code-fragment" style="margin-bottom: 20px; background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #06287e">interpret</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Free</span> <span style="color: #902000">EditableListOpsF</span> a <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">StateHolder</span> a
<span style="color: #06287e">interpret</span> <span style="color: #007020; font-weight: bold">=</span> foldFree interpret&#39;
</pre></div>



<!-- HTML generated using hilite.me --><div id="code-fragment---free-monads---inner-interpreter-function" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #06287e">interpret&#39;</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">EditableListOpsF</span> a <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">StateHolder</span> a
<span style="color: #06287e">interpret&#39;</span> (<span style="color: #902000">GetList</span> k) <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span> lst <span style="color: #007020; font-weight: bold">&lt;-</span> rows <span style="color: #666666">&lt;$&gt;</span> (<span style="color: #902000">StateHolder</span> get)
                            return (k lst)
<span style="color: #06287e">interpret&#39;</span> (<span style="color: #902000">GetActiveCellY</span> k) <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span> y <span style="color: #007020; font-weight: bold">&lt;-</span> activeCellY <span style="color: #666666">&lt;$&gt;</span> (<span style="color: #902000">StateHolder</span> get)
                                   return (k y)
<span style="color: #06287e">interpret&#39;</span> (<span style="color: #902000">GetLogs</span> k) <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span> logs <span style="color: #007020; font-weight: bold">&lt;-</span> debugMessages <span style="color: #666666">&lt;$&gt;</span> (<span style="color: #902000">StateHolder</span> get)
                            return (k logs)
<span style="color: #06287e">interpret&#39;</span> (<span style="color: #902000">UpdateList</span> l k) <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span> <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> modify <span style="color: #666666">$</span> <span style="color: #06287e">\</span>s <span style="color: #007020; font-weight: bold">-&gt;</span> s { rows <span style="color: #007020; font-weight: bold">=</span> l }
                                 reacts <span style="color: #007020; font-weight: bold">&lt;-</span> (rowsListeners <span style="color: #666666">.</span> listeners) <span style="color: #666666">&lt;$&gt;</span> (<span style="color: #902000">StateHolder</span> get)
                                 forM_ reacts (<span style="color: #666666">$</span> l) <span style="color: #60a0b0; font-style: italic">-- same as forM_ reacts $ \react -&gt; react l</span>
                                 return k
<span style="color: #06287e">interpret&#39;</span> (<span style="color: #902000">UpdateActiveCellY</span> y k) <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span> <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> modify <span style="color: #666666">$</span> <span style="color: #06287e">\</span>s <span style="color: #007020; font-weight: bold">-&gt;</span> s { activeCellY <span style="color: #007020; font-weight: bold">=</span> y }
                                        reacts <span style="color: #007020; font-weight: bold">&lt;-</span> (activeCellYListeners <span style="color: #666666">.</span> listeners) <span style="color: #666666">&lt;$&gt;</span> (<span style="color: #902000">StateHolder</span> get)
                                        forM_ reacts (<span style="color: #666666">$</span> y) <span style="color: #60a0b0; font-style: italic">-- same as forM_ reacts $ \react -&gt; react y</span>
                                        return k
<span style="color: #06287e">interpret&#39;</span> (<span style="color: #902000">Log</span> msg k) <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span> <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> modify <span style="color: #666666">$</span> <span style="color: #06287e">\</span>s <span style="color: #007020; font-weight: bold">-&gt;</span> s { debugMessages <span style="color: #007020; font-weight: bold">=</span> take debugLinesCount (msg<span style="color: #902000">:</span>(debugMessages s)) }
                            logs <span style="color: #007020; font-weight: bold">&lt;-</span> debugMessages <span style="color: #666666">&lt;$&gt;</span> (<span style="color: #902000">StateHolder</span> get)
                            reacts <span style="color: #007020; font-weight: bold">&lt;-</span> (debugMessagesListeners <span style="color: #666666">.</span> listeners) <span style="color: #666666">&lt;$&gt;</span> (<span style="color: #902000">StateHolder</span> get)
                            forM_ reacts (<span style="color: #666666">$</span> logs) <span style="color: #60a0b0; font-style: italic">-- same as forM_ reacts $ \react -&gt; react logs</span>
                            return k
<span style="color: #06287e">interpret&#39;</span> (<span style="color: #902000">LiftIO</span> a k) <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span> v <span style="color: #007020; font-weight: bold">&lt;-</span> liftIO a
                             return (k v)
</pre></div>


















      <p>
The rest of the code (the listeners and a loop function) is the same as in initial style, we only need to change type signatures of functions:
      </p>


<!-- HTML generated using hilite.me --><div id="code-fragment---free-monads---type-signatures-of-listeners-and-loop" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%">    mainRowsListener <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">RowData</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Free</span> <span style="color: #902000">EditableListOpsF</span> <span style="color: #007020">()</span>
    activeCellYListener <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Free</span> <span style="color: #902000">EditableListOpsF</span> <span style="color: #007020">()</span>
    debugMessagesListener <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">String</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Free</span> <span style="color: #902000">EditableListOpsF</span> <span style="color: #007020">()</span>
    loop <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Free</span> <span style="color: #902000">EditableListOpsF</span> <span style="color: #007020">()</span>
</pre></div>


















      <p>
The Free module:
      </p>



<!-- HTML generated using hilite.me --><div id="code-fragment---free-monads---free-module" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #60a0b0; font-style: italic">{-# LANGUAGE  RankNTypes #-}</span>

<span style="color: #007020; font-weight: bold">module</span> <span style="color: #0e84b5; font-weight: bold">Free</span> (<span style="color: #902000">Free</span>(<span style="color: #666666">..</span>), <span style="color: #06287e">liftF</span>, <span style="color: #06287e">foldFree</span>) <span style="color: #007020; font-weight: bold">where</span>

<span style="color: #007020; font-weight: bold">data</span> <span style="color: #902000">Free</span> f a <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">Free</span> (f (<span style="color: #902000">Free</span> f a))
              <span style="color: #666666">|</span> <span style="color: #902000">Pure</span> a

<span style="color: #007020; font-weight: bold">instance</span> <span style="color: #902000">Functor</span> f <span style="color: #007020; font-weight: bold">=&gt;</span> <span style="color: #902000">Functor</span> (<span style="color: #902000">Free</span> f) <span style="color: #007020; font-weight: bold">where</span>
  fmap f (<span style="color: #902000">Pure</span> x) <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">Pure</span> (f x)
  fmap f (<span style="color: #902000">Free</span> x) <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">Free</span> (fmap (fmap f) x)

<span style="color: #007020; font-weight: bold">instance</span> <span style="color: #902000">Functor</span> f <span style="color: #007020; font-weight: bold">=&gt;</span> <span style="color: #902000">Applicative</span> (<span style="color: #902000">Free</span> f) <span style="color: #007020; font-weight: bold">where</span>
  pure <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">Pure</span>
  <span style="color: #902000">Pure</span> f <span style="color: #666666">&lt;*&gt;</span> <span style="color: #902000">Pure</span> x <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">Pure</span> (f x)
  <span style="color: #902000">Pure</span> f <span style="color: #666666">&lt;*&gt;</span> <span style="color: #902000">Free</span> x <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">Free</span> (fmap (fmap f) x)
  <span style="color: #902000">Free</span> f <span style="color: #666666">&lt;*&gt;</span> x <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">Free</span> (fmap (<span style="color: #666666">&lt;*&gt;</span> x) f)

<span style="color: #007020; font-weight: bold">instance</span> <span style="color: #902000">Functor</span> f <span style="color: #007020; font-weight: bold">=&gt;</span> <span style="color: #902000">Monad</span> (<span style="color: #902000">Free</span> f) <span style="color: #007020; font-weight: bold">where</span>
  return <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">Pure</span>
  <span style="color: #902000">Pure</span> x <span style="color: #666666">&gt;&gt;=</span> f <span style="color: #007020; font-weight: bold">=</span> f x
  <span style="color: #902000">Free</span> x <span style="color: #666666">&gt;&gt;=</span> f <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">Free</span> (fmap (<span style="color: #666666">&gt;&gt;=</span> f) x)

<span style="color: #06287e">liftF</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Functor</span> f <span style="color: #007020; font-weight: bold">=&gt;</span> f a <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Free</span> f a
<span style="color: #06287e">liftF</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">Free</span> <span style="color: #666666">.</span> fmap return

<span style="color: #06287e">foldFree</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Monad</span> m <span style="color: #007020; font-weight: bold">=&gt;</span> (forall r<span style="color: #666666">.</span> f r <span style="color: #007020; font-weight: bold">-&gt;</span> m r) <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Free</span> f a <span style="color: #007020; font-weight: bold">-&gt;</span> m a
<span style="color: #06287e">foldFree</span> <span style="color: #007020; font-weight: bold">_</span>         (<span style="color: #902000">Pure</span> x) <span style="color: #007020; font-weight: bold">=</span> return x
<span style="color: #06287e">foldFree</span> interpret (<span style="color: #902000">Free</span> x) <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span> x&#39; <span style="color: #007020; font-weight: bold">&lt;-</span> interpret x
                                 foldFree interpret x&#39;
                      <span style="color: #60a0b0; font-style: italic">-- or = interpret x &gt;&gt;= foldFree interpret</span>
</pre></div>































<p class="centered section-delimiter">
      <a name="operational-style" class="inner-anchor grey">
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
      </a>
      </p>
















<p class="centered">
Operational style
      </p>













      <p>
Linguistic parallels become more apparent in initial and operational styles: interpretation becomes a step (a function call) in the execution flow. We can see interpretation as translating the description of action from the language of one monad (let's call it the descriptive monad) to the language of another monad (let's call it a target monad).
      </p>

      <p>
In operational style this parallel becomes even more obvious: the descriptive monad explicitly constructs a syntax tree describing actions.
      </p>

      <p>
Besides, in operational style we have the most short and straightforward implementation of the bind (&gt;&gt;=) function:
      </p>

<!-- HTML generated using hilite.me --><div id="code-fragment---operational-style---short-bind-implementation" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #007020; font-weight: bold">instance</span> <span style="color: #902000">Monad</span> <span style="color: #902000">EditableListApp</span> <span style="color: #007020; font-weight: bold">where</span>
  return <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">Done</span>
  (<span style="color: #666666">&gt;&gt;=</span>) <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">Bind</span>
</pre></div>

      <p>
But first things first.
      </p>


      <p>
Data types that represent application state are the same types as in the final and initial styles.
      </p>

<!-- HTML generated using hilite.me --><div id="code-fragment---operational-style---state-data-types" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #007020; font-weight: bold">data</span> <span style="color: #902000">AppStateData</span> m <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">AppState</span>
  { rows <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">RowData</span>]
  , activeCellY <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span>
  , debugMessages <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">String</span>]
  , listeners <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">AppStateListenersData</span> m
  }

<span style="color: #007020; font-weight: bold">data</span> <span style="color: #902000">AppStateListenersData</span> m <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">AppStateListeners</span>
  { rowsListeners <span style="color: #007020; font-weight: bold">::</span> [[<span style="color: #902000">RowData</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>]
  , activeCellYListeners <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span> <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>]
  , debugMessagesListeners <span style="color: #007020; font-weight: bold">::</span> [[<span style="color: #902000">String</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>]
  }
</pre></div>

      <p>
Helper functions that add listeners, same as in initial style.
      </p>


<!-- HTML generated using hilite.me --><div id="code-fragment---operational-style---functions-that-add-listeners" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #06287e">addRowsListener</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Monad</span> m <span style="color: #007020; font-weight: bold">=&gt;</span> ([<span style="color: #902000">RowData</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>) <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span> m <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span> m
<span style="color: #06287e">addActiveCellYListener</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Monad</span> m <span style="color: #007020; font-weight: bold">=&gt;</span> (<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span> <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>) <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span> m <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span> m
<span style="color: #06287e">addDebugMessagesListener</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Monad</span> m <span style="color: #007020; font-weight: bold">=&gt;</span> ([<span style="color: #902000">String</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>) <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span> m <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span> m
</pre></div>





      <p>
Here is how we create a monad in operational style:
<br/>
&nbsp;-&nbsp;we declare monad's operations as GADT; in addition to constructors that represent operations we add Done and Bind constructors that correspond to monad's return and bind (&gt;&gt;=) functions.
<br/>
&nbsp;-&nbsp;we make that GADT a monad
<br/>
&nbsp;-&nbsp;for our convenience, we create smart-constructors for operations
      </p>

      <p>
Here is how to use a monad in operational style:
<br/>
&nbsp;-&nbsp;we describe some actions in terms of the descriptive monad
<br/>
&nbsp;-&nbsp;we declare some target monad
<br/>
&nbsp;-&nbsp;we create an interpreter function that translates from descriptive monad to the target monad
      </p>



      <p>
Declaring monad's operations as GADT:
      </p>


<!-- HTML generated using hilite.me --><div id="code-fragment---operational-style---declaring-monad-operations-as-gadt" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #007020; font-weight: bold">data</span> <span style="color: #902000">EditableListApp</span> a <span style="color: #007020; font-weight: bold">where</span>
  <span style="color: #902000">GetList</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">EditableListApp</span> [<span style="color: #902000">RowData</span>]
  <span style="color: #902000">GetActiveCellY</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">EditableListApp</span> (<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span>)
  <span style="color: #902000">GetLogs</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">EditableListApp</span> [<span style="color: #902000">String</span>]

  <span style="color: #902000">UpdateList</span> <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">RowData</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">EditableListApp</span> <span style="color: #007020">()</span>
  <span style="color: #902000">UpdateActiveCellY</span> <span style="color: #007020; font-weight: bold">::</span> (<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span>) <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">EditableListApp</span> <span style="color: #007020">()</span>
  <span style="color: #902000">Log</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">String</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">EditableListApp</span> <span style="color: #007020">()</span>

  <span style="color: #902000">LiftIO</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">IO</span> b <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">EditableListApp</span> b

  <span style="color: #902000">Done</span> <span style="color: #007020; font-weight: bold">::</span> a <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">EditableListApp</span> a
  <span style="color: #902000">Bind</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">EditableListApp</span> a <span style="color: #007020; font-weight: bold">-&gt;</span> (a <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">EditableListApp</span> b) <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">EditableListApp</span> b
</pre></div>









      <p>
Here is how to determine a type signature for a constructor:
<br/>
&nbsp;-&nbsp;operations that return a result - they return results in EditableListApp context.
      </p>

<!-- HTML generated using hilite.me --><div id="code-fragment---operational-style---getters-in-ops-gadt" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%">  <span style="color: #902000">GetList</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">EditableListApp</span> [<span style="color: #902000">RowData</span>]
  <span style="color: #902000">GetActiveCellY</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">EditableListApp</span> (<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span>)
  <span style="color: #902000">GetLogs</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">EditableListApp</span> [<span style="color: #902000">String</span>]
</pre></div>

      <p>
&nbsp;-&nbsp;operations that don't return a result, because we're interested in their side-effects, not in the results. They return an empty result (indicating side-effects) in EditableListApp context.
      </p>

<!-- HTML generated using hilite.me --><div id="code-fragment---operational-style---setters-in-ops-gadt" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%">  <span style="color: #902000">UpdateList</span> <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">RowData</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">EditableListApp</span> <span style="color: #007020">()</span>
  <span style="color: #902000">UpdateActiveCellY</span> <span style="color: #007020; font-weight: bold">::</span> (<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span>) <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">EditableListApp</span> <span style="color: #007020">()</span>
  <span style="color: #902000">Log</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">String</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">EditableListApp</span> <span style="color: #007020">()</span>
</pre></div>













      <p>
Making a GADT a monad (I think this implementation is universal across all operational style monads, you can just copy-paste the same implementation for all your descriptive monads):
      </p>

<!-- HTML generated using hilite.me --><div id="code-fragment---operational-style---making-gadt-a-monad" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #007020; font-weight: bold">instance</span> <span style="color: #902000">Functor</span> <span style="color: #902000">EditableListApp</span> <span style="color: #007020; font-weight: bold">where</span>
  fmap f x <span style="color: #007020; font-weight: bold">=</span> x `<span style="color: #902000">Bind</span>` (<span style="color: #06287e">\</span>x&#39; <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Done</span> (f x&#39;))

<span style="color: #007020; font-weight: bold">instance</span> <span style="color: #902000">Applicative</span> <span style="color: #902000">EditableListApp</span> <span style="color: #007020; font-weight: bold">where</span>
  pure <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">Done</span>
  f <span style="color: #666666">&lt;*&gt;</span> x <span style="color: #007020; font-weight: bold">=</span> f `<span style="color: #902000">Bind</span>` (<span style="color: #06287e">\</span>f&#39; <span style="color: #007020; font-weight: bold">-&gt;</span> x `<span style="color: #902000">Bind</span>` (<span style="color: #06287e">\</span>x&#39; <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Done</span> (f&#39; x&#39;)))

<span style="color: #007020; font-weight: bold">instance</span> <span style="color: #902000">Monad</span> <span style="color: #902000">EditableListApp</span> <span style="color: #007020; font-weight: bold">where</span>
  return <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">Done</span>
  (<span style="color: #666666">&gt;&gt;=</span>) <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">Bind</span>
</pre></div>





      <p>
We need to make the desciptive monad an instance of MonadIO to be able to call IO-actions using liftIO.
      </p>

<!-- HTML generated using hilite.me --><div id="code-fragment---operational-style---making-gadt-a-monadio" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #007020; font-weight: bold">instance</span> <span style="color: #902000">MonadIO</span> <span style="color: #902000">EditableListApp</span> <span style="color: #007020; font-weight: bold">where</span>
  liftIO <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">LiftIO</span>
</pre></div>



      <p>
Creating smart constructors for operations
      </p>


<!-- HTML generated using hilite.me --><div id="code-fragment---operational-style---smart-constructors" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #06287e">getList</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">EditableListApp</span> [<span style="color: #902000">RowData</span>]
<span style="color: #06287e">getList</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">GetList</span>

<span style="color: #06287e">getActiveCellY</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">EditableListApp</span> (<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span>)
<span style="color: #06287e">getActiveCellY</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">GetActiveCellY</span>

<span style="color: #06287e">getLogs</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">EditableListApp</span> [<span style="color: #902000">String</span>]
<span style="color: #06287e">getLogs</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">GetLogs</span>

<span style="color: #06287e">updateList</span> <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">RowData</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">EditableListApp</span> <span style="color: #007020">()</span>
<span style="color: #06287e">updateList</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">UpdateList</span>

<span style="color: #06287e">updateActiveCellY</span> <span style="color: #007020; font-weight: bold">::</span> (<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span>) <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">EditableListApp</span> <span style="color: #007020">()</span>
<span style="color: #06287e">updateActiveCellY</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">UpdateActiveCellY</span>

<span style="color: #06287e">log</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">String</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">EditableListApp</span> <span style="color: #007020">()</span>
<span style="color: #06287e">log</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">Log</span>
</pre></div>





      <p>
Declaring a target monad
      </p>

<!-- HTML generated using hilite.me --><div id="code-fragment---operational-style---target-monad" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #007020; font-weight: bold">newtype</span> <span style="color: #902000">StateHolder</span> a <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">StateHolder</span> (<span style="color: #902000">StateT</span> (<span style="color: #902000">AppStateData</span> <span style="color: #902000">StateHolder</span>) <span style="color: #902000">IO</span> a)
  <span style="color: #007020; font-weight: bold">deriving</span> (<span style="color: #902000">Functor</span>, <span style="color: #902000">Applicative</span>, <span style="color: #902000">Monad</span>, <span style="color: #902000">MonadIO</span>)
</pre></div>






      <p>
Creating an interpreter function that translates from descriptive monad to the target monad
      </p>


<!-- HTML generated using hilite.me --><div id="code-fragment---operational-style---interpreter-function" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #06287e">interpret</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">EditableListApp</span> a <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">StateHolder</span> a
<span style="color: #06287e">interpret</span> <span style="color: #902000">GetList</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> rows <span style="color: #666666">&lt;$&gt;</span> get
<span style="color: #06287e">interpret</span> <span style="color: #902000">GetActiveCellY</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> activeCellY <span style="color: #666666">&lt;$&gt;</span> get
<span style="color: #06287e">interpret</span> <span style="color: #902000">GetLogs</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> debugMessages <span style="color: #666666">&lt;$&gt;</span> get

<span style="color: #06287e">interpret</span> (<span style="color: #902000">UpdateList</span> l) <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
  <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> modify <span style="color: #666666">$</span> <span style="color: #06287e">\</span>s <span style="color: #007020; font-weight: bold">-&gt;</span> s { rows <span style="color: #007020; font-weight: bold">=</span> l }
  reacts <span style="color: #007020; font-weight: bold">&lt;-</span> <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> (rowsListeners <span style="color: #666666">.</span> listeners) <span style="color: #666666">&lt;$&gt;</span> get
  forM_ reacts (<span style="color: #666666">$</span> l) <span style="color: #60a0b0; font-style: italic">-- same as forM_ reacts $ \react -&gt; react l</span>
<span style="color: #06287e">interpret</span> (<span style="color: #902000">UpdateActiveCellY</span> y) <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
  <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> modify <span style="color: #666666">$</span> <span style="color: #06287e">\</span>s <span style="color: #007020; font-weight: bold">-&gt;</span> s { activeCellY <span style="color: #007020; font-weight: bold">=</span> y }
  s <span style="color: #007020; font-weight: bold">&lt;-</span> <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> get
  <span style="color: #007020; font-weight: bold">let</span> reacts <span style="color: #007020; font-weight: bold">=</span> activeCellYListeners (listeners s)
  forM_ reacts (<span style="color: #666666">$</span> y) <span style="color: #60a0b0; font-style: italic">-- same as forM_ reacts $ \react -&gt; react y</span>
<span style="color: #06287e">interpret</span> (<span style="color: #902000">Log</span> msg) <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
  <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> modify <span style="color: #666666">$</span> <span style="color: #06287e">\</span>s <span style="color: #007020; font-weight: bold">-&gt;</span> s { debugMessages <span style="color: #007020; font-weight: bold">=</span> take debugLinesCount (msg<span style="color: #902000">:</span>(debugMessages s)) }
  logs <span style="color: #007020; font-weight: bold">&lt;-</span> <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> debugMessages <span style="color: #666666">&lt;$&gt;</span> get
  reacts <span style="color: #007020; font-weight: bold">&lt;-</span> <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> (debugMessagesListeners <span style="color: #666666">.</span> listeners) <span style="color: #666666">&lt;$&gt;</span> get
  forM_ reacts (<span style="color: #666666">$</span> logs) <span style="color: #60a0b0; font-style: italic">-- same as forM_ reacts $ \react -&gt; react logs</span>
<span style="color: #06287e">interpret</span> (<span style="color: #902000">Done</span> a) <span style="color: #007020; font-weight: bold">=</span> return a
<span style="color: #06287e">interpret</span> (<span style="color: #902000">Bind</span> g h) <span style="color: #007020; font-weight: bold">=</span> (interpret g) <span style="color: #666666">&gt;&gt;=</span> (interpret <span style="color: #666666">.</span> h)
<span style="color: #06287e">interpret</span> (<span style="color: #902000">LiftIO</span> a) <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
  v <span style="color: #007020; font-weight: bold">&lt;-</span> liftIO a
  return v
</pre></div>







      <p>
The performStateAction function translates actions from target monad further to IO-monad. Same as in initial style
      </p>


<!-- HTML generated using hilite.me --><div id="code-fragment---operational-style---performStateAction" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #06287e">performStateAction</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">AppStateData</span> <span style="color: #902000">StateHolder</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">StateHolder</span> a <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">IO</span> <span style="color: #007020">()</span>
<span style="color: #06287e">performStateAction</span> state (<span style="color: #902000">StateHolder</span> action) <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
  runStateT action state
  return <span style="color: #007020">()</span>
</pre></div>






      <p>
The main function clears the screen, creates an initial state (and listeners), invokes, wrapping with performStateAction function call, the initRows and the loop function:
      </p>

<!-- HTML generated using hilite.me --><div id="code-fragment---operational-style---main" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #06287e">main</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">IO</span> <span style="color: #007020">()</span>
<span style="color: #06287e">main</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
  hSetBuffering stdin <span style="color: #902000">NoBuffering</span>
  hSetBuffering stdout <span style="color: #902000">NoBuffering</span>
  hSetEcho stdin <span style="color: #902000">False</span>
  clearScreen
  <span style="color: #60a0b0; font-style: italic">-- performStateAction initialState (interpret (do ...))</span>
  performStateAction initialState <span style="color: #666666">$</span> interpret <span style="color: #666666">$</span> <span style="color: #007020; font-weight: bold">do</span>
    initRows
    loop
  <span style="color: #007020; font-weight: bold">where</span>
    <span style="color: #666666">...</span>
</pre></div>

      <p>
----------------------------------
      </p>

      <p>
 - creating an initial state
      </p>

<!-- HTML generated using hilite.me --><div id="code-fragment---operational-style---initialState" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%">    initialState <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">AppStateData</span> <span style="color: #902000">StateHolder</span>
    initialState <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">AppState</span> <span style="color: #902000">[]</span> <span style="color: #902000">Nothing</span> <span style="color: #902000">[]</span> initListeners
</pre></div>

      <p>
----------------------------------
      </p>

      <p>
 - creating listeners:
      </p>

<!-- HTML generated using hilite.me --><div id="code-fragment---operational-style---initListeners" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%">    initListeners <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">AppStateListenersData</span> <span style="color: #902000">StateHolder</span>
    <span style="color: #60a0b0; font-style: italic">-- initListeners =</span>
    <span style="color: #60a0b0; font-style: italic">--     addRowsListener (interpret . mainRowsListener)</span>
    <span style="color: #60a0b0; font-style: italic">--     (addActiveCellYListener (interpret . activeCellYListener)</span>
    <span style="color: #60a0b0; font-style: italic">--     (addDebugMessagesListener (interpret . debugMessagesListener)</span>
    <span style="color: #60a0b0; font-style: italic">--     (empty)))</span>
    initListeners <span style="color: #007020; font-weight: bold">=</span>
        addRowsListener (interpret <span style="color: #666666">.</span> mainRowsListener)
        <span style="color: #666666">$</span> addActiveCellYListener (interpret <span style="color: #666666">.</span> activeCellYListener)
        <span style="color: #666666">$</span> addDebugMessagesListener (interpret <span style="color: #666666">.</span> debugMessagesListener)
        <span style="color: #666666">$</span> empty
      <span style="color: #007020; font-weight: bold">where</span>
        empty <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">AppStateListeners</span> <span style="color: #902000">[]</span> <span style="color: #902000">[]</span> <span style="color: #902000">[]</span>

    mainRowsListener <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">RowData</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">EditableListApp</span> <span style="color: #007020">()</span>
    mainRowsListener rows <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
      activeCellCoords <span style="color: #007020; font-weight: bold">&lt;-</span> fmap (<span style="color: #06287e">\</span>y <span style="color: #007020; font-weight: bold">-&gt;</span> (<span style="color: #40a070">0</span>, y)) <span style="color: #666666">&lt;$&gt;</span> getActiveCellY
      liftIO <span style="color: #666666">$</span> showInGrid
                 xUpperLeft
                 yUpperLeft
                 columnCount
                 columnWidth
                 activeCellCoords
                 (map (<span style="color: #06287e">\</span>row <span style="color: #007020; font-weight: bold">-&gt;</span> [smth row]) rows)
      log <span style="color: #4070a0">&quot;updated rows&quot;</span>

    activeCellYListener <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">EditableListApp</span> <span style="color: #007020">()</span>
    activeCellYListener activeCellY <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
      <span style="color: #007020; font-weight: bold">let</span> activeCellCoords <span style="color: #007020; font-weight: bold">=</span> fmap (<span style="color: #06287e">\</span>y <span style="color: #007020; font-weight: bold">-&gt;</span> (<span style="color: #40a070">0</span>, y)) activeCellY
      liftIO <span style="color: #666666">$</span> drawGrid xUpperLeft yUpperLeft columnWidth columnCount rowCount
      <span style="color: #007020; font-weight: bold">case</span> activeCellCoords <span style="color: #007020; font-weight: bold">of</span>
        <span style="color: #902000">Nothing</span> <span style="color: #007020; font-weight: bold">-&gt;</span> return <span style="color: #007020">()</span>
        <span style="color: #902000">Just</span> coordsPair <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span>
          liftIO <span style="color: #666666">$</span> highlightCell xUpperLeft yUpperLeft columnWidth columnCount rowCount coordsPair
          log <span style="color: #4070a0">&quot;highlighted cell&quot;</span>

    debugMessagesListener <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">String</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">EditableListApp</span> <span style="color: #007020">()</span>
    debugMessagesListener debugMessages <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
      liftIO <span style="color: #666666">$</span> printFromBottom
                 xUpperLeft
                 (yUpperLeft<span style="color: #666666">+</span><span style="color: #40a070">12</span><span style="color: #666666">+</span>debugLinesCount)
                 debugMessages
</pre></div>

      <p>
----------------------------------
      </p>

      <p>
 - the strings list initialization:
      </p>

<!-- HTML generated using hilite.me --><div id="code-fragment---operational-style---initRows" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%">    initRows <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">EditableListApp</span> <span style="color: #007020">()</span>
    initRows <span style="color: #007020; font-weight: bold">=</span> updateList initialRows
</pre></div>

      <p>
When initializing the list, we invoke updateList function, which in turn invokes its listeners.
      </p>

      <p>
----------------------------------
      </p>

      <p>
 - the loop function:
      </p>

      <p>
The loop function doesn't take any parameters, because the state is passed implicitly through the context, the context here is EditableListApp monad.
      </p>

      <p>
Since the loop function is defined in the EditableListApp monad's context, not in IO context, we can't directly invoke IO actions from here, but we made EditableListApp an instance of MonadIO, so we can invoke IO actions using liftIO function.
      </p>


<!-- HTML generated using hilite.me --><div id="code-fragment---operational-style---loop" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%">    loop <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">EditableListApp</span> <span style="color: #007020">()</span>
    loop <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
      key <span style="color: #007020; font-weight: bold">&lt;-</span> liftIO <span style="color: #666666">$</span> getKey
      when (key <span style="color: #666666">/=</span> <span style="color: #4070a0">&quot;</span><span style="color: #4070a0; font-weight: bold">\ESC</span><span style="color: #4070a0">&quot;</span>) <span style="color: #666666">$</span> <span style="color: #007020; font-weight: bold">do</span>
        <span style="color: #007020; font-weight: bold">case</span> key <span style="color: #007020; font-weight: bold">of</span>
          <span style="color: #4070a0">&quot;</span><span style="color: #4070a0; font-weight: bold">\ESC</span><span style="color: #4070a0">[A&quot;</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span> <span style="color: #60a0b0; font-style: italic">-- up</span>
              activeCellY <span style="color: #007020; font-weight: bold">&lt;-</span> getActiveCellY
              <span style="color: #007020; font-weight: bold">let</span>
                newActiveCellY <span style="color: #007020; font-weight: bold">=</span>
                  <span style="color: #007020; font-weight: bold">case</span> activeCellY <span style="color: #007020; font-weight: bold">of</span>
                    <span style="color: #902000">Just</span> y <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Just</span> <span style="color: #666666">$</span> max <span style="color: #40a070">0</span> (y<span style="color: #666666">-</span><span style="color: #40a070">1</span>)
                    <span style="color: #902000">Nothing</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Just</span> <span style="color: #40a070">0</span>
              updateActiveCellY newActiveCellY
              log <span style="color: #666666">$</span> <span style="color: #4070a0">&quot;up, &quot;</span> <span style="color: #666666">++</span> show(newActiveCellY)
              loop
</pre></div>















<p class="centered section-delimiter">
      <a name="freer-monads" class="inner-anchor grey">
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
      </a>
      </p>
















<p class="centered">
Freer monads
      </p>













      <p>
Just like free monads make it easier for us to create initial style monads, freer monads make it easier for us to create operational style monads: we list our operations as GADT, and through Freer monad magic we get a monad. 
      </p>





      <p>
And just like with free monads, we can say that freer monads approach is a result of extracting common abstractions from operational style monads into a module. In our code this module is called FreerProgram.
      </p>


      <p>
Let's assume that we have a module called FreerProgram that helps us to magically create a monad out of a GADT that lists operations (the module consists of only 25 lines of code, the code is shown at the end of this part). Each constructor in the GADT is considered a description of an instruction. That's why we add the "I" suffix when naming a GADT and also call the type variable "instr" in the following code.
      </p>

<!-- HTML generated using hilite.me --><div id="code-fragment---freer---freer-program-module-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #007020; font-weight: bold">module</span> <span style="color: #0e84b5; font-weight: bold">FreerProgram</span> (<span style="color: #902000">Program</span>(<span style="color: #666666">..</span>), <span style="color: #06287e">foldFreer</span>) <span style="color: #007020; font-weight: bold">where</span>

<span style="color: #007020; font-weight: bold">data</span> <span style="color: #902000">Program</span> instr a <span style="color: #007020; font-weight: bold">where</span>
  <span style="color: #902000">Done</span> <span style="color: #007020; font-weight: bold">::</span> a <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Program</span> instr a
  <span style="color: #902000">Bind</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Program</span> instr a <span style="color: #007020; font-weight: bold">-&gt;</span> (a <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Program</span> instr b) <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Program</span> instr b
  <span style="color: #902000">Instr</span> <span style="color: #007020; font-weight: bold">::</span> instr a <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Program</span> instr a
</pre></div>

      <p>
In operational style we added Done and Bind constructors to GADT. Now we don't have to do that because it is already done for us in the Program data type that is going to wrap the GADT.
      </p>


      <p>
foldFreer function is used to build interpreter functions (in the operational style we built recursive interpreter functions. Now we don't have to make them recursive, because the foldFreer function takes care of recursion)
      </p>


      <p>
Having all this infractrusture in place, we can just list our operations (instructions) in GADT and get a monad for free.
<br/>
We don't even need to make that GADT a functor like in free monads approach, that's why this approach is called freer monads.
      </p>



















      <p>
Monad operations (instructions):
      </p>

<!-- HTML generated using hilite.me --><div id="code-fragment---freer---operations-as-gadt" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #007020; font-weight: bold">data</span> <span style="color: #902000">EditableListAppI</span> a <span style="color: #007020; font-weight: bold">where</span>
  <span style="color: #902000">GetList</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">EditableListAppI</span> [<span style="color: #902000">RowData</span>]
  <span style="color: #902000">GetActiveCellY</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">EditableListAppI</span> (<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span>)
  <span style="color: #902000">GetLogs</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">EditableListAppI</span> [<span style="color: #902000">String</span>]

  <span style="color: #902000">UpdateList</span> <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">RowData</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">EditableListAppI</span> <span style="color: #007020">()</span>
  <span style="color: #902000">UpdateActiveCellY</span> <span style="color: #007020; font-weight: bold">::</span> (<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span>) <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">EditableListAppI</span> <span style="color: #007020">()</span>
  <span style="color: #902000">Log</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">String</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">EditableListAppI</span> <span style="color: #007020">()</span>

  <span style="color: #902000">LiftIO</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">IO</span> b <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">EditableListAppI</span> b
</pre></div>











      <p>
We can use the same logic as in operational style to determine type signatures in GADT:
<br/>
 - operations that return a result - return a result in EditableListAppI context.
      </p>

<!-- HTML generated using hilite.me --><div id="code-fragment---freer---getters-in-gadt" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%">  <span style="color: #902000">GetList</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">EditableListAppI</span> [<span style="color: #902000">RowData</span>]
  <span style="color: #902000">GetActiveCellY</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">EditableListAppI</span> (<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span>)
  <span style="color: #902000">GetLogs</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">EditableListAppI</span> [<span style="color: #902000">String</span>]
</pre></div>

      <p>
 - operations that don't return a result, because we're interested in their side-effects, not in the results. Those operations return an empty result in EditableListAppI context.
      </p>

<!-- HTML generated using hilite.me --><div id="code-fragment---freer---setters-in-gadt" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%">  <span style="color: #902000">UpdateList</span> <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">RowData</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">EditableListAppI</span> <span style="color: #007020">()</span>
  <span style="color: #902000">UpdateActiveCellY</span> <span style="color: #007020; font-weight: bold">::</span> (<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span>) <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">EditableListAppI</span> <span style="color: #007020">()</span>
  <span style="color: #902000">Log</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">String</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">EditableListAppI</span> <span style="color: #007020">()</span>
</pre></div>




      <p>
smart-constructors:
      </p>

<!-- HTML generated using hilite.me --><div id="code-fragment---freer---smart-constructors" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #06287e">getList</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Program</span> <span style="color: #902000">EditableListAppI</span> [<span style="color: #902000">RowData</span>]
<span style="color: #06287e">getList</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">Instr</span> <span style="color: #666666">$</span> <span style="color: #902000">GetList</span>

<span style="color: #06287e">getActiveCellY</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Program</span> <span style="color: #902000">EditableListAppI</span> (<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span>)
<span style="color: #06287e">getActiveCellY</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">Instr</span> <span style="color: #666666">$</span> <span style="color: #902000">GetActiveCellY</span>

<span style="color: #06287e">getLogs</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Program</span> <span style="color: #902000">EditableListAppI</span> [<span style="color: #902000">String</span>]
<span style="color: #06287e">getLogs</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">Instr</span> <span style="color: #666666">$</span> <span style="color: #902000">GetLogs</span>

<span style="color: #06287e">updateList</span> <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">RowData</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Program</span> <span style="color: #902000">EditableListAppI</span> <span style="color: #007020">()</span>
<span style="color: #06287e">updateList</span> x <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">Instr</span> <span style="color: #666666">.</span> <span style="color: #902000">UpdateList</span> <span style="color: #666666">$</span> x

<span style="color: #06287e">updateActiveCellY</span> <span style="color: #007020; font-weight: bold">::</span> (<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span>) <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Program</span> <span style="color: #902000">EditableListAppI</span> <span style="color: #007020">()</span>
<span style="color: #06287e">updateActiveCellY</span> y <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">Instr</span> <span style="color: #666666">.</span> <span style="color: #902000">UpdateActiveCellY</span> <span style="color: #666666">$</span> y

<span style="color: #06287e">log</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">String</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Program</span> <span style="color: #902000">EditableListAppI</span> <span style="color: #007020">()</span>
<span style="color: #06287e">log</span> msg <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">Instr</span> <span style="color: #666666">.</span> <span style="color: #902000">Log</span> <span style="color: #666666">$</span> msg
</pre></div>




      <p>
The MonadIO instance for our monad:
      </p>

<!-- HTML generated using hilite.me --><div id="code-fragment---freer---monadio-instance" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #007020; font-weight: bold">instance</span> <span style="color: #902000">MonadIO</span> (<span style="color: #902000">Program</span> <span style="color: #902000">EditableListAppI</span>) <span style="color: #007020; font-weight: bold">where</span>
  liftIO <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">Instr</span> <span style="color: #666666">.</span> <span style="color: #902000">LiftIO</span>
</pre></div>








      <p>
The target monad is the same as was previously:
      </p>

<!-- HTML generated using hilite.me --><div id="code-fragment---freer---target-monad" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #007020; font-weight: bold">newtype</span> <span style="color: #902000">StateHolder</span> a <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">StateHolder</span> (<span style="color: #902000">StateT</span> (<span style="color: #902000">AppStateData</span> <span style="color: #902000">StateHolder</span>) <span style="color: #902000">IO</span> a)
  <span style="color: #007020; font-weight: bold">deriving</span> (<span style="color: #902000">Functor</span>, <span style="color: #902000">Applicative</span>, <span style="color: #902000">Monad</span>, <span style="color: #902000">MonadIO</span>)
</pre></div>





      <p>
The interpreter function is built using foldFreer:
      </p>


<!-- HTML generated using hilite.me --><div id="code-fragment---freer---interpreter-function" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #06287e">interpret&#39;</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">EditableListAppI</span> a <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">StateHolder</span> a
<span style="color: #06287e">interpret&#39;</span> <span style="color: #902000">GetList</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> rows <span style="color: #666666">&lt;$&gt;</span> get
<span style="color: #06287e">interpret&#39;</span> <span style="color: #902000">GetActiveCellY</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> activeCellY <span style="color: #666666">&lt;$&gt;</span> get
<span style="color: #06287e">interpret&#39;</span> <span style="color: #902000">GetLogs</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> debugMessages <span style="color: #666666">&lt;$&gt;</span> get

<span style="color: #06287e">interpret&#39;</span> (<span style="color: #902000">UpdateList</span> l) <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
  <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> modify <span style="color: #666666">$</span> <span style="color: #06287e">\</span>s <span style="color: #007020; font-weight: bold">-&gt;</span> s { rows <span style="color: #007020; font-weight: bold">=</span> l }
  reacts <span style="color: #007020; font-weight: bold">&lt;-</span> <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> (rowsListeners <span style="color: #666666">.</span> listeners) <span style="color: #666666">&lt;$&gt;</span> get
  forM_ reacts (<span style="color: #666666">$</span> l) <span style="color: #60a0b0; font-style: italic">-- same as forM_ reacts $ \react -&gt; react l</span>
<span style="color: #06287e">interpret&#39;</span> (<span style="color: #902000">UpdateActiveCellY</span> y) <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
  <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> modify <span style="color: #666666">$</span> <span style="color: #06287e">\</span>s <span style="color: #007020; font-weight: bold">-&gt;</span> s { activeCellY <span style="color: #007020; font-weight: bold">=</span> y }
  s <span style="color: #007020; font-weight: bold">&lt;-</span> <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> get
  <span style="color: #007020; font-weight: bold">let</span> reacts <span style="color: #007020; font-weight: bold">=</span> activeCellYListeners (listeners s)
  forM_ reacts (<span style="color: #666666">$</span> y) <span style="color: #60a0b0; font-style: italic">-- same as forM_ reacts $ \react -&gt; react y</span>
<span style="color: #06287e">interpret&#39;</span> (<span style="color: #902000">Log</span> msg) <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
  <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> modify <span style="color: #666666">$</span> <span style="color: #06287e">\</span>s <span style="color: #007020; font-weight: bold">-&gt;</span> s { debugMessages <span style="color: #007020; font-weight: bold">=</span> take debugLinesCount (msg<span style="color: #902000">:</span>(debugMessages s)) }
  logs <span style="color: #007020; font-weight: bold">&lt;-</span> <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> debugMessages <span style="color: #666666">&lt;$&gt;</span> get
  reacts <span style="color: #007020; font-weight: bold">&lt;-</span> <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> (debugMessagesListeners <span style="color: #666666">.</span> listeners) <span style="color: #666666">&lt;$&gt;</span> get
  forM_ reacts (<span style="color: #666666">$</span> logs) <span style="color: #60a0b0; font-style: italic">-- same as forM_ reacts $ \react -&gt; react logs</span>
<span style="color: #06287e">interpret&#39;</span> (<span style="color: #902000">LiftIO</span> a) <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
  v <span style="color: #007020; font-weight: bold">&lt;-</span> liftIO a
  return v

<span style="color: #06287e">interpret</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Program</span> <span style="color: #902000">EditableListAppI</span> a <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">StateHolder</span> a
<span style="color: #06287e">interpret</span> <span style="color: #007020; font-weight: bold">=</span> foldFreer interpret&#39;
</pre></div>









      <p>
The rest of the code (the listeners and a loop function) is the same as in operational style, we only need to change type signatures of functions:
      </p>


<!-- HTML generated using hilite.me --><div id="code-fragment---freer---type-signatures-of-listeners-and-loop" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%">    mainRowsListener <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">RowData</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Program</span> <span style="color: #902000">EditableListAppI</span> <span style="color: #007020">()</span>
    activeCellYListener <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Program</span> <span style="color: #902000">EditableListAppI</span> <span style="color: #007020">()</span>
    debugMessagesListener <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">String</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Program</span> <span style="color: #902000">EditableListAppI</span> <span style="color: #007020">()</span>
    loop <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Program</span> <span style="color: #902000">EditableListAppI</span> <span style="color: #007020">()</span>
</pre></div>









      <p>
The FreerProgram module:
      </p>

<!-- HTML generated using hilite.me --><div id="code-fragment---freer---freer-program-module" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #60a0b0; font-style: italic">{-# LANGUAGE GADTs #-}</span>
<span style="color: #60a0b0; font-style: italic">{-# LANGUAGE  RankNTypes #-}</span>
<span style="color: #007020; font-weight: bold">module</span> <span style="color: #0e84b5; font-weight: bold">FreerProgram</span> (<span style="color: #902000">Program</span>(<span style="color: #666666">..</span>), <span style="color: #06287e">foldFreer</span>) <span style="color: #007020; font-weight: bold">where</span>

<span style="color: #007020; font-weight: bold">data</span> <span style="color: #902000">Program</span> instr a <span style="color: #007020; font-weight: bold">where</span>
  <span style="color: #902000">Done</span> <span style="color: #007020; font-weight: bold">::</span> a <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Program</span> instr a
  <span style="color: #902000">Bind</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Program</span> instr a <span style="color: #007020; font-weight: bold">-&gt;</span> (a <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Program</span> instr b) <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Program</span> instr b
  <span style="color: #902000">Instr</span> <span style="color: #007020; font-weight: bold">::</span> instr a <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Program</span> instr a

<span style="color: #007020; font-weight: bold">instance</span> <span style="color: #902000">Functor</span> (<span style="color: #902000">Program</span> instr) <span style="color: #007020; font-weight: bold">where</span>
  fmap f x <span style="color: #007020; font-weight: bold">=</span> x `<span style="color: #902000">Bind</span>` (<span style="color: #06287e">\</span>x&#39; <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Done</span> (f x&#39;))

<span style="color: #007020; font-weight: bold">instance</span> <span style="color: #902000">Applicative</span> (<span style="color: #902000">Program</span> instr) <span style="color: #007020; font-weight: bold">where</span>
  pure <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">Done</span>
  f <span style="color: #666666">&lt;*&gt;</span> x <span style="color: #007020; font-weight: bold">=</span> f `<span style="color: #902000">Bind</span>` (<span style="color: #06287e">\</span>f&#39; <span style="color: #007020; font-weight: bold">-&gt;</span> x `<span style="color: #902000">Bind</span>` (<span style="color: #06287e">\</span>x&#39; <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Done</span> (f&#39; x&#39;)))

<span style="color: #007020; font-weight: bold">instance</span> <span style="color: #902000">Monad</span> (<span style="color: #902000">Program</span> instr) <span style="color: #007020; font-weight: bold">where</span>
  return <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">Done</span>
  (<span style="color: #666666">&gt;&gt;=</span>) <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">Bind</span>

<span style="color: #06287e">foldFreer</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Monad</span> m <span style="color: #007020; font-weight: bold">=&gt;</span> (forall r<span style="color: #666666">.</span> instr r <span style="color: #007020; font-weight: bold">-&gt;</span> m r) <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Program</span> instr a <span style="color: #007020; font-weight: bold">-&gt;</span> m a
<span style="color: #06287e">foldFreer</span> <span style="color: #007020; font-weight: bold">_</span> (<span style="color: #902000">Done</span> x) <span style="color: #007020; font-weight: bold">=</span> return x
<span style="color: #06287e">foldFreer</span> interpret (x `<span style="color: #902000">Bind</span>` f) <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span> x&#39; <span style="color: #007020; font-weight: bold">&lt;-</span> foldFreer interpret x
                                      foldFreer interpret (f x&#39;)
<span style="color: #06287e">foldFreer</span> interpret (<span style="color: #902000">Instr</span> x) <span style="color: #007020; font-weight: bold">=</span> interpret x
</pre></div>







    </div> <!-- end of column left -->



    <div id="code-wrapper" class="column right">

<div style="font-size: large; padding: 20px; font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji;">
  <p>
  The code will be shown here.
  </p>
  <p>
  Elements on the diagram and code fragments are clickable. A code fragment is going to be highlighted here when clicked.
  </p>
</div>





<!-- HTML generated using hilite.me --><div id="source---observer-in-final-style-monad---main" style="display: none; background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #60a0b0; font-style: italic">{-# LANGUAGE  GeneralizedNewtypeDeriving #-}</span>
<span style="color: #007020; font-weight: bold">module</span> <span style="color: #0e84b5; font-weight: bold">Main</span> <span style="color: #007020; font-weight: bold">where</span>

<span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">Control.Monad</span> (<span style="color: #06287e">when</span>, <span style="color: #06287e">forM_</span>)
<span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">Control.Exception</span> (<span style="color: #06287e">try</span>)
<span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">System.IO</span> (<span style="color: #06287e">stdin</span>, <span style="color: #06287e">stdout</span>, <span style="color: #06287e">hSetEcho</span>, <span style="color: #06287e">hSetBuffering</span>, <span style="color: #06287e">hReady</span>, <span style="color: #902000">BufferMode</span> (<span style="color: #902000">NoBuffering</span>) )
<span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">Control.Monad.State.Strict</span> (<span style="color: #902000">StateT</span>, <span style="color: #06287e">get</span>, <span style="color: #06287e">modify</span>, <span style="color: #06287e">runStateT</span>)
<span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">Control.Monad.IO.Class</span> (<span style="color: #902000">MonadIO</span>, <span style="color: #06287e">liftIO</span>)
<span style="color: #007020; font-weight: bold">import</span> <span style="color: #007020; font-weight: bold">qualified</span> <span style="color: #0e84b5; font-weight: bold">Data.Map</span> <span style="color: #007020; font-weight: bold">as</span> Map
<span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">ViewUtils</span> (<span style="color: #06287e">clearScreen</span>, <span style="color: #06287e">showInRectangle</span>, <span style="color: #06287e">clearRectangle</span>, <span style="color: #06287e">showInGrid</span>, <span style="color: #06287e">drawGrid</span>, <span style="color: #06287e">highlightCell</span>, <span style="color: #06287e">printFromBottom</span>)
<span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">Prelude</span> <span style="color: #007020; font-weight: bold">hiding</span> (<span style="color: #06287e">log</span>)

<span style="color: #007020; font-weight: bold">data</span> <span style="color: #902000">RowData</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">Row</span> { smth <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">String</span> } <span style="color: #007020; font-weight: bold">deriving</span> <span style="color: #902000">Eq</span>

<span style="color: #06287e">initialRows</span> <span style="color: #007020; font-weight: bold">=</span> [
  <span style="color: #902000">Row</span> <span style="color: #4070a0">&quot;something a&quot;</span>
  , <span style="color: #902000">Row</span> <span style="color: #4070a0">&quot;something b&quot;</span>
  , <span style="color: #902000">Row</span> <span style="color: #4070a0">&quot;something c&quot;</span>
  , <span style="color: #902000">Row</span> <span style="color: #4070a0">&quot;something d&quot;</span>
  , <span style="color: #902000">Row</span> <span style="color: #4070a0">&quot;something e&quot;</span>
  ]

<div id="source---observer-in-final-style-monad---state-adt" style="display: inline-block;"><div id="source---observer-in-final-style-monad---AppStateData" style="display: inline-block;"><span style="color: #007020; font-weight: bold">data</span> <span style="color: #902000">AppStateData</span> m <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">AppState</span>
  { <div id="source---observer-in-final-style-monad---main-rows-field" style="display: inline;">rows <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">RowData</span>]</div>
  , <div id="source---observer-in-final-style-monad---highlighted-row-index-field" style="display: inline;">activeCellY <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span></div>
  , <div id="source---observer-in-final-style-monad---debug-messages-field" style="display: inline;">debugMessages <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">String</span>]</div>
  , <div id="source---observer-in-final-style-monad---listeners-field" style="display: inline;">listeners <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">AppStateListenersData</span> m</div>
  }
</div>

<span style="color: #007020; font-weight: bold">data</span> <span style="color: #902000">AppStateListenersData</span> m <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">AppStateListeners</span>
  { <div id="source---observer-in-final-style-monad---rowsListeners" style="display: inline;">rowsListeners <span style="color: #007020; font-weight: bold">::</span> [[<span style="color: #902000">RowData</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>]</div>
  , <div id="source---observer-in-final-style-monad---activeCellYListeners" style="display: inline;">activeCellYListeners <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span> <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>]</div>
  , <div id="source---observer-in-final-style-monad---debugMessagesListeners" style="display: inline;">debugMessagesListeners <span style="color: #007020; font-weight: bold">::</span> [[<span style="color: #902000">String</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>]</div>
  }
</div>

<div id="source---observer-in-final-style-monad---adding-listeners" style="display: inline-block;"><span style="color: #06287e">addRowsListener</span> <span style="color: #007020; font-weight: bold">::</span> (<span style="color: #902000">Monad</span> m, <span style="color: #902000">EditableListApp</span> m) <span style="color: #007020; font-weight: bold">=&gt;</span> ([<span style="color: #902000">RowData</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>) <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span> m <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span> m
</div>
<span style="color: #06287e">addRowsListener</span> listener (<span style="color: #902000">AppStateListeners</span> rowsListeners _activeCellYListeners _debugMessagesListeners) <span style="color: #007020; font-weight: bold">=</span>
  <span style="color: #902000">AppStateListeners</span> (listener<span style="color: #902000">:</span>rowsListeners) _activeCellYListeners _debugMessagesListeners

<span style="color: #06287e">addActiveCellYListener</span> <span style="color: #007020; font-weight: bold">::</span> (<span style="color: #902000">Monad</span> m, <span style="color: #902000">EditableListApp</span> m) <span style="color: #007020; font-weight: bold">=&gt;</span> (<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span> <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>) <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span> m <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span> m
<span style="color: #06287e">addActiveCellYListener</span> listener (<span style="color: #902000">AppStateListeners</span> _rowsListeners activeCellYListeners _debugMessagesListeners) <span style="color: #007020; font-weight: bold">=</span>
  <span style="color: #902000">AppStateListeners</span> _rowsListeners (listener<span style="color: #902000">:</span>activeCellYListeners) _debugMessagesListeners

<span style="color: #06287e">addDebugMessagesListener</span> <span style="color: #007020; font-weight: bold">::</span> (<span style="color: #902000">Monad</span> m, <span style="color: #902000">EditableListApp</span> m) <span style="color: #007020; font-weight: bold">=&gt;</span> ([<span style="color: #902000">String</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>) <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span> m <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span> m
<span style="color: #06287e">addDebugMessagesListener</span> listener (<span style="color: #902000">AppStateListeners</span> _rowsListeners _activeCellYListeners debugMessagesListeners) <span style="color: #007020; font-weight: bold">=</span>
  <span style="color: #902000">AppStateListeners</span> _rowsListeners _activeCellYListeners (listener<span style="color: #902000">:</span>debugMessagesListeners)

<div id="source---observer-in-final-style-monad---descriptive-adt" style="display: inline-block;"><span style="color: #007020; font-weight: bold">class</span> <span style="color: #902000">EditableListApp</span> m <span style="color: #007020; font-weight: bold">where</span>
  <div id="source---observer-in-final-style-monad---descriptive-adt-getters" style="display: inline-block;">  getList <span style="color: #007020; font-weight: bold">::</span> m [<span style="color: #902000">RowData</span>]
  getActiveCellY <span style="color: #007020; font-weight: bold">::</span> m (<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span>)
  getLogs <span style="color: #007020; font-weight: bold">::</span> m [<span style="color: #902000">String</span>]</div>

  <div id="source---observer-in-final-style-monad---descriptive-adt-setters" style="display: inline-block;">  updateList <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">RowData</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>
  updateActiveCellY <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span> <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>
  log <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">String</span> <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span></div>
</div>

<div id="source---observer-in-final-style-monad---target-monad" style="display: inline-block;"><span style="color: #007020; font-weight: bold">newtype</span> <span style="color: #902000">StateHolder</span> a <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">StateHolder</span> (<span style="color: #902000">StateT</span> (<span style="color: #902000">AppStateData</span> <span style="color: #902000">StateHolder</span>) <span style="color: #902000">IO</span> a)
  <span style="color: #007020; font-weight: bold">deriving</span> (<span style="color: #902000">Functor</span>, <span style="color: #902000">Applicative</span>, <span style="color: #902000">Monad</span>, <span style="color: #902000">MonadIO</span>)
</div>

<div id="source---observer-in-final-style-monad---target-monad-instance-of-descriptive-monad" style="display: inline-block;"><span style="color: #007020; font-weight: bold">instance</span> <span style="color: #902000">EditableListApp</span> <span style="color: #902000">StateHolder</span> <span style="color: #007020; font-weight: bold">where</span>
  <div id="source---observer-in-final-style-monad---getList" style="display: inline;">getList <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> rows <span style="color: #666666">&lt;$&gt;</span> get</div>
  <div id="source---observer-in-final-style-monad---getActiveCellY" style="display: inline;">getActiveCellY <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> activeCellY <span style="color: #666666">&lt;$&gt;</span> get</div>
  <div id="source---observer-in-final-style-monad---getLogs" style="display: inline;">getLogs <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> debugMessages <span style="color: #666666">&lt;$&gt;</span> get</div>

<div id="source---observer-in-final-style-monad---updateList" style="display: inline-block;"
>  updateList l <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
    <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> modify <span style="color: #666666">$</span> <span style="color: #06287e">\</span>s <span style="color: #007020; font-weight: bold">-&gt;</span> s { rows <span style="color: #007020; font-weight: bold">=</span> l }
    reacts <span style="color: #007020; font-weight: bold">&lt;-</span> <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> (rowsListeners <span style="color: #666666">.</span> listeners) <span style="color: #666666">&lt;$&gt;</span> get
    <div id="source---observer-in-final-style-monad---triggering-main-rows-listener" style="display: inline;">forM_ reacts (<span style="color: #666666">$</span> l)</div> <span style="color: #60a0b0; font-style: italic">-- same as forM_ reacts $ \react -&gt; react l</span>
</div>
<div id="source---observer-in-final-style-monad---updateActiveCellY" style="display: inline-block;"
>  updateActiveCellY y <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
    <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> modify <span style="color: #666666">$</span> <span style="color: #06287e">\</span>s <span style="color: #007020; font-weight: bold">-&gt;</span> s { activeCellY <span style="color: #007020; font-weight: bold">=</span> y }
    s <span style="color: #007020; font-weight: bold">&lt;-</span> <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> get
    <span style="color: #007020; font-weight: bold">let</span> reacts <span style="color: #007020; font-weight: bold">=</span> activeCellYListeners (listeners s)
    <div id="source---observer-in-final-style-monad---triggering-highlighted-cell-listener" style="display: inline;">forM_ reacts (<span style="color: #666666">$</span> y)</div> <span style="color: #60a0b0; font-style: italic">-- same as forM_ reacts $ \react -&gt; react y</span>
</div>
<div id="source---observer-in-final-style-monad---log" style="display: inline-block;"
>  log msg <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
    <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> modify <span style="color: #666666">$</span> <span style="color: #06287e">\</span>s <span style="color: #007020; font-weight: bold">-&gt;</span> s { debugMessages <span style="color: #007020; font-weight: bold">=</span> take debugLinesCount (msg<span style="color: #902000">:</span>(debugMessages s)) }
    logs <span style="color: #007020; font-weight: bold">&lt;-</span> <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> debugMessages <span style="color: #666666">&lt;$&gt;</span> get
    reacts <span style="color: #007020; font-weight: bold">&lt;-</span> <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> (debugMessagesListeners <span style="color: #666666">.</span> listeners) <span style="color: #666666">&lt;$&gt;</span> get
    <div id="source---observer-in-final-style-monad---triggering-debug-messages-listener" style="display: inline;">forM_ reacts (<span style="color: #666666">$</span> logs)</div> <span style="color: #60a0b0; font-style: italic">-- same as forM_ reacts $ \react -&gt; react logs</span>
</div>
</div>

<div id="source---observer-in-final-style-monad---performStateAction" style="display: inline-block;"><span style="color: #06287e">performStateAction</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">AppStateData</span> <span style="color: #902000">StateHolder</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">StateHolder</span> a <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">IO</span> <span style="color: #007020">()</span>
<span style="color: #06287e">performStateAction</span> state (<span style="color: #902000">StateHolder</span> action) <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
  runStateT action state
  return <span style="color: #007020">()</span>
</div>

<span style="color: #06287e">debugLinesCount</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #40a070">20</span>

<div id="source---observer-in-final-style-monad---main-func" style="display: inline-block;"><span style="color: #06287e">main</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">IO</span> <span style="color: #007020">()</span>
<span style="color: #06287e">main</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
  hSetBuffering stdin <span style="color: #902000">NoBuffering</span>
  hSetBuffering stdout <span style="color: #902000">NoBuffering</span>
  hSetEcho stdin <span style="color: #902000">False</span>
  clearScreen
  performStateAction initialState <span style="color: #666666">$</span> <span style="color: #007020; font-weight: bold">do</span>
    initRows
    loop
  <span style="color: #007020; font-weight: bold">where</span>
</div>
    xUpperLeft <span style="color: #007020; font-weight: bold">=</span> <span style="color: #40a070">0</span>
    yUpperLeft <span style="color: #007020; font-weight: bold">=</span> <span style="color: #40a070">0</span>
    columnCount <span style="color: #007020; font-weight: bold">=</span> <span style="color: #40a070">1</span>
    columnWidth <span style="color: #007020; font-weight: bold">=</span> <span style="color: #40a070">14</span>
    rowCount <span style="color: #007020; font-weight: bold">=</span> length initialRows

<div id="source---observer-in-final-style-monad---initialState" style="display: inline-block;">    initialState <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">AppStateData</span> <span style="color: #902000">StateHolder</span>
    initialState <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">AppState</span> <span style="color: #902000">[]</span> <span style="color: #902000">Nothing</span> <span style="color: #902000">[]</span> initListeners
</div>

<div id="source---observer-in-final-style-monad---initRows" style="display: inline-block;">    initRows <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">StateHolder</span> <span style="color: #007020">()</span>
    initRows <span style="color: #007020; font-weight: bold">=</span> updateList initialRows
</div>

<div id="source---observer-in-final-style-monad---creating-listeners" style="display: inline-block;">    initListeners <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">AppStateListenersData</span> <span style="color: #902000">StateHolder</span>
    <span style="color: #60a0b0; font-style: italic">-- initListeners =</span>
    <span style="color: #60a0b0; font-style: italic">--     addRowsListener mainRowsListener</span>
    <span style="color: #60a0b0; font-style: italic">--     (addActiveCellYListener activeCellYListener</span>
    <span style="color: #60a0b0; font-style: italic">--     (addDebugMessagesListener debugMessagesListener</span>
    <span style="color: #60a0b0; font-style: italic">--     (empty)))</span>
    initListeners <span style="color: #007020; font-weight: bold">=</span>
        addRowsListener mainRowsListener
        <span style="color: #666666">$</span> addActiveCellYListener activeCellYListener
        <span style="color: #666666">$</span> addDebugMessagesListener debugMessagesListener
        <span style="color: #666666">$</span> empty
      <span style="color: #007020; font-weight: bold">where</span>
        empty <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">AppStateListeners</span> <span style="color: #902000">[]</span> <span style="color: #902000">[]</span> <span style="color: #902000">[]</span>

<div id="source---observer-in-final-style-monad---list-listener" style="display: inline-block;"
>    mainRowsListener <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">RowData</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">StateHolder</span> <span style="color: #007020">()</span>
    mainRowsListener rows <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
      activeCellCoords <span style="color: #007020; font-weight: bold">&lt;-</span> fmap (<span style="color: #06287e">\</span>y <span style="color: #007020; font-weight: bold">-&gt;</span> (<span style="color: #40a070">0</span>, y)) <span style="color: #666666">&lt;$&gt;</span> getActiveCellY
<div id="source---observer-in-final-style-monad---main-rows-listener-draw" style="display: inline-block;"
>      liftIO <span style="color: #666666">$</span> showInGrid
                 xUpperLeft
                 yUpperLeft
                 columnCount
                 columnWidth
                 activeCellCoords
                 (map (<span style="color: #06287e">\</span>row <span style="color: #007020; font-weight: bold">-&gt;</span> [smth row]) rows)
</div>
      <div id="source---observer-in-final-style-monad---main-rows-listener-log" style="display: inline;">log <span style="color: #4070a0">&quot;updated rows&quot;</span></div>
</div>

<div id="source---observer-in-final-style-monad---active-cell-y-listener" style="display: inline-block;"
>    activeCellYListener <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">StateHolder</span> <span style="color: #007020">()</span>
    activeCellYListener activeCellY <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
      <span style="color: #007020; font-weight: bold">let</span> activeCellCoords <span style="color: #007020; font-weight: bold">=</span> fmap (<span style="color: #06287e">\</span>y <span style="color: #007020; font-weight: bold">-&gt;</span> (<span style="color: #40a070">0</span>, y)) activeCellY
      <div class="source---observer-in-final-style-monad---active-cell-y-listener-draw" style="display: inline;">liftIO <span style="color: #666666">$</span> drawGrid xUpperLeft yUpperLeft columnWidth columnCount rowCount</div>
      <span style="color: #007020; font-weight: bold">case</span> activeCellCoords <span style="color: #007020; font-weight: bold">of</span>
        <span style="color: #902000">Nothing</span> <span style="color: #007020; font-weight: bold">-&gt;</span> return <span style="color: #007020">()</span>
        <span style="color: #902000">Just</span> coordsPair <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span>
          <div class="source---observer-in-final-style-monad---active-cell-y-listener-draw" style="display: inline;">liftIO <span style="color: #666666">$</span> highlightCell xUpperLeft yUpperLeft columnWidth columnCount rowCount coordsPair</div>
          <div id="source---observer-in-final-style-monad---active-cell-y-listener-log" style="display: inline;">log <span style="color: #4070a0">&quot;highlighted cell&quot;</span></div>
</div>

<div id="source---observer-in-final-style-monad---logs-listener" style="display: inline-block;"
>    debugMessagesListener <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">String</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">StateHolder</span> <span style="color: #007020">()</span>
    debugMessagesListener debugMessages <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
<div id="source---observer-in-final-style-monad---debug-messages-listener-draw" style="display: inline-block;"
>      liftIO <span style="color: #666666">$</span> printFromBottom
                 xUpperLeft
                 (yUpperLeft<span style="color: #666666">+</span><span style="color: #40a070">12</span><span style="color: #666666">+</span>debugLinesCount)
                 debugMessages
</div>
</div>
</div>

<div id="source---observer-in-final-style-monad---loop" style="display: inline-block;"><div id="source---observer-in-final-style-monad---loop-definition-2-lines" style="display: inline-block;">    loop <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">StateHolder</span> <span style="color: #007020">()</span>
    loop <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
</div>
      <div id="source---observer-in-final-style-monad---getKey" style="display: inline;">key <span style="color: #007020; font-weight: bold">&lt;-</span> liftIO <span style="color: #666666">$</span> getKey</div>
      when (key <span style="color: #666666">/=</span> <span style="color: #4070a0">&quot;</span><span style="color: #4070a0; font-weight: bold">\ESC</span><span style="color: #4070a0">&quot;</span>) <span style="color: #666666">$</span> <span style="color: #007020; font-weight: bold">do</span>
        <div id="source---observer-in-final-style-monad---case-key-of" style="display: inline;"><span style="color: #007020; font-weight: bold">case</span> key <span style="color: #007020; font-weight: bold">of</span></div>
          <div id="source---observer-in-final-style-monad---case-key-up" style="display: inline;"><span style="color: #4070a0">&quot;</span><span style="color: #4070a0; font-weight: bold">\ESC</span><span style="color: #4070a0">[A&quot;</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span> <span style="color: #60a0b0; font-style: italic">-- up</span></div>
              activeCellY <span style="color: #007020; font-weight: bold">&lt;-</span> getActiveCellY
              <span style="color: #007020; font-weight: bold">let</span>
                newActiveCellY <span style="color: #007020; font-weight: bold">=</span>
                  <span style="color: #007020; font-weight: bold">case</span> activeCellY <span style="color: #007020; font-weight: bold">of</span>
                    <span style="color: #902000">Just</span> y <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Just</span> <span style="color: #666666">$</span> max <span style="color: #40a070">0</span> (y<span style="color: #666666">-</span><span style="color: #40a070">1</span>)
                    <span style="color: #902000">Nothing</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Just</span> <span style="color: #40a070">0</span>
              <div id="source---observer-in-final-style-monad---write2field-active-cell-y-from-up-key-press" style="display: inline;">updateActiveCellY newActiveCellY</div>
              <div id="source---observer-in-final-style-monad---write2field-debug-messages-from-up-key-press" style="display: inline;">log <span style="color: #666666">$</span> <span style="color: #4070a0">&quot;up, &quot;</span> <span style="color: #666666">++</span> show(newActiveCellY)</div>
              loop
</div>
          <div id="source---observer-in-final-style-monad---case-key-down" style="display: inline;"><span style="color: #4070a0">&quot;</span><span style="color: #4070a0; font-weight: bold">\ESC</span><span style="color: #4070a0">[B&quot;</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span> <span style="color: #60a0b0; font-style: italic">-- down</span></div>
              activeCellY <span style="color: #007020; font-weight: bold">&lt;-</span> getActiveCellY
              <span style="color: #007020; font-weight: bold">let</span>
                newActiveCellY <span style="color: #007020; font-weight: bold">=</span>
                  <span style="color: #007020; font-weight: bold">case</span> activeCellY <span style="color: #007020; font-weight: bold">of</span>
                    <span style="color: #902000">Just</span> y <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Just</span> <span style="color: #666666">$</span> min (rowCount<span style="color: #666666">-</span><span style="color: #40a070">1</span>) (y<span style="color: #666666">+</span><span style="color: #40a070">1</span>)
                    <span style="color: #902000">Nothing</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Just</span> <span style="color: #40a070">0</span>
              <div id="source---observer-in-final-style-monad---write2field-active-cell-y-from-down-key-press" style="display: inline;">updateActiveCellY newActiveCellY</div>
              <div id="source---observer-in-final-style-monad---write2field-debug-messages-from-down-key-press" style="display: inline;">log <span style="color: #666666">$</span> <span style="color: #4070a0">&quot;down, &quot;</span> <span style="color: #666666">++</span> show(newActiveCellY)</div>
              loop
          <div id="source---observer-in-final-style-monad---case-key-enter" style="display: inline;"><span style="color: #4070a0">&quot;</span><span style="color: #4070a0; font-weight: bold">\n</span><span style="color: #4070a0">&quot;</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span> <span style="color: #60a0b0; font-style: italic">-- enter</span></div>
              activeCellY <span style="color: #007020; font-weight: bold">&lt;-</span> getActiveCellY
              rows <span style="color: #007020; font-weight: bold">&lt;-</span> getList
                
              <span style="color: #007020; font-weight: bold">let</span>
                  eitherValue <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Either</span> <span style="color: #902000">String</span> <span style="color: #902000">String</span>
                  eitherValue <span style="color: #007020; font-weight: bold">=</span>
                    <span style="color: #007020; font-weight: bold">case</span> activeCellY <span style="color: #007020; font-weight: bold">of</span>
                      <span style="color: #902000">Nothing</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Left</span> <span style="color: #4070a0">&quot;there&#39;s no selected cell&quot;</span>
                      <span style="color: #902000">Just</span> cellIndex <span style="color: #007020; font-weight: bold">-&gt;</span>
                        <span style="color: #007020; font-weight: bold">if</span> cellIndex <span style="color: #666666">&lt;</span> <span style="color: #40a070">0</span> <span style="color: #666666">||</span> cellIndex <span style="color: #666666">&gt;=</span> (length rows)
                          <span style="color: #007020; font-weight: bold">then</span> <span style="color: #902000">Left</span> <span style="color: #666666">$</span> <span style="color: #4070a0">&quot;index out of bounds: &quot;</span> <span style="color: #666666">++</span> (show cellIndex)
                          <span style="color: #007020; font-weight: bold">else</span> <span style="color: #902000">Right</span> <span style="color: #666666">$</span> smth <span style="color: #666666">$</span> rows <span style="color: #666666">!!</span> cellIndex

                  showEditField <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">String</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">StateHolder</span> <span style="color: #007020">()</span>
                  showEditField value <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
                    <span style="color: #007020; font-weight: bold">let</span>
                      txt <span style="color: #007020; font-weight: bold">=</span> <span style="color: #4070a0">&quot;edit cell value:&quot;</span>
                      lentxt <span style="color: #007020; font-weight: bold">=</span> length txt
                      yPos <span style="color: #007020; font-weight: bold">=</span> <span style="color: #40a070">0</span>
                      xPos <span style="color: #007020; font-weight: bold">=</span> (columnCount <span style="color: #666666">*</span> (columnWidth <span style="color: #666666">+</span> <span style="color: #40a070">1</span>)) <span style="color: #666666">+</span> <span style="color: #40a070">3</span>
                      replaceNth lst idx val <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">if</span> idx <span style="color: #666666">&lt;</span> <span style="color: #40a070">1</span> <span style="color: #007020; font-weight: bold">then</span> val<span style="color: #902000">:</span>(tail lst) <span style="color: #007020; font-weight: bold">else</span> (head lst) <span style="color: #902000">:</span> (replaceNth (tail lst) (idx <span style="color: #666666">-</span> <span style="color: #40a070">1</span>) val)
                    liftIO <span style="color: #666666">$</span> showInRectangle xPos yPos lentxt [txt, value]
                    key <span style="color: #007020; font-weight: bold">&lt;-</span> liftIO <span style="color: #666666">$</span> getKey
                    <span style="color: #007020; font-weight: bold">case</span> key <span style="color: #007020; font-weight: bold">of</span>
                      <span style="color: #4070a0">&quot;</span><span style="color: #4070a0; font-weight: bold">\n</span><span style="color: #4070a0">&quot;</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span>
                        <span style="color: #007020; font-weight: bold">case</span> activeCellY <span style="color: #007020; font-weight: bold">of</span>
                          <span style="color: #902000">Nothing</span> <span style="color: #007020; font-weight: bold">-&gt;</span> return <span style="color: #007020">()</span>
                          <span style="color: #902000">Just</span> cellIndex <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span>
                            liftIO <span style="color: #666666">$</span> clearRectangle xPos yPos lentxt <span style="color: #40a070">2</span>
                            rows <span style="color: #007020; font-weight: bold">&lt;-</span> getList
                            <div id="source---observer-in-final-style-monad---write2field-main-rows-from-enter-key-press" style="display: inline;">updateList <span style="color: #666666">$</span> replaceNth rows cellIndex (<span style="color: #902000">Row</span> value)</div>
                            loop
                      <span style="color: #4070a0">&quot;</span><span style="color: #4070a0; font-weight: bold">\DEL</span><span style="color: #4070a0">&quot;</span> <span style="color: #007020; font-weight: bold">-&gt;</span> showEditField (<span style="color: #007020; font-weight: bold">if</span> (length value) <span style="color: #666666">==</span> <span style="color: #40a070">0</span> <span style="color: #007020; font-weight: bold">then</span> value <span style="color: #007020; font-weight: bold">else</span> init value)
                      c <span style="color: #007020; font-weight: bold">-&gt;</span> showEditField (value <span style="color: #666666">++</span> c)
              <span style="color: #007020; font-weight: bold">case</span> eitherValue <span style="color: #007020; font-weight: bold">of</span>
                <span style="color: #902000">Left</span> e <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span>
                  <div id="source---observer-in-final-style-monad---write2field-debug-messages-from-enter-key-press" style="display: inline;">log <span style="color: #666666">$</span> <span style="color: #4070a0">&quot;error: &quot;</span> <span style="color: #666666">++</span> (show e)</div>
                  loop
                <span style="color: #902000">Right</span> v <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span>
                  showEditField v
<div id="source---observer-in-final-style-monad---case-key-otherwise" style="display: inline-block;"
>          <span style="color: #4070a0">&quot;q&quot;</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <div class="source---observer-in-final-style-monad---exit" style="display: inline;">return <span style="color: #007020">()</span></div>
          <span style="color: #007020; font-weight: bold">_</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <div class="source---observer-in-final-style-monad---exit" style="display: inline;">return <span style="color: #007020">()</span></div>
</div>

<span style="color: #06287e">getKey</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">IO</span> [<span style="color: #902000">Char</span>]
<span style="color: #06287e">getKey</span> <span style="color: #007020; font-weight: bold">=</span> reverse <span style="color: #666666">&lt;$&gt;</span> getKey&#39; <span style="color: #4070a0">&quot;&quot;</span>
  <span style="color: #007020; font-weight: bold">where</span>
  getKey&#39; chars <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
    char <span style="color: #007020; font-weight: bold">&lt;-</span> getChar
    more <span style="color: #007020; font-weight: bold">&lt;-</span> hReady stdin
    (<span style="color: #007020; font-weight: bold">if</span> more <span style="color: #007020; font-weight: bold">then</span> getKey&#39; <span style="color: #007020; font-weight: bold">else</span> return) (char<span style="color: #902000">:</span>chars)
  </pre></div> <!-- end of source observer-in-final-style-monad main -->




























<!-- HTML generated using hilite.me --><div id="source---observer-in-initial-style-monad---main" style="display: none; background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #60a0b0; font-style: italic">{-# LANGUAGE  GeneralizedNewtypeDeriving #-}</span>
<span style="color: #60a0b0; font-style: italic">{-# LANGUAGE  ExistentialQuantification #-}</span>
<span style="color: #007020; font-weight: bold">module</span> <span style="color: #0e84b5; font-weight: bold">Main</span> <span style="color: #007020; font-weight: bold">where</span>

<span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">Control.Monad</span> (<span style="color: #06287e">when</span>, <span style="color: #06287e">forM_</span>)
<span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">Control.Exception</span> (<span style="color: #06287e">try</span>)
<span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">System.IO</span> (<span style="color: #06287e">stdin</span>, <span style="color: #06287e">stdout</span>, <span style="color: #06287e">hSetEcho</span>, <span style="color: #06287e">hSetBuffering</span>, <span style="color: #06287e">hReady</span>, <span style="color: #902000">BufferMode</span> (<span style="color: #902000">NoBuffering</span>) )
<span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">Control.Monad.State.Strict</span> (<span style="color: #902000">StateT</span>, <span style="color: #06287e">get</span>, <span style="color: #06287e">modify</span>, <span style="color: #06287e">runStateT</span>)
<span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">Control.Monad.IO.Class</span> (<span style="color: #902000">MonadIO</span>, <span style="color: #06287e">liftIO</span>)
<span style="color: #007020; font-weight: bold">import</span> <span style="color: #007020; font-weight: bold">qualified</span> <span style="color: #0e84b5; font-weight: bold">Data.Map</span> <span style="color: #007020; font-weight: bold">as</span> Map
<span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">ViewUtils</span> (<span style="color: #06287e">clearScreen</span>, <span style="color: #06287e">showInRectangle</span>, <span style="color: #06287e">clearRectangle</span>, <span style="color: #06287e">showInGrid</span>, <span style="color: #06287e">drawGrid</span>, <span style="color: #06287e">highlightCell</span>, <span style="color: #06287e">printFromBottom</span>)
<span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">Prelude</span> <span style="color: #007020; font-weight: bold">hiding</span> (<span style="color: #06287e">log</span>)

<span style="color: #007020; font-weight: bold">data</span> <span style="color: #902000">RowData</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">Row</span> { smth <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">String</span> } <span style="color: #007020; font-weight: bold">deriving</span> <span style="color: #902000">Eq</span>

<span style="color: #06287e">initialRows</span> <span style="color: #007020; font-weight: bold">=</span> [
  <span style="color: #902000">Row</span> <span style="color: #4070a0">&quot;something a&quot;</span>
  , <span style="color: #902000">Row</span> <span style="color: #4070a0">&quot;something b&quot;</span>
  , <span style="color: #902000">Row</span> <span style="color: #4070a0">&quot;something c&quot;</span>
  , <span style="color: #902000">Row</span> <span style="color: #4070a0">&quot;something d&quot;</span>
  , <span style="color: #902000">Row</span> <span style="color: #4070a0">&quot;something e&quot;</span>
  ]

<div id="source---initial-style---state-adt" style="display: inline-block;"><span style="color: #007020; font-weight: bold">data</span> <span style="color: #902000">AppStateData</span> m <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">AppState</span>
  { <div id="source---initial-style---main-rows-field" style="display: inline;">rows <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">RowData</span>]</div>
  , <div id="source---initial-style---active-cell-y-field" style="display: inline;">activeCellY <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span></div>
  , <div id="source---initial-style---debug-messages-field" style="display: inline;">debugMessages <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">String</span>]</div>
  , listeners <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">AppStateListenersData</span> m
  }

<span style="color: #007020; font-weight: bold">data</span> <span style="color: #902000">AppStateListenersData</span> m <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">AppStateListeners</span>
  { rowsListeners <span style="color: #007020; font-weight: bold">::</span> [[<span style="color: #902000">RowData</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>]
  , activeCellYListeners <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span> <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>]
  , debugMessagesListeners <span style="color: #007020; font-weight: bold">::</span> [[<span style="color: #902000">String</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>]
  }
</div>

<div class="source---initial-style---functions-that-add-listeners" style="display: inline;"><span style="color: #06287e">addRowsListener</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Monad</span> m <span style="color: #007020; font-weight: bold">=&gt;</span> ([<span style="color: #902000">RowData</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>) <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span> m <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span> m</div>
<span style="color: #06287e">addRowsListener</span> listener (<span style="color: #902000">AppStateListeners</span> rowsListeners _activeCellYListeners _debugMessagesListeners) <span style="color: #007020; font-weight: bold">=</span>
  <span style="color: #902000">AppStateListeners</span> (listener<span style="color: #902000">:</span>rowsListeners) _activeCellYListeners _debugMessagesListeners

<div class="source---initial-style---functions-that-add-listeners" style="display: inline;"><span style="color: #06287e">addActiveCellYListener</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Monad</span> m <span style="color: #007020; font-weight: bold">=&gt;</span> (<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span> <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>) <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span> m <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span> m</div>
<span style="color: #06287e">addActiveCellYListener</span> listener (<span style="color: #902000">AppStateListeners</span> _rowsListeners activeCellYListeners _debugMessagesListeners) <span style="color: #007020; font-weight: bold">=</span>
  <span style="color: #902000">AppStateListeners</span> _rowsListeners (listener<span style="color: #902000">:</span>activeCellYListeners) _debugMessagesListeners

<div class="source---initial-style---functions-that-add-listeners" style="display: inline;"><span style="color: #06287e">addDebugMessagesListener</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Monad</span> m <span style="color: #007020; font-weight: bold">=&gt;</span> ([<span style="color: #902000">String</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>) <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span> m <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span> m</div>
<span style="color: #06287e">addDebugMessagesListener</span> listener (<span style="color: #902000">AppStateListeners</span> _rowsListeners _activeCellYListeners debugMessagesListeners) <span style="color: #007020; font-weight: bold">=</span>
  <span style="color: #902000">AppStateListeners</span> _rowsListeners _activeCellYListeners (listener<span style="color: #902000">:</span>debugMessagesListeners)

<div id="source---initial-style---declaring-monad-operations-as-adt" style="display: inline-block;"><span style="color: #007020; font-weight: bold">data</span> <span style="color: #902000">EditableListOps</span> a <span style="color: #007020; font-weight: bold">=</span><div id="source---initial-style---getters-in-decriptive-adt" style="display: inline;"> <span style="color: #902000">GetList</span>                          ([<span style="color: #902000">RowData</span>]   <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">EditableListOps</span> a)
                       <span style="color: #666666">|</span> <span style="color: #902000">GetActiveCellY</span>                   ((<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span>) <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">EditableListOps</span> a)
                       <span style="color: #666666">|</span> <span style="color: #902000">GetLogs</span>                          ([<span style="color: #902000">String</span>]    <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">EditableListOps</span> a)</div>
<div id="source---initial-style---setters-in-decriptive-adt" style="display: inline-block;">                       <span style="color: #666666">|</span> <span style="color: #902000">UpdateList</span>           [<span style="color: #902000">RowData</span>]   (<span style="color: #902000">EditableListOps</span> a)
                       <span style="color: #666666">|</span> <span style="color: #902000">UpdateActiveCellY</span>    (<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span>) (<span style="color: #902000">EditableListOps</span> a)
                       <span style="color: #666666">|</span> <span style="color: #902000">Log</span>                  <span style="color: #902000">String</span>      (<span style="color: #902000">EditableListOps</span> a)</div>
                       <span style="color: #666666">|</span> forall b<span style="color: #666666">.</span> <span style="color: #902000">LiftIO</span>     (<span style="color: #902000">IO</span> b)      (b <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">EditableListOps</span> a)
                       <span style="color: #666666">|</span> <span style="color: #902000">Done</span>                 a
</div>

<div id="source---initial-style---making-descriptive-adt-a-monad" style="display: inline-block;"><span style="color: #007020; font-weight: bold">instance</span> <span style="color: #902000">Functor</span> <span style="color: #902000">EditableListOps</span> <span style="color: #007020; font-weight: bold">where</span>
  fmap f (<span style="color: #902000">GetList</span> k)              <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">GetList</span>        <span style="color: #666666">$</span> <span style="color: #06287e">\</span>lst      <span style="color: #007020; font-weight: bold">-&gt;</span> fmap f (k lst)
  fmap f (<span style="color: #902000">GetActiveCellY</span> k)       <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">GetActiveCellY</span> <span style="color: #666666">$</span> <span style="color: #06287e">\</span>maybeInt <span style="color: #007020; font-weight: bold">-&gt;</span> fmap f (k maybeInt)
  fmap f (<span style="color: #902000">GetLogs</span> k)              <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">GetLogs</span>        <span style="color: #666666">$</span> <span style="color: #06287e">\</span>logs     <span style="color: #007020; font-weight: bold">-&gt;</span> fmap f (k logs)
  fmap f (<span style="color: #902000">UpdateList</span> lst op)      <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">UpdateList</span>        lst (fmap f op)
  fmap f (<span style="color: #902000">UpdateActiveCellY</span> y op) <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">UpdateActiveCellY</span> y   (fmap f op)
  fmap f (<span style="color: #902000">Log</span> msg op)             <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">Log</span>               msg (fmap f op)
  fmap f (<span style="color: #902000">LiftIO</span> a op)            <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">LiftIO</span>            a   (<span style="color: #06287e">\</span>k <span style="color: #007020; font-weight: bold">-&gt;</span> fmap f (op k))
  fmap f (<span style="color: #902000">Done</span> a)                 <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">Done</span> (f a)

<span style="color: #007020; font-weight: bold">instance</span> <span style="color: #902000">Applicative</span> <span style="color: #902000">EditableListOps</span> <span style="color: #007020; font-weight: bold">where</span>
  pure <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">Done</span>

  (<span style="color: #902000">GetList</span> h)             <span style="color: #666666">&lt;*&gt;</span> g <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">GetList</span>        <span style="color: #666666">$</span> <span style="color: #06287e">\</span>lst  <span style="color: #007020; font-weight: bold">-&gt;</span> (h  lst) <span style="color: #666666">&lt;*&gt;</span> g
  (<span style="color: #902000">GetActiveCellY</span> h)      <span style="color: #666666">&lt;*&gt;</span> g <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">GetActiveCellY</span> <span style="color: #666666">$</span> <span style="color: #06287e">\</span>y    <span style="color: #007020; font-weight: bold">-&gt;</span> (h    y) <span style="color: #666666">&lt;*&gt;</span> g
  (<span style="color: #902000">GetLogs</span> h)             <span style="color: #666666">&lt;*&gt;</span> g <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">GetLogs</span>        <span style="color: #666666">$</span> <span style="color: #06287e">\</span>logs <span style="color: #007020; font-weight: bold">-&gt;</span> (h logs) <span style="color: #666666">&lt;*&gt;</span> g
  (<span style="color: #902000">UpdateList</span> lst h)      <span style="color: #666666">&lt;*&gt;</span> g <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">UpdateList</span>        lst (h <span style="color: #666666">&lt;*&gt;</span> g)
  (<span style="color: #902000">UpdateActiveCellY</span> y h) <span style="color: #666666">&lt;*&gt;</span> g <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">UpdateActiveCellY</span>   y (h <span style="color: #666666">&lt;*&gt;</span> g)
  (<span style="color: #902000">Log</span> msg h)             <span style="color: #666666">&lt;*&gt;</span> g <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">Log</span>               msg (h <span style="color: #666666">&lt;*&gt;</span> g)
  (<span style="color: #902000">LiftIO</span> a h)            <span style="color: #666666">&lt;*&gt;</span> g <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">LiftIO</span>              a (<span style="color: #06287e">\</span>k <span style="color: #007020; font-weight: bold">-&gt;</span> (h k) <span style="color: #666666">&lt;*&gt;</span> g)
  (<span style="color: #902000">Done</span> a)                <span style="color: #666666">&lt;*&gt;</span> g <span style="color: #007020; font-weight: bold">=</span> fmap a g

<span style="color: #007020; font-weight: bold">instance</span> <span style="color: #902000">Monad</span> <span style="color: #902000">EditableListOps</span> <span style="color: #007020; font-weight: bold">where</span>
  return <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">Done</span>
  (<span style="color: #902000">GetList</span> h)             <span style="color: #666666">&gt;&gt;=</span> f <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">GetList</span>        <span style="color: #666666">$</span> <span style="color: #06287e">\</span>lst  <span style="color: #007020; font-weight: bold">-&gt;</span> (h  lst) <span style="color: #666666">&gt;&gt;=</span> f
  (<span style="color: #902000">GetActiveCellY</span> h)      <span style="color: #666666">&gt;&gt;=</span> f <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">GetActiveCellY</span> <span style="color: #666666">$</span> <span style="color: #06287e">\</span>y    <span style="color: #007020; font-weight: bold">-&gt;</span> (h    y) <span style="color: #666666">&gt;&gt;=</span> f
  (<span style="color: #902000">GetLogs</span> h)             <span style="color: #666666">&gt;&gt;=</span> f <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">GetLogs</span>        <span style="color: #666666">$</span> <span style="color: #06287e">\</span>logs <span style="color: #007020; font-weight: bold">-&gt;</span> (h logs) <span style="color: #666666">&gt;&gt;=</span> f
  (<span style="color: #902000">UpdateList</span> lst h)      <span style="color: #666666">&gt;&gt;=</span> f <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">UpdateList</span>        lst (h <span style="color: #666666">&gt;&gt;=</span> f)
  (<span style="color: #902000">UpdateActiveCellY</span> y h) <span style="color: #666666">&gt;&gt;=</span> f <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">UpdateActiveCellY</span>   y (h <span style="color: #666666">&gt;&gt;=</span> f)
  (<span style="color: #902000">Log</span> msg h)             <span style="color: #666666">&gt;&gt;=</span> f <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">Log</span>               msg (h <span style="color: #666666">&gt;&gt;=</span> f)
  (<span style="color: #902000">LiftIO</span> a h)            <span style="color: #666666">&gt;&gt;=</span> f <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">LiftIO</span>              a (<span style="color: #06287e">\</span>k <span style="color: #007020; font-weight: bold">-&gt;</span> (h k) <span style="color: #666666">&gt;&gt;=</span> f)
  (<span style="color: #902000">Done</span> x)                <span style="color: #666666">&gt;&gt;=</span> f <span style="color: #007020; font-weight: bold">=</span> f x
</div>

<div id="source---initial-style---smart-constructors" style="display: inline-block;"><span style="color: #06287e">getList</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">EditableListOps</span> [<span style="color: #902000">RowData</span>]
<span style="color: #06287e">getList</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">GetList</span> return

<span style="color: #06287e">getActiveCellY</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">EditableListOps</span> (<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span>)
<span style="color: #06287e">getActiveCellY</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">GetActiveCellY</span> return

<span style="color: #06287e">getLogs</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">EditableListOps</span> [<span style="color: #902000">String</span>]
<span style="color: #06287e">getLogs</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">GetLogs</span> return

<span style="color: #06287e">updateList</span> <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">RowData</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">EditableListOps</span> <span style="color: #007020">()</span>
<span style="color: #06287e">updateList</span> l <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">UpdateList</span> l <span style="color: #666666">$</span> return <span style="color: #007020">()</span>

<span style="color: #06287e">updateActiveCellY</span> <span style="color: #007020; font-weight: bold">::</span> (<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span>) <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">EditableListOps</span> <span style="color: #007020">()</span>
<span style="color: #06287e">updateActiveCellY</span> y <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">UpdateActiveCellY</span> y <span style="color: #666666">$</span> return <span style="color: #007020">()</span>

<span style="color: #06287e">log</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">String</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">EditableListOps</span> <span style="color: #007020">()</span>
<span style="color: #06287e">log</span> msg <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">Log</span> msg <span style="color: #666666">$</span> return <span style="color: #007020">()</span>
</div>

<div id="source---initial-style---making-descriptive-adt-monadio" style="display: inline-block;"><span style="color: #007020; font-weight: bold">instance</span> <span style="color: #902000">MonadIO</span> <span style="color: #902000">EditableListOps</span> <span style="color: #007020; font-weight: bold">where</span>
  <span style="color: #60a0b0; font-style: italic">-- liftIO a = LiftIO a $ \k -&gt; return k</span>
  liftIO a <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">LiftIO</span> a return
</div>

<div id="source---initial-style---declaring-a-target-monad" style="display: inline-block;"><span style="color: #007020; font-weight: bold">newtype</span> <span style="color: #902000">StateHolder</span> a <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">StateHolder</span> (<span style="color: #902000">StateT</span> (<span style="color: #902000">AppStateData</span> <span style="color: #902000">StateHolder</span>) <span style="color: #902000">IO</span> a)
  <span style="color: #007020; font-weight: bold">deriving</span> (<span style="color: #902000">Functor</span>, <span style="color: #902000">Applicative</span>, <span style="color: #902000">Monad</span>, <span style="color: #902000">MonadIO</span>)
</div>

<div id="source---initial-style---interpreter-function" style="display: inline-block;"><span style="color: #06287e">interpret</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">EditableListOps</span> a <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">StateHolder</span> a
<span style="color: #06287e">interpret</span> (<span style="color: #902000">Done</span> x) <span style="color: #007020; font-weight: bold">=</span> return x
<span style="color: #06287e">interpret</span> (<span style="color: #902000">GetList</span> k) <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span> lst <span style="color: #007020; font-weight: bold">&lt;-</span> rows <span style="color: #666666">&lt;$&gt;</span> (<span style="color: #902000">StateHolder</span> get)
                           interpret (k lst)
<span style="color: #06287e">interpret</span> (<span style="color: #902000">GetActiveCellY</span> k) <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span> y <span style="color: #007020; font-weight: bold">&lt;-</span> activeCellY <span style="color: #666666">&lt;$&gt;</span> (<span style="color: #902000">StateHolder</span> get)
                                  interpret (k y)
<span style="color: #06287e">interpret</span> (<span style="color: #902000">GetLogs</span> k) <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span> logs <span style="color: #007020; font-weight: bold">&lt;-</span> debugMessages <span style="color: #666666">&lt;$&gt;</span> (<span style="color: #902000">StateHolder</span> get)
                           interpret (k logs)
<span style="color: #06287e">interpret</span> (<span style="color: #902000">UpdateList</span> l k) <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span> <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> modify <span style="color: #666666">$</span> <span style="color: #06287e">\</span>s <span style="color: #007020; font-weight: bold">-&gt;</span> s { rows <span style="color: #007020; font-weight: bold">=</span> l }
                                reacts <span style="color: #007020; font-weight: bold">&lt;-</span> (rowsListeners <span style="color: #666666">.</span> listeners) <span style="color: #666666">&lt;$&gt;</span> (<span style="color: #902000">StateHolder</span> get)
                                <div id="source---initial-style---main-rows-listener-trigger" style="display: inline;">forM_ reacts (<span style="color: #666666">$</span> l) <span style="color: #60a0b0; font-style: italic">-- same as forM_ reacts $ \react -&gt; react l</span></div>
                                interpret k
<span style="color: #06287e">interpret</span> (<span style="color: #902000">UpdateActiveCellY</span> y k) <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span> <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> modify <span style="color: #666666">$</span> <span style="color: #06287e">\</span>s <span style="color: #007020; font-weight: bold">-&gt;</span> s { activeCellY <span style="color: #007020; font-weight: bold">=</span> y }
                                       reacts <span style="color: #007020; font-weight: bold">&lt;-</span> (activeCellYListeners <span style="color: #666666">.</span> listeners) <span style="color: #666666">&lt;$&gt;</span> (<span style="color: #902000">StateHolder</span> get)
                                       <div id="source---initial-style---active-cell-y-listener-trigger" style="display: inline;">forM_ reacts (<span style="color: #666666">$</span> y) <span style="color: #60a0b0; font-style: italic">-- same as forM_ reacts $ \react -&gt; react y</span></div>
                                       interpret k
<span style="color: #06287e">interpret</span> (<span style="color: #902000">Log</span> msg k) <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span> <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> modify <span style="color: #666666">$</span> <span style="color: #06287e">\</span>s <span style="color: #007020; font-weight: bold">-&gt;</span> s { debugMessages <span style="color: #007020; font-weight: bold">=</span> take debugLinesCount (msg<span style="color: #902000">:</span>(debugMessages s)) }
                           logs <span style="color: #007020; font-weight: bold">&lt;-</span> debugMessages <span style="color: #666666">&lt;$&gt;</span> (<span style="color: #902000">StateHolder</span> get)
                           reacts <span style="color: #007020; font-weight: bold">&lt;-</span> (debugMessagesListeners <span style="color: #666666">.</span> listeners) <span style="color: #666666">&lt;$&gt;</span> (<span style="color: #902000">StateHolder</span> get)
                           <div id="source---initial-style---debug-messages-listener-trigger" style="display: inline;">forM_ reacts (<span style="color: #666666">$</span> logs) <span style="color: #60a0b0; font-style: italic">-- same as forM_ reacts $ \react -&gt; react logs</span></div>
                           interpret k
<span style="color: #06287e">interpret</span> (<span style="color: #902000">LiftIO</span> a k) <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span> v <span style="color: #007020; font-weight: bold">&lt;-</span> liftIO a
                            interpret (k v)
</div>

<div id="source---initial-style---perform-state-action" style="display: inline-block;"><span style="color: #06287e">performStateAction</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">AppStateData</span> <span style="color: #902000">StateHolder</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <div id="source---initial-style---StateHolder-context" style="display: inline;"><span style="color: #902000">StateHolder</span> a</div> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">IO</span> <span style="color: #007020">()</span>
<span style="color: #06287e">performStateAction</span> state (<span style="color: #902000">StateHolder</span> action) <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
  runStateT action state
  return <span style="color: #007020">()</span>
</div>

<span style="color: #06287e">debugLinesCount</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #40a070">20</span>

<div id="source---initial-style---fragment-of-main" style="display: inline-block;"><span style="color: #06287e">main</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">IO</span> <span style="color: #007020">()</span>
<span style="color: #06287e">main</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
  hSetBuffering stdin <span style="color: #902000">NoBuffering</span>
  hSetBuffering stdout <span style="color: #902000">NoBuffering</span>
  hSetEcho stdin <span style="color: #902000">False</span>
  clearScreen
  <span style="color: #60a0b0; font-style: italic">--performStateAction initialState (interpret (do ...))</span>
  performStateAction initialState <span style="color: #666666">$</span> <div id="source---initial-style---loop-interpret" style="display: inline;">interpret</div> <span style="color: #666666">$</span> <span style="color: #007020; font-weight: bold">do</span>
    initRows
    <div class="source---initial-style---loop-invokation-and-definition" style="display: inline;">loop</div>
  <span style="color: #007020; font-weight: bold">where</span>
</div>
    xUpperLeft <span style="color: #007020; font-weight: bold">=</span> <span style="color: #40a070">0</span>
    yUpperLeft <span style="color: #007020; font-weight: bold">=</span> <span style="color: #40a070">0</span>
    columnCount <span style="color: #007020; font-weight: bold">=</span> <span style="color: #40a070">1</span>
    columnWidth <span style="color: #007020; font-weight: bold">=</span> <span style="color: #40a070">14</span>
    rowCount <span style="color: #007020; font-weight: bold">=</span> length initialRows

<div id="source---initial-style---initial-state" style="display: inline-block;"
>    initialState <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">AppStateData</span> <span style="color: #902000">StateHolder</span>
    initialState <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">AppState</span> <span style="color: #902000">[]</span> <span style="color: #902000">Nothing</span> <span style="color: #902000">[]</span> initListeners
</div>

<div id="source---initial-style---initRows" style="display: inline-block;"
>    initRows <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">EditableListOps</span> <span style="color: #007020">()</span>
    initRows <span style="color: #007020; font-weight: bold">=</span> updateList initialRows
</div>

<div id="source---initial-style---initListeners" style="display: inline-block;"
>    initListeners <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">AppStateListenersData</span> <span style="color: #902000">StateHolder</span>
    <span style="color: #60a0b0; font-style: italic">-- initListeners =</span>
    <span style="color: #60a0b0; font-style: italic">--     addRowsListener (interpret . mainRowsListener)</span>
    <span style="color: #60a0b0; font-style: italic">--     (addActiveCellYListener (interpret . activeCellYListener)</span>
    <span style="color: #60a0b0; font-style: italic">--     (addDebugMessagesListener (interpret . debugMessagesListener)</span>
    <span style="color: #60a0b0; font-style: italic">--     (empty)))</span>
    initListeners <span style="color: #007020; font-weight: bold">=</span>
        addRowsListener (<div id="source---initial-style---main-rows-listener-interpret" style="display: inline;">interpret</div> <span style="color: #666666">.</span> mainRowsListener)
        <span style="color: #666666">$</span> addActiveCellYListener (<div id="source---initial-style---active-cell-y-listener-interpret" style="display: inline;">interpret</div> <span style="color: #666666">.</span> activeCellYListener)
        <span style="color: #666666">$</span> addDebugMessagesListener (<div id="source---initial-style---debug-messages-listener-interpret" style="display: inline;">interpret</div> <span style="color: #666666">.</span> debugMessagesListener)
        <span style="color: #666666">$</span> empty
      <span style="color: #007020; font-weight: bold">where</span>
        empty <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">AppStateListeners</span> <span style="color: #902000">[]</span> <span style="color: #902000">[]</span> <span style="color: #902000">[]</span>

<div id="source---initial-style---main-rows-listener" style="display: inline-block;"
>    mainRowsListener <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">RowData</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> <div id="source---initial-style---main-rows-listener-EditableListOps-context" style="display: inline;"><span style="color: #902000">EditableListOps</span> <span style="color: #007020">()</span></div>
    mainRowsListener rows <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
      activeCellCoords <span style="color: #007020; font-weight: bold">&lt;-</span> fmap (<span style="color: #06287e">\</span>y <span style="color: #007020; font-weight: bold">-&gt;</span> (<span style="color: #40a070">0</span>, y)) <span style="color: #666666">&lt;$&gt;</span> getActiveCellY
<div id="source---initial-style---main-rows-listener-draw" style="display: inline-block;"
>      liftIO <span style="color: #666666">$</span> showInGrid
                 xUpperLeft
                 yUpperLeft
                 columnCount
                 columnWidth
                 activeCellCoords
                 (map (<span style="color: #06287e">\</span>row <span style="color: #007020; font-weight: bold">-&gt;</span> [smth row]) rows)
</div>
      <div id="source---initial-style---main-rows-listener-log" style="display: inline;">log <span style="color: #4070a0">&quot;updated rows&quot;</span></div>
</div>

<div id="source---initial-style---active-cell-y-listener" style="display: inline-block;"
>    activeCellYListener <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <div id="source---initial-style---active-cell-y-listener-EditableListOps-context" style="display: inline;"><span style="color: #902000">EditableListOps</span> <span style="color: #007020">()</span></div>
    activeCellYListener activeCellY <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
      <span style="color: #007020; font-weight: bold">let</span> activeCellCoords <span style="color: #007020; font-weight: bold">=</span> fmap (<span style="color: #06287e">\</span>y <span style="color: #007020; font-weight: bold">-&gt;</span> (<span style="color: #40a070">0</span>, y)) activeCellY
      <div class="source---initial-style---active-cell-y-listener-draw" style="display: inline;">liftIO <span style="color: #666666">$</span> drawGrid xUpperLeft yUpperLeft columnWidth columnCount rowCount</div>
      <span style="color: #007020; font-weight: bold">case</span> activeCellCoords <span style="color: #007020; font-weight: bold">of</span>
        <span style="color: #902000">Nothing</span> <span style="color: #007020; font-weight: bold">-&gt;</span> return <span style="color: #007020">()</span>
        <span style="color: #902000">Just</span> coordsPair <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span>
          <div class="source---initial-style---active-cell-y-listener-draw" style="display: inline;">liftIO <span style="color: #666666">$</span> highlightCell xUpperLeft yUpperLeft columnWidth columnCount rowCount coordsPair</div>
          <div id="source---initial-style---active-cell-y-listener-log" style="display: inline;">log <span style="color: #4070a0">&quot;highlighted cell&quot;</span></div>
</div>

<div id="source---initial-style---debug-messages-listener" style="display: inline-block;"
>    debugMessagesListener <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">String</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> <div id="source---initial-style---debug-messages-listener-EditableListOps-context" style="display: inline;"><span style="color: #902000">EditableListOps</span> <span style="color: #007020">()</span></div>
    debugMessagesListener debugMessages <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
<div id="source---initial-style---debug-messages-listener-draw" style="display: inline-block;"
>      liftIO <span style="color: #666666">$</span> printFromBottom
                 xUpperLeft
                 (yUpperLeft<span style="color: #666666">+</span><span style="color: #40a070">12</span><span style="color: #666666">+</span>debugLinesCount)
                 debugMessages
</div>
</div>
</div>

<div id="source---initial-style---loop" style="display: inline-block;"
><div id="source---initial-style---loop-2-lines" class="source---initial-style---loop-invokation-and-definition" style="display: inline-block;"
>    loop <span style="color: #007020; font-weight: bold">::</span> <div id="source---initial-style---loop-EditableListOps-context" style="display: inline;"><span style="color: #902000">EditableListOps</span> <span style="color: #007020">()</span></div>
    loop <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
</div>
      key <span style="color: #007020; font-weight: bold">&lt;-</span> liftIO <span style="color: #666666">$</span> <div id="source---initial-style---getKey" style="display: inline;">getKey</div>
      when (key <span style="color: #666666">/=</span> <span style="color: #4070a0">&quot;</span><span style="color: #4070a0; font-weight: bold">\ESC</span><span style="color: #4070a0">&quot;</span>) <span style="color: #666666">$</span> <span style="color: #007020; font-weight: bold">do</span>
        <div id="source---initial-style---case-key-of" style="display: inline;"><span style="color: #007020; font-weight: bold">case</span> key <span style="color: #007020; font-weight: bold">of</span></div>
          <div id="source---initial-style---up" style="display: inline;"><span style="color: #4070a0">&quot;</span><span style="color: #4070a0; font-weight: bold">\ESC</span><span style="color: #4070a0">[A&quot;</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span> <span style="color: #60a0b0; font-style: italic">-- up</span></div>
              activeCellY <span style="color: #007020; font-weight: bold">&lt;-</span> getActiveCellY
              <span style="color: #007020; font-weight: bold">let</span>
                newActiveCellY <span style="color: #007020; font-weight: bold">=</span>
                  <span style="color: #007020; font-weight: bold">case</span> activeCellY <span style="color: #007020; font-weight: bold">of</span>
                    <span style="color: #902000">Just</span> y <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Just</span> <span style="color: #666666">$</span> max <span style="color: #40a070">0</span> (y<span style="color: #666666">-</span><span style="color: #40a070">1</span>)
                    <span style="color: #902000">Nothing</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Just</span> <span style="color: #40a070">0</span>
              <div id="source---initial-style---from-up-to-active-cell-y" style="display: inline;">updateActiveCellY newActiveCellY</div>
              <div id="source---initial-style---from-up-to-debug-messages" style="display: inline;">log <span style="color: #666666">$</span> <span style="color: #4070a0">&quot;&uarr; &quot;</span> <span style="color: #666666">++</span> show(newActiveCellY)</div>
              loop
</div>
          <div id="source---initial-style---down" style="display: inline;"><span style="color: #4070a0">&quot;</span><span style="color: #4070a0; font-weight: bold">\ESC</span><span style="color: #4070a0">[B&quot;</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span> <span style="color: #60a0b0; font-style: italic">-- down</span></div>
              activeCellY <span style="color: #007020; font-weight: bold">&lt;-</span> getActiveCellY
              <span style="color: #007020; font-weight: bold">let</span>
                newActiveCellY <span style="color: #007020; font-weight: bold">=</span>
                  <span style="color: #007020; font-weight: bold">case</span> activeCellY <span style="color: #007020; font-weight: bold">of</span>
                    <span style="color: #902000">Just</span> y <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Just</span> <span style="color: #666666">$</span> min (rowCount<span style="color: #666666">-</span><span style="color: #40a070">1</span>) (y<span style="color: #666666">+</span><span style="color: #40a070">1</span>)
                    <span style="color: #902000">Nothing</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Just</span> <span style="color: #40a070">0</span>
              <div id="source---initial-style---from-down-to-active-cell-y" style="display: inline;">updateActiveCellY newActiveCellY</div>
              <div id="source---initial-style---from-down-to-debug-messages" style="display: inline;">log <span style="color: #666666">$</span> <span style="color: #4070a0">&quot;&darr; &quot;</span> <span style="color: #666666">++</span> show(newActiveCellY)</div>
              loop
          <div id="source---initial-style---enter" style="display: inline;"><span style="color: #4070a0">&quot;</span><span style="color: #4070a0; font-weight: bold">\n</span><span style="color: #4070a0">&quot;</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span> <span style="color: #60a0b0; font-style: italic">-- enter</span></div>
              activeCellY <span style="color: #007020; font-weight: bold">&lt;-</span> getActiveCellY
              rows <span style="color: #007020; font-weight: bold">&lt;-</span> getList
                
              <span style="color: #007020; font-weight: bold">let</span>
                  eitherValue <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Either</span> <span style="color: #902000">String</span> <span style="color: #902000">String</span>
                  eitherValue <span style="color: #007020; font-weight: bold">=</span>
                    <span style="color: #007020; font-weight: bold">case</span> activeCellY <span style="color: #007020; font-weight: bold">of</span>
                      <span style="color: #902000">Nothing</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Left</span> <span style="color: #4070a0">&quot;there&#39;s no selected cell&quot;</span>
                      <span style="color: #902000">Just</span> cellIndex <span style="color: #007020; font-weight: bold">-&gt;</span>
                        <span style="color: #007020; font-weight: bold">if</span> cellIndex <span style="color: #666666">&lt;</span> <span style="color: #40a070">0</span> <span style="color: #666666">||</span> cellIndex <span style="color: #666666">&gt;=</span> (length rows)
                          <span style="color: #007020; font-weight: bold">then</span> <span style="color: #902000">Left</span> <span style="color: #666666">$</span> <span style="color: #4070a0">&quot;index out of bounds: &quot;</span> <span style="color: #666666">++</span> (show cellIndex)
                          <span style="color: #007020; font-weight: bold">else</span> <span style="color: #902000">Right</span> <span style="color: #666666">$</span> smth <span style="color: #666666">$</span> rows <span style="color: #666666">!!</span> cellIndex

                  showEditField <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">String</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">EditableListOps</span> <span style="color: #007020">()</span>
                  showEditField value <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
                    <span style="color: #007020; font-weight: bold">let</span>
                      txt <span style="color: #007020; font-weight: bold">=</span> <span style="color: #4070a0">&quot;edit cell value:&quot;</span>
                      lentxt <span style="color: #007020; font-weight: bold">=</span> length txt
                      yPos <span style="color: #007020; font-weight: bold">=</span> <span style="color: #40a070">0</span>
                      xPos <span style="color: #007020; font-weight: bold">=</span> (columnCount <span style="color: #666666">*</span> (columnWidth <span style="color: #666666">+</span> <span style="color: #40a070">1</span>)) <span style="color: #666666">+</span> <span style="color: #40a070">3</span>
                      replaceNth lst idx val <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">if</span> idx <span style="color: #666666">&lt;</span> <span style="color: #40a070">1</span> <span style="color: #007020; font-weight: bold">then</span> val<span style="color: #902000">:</span>(tail lst) <span style="color: #007020; font-weight: bold">else</span> (head lst) <span style="color: #902000">:</span> (replaceNth (tail lst) (idx <span style="color: #666666">-</span> <span style="color: #40a070">1</span>) val)
                    liftIO <span style="color: #666666">$</span> showInRectangle xPos yPos lentxt [txt, value]
                    key <span style="color: #007020; font-weight: bold">&lt;-</span> liftIO <span style="color: #666666">$</span> getKey
                    <span style="color: #007020; font-weight: bold">case</span> key <span style="color: #007020; font-weight: bold">of</span>
                      <span style="color: #4070a0">&quot;</span><span style="color: #4070a0; font-weight: bold">\n</span><span style="color: #4070a0">&quot;</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span>
                        <span style="color: #007020; font-weight: bold">case</span> activeCellY <span style="color: #007020; font-weight: bold">of</span>
                          <span style="color: #902000">Nothing</span> <span style="color: #007020; font-weight: bold">-&gt;</span> return <span style="color: #007020">()</span>
                          <span style="color: #902000">Just</span> cellIndex <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span>
                            liftIO <span style="color: #666666">$</span> clearRectangle xPos yPos lentxt <span style="color: #40a070">2</span>
                            rows <span style="color: #007020; font-weight: bold">&lt;-</span> getList
                            <div id="source---initial-style---from-enter-to-main-rows" style="display: inline;">updateList <span style="color: #666666">$</span> replaceNth rows cellIndex (<span style="color: #902000">Row</span> value)</div>
                            loop
                      <span style="color: #4070a0">&quot;</span><span style="color: #4070a0; font-weight: bold">\DEL</span><span style="color: #4070a0">&quot;</span> <span style="color: #007020; font-weight: bold">-&gt;</span> showEditField (<span style="color: #007020; font-weight: bold">if</span> (length value) <span style="color: #666666">==</span> <span style="color: #40a070">0</span> <span style="color: #007020; font-weight: bold">then</span> value <span style="color: #007020; font-weight: bold">else</span> init value)
                      c <span style="color: #007020; font-weight: bold">-&gt;</span> showEditField (value <span style="color: #666666">++</span> c)
              <span style="color: #007020; font-weight: bold">case</span> eitherValue <span style="color: #007020; font-weight: bold">of</span>
                <span style="color: #902000">Left</span> e <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span>
                  <div id="source---initial-style---from-enter-to-debug-messages" style="display: inline;">log <span style="color: #666666">$</span> <span style="color: #4070a0">&quot;error: &quot;</span> <span style="color: #666666">++</span> (show e)</div>
                  loop
                <span style="color: #902000">Right</span> v <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span>
                  showEditField v
<div id="source---initial-style---case-key-otherwise" style="display: inline-block;"
>          <span style="color: #4070a0">&quot;q&quot;</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <div class="source---initial-style---exit" style="display: inline;">return <span style="color: #007020">()</span></div>
          <span style="color: #007020; font-weight: bold">_</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <div class="source---initial-style---exit" style="display: inline;">return <span style="color: #007020">()</span></div>
</div>

<span style="color: #06287e">getKey</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">IO</span> [<span style="color: #902000">Char</span>]
<span style="color: #06287e">getKey</span> <span style="color: #007020; font-weight: bold">=</span> reverse <span style="color: #666666">&lt;$&gt;</span> getKey&#39; <span style="color: #4070a0">&quot;&quot;</span>
  <span style="color: #007020; font-weight: bold">where</span>
  getKey&#39; chars <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
    char <span style="color: #007020; font-weight: bold">&lt;-</span> getChar
    more <span style="color: #007020; font-weight: bold">&lt;-</span> hReady stdin
    (<span style="color: #007020; font-weight: bold">if</span> more <span style="color: #007020; font-weight: bold">then</span> getKey&#39; <span style="color: #007020; font-weight: bold">else</span> return) (char<span style="color: #902000">:</span>chars)
</pre></div> <!-- end of source observer-in-initial-style-monad main -->














<!-- HTML generated using hilite.me --><div id="source---free-monads---main" style="display: none; background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #60a0b0; font-style: italic">{-# LANGUAGE  GeneralizedNewtypeDeriving #-}</span>
<span style="color: #60a0b0; font-style: italic">{-# LANGUAGE  DeriveFunctor #-}</span>
<span style="color: #60a0b0; font-style: italic">{-# LANGUAGE  ExistentialQuantification #-}</span>
<span style="color: #60a0b0; font-style: italic">{-# LANGUAGE  FlexibleInstances #-}</span>
<span style="color: #60a0b0; font-style: italic">{-# LANGUAGE  StandaloneDeriving #-}</span>
<span style="color: #007020; font-weight: bold">module</span> <span style="color: #0e84b5; font-weight: bold">Main</span> <span style="color: #007020; font-weight: bold">where</span>

<span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">Control.Monad</span> (<span style="color: #06287e">when</span>, <span style="color: #06287e">forM_</span>)
<span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">Control.Exception</span> (<span style="color: #06287e">try</span>)
<span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">System.IO</span> (<span style="color: #06287e">stdin</span>, <span style="color: #06287e">stdout</span>, <span style="color: #06287e">hSetEcho</span>, <span style="color: #06287e">hSetBuffering</span>, <span style="color: #06287e">hReady</span>, <span style="color: #902000">BufferMode</span> (<span style="color: #902000">NoBuffering</span>) )
<span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">Control.Monad.State.Strict</span> (<span style="color: #902000">StateT</span>, <span style="color: #06287e">get</span>, <span style="color: #06287e">modify</span>, <span style="color: #06287e">runStateT</span>)
<span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">Control.Monad.IO.Class</span> (<span style="color: #902000">MonadIO</span>, <span style="color: #06287e">liftIO</span>)
<span style="color: #007020; font-weight: bold">import</span> <span style="color: #007020; font-weight: bold">qualified</span> <span style="color: #0e84b5; font-weight: bold">Data.Map</span> <span style="color: #007020; font-weight: bold">as</span> Map
<span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">Prelude</span> <span style="color: #007020; font-weight: bold">hiding</span> (<span style="color: #06287e">log</span>)
<span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">ViewUtils</span> (<span style="color: #06287e">clearScreen</span>, <span style="color: #06287e">showInRectangle</span>, <span style="color: #06287e">clearRectangle</span>, <span style="color: #06287e">showInGrid</span>, <span style="color: #06287e">drawGrid</span>, <span style="color: #06287e">highlightCell</span>, <span style="color: #06287e">printFromBottom</span>)
<span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">Free</span> (<span style="color: #902000">Free</span>(<span style="color: #666666">..</span>), <span style="color: #06287e">liftF</span>, <span style="color: #06287e">foldFree</span>)

<span style="color: #007020; font-weight: bold">data</span> <span style="color: #902000">RowData</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">Row</span> { smth <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">String</span> } <span style="color: #007020; font-weight: bold">deriving</span> <span style="color: #902000">Eq</span>

<span style="color: #06287e">initialRows</span> <span style="color: #007020; font-weight: bold">=</span> [
  <span style="color: #902000">Row</span> <span style="color: #4070a0">&quot;something a&quot;</span>
  , <span style="color: #902000">Row</span> <span style="color: #4070a0">&quot;something b&quot;</span>
  , <span style="color: #902000">Row</span> <span style="color: #4070a0">&quot;something c&quot;</span>
  , <span style="color: #902000">Row</span> <span style="color: #4070a0">&quot;something d&quot;</span>
  , <span style="color: #902000">Row</span> <span style="color: #4070a0">&quot;something e&quot;</span>
  ]

<span style="color: #007020; font-weight: bold">data</span> <span style="color: #902000">AppStateData</span> m <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">AppState</span>
  { <div id="source---free---main-rows-field" style="display: inline;">rows <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">RowData</span>]</div>
  , <div id="source---free---active-cell-y-field" style="display: inline;">activeCellY <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span></div>
  , <div id="source---free---debug-messages-field" style="display: inline;">debugMessages <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">String</span>]</div>
  , listeners <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">AppStateListenersData</span> m
  }

<span style="color: #007020; font-weight: bold">data</span> <span style="color: #902000">AppStateListenersData</span> m <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">AppStateListeners</span>
  { rowsListeners <span style="color: #007020; font-weight: bold">::</span> [[<span style="color: #902000">RowData</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>]
  , activeCellYListeners <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span> <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>]
  , debugMessagesListeners <span style="color: #007020; font-weight: bold">::</span> [[<span style="color: #902000">String</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>]
  }

<span style="color: #06287e">addRowsListener</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Monad</span> m <span style="color: #007020; font-weight: bold">=&gt;</span> ([<span style="color: #902000">RowData</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>) <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span> m <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span> m
<span style="color: #06287e">addRowsListener</span> listener (<span style="color: #902000">AppStateListeners</span> rowsListeners _activeCellYListeners _debugMessagesListeners) <span style="color: #007020; font-weight: bold">=</span>
  <span style="color: #902000">AppStateListeners</span> (listener<span style="color: #902000">:</span>rowsListeners) _activeCellYListeners _debugMessagesListeners

<span style="color: #06287e">addActiveCellYListener</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Monad</span> m <span style="color: #007020; font-weight: bold">=&gt;</span> (<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span> <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>) <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span> m <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span> m
<span style="color: #06287e">addActiveCellYListener</span> listener (<span style="color: #902000">AppStateListeners</span> _rowsListeners activeCellYListeners _debugMessagesListeners) <span style="color: #007020; font-weight: bold">=</span>
  <span style="color: #902000">AppStateListeners</span> _rowsListeners (listener<span style="color: #902000">:</span>activeCellYListeners) _debugMessagesListeners

<span style="color: #06287e">addDebugMessagesListener</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Monad</span> m <span style="color: #007020; font-weight: bold">=&gt;</span> ([<span style="color: #902000">String</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>) <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span> m <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span> m
<span style="color: #06287e">addDebugMessagesListener</span> listener (<span style="color: #902000">AppStateListeners</span> _rowsListeners _activeCellYListeners debugMessagesListeners) <span style="color: #007020; font-weight: bold">=</span>
  <span style="color: #902000">AppStateListeners</span> _rowsListeners _activeCellYListeners (listener<span style="color: #902000">:</span>debugMessagesListeners)



<div id="source---free-monads---declaring-operations-as-adt" style="display: inline-block;"><span style="color: #007020; font-weight: bold">data</span> <span style="color: #902000">EditableListOpsF</span> r <span style="color: #007020; font-weight: bold">=</span> <div id="source---free-monads---getters-in-adt" style="display: inline;"><span style="color: #902000">GetList</span>                          ([<span style="color: #902000">RowData</span>]   <span style="color: #007020; font-weight: bold">-&gt;</span> r)
                        <span style="color: #666666">|</span> <span style="color: #902000">GetActiveCellY</span>                   ((<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span>) <span style="color: #007020; font-weight: bold">-&gt;</span> r)
                        <span style="color: #666666">|</span> <span style="color: #902000">GetLogs</span>                          ([<span style="color: #902000">String</span>]    <span style="color: #007020; font-weight: bold">-&gt;</span> r)</div>
<div id="source---free-monads---setters-in-adt" style="display: inline-block;"
>                        <span style="color: #666666">|</span> <span style="color: #902000">UpdateList</span>           [<span style="color: #902000">RowData</span>]   r
                        <span style="color: #666666">|</span> <span style="color: #902000">UpdateActiveCellY</span>    (<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span>) r
                        <span style="color: #666666">|</span> <span style="color: #902000">Log</span>                  <span style="color: #902000">String</span>      r
</div>
                        <span style="color: #666666">|</span> forall b<span style="color: #666666">.</span> <span style="color: #902000">LiftIO</span>     (<span style="color: #902000">IO</span> b)      (b <span style="color: #007020; font-weight: bold">-&gt;</span> r)
                        <span style="color: #60a0b0; font-style: italic">--deriving Functor</span>
<span style="color: #007020; font-weight: bold">deriving</span> <span style="color: #007020; font-weight: bold">instance</span> <span style="color: #902000">Functor</span> (<span style="color: #902000">EditableListOpsF</span>)
</div>

<div id="source---free-monads---smart-constructors" style="display: inline-block;"><span style="color: #06287e">getList</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Free</span> <span style="color: #902000">EditableListOpsF</span> [<span style="color: #902000">RowData</span>]
<span style="color: #06287e">getList</span> <span style="color: #007020; font-weight: bold">=</span> liftF (<span style="color: #902000">GetList</span> id) <span style="color: #60a0b0; font-style: italic">-- or Free (GetList return)</span>

<span style="color: #06287e">getActiveCellY</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Free</span> <span style="color: #902000">EditableListOpsF</span> (<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span>)
<span style="color: #06287e">getActiveCellY</span> <span style="color: #007020; font-weight: bold">=</span> liftF (<span style="color: #902000">GetActiveCellY</span> id) <span style="color: #60a0b0; font-style: italic">-- or Free (GetActiveCellY return)</span>

<span style="color: #06287e">getLogs</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Free</span> <span style="color: #902000">EditableListOpsF</span> [<span style="color: #902000">String</span>]
<span style="color: #06287e">getLogs</span> <span style="color: #007020; font-weight: bold">=</span> liftF (<span style="color: #902000">GetLogs</span> id) <span style="color: #60a0b0; font-style: italic">-- or Free (GetLogs return)</span>

<span style="color: #06287e">updateList</span> <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">RowData</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Free</span> <span style="color: #902000">EditableListOpsF</span> <span style="color: #007020">()</span>
<span style="color: #06287e">updateList</span> l <span style="color: #007020; font-weight: bold">=</span> liftF (<span style="color: #902000">UpdateList</span> l <span style="color: #007020">()</span>) <span style="color: #60a0b0; font-style: italic">-- or Free (UpdateList l ())</span>

<span style="color: #06287e">updateActiveCellY</span> <span style="color: #007020; font-weight: bold">::</span> (<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span>) <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Free</span> <span style="color: #902000">EditableListOpsF</span> <span style="color: #007020">()</span>
<span style="color: #06287e">updateActiveCellY</span> y <span style="color: #007020; font-weight: bold">=</span> liftF (<span style="color: #902000">UpdateActiveCellY</span> y <span style="color: #007020">()</span>) <span style="color: #60a0b0; font-style: italic">-- or Free (UpdateActiveCellY y ())</span>

<span style="color: #06287e">log</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">String</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Free</span> <span style="color: #902000">EditableListOpsF</span> <span style="color: #007020">()</span>
<span style="color: #06287e">log</span> msg <span style="color: #007020; font-weight: bold">=</span> liftF (<span style="color: #902000">Log</span> msg <span style="color: #007020">()</span>) <span style="color: #60a0b0; font-style: italic">-- or Free (Log msg ())</span>
</div>

<div id="source---free-monads---monadio-instance" style="display: inline-block;"><span style="color: #007020; font-weight: bold">instance</span> <span style="color: #902000">MonadIO</span> (<span style="color: #902000">Free</span> <span style="color: #902000">EditableListOpsF</span>) <span style="color: #007020; font-weight: bold">where</span>
  liftIO a <span style="color: #007020; font-weight: bold">=</span> liftF (<span style="color: #902000">LiftIO</span> a id) <span style="color: #60a0b0; font-style: italic">-- or Free (LiftIO a id)</span>
</div>

<div id="source---free-monads---declaring-target-monad" style="display: inline-block;"><span style="color: #007020; font-weight: bold">newtype</span> <span style="color: #902000">StateHolder</span> a <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">StateHolder</span> (<span style="color: #902000">StateT</span> (<span style="color: #902000">AppStateData</span> <span style="color: #902000">StateHolder</span>) <span style="color: #902000">IO</span> a)
  <span style="color: #007020; font-weight: bold">deriving</span> (<span style="color: #902000">Functor</span>, <span style="color: #902000">Applicative</span>, <span style="color: #902000">Monad</span>, <span style="color: #902000">MonadIO</span>)
</div>

<div id="source---free-monads---inner-interpreter-function" style="display: inline-block;"><span style="color: #06287e">interpret&#39;</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">EditableListOpsF</span> a <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">StateHolder</span> a
<span style="color: #06287e">interpret&#39;</span> (<span style="color: #902000">GetList</span> k) <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span> lst <span style="color: #007020; font-weight: bold">&lt;-</span> rows <span style="color: #666666">&lt;$&gt;</span> (<span style="color: #902000">StateHolder</span> get)
                            return (k lst)
<span style="color: #06287e">interpret&#39;</span> (<span style="color: #902000">GetActiveCellY</span> k) <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span> y <span style="color: #007020; font-weight: bold">&lt;-</span> activeCellY <span style="color: #666666">&lt;$&gt;</span> (<span style="color: #902000">StateHolder</span> get)
                                   return (k y)
<span style="color: #06287e">interpret&#39;</span> (<span style="color: #902000">GetLogs</span> k) <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span> logs <span style="color: #007020; font-weight: bold">&lt;-</span> debugMessages <span style="color: #666666">&lt;$&gt;</span> (<span style="color: #902000">StateHolder</span> get)
                            return (k logs)
<span style="color: #06287e">interpret&#39;</span> (<span style="color: #902000">UpdateList</span> l k) <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span> <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> modify <span style="color: #666666">$</span> <span style="color: #06287e">\</span>s <span style="color: #007020; font-weight: bold">-&gt;</span> s { rows <span style="color: #007020; font-weight: bold">=</span> l }
                                 reacts <span style="color: #007020; font-weight: bold">&lt;-</span> (rowsListeners <span style="color: #666666">.</span> listeners) <span style="color: #666666">&lt;$&gt;</span> (<span style="color: #902000">StateHolder</span> get)
                                 <div id="source---free---main-rows-listener-trigger" style="display: inline;">forM_ reacts (<span style="color: #666666">$</span> l) <span style="color: #60a0b0; font-style: italic">-- same as forM_ reacts $ \react -&gt; react l</span></div>
                                 return k
<span style="color: #06287e">interpret&#39;</span> (<span style="color: #902000">UpdateActiveCellY</span> y k) <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span> <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> modify <span style="color: #666666">$</span> <span style="color: #06287e">\</span>s <span style="color: #007020; font-weight: bold">-&gt;</span> s { activeCellY <span style="color: #007020; font-weight: bold">=</span> y }
                                        reacts <span style="color: #007020; font-weight: bold">&lt;-</span> (activeCellYListeners <span style="color: #666666">.</span> listeners) <span style="color: #666666">&lt;$&gt;</span> (<span style="color: #902000">StateHolder</span> get)
                                        <div id="source---free---active-cell-y-listener-trigger" style="display: inline;">forM_ reacts (<span style="color: #666666">$</span> y) <span style="color: #60a0b0; font-style: italic">-- same as forM_ reacts $ \react -&gt; react y</span></div>
                                        return k
<span style="color: #06287e">interpret&#39;</span> (<span style="color: #902000">Log</span> msg k) <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span> <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> modify <span style="color: #666666">$</span> <span style="color: #06287e">\</span>s <span style="color: #007020; font-weight: bold">-&gt;</span> s { debugMessages <span style="color: #007020; font-weight: bold">=</span> take debugLinesCount (msg<span style="color: #902000">:</span>(debugMessages s)) }
                            logs <span style="color: #007020; font-weight: bold">&lt;-</span> debugMessages <span style="color: #666666">&lt;$&gt;</span> (<span style="color: #902000">StateHolder</span> get)
                            reacts <span style="color: #007020; font-weight: bold">&lt;-</span> (debugMessagesListeners <span style="color: #666666">.</span> listeners) <span style="color: #666666">&lt;$&gt;</span> (<span style="color: #902000">StateHolder</span> get)
                            <div id="source---free---debug-messages-listener-trigger" style="display: inline;">forM_ reacts (<span style="color: #666666">$</span> logs) <span style="color: #60a0b0; font-style: italic">-- same as forM_ reacts $ \react -&gt; react logs</span></div>
                            return k
<span style="color: #06287e">interpret&#39;</span> (<span style="color: #902000">LiftIO</span> a k) <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span> v <span style="color: #007020; font-weight: bold">&lt;-</span> liftIO a
                             return (k v)
</div>

<div id="source---free-monads---interpreter-function-foldFree" style="display: inline-block;"><span style="color: #06287e">interpret</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Free</span> <span style="color: #902000">EditableListOpsF</span> a <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">StateHolder</span> a
<span style="color: #06287e">interpret</span> <span style="color: #007020; font-weight: bold">=</span> foldFree interpret&#39;
</div>

<span style="color: #06287e">performStateAction</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">AppStateData</span> <span style="color: #902000">StateHolder</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <div id="source---free---StateHolder-context" style="display: inline;"><span style="color: #902000">StateHolder</span> a</div> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">IO</span> <span style="color: #007020">()</span>
<span style="color: #06287e">performStateAction</span> state (<span style="color: #902000">StateHolder</span> action) <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
  runStateT action state
  return <span style="color: #007020">()</span>

<span style="color: #06287e">debugLinesCount</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #40a070">20</span>

<span style="color: #06287e">main</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">IO</span> <span style="color: #007020">()</span>
<span style="color: #06287e">main</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
  hSetBuffering stdin <span style="color: #902000">NoBuffering</span>
  hSetBuffering stdout <span style="color: #902000">NoBuffering</span>
  hSetEcho stdin <span style="color: #902000">False</span>
  clearScreen
  <span style="color: #60a0b0; font-style: italic">--performStateAction initialState (interpret (do ... ))</span>
  performStateAction initialState <span style="color: #666666">$</span> <div id="source---free---loop-interpret" style="display: inline;">interpret</div> <span style="color: #666666">$</span> <span style="color: #007020; font-weight: bold">do</span>
    initRows
    <div class="source---free---loop-invokation-and-definition" style="display: inline;">loop</div>
  <span style="color: #007020; font-weight: bold">where</span>
    xUpperLeft <span style="color: #007020; font-weight: bold">=</span> <span style="color: #40a070">0</span>
    yUpperLeft <span style="color: #007020; font-weight: bold">=</span> <span style="color: #40a070">0</span>
    columnCount <span style="color: #007020; font-weight: bold">=</span> <span style="color: #40a070">1</span>
    columnWidth <span style="color: #007020; font-weight: bold">=</span> <span style="color: #40a070">14</span>
    rowCount <span style="color: #007020; font-weight: bold">=</span> length initialRows

    initialState <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">AppStateData</span> <span style="color: #902000">StateHolder</span>
    initialState <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">AppState</span> <span style="color: #902000">[]</span> <span style="color: #902000">Nothing</span> <span style="color: #902000">[]</span> initListeners

    initRows <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Free</span> <span style="color: #902000">EditableListOpsF</span> <span style="color: #007020">()</span>
    initRows <span style="color: #007020; font-weight: bold">=</span> updateList initialRows

    initListeners <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">AppStateListenersData</span> <span style="color: #902000">StateHolder</span>
    <span style="color: #60a0b0; font-style: italic">--initListeners =</span>
    <span style="color: #60a0b0; font-style: italic">--    addRowsListener (interpret . mainRowsListener)</span>
    <span style="color: #60a0b0; font-style: italic">--    (addActiveCellYListener (interpret . activeCellYListener)</span>
    <span style="color: #60a0b0; font-style: italic">--    (addDebugMessagesListener (interpret . debugMessagesListener)</span>
    <span style="color: #60a0b0; font-style: italic">--    (empty)))</span>
    initListeners <span style="color: #007020; font-weight: bold">=</span>
        addRowsListener (<div id="source---free---main-rows-listener-interpret" style="display: inline;">interpret</div> <span style="color: #666666">.</span> mainRowsListener)
        <span style="color: #666666">$</span> addActiveCellYListener (<div id="source---free---active-cell-y-listener-interpret" style="display: inline;">interpret</div> <span style="color: #666666">.</span> activeCellYListener)
        <span style="color: #666666">$</span> addDebugMessagesListener (<div id="source---free---debug-messages-listener-interpret" style="display: inline;">interpret</div> <span style="color: #666666">.</span> debugMessagesListener)
        <span style="color: #666666">$</span> empty
      <span style="color: #007020; font-weight: bold">where</span>
        empty <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">AppStateListeners</span> <span style="color: #902000">[]</span> <span style="color: #902000">[]</span> <span style="color: #902000">[]</span>

<div id="source---free---main-rows-listener" style="display: inline-block;"
>    <div class="source---free-monads---type-signatures-of-listeners-and-loop" style="display: inline;">mainRowsListener <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">RowData</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> <div id="source---free---main-rows-listener-EditableListOps-context" style="display: inline;"><span style="color: #902000">Free</span> <span style="color: #902000">EditableListOpsF</span> <span style="color: #007020">()</span></div></div>
    mainRowsListener rows <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
      activeCellCoords <span style="color: #007020; font-weight: bold">&lt;-</span> fmap (<span style="color: #06287e">\</span>y <span style="color: #007020; font-weight: bold">-&gt;</span> (<span style="color: #40a070">0</span>, y)) <span style="color: #666666">&lt;$&gt;</span> getActiveCellY
<div id="source---free---main-rows-listener-draw" style="display: inline-block;"
>      liftIO <span style="color: #666666">$</span> showInGrid
                 xUpperLeft
                 yUpperLeft
                 columnCount
                 columnWidth
                 activeCellCoords
                 (map (<span style="color: #06287e">\</span>row <span style="color: #007020; font-weight: bold">-&gt;</span> [smth row]) rows)
</div>
      <div id="source---free---main-rows-listener-log" style="display: inline;">log <span style="color: #4070a0">&quot;updated rows&quot;</span></div>
</div>

<div id="source---free---active-cell-y-listener" style="display: inline-block;"
>    <div class="source---free-monads---type-signatures-of-listeners-and-loop" style="display: inline;">activeCellYListener <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <div id="source---free---active-cell-y-listener-EditableListOps-context" style="display: inline;"><span style="color: #902000">Free</span> <span style="color: #902000">EditableListOpsF</span> <span style="color: #007020">()</span></div></div>
    activeCellYListener activeCellY <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
      <span style="color: #007020; font-weight: bold">let</span> activeCellCoords <span style="color: #007020; font-weight: bold">=</span> fmap (<span style="color: #06287e">\</span>y <span style="color: #007020; font-weight: bold">-&gt;</span> (<span style="color: #40a070">0</span>, y)) activeCellY
      <div class="source---free---active-cell-y-listener-draw" style="display: inline;">liftIO <span style="color: #666666">$</span> drawGrid xUpperLeft yUpperLeft columnWidth columnCount rowCount</div>
      <span style="color: #007020; font-weight: bold">case</span> activeCellCoords <span style="color: #007020; font-weight: bold">of</span>
        <span style="color: #902000">Nothing</span> <span style="color: #007020; font-weight: bold">-&gt;</span> return <span style="color: #007020">()</span>
        <span style="color: #902000">Just</span> coordsPair <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span>
          <div class="source---free---active-cell-y-listener-draw" style="display: inline;">liftIO <span style="color: #666666">$</span> highlightCell xUpperLeft yUpperLeft columnWidth columnCount rowCount coordsPair</div>
          <div id="source---free---active-cell-y-listener-log" style="display: inline;">log <span style="color: #4070a0">&quot;highlighted cell&quot;</span></div>
</div>

<div id="source---free---debug-messages-listener" style="display: inline-block;"
>    <div class="source---free-monads---type-signatures-of-listeners-and-loop" style="display: inline;">debugMessagesListener <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">String</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> <div id="source---free---debug-messages-listener-EditableListOps-context" style="display: inline;"><span style="color: #902000">Free</span> <span style="color: #902000">EditableListOpsF</span> <span style="color: #007020">()</span></div></div>
    debugMessagesListener debugMessages <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
<div id="source---free---debug-messages-listener-draw" style="display: inline-block;"
>      liftIO <span style="color: #666666">$</span> printFromBottom
                 xUpperLeft
                 (yUpperLeft<span style="color: #666666">+</span><span style="color: #40a070">12</span><span style="color: #666666">+</span>debugLinesCount)
                 debugMessages
</div>
</div>

<div class="source---free---loop-invokation-and-definition" style="display: inline-block;"
>    <div class="source---free-monads---type-signatures-of-listeners-and-loop" style="display: inline;">loop <span style="color: #007020; font-weight: bold">::</span> <div id="source---free---loop-EditableListOps-context" style="display: inline;"><span style="color: #902000">Free</span> <span style="color: #902000">EditableListOpsF</span> <span style="color: #007020">()</span></div></div>
    loop <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
</div>
      <div id="source---free---getKey" style="display: inline;">key <span style="color: #007020; font-weight: bold">&lt;-</span> liftIO <span style="color: #666666">$</span> getKey</div>
      when (key <span style="color: #666666">/=</span> <span style="color: #4070a0">&quot;</span><span style="color: #4070a0; font-weight: bold">\ESC</span><span style="color: #4070a0">&quot;</span>) <span style="color: #666666">$</span> <span style="color: #007020; font-weight: bold">do</span>
        <div id="source---free---case-key-of" style="display: inline;"><span style="color: #007020; font-weight: bold">case</span> key <span style="color: #007020; font-weight: bold">of</span></div>
          <div id="source---free---up" style="display: inline;"><span style="color: #4070a0">&quot;</span><span style="color: #4070a0; font-weight: bold">\ESC</span><span style="color: #4070a0">[A&quot;</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span> <span style="color: #60a0b0; font-style: italic">-- up</span></div>
              activeCellY <span style="color: #007020; font-weight: bold">&lt;-</span> getActiveCellY
              <span style="color: #007020; font-weight: bold">let</span>
                newActiveCellY <span style="color: #007020; font-weight: bold">=</span>
                  <span style="color: #007020; font-weight: bold">case</span> activeCellY <span style="color: #007020; font-weight: bold">of</span>
                    <span style="color: #902000">Just</span> y <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Just</span> <span style="color: #666666">$</span> max <span style="color: #40a070">0</span> (y<span style="color: #666666">-</span><span style="color: #40a070">1</span>)
                    <span style="color: #902000">Nothing</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Just</span> <span style="color: #40a070">0</span>
              <div id="source---free---from-up-to-active-cell-y" style="display: inline;">updateActiveCellY newActiveCellY</div>
              <div id="source---free---from-up-to-debug-messages" style="display: inline;">log <span style="color: #666666">$</span> <span style="color: #4070a0">&quot;&uarr; &quot;</span> <span style="color: #666666">++</span> show(newActiveCellY)</div>
              loop
          <div id="source---free---down" style="display: inline;"><span style="color: #4070a0">&quot;</span><span style="color: #4070a0; font-weight: bold">\ESC</span><span style="color: #4070a0">[B&quot;</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span> <span style="color: #60a0b0; font-style: italic">-- down</span></div>
              activeCellY <span style="color: #007020; font-weight: bold">&lt;-</span> getActiveCellY
              <span style="color: #007020; font-weight: bold">let</span>
                newActiveCellY <span style="color: #007020; font-weight: bold">=</span>
                  <span style="color: #007020; font-weight: bold">case</span> activeCellY <span style="color: #007020; font-weight: bold">of</span>
                    <span style="color: #902000">Just</span> y <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Just</span> <span style="color: #666666">$</span> min (rowCount<span style="color: #666666">-</span><span style="color: #40a070">1</span>) (y<span style="color: #666666">+</span><span style="color: #40a070">1</span>)
                    <span style="color: #902000">Nothing</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Just</span> <span style="color: #40a070">0</span>
              <div id="source---free---from-down-to-active-cell-y" style="display: inline;">updateActiveCellY newActiveCellY</div>
              <div id="source---free---from-down-to-debug-messages" style="display: inline;">log <span style="color: #666666">$</span> <span style="color: #4070a0">&quot;&darr; &quot;</span> <span style="color: #666666">++</span> show(newActiveCellY)</div>
              loop
          <div id="source---free---enter" style="display: inline;"><span style="color: #4070a0">&quot;</span><span style="color: #4070a0; font-weight: bold">\n</span><span style="color: #4070a0">&quot;</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span> <span style="color: #60a0b0; font-style: italic">-- enter</span></div>
              activeCellY <span style="color: #007020; font-weight: bold">&lt;-</span> getActiveCellY
              rows <span style="color: #007020; font-weight: bold">&lt;-</span> getList
                
              <span style="color: #007020; font-weight: bold">let</span>
                  eitherValue <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Either</span> <span style="color: #902000">String</span> <span style="color: #902000">String</span>
                  eitherValue <span style="color: #007020; font-weight: bold">=</span>
                    <span style="color: #007020; font-weight: bold">case</span> activeCellY <span style="color: #007020; font-weight: bold">of</span>
                      <span style="color: #902000">Nothing</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Left</span> <span style="color: #4070a0">&quot;there&#39;s no selected cell&quot;</span>
                      <span style="color: #902000">Just</span> cellIndex <span style="color: #007020; font-weight: bold">-&gt;</span>
                        <span style="color: #007020; font-weight: bold">if</span> cellIndex <span style="color: #666666">&lt;</span> <span style="color: #40a070">0</span> <span style="color: #666666">||</span> cellIndex <span style="color: #666666">&gt;=</span> (length rows)
                          <span style="color: #007020; font-weight: bold">then</span> <span style="color: #902000">Left</span> <span style="color: #666666">$</span> <span style="color: #4070a0">&quot;index out of bounds: &quot;</span> <span style="color: #666666">++</span> (show cellIndex)
                          <span style="color: #007020; font-weight: bold">else</span> <span style="color: #902000">Right</span> <span style="color: #666666">$</span> smth <span style="color: #666666">$</span> rows <span style="color: #666666">!!</span> cellIndex

                  showEditField <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">String</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Free</span> <span style="color: #902000">EditableListOpsF</span> <span style="color: #007020">()</span>
                  showEditField value <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
                    <span style="color: #007020; font-weight: bold">let</span>
                      txt <span style="color: #007020; font-weight: bold">=</span> <span style="color: #4070a0">&quot;edit cell value:&quot;</span>
                      lentxt <span style="color: #007020; font-weight: bold">=</span> length txt
                      yPos <span style="color: #007020; font-weight: bold">=</span> <span style="color: #40a070">0</span>
                      xPos <span style="color: #007020; font-weight: bold">=</span> (columnCount <span style="color: #666666">*</span> (columnWidth <span style="color: #666666">+</span> <span style="color: #40a070">1</span>)) <span style="color: #666666">+</span> <span style="color: #40a070">3</span>
                      replaceNth lst idx val <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">if</span> idx <span style="color: #666666">&lt;</span> <span style="color: #40a070">1</span> <span style="color: #007020; font-weight: bold">then</span> val<span style="color: #902000">:</span>(tail lst) <span style="color: #007020; font-weight: bold">else</span> (head lst) <span style="color: #902000">:</span> (replaceNth (tail lst) (idx <span style="color: #666666">-</span> <span style="color: #40a070">1</span>) val)
                    liftIO <span style="color: #666666">$</span> showInRectangle xPos yPos lentxt [txt, value]
                    key <span style="color: #007020; font-weight: bold">&lt;-</span> liftIO <span style="color: #666666">$</span> getKey
                    <span style="color: #007020; font-weight: bold">case</span> key <span style="color: #007020; font-weight: bold">of</span>
                      <span style="color: #4070a0">&quot;</span><span style="color: #4070a0; font-weight: bold">\n</span><span style="color: #4070a0">&quot;</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span>
                        <span style="color: #007020; font-weight: bold">case</span> activeCellY <span style="color: #007020; font-weight: bold">of</span>
                          <span style="color: #902000">Nothing</span> <span style="color: #007020; font-weight: bold">-&gt;</span> return <span style="color: #007020">()</span>
                          <span style="color: #902000">Just</span> cellIndex <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span>
                            liftIO <span style="color: #666666">$</span> clearRectangle xPos yPos lentxt <span style="color: #40a070">2</span>
                            rows <span style="color: #007020; font-weight: bold">&lt;-</span> getList
                            <div id="source---free---from-enter-to-main-rows" style="display: inline;">updateList <span style="color: #666666">$</span> replaceNth rows cellIndex (<span style="color: #902000">Row</span> value)</div>
                            loop
                      <span style="color: #4070a0">&quot;</span><span style="color: #4070a0; font-weight: bold">\DEL</span><span style="color: #4070a0">&quot;</span> <span style="color: #007020; font-weight: bold">-&gt;</span> showEditField (<span style="color: #007020; font-weight: bold">if</span> (length value) <span style="color: #666666">==</span> <span style="color: #40a070">0</span> <span style="color: #007020; font-weight: bold">then</span> value <span style="color: #007020; font-weight: bold">else</span> init value)
                      c <span style="color: #007020; font-weight: bold">-&gt;</span> showEditField (value <span style="color: #666666">++</span> c)
              <span style="color: #007020; font-weight: bold">case</span> eitherValue <span style="color: #007020; font-weight: bold">of</span>
                <span style="color: #902000">Left</span> e <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span>
                  <div id="source---free---from-enter-to-debug-messages" style="display: inline;">log <span style="color: #666666">$</span> <span style="color: #4070a0">&quot;error: &quot;</span> <span style="color: #666666">++</span> (show e)</div>
                  loop
                <span style="color: #902000">Right</span> v <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span>
                  showEditField v
<div id="source---free---case-key-otherwise" style="display: inline-block;"
>          <span style="color: #4070a0">&quot;q&quot;</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <div class="source---free---exit" style="display: inline;">return <span style="color: #007020">()</span></div>
          <span style="color: #007020; font-weight: bold">_</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <div class="source---free---exit" style="display: inline;">return <span style="color: #007020">()</span></div>
</div>

<span style="color: #06287e">getKey</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">IO</span> [<span style="color: #902000">Char</span>]
<span style="color: #06287e">getKey</span> <span style="color: #007020; font-weight: bold">=</span> reverse <span style="color: #666666">&lt;$&gt;</span> getKey&#39; <span style="color: #4070a0">&quot;&quot;</span>
  <span style="color: #007020; font-weight: bold">where</span>
  getKey&#39; chars <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
    char <span style="color: #007020; font-weight: bold">&lt;-</span> getChar
    more <span style="color: #007020; font-weight: bold">&lt;-</span> hReady stdin
    (<span style="color: #007020; font-weight: bold">if</span> more <span style="color: #007020; font-weight: bold">then</span> getKey&#39; <span style="color: #007020; font-weight: bold">else</span> return) (char<span style="color: #902000">:</span>chars)
</pre></div> <!-- end of source free-monad main -->
















<!-- HTML generated using hilite.me --><div id="source---operational-style---main" style="display: none; background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #60a0b0; font-style: italic">{-# LANGUAGE  GeneralizedNewtypeDeriving #-}</span>
<span style="color: #60a0b0; font-style: italic">{-# LANGUAGE GADTs #-}</span>
<span style="color: #007020; font-weight: bold">module</span> <span style="color: #0e84b5; font-weight: bold">Main</span> <span style="color: #007020; font-weight: bold">where</span>

<span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">Control.Monad</span> (<span style="color: #06287e">when</span>, <span style="color: #06287e">forM_</span>)
<span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">Control.Exception</span> (<span style="color: #06287e">try</span>)
<span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">System.IO</span> (<span style="color: #06287e">stdin</span>, <span style="color: #06287e">stdout</span>, <span style="color: #06287e">hSetEcho</span>, <span style="color: #06287e">hSetBuffering</span>, <span style="color: #06287e">hReady</span>, <span style="color: #902000">BufferMode</span> (<span style="color: #902000">NoBuffering</span>) )
<span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">Control.Monad.State.Strict</span> (<span style="color: #902000">StateT</span>, <span style="color: #06287e">get</span>, <span style="color: #06287e">modify</span>, <span style="color: #06287e">runStateT</span>)
<span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">Control.Monad.IO.Class</span> (<span style="color: #902000">MonadIO</span>, <span style="color: #06287e">liftIO</span>)
<span style="color: #007020; font-weight: bold">import</span> <span style="color: #007020; font-weight: bold">qualified</span> <span style="color: #0e84b5; font-weight: bold">Data.Map</span> <span style="color: #007020; font-weight: bold">as</span> Map
<span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">ViewUtils</span> (<span style="color: #06287e">clearScreen</span>, <span style="color: #06287e">showInRectangle</span>, <span style="color: #06287e">clearRectangle</span>, <span style="color: #06287e">showInGrid</span>, <span style="color: #06287e">drawGrid</span>, <span style="color: #06287e">highlightCell</span>, <span style="color: #06287e">printFromBottom</span>)
<span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">Prelude</span> <span style="color: #007020; font-weight: bold">hiding</span> (<span style="color: #06287e">log</span>)

<span style="color: #007020; font-weight: bold">data</span> <span style="color: #902000">RowData</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">Row</span> { smth <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">String</span> } <span style="color: #007020; font-weight: bold">deriving</span> <span style="color: #902000">Eq</span>

<span style="color: #06287e">initialRows</span> <span style="color: #007020; font-weight: bold">=</span> [
  <span style="color: #902000">Row</span> <span style="color: #4070a0">&quot;something a&quot;</span>
  , <span style="color: #902000">Row</span> <span style="color: #4070a0">&quot;something b&quot;</span>
  , <span style="color: #902000">Row</span> <span style="color: #4070a0">&quot;something c&quot;</span>
  , <span style="color: #902000">Row</span> <span style="color: #4070a0">&quot;something d&quot;</span>
  , <span style="color: #902000">Row</span> <span style="color: #4070a0">&quot;something e&quot;</span>
  ]

<div id="source---operational-style---state-data-types" style="display: inline-block;"><span style="color: #007020; font-weight: bold">data</span> <span style="color: #902000">AppStateData</span> m <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">AppState</span>
  { rows <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">RowData</span>]
  , activeCellY <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span>
  , debugMessages <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">String</span>]
  , listeners <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">AppStateListenersData</span> m
  }

<span style="color: #007020; font-weight: bold">data</span> <span style="color: #902000">AppStateListenersData</span> m <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">AppStateListeners</span>
  { rowsListeners <span style="color: #007020; font-weight: bold">::</span> [[<span style="color: #902000">RowData</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>]
  , activeCellYListeners <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span> <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>]
  , debugMessagesListeners <span style="color: #007020; font-weight: bold">::</span> [[<span style="color: #902000">String</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>]
  }
</div>

<div class="source---operational-style---functions-that-add-listeners" style="display: inline;"><span style="color: #06287e">addRowsListener</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Monad</span> m <span style="color: #007020; font-weight: bold">=&gt;</span> ([<span style="color: #902000">RowData</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>) <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span> m <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span> m</div>
<span style="color: #06287e">addRowsListener</span> listener (<span style="color: #902000">AppStateListeners</span> rowsListeners _activeCellYListeners _debugMessagesListeners) <span style="color: #007020; font-weight: bold">=</span>
  <span style="color: #902000">AppStateListeners</span> (listener<span style="color: #902000">:</span>rowsListeners) _activeCellYListeners _debugMessagesListeners

<div class="source---operational-style---functions-that-add-listeners" style="display: inline;"><span style="color: #06287e">addActiveCellYListener</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Monad</span> m <span style="color: #007020; font-weight: bold">=&gt;</span> (<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span> <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>) <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span> m <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span> m</div>
<span style="color: #06287e">addActiveCellYListener</span> listener (<span style="color: #902000">AppStateListeners</span> _rowsListeners activeCellYListeners _debugMessagesListeners) <span style="color: #007020; font-weight: bold">=</span>
  <span style="color: #902000">AppStateListeners</span> _rowsListeners (listener<span style="color: #902000">:</span>activeCellYListeners) _debugMessagesListeners

<div class="source---operational-style---functions-that-add-listeners" style="display: inline;"><span style="color: #06287e">addDebugMessagesListener</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Monad</span> m <span style="color: #007020; font-weight: bold">=&gt;</span> ([<span style="color: #902000">String</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>) <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span> m <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span> m</div>
<span style="color: #06287e">addDebugMessagesListener</span> listener (<span style="color: #902000">AppStateListeners</span> _rowsListeners _activeCellYListeners debugMessagesListeners) <span style="color: #007020; font-weight: bold">=</span>
  <span style="color: #902000">AppStateListeners</span> _rowsListeners _activeCellYListeners (listener<span style="color: #902000">:</span>debugMessagesListeners)

<div id="source---operational-style---declaring-monad-operations-as-gadt" style="display: inline-block;"><span style="color: #007020; font-weight: bold">data</span> <span style="color: #902000">EditableListApp</span> a <span style="color: #007020; font-weight: bold">where</span>
<div id="source---operational-style---getters-in-ops-gadt" style="display: inline-block;"
>  <span style="color: #902000">GetList</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">EditableListApp</span> [<span style="color: #902000">RowData</span>]
  <span style="color: #902000">GetActiveCellY</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">EditableListApp</span> (<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span>)
  <span style="color: #902000">GetLogs</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">EditableListApp</span> [<span style="color: #902000">String</span>]
</div>

<div id="source---operational-style---setters-in-ops-gadt" style="display: inline-block;"
>  <span style="color: #902000">UpdateList</span> <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">RowData</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">EditableListApp</span> <span style="color: #007020">()</span>
  <span style="color: #902000">UpdateActiveCellY</span> <span style="color: #007020; font-weight: bold">::</span> (<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span>) <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">EditableListApp</span> <span style="color: #007020">()</span>
  <span style="color: #902000">Log</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">String</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">EditableListApp</span> <span style="color: #007020">()</span>
</div>

  <span style="color: #902000">LiftIO</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">IO</span> b <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">EditableListApp</span> b

  <span style="color: #902000">Done</span> <span style="color: #007020; font-weight: bold">::</span> a <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">EditableListApp</span> a
  <span style="color: #902000">Bind</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">EditableListApp</span> a <span style="color: #007020; font-weight: bold">-&gt;</span> (a <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">EditableListApp</span> b) <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">EditableListApp</span> b
</div>

<div id="source---operational-style---smart-constructors" style="display: inline-block;"
><span style="color: #06287e">getList</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">EditableListApp</span> [<span style="color: #902000">RowData</span>]
<span style="color: #06287e">getList</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">GetList</span>

<span style="color: #06287e">getActiveCellY</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">EditableListApp</span> (<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span>)
<span style="color: #06287e">getActiveCellY</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">GetActiveCellY</span>

<span style="color: #06287e">getLogs</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">EditableListApp</span> [<span style="color: #902000">String</span>]
<span style="color: #06287e">getLogs</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">GetLogs</span>

<span style="color: #06287e">updateList</span> <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">RowData</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">EditableListApp</span> <span style="color: #007020">()</span>
<span style="color: #06287e">updateList</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">UpdateList</span>

<span style="color: #06287e">updateActiveCellY</span> <span style="color: #007020; font-weight: bold">::</span> (<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span>) <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">EditableListApp</span> <span style="color: #007020">()</span>
<span style="color: #06287e">updateActiveCellY</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">UpdateActiveCellY</span>

<span style="color: #06287e">log</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">String</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">EditableListApp</span> <span style="color: #007020">()</span>
<span style="color: #06287e">log</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">Log</span>
</div>

<div id="source---operational-style---making-gadt-a-monad" style="display: inline-block;"
><span style="color: #007020; font-weight: bold">instance</span> <span style="color: #902000">Functor</span> <span style="color: #902000">EditableListApp</span> <span style="color: #007020; font-weight: bold">where</span>
  fmap f x <span style="color: #007020; font-weight: bold">=</span> x `<span style="color: #902000">Bind</span>` (<span style="color: #06287e">\</span>x&#39; <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Done</span> (f x&#39;))

<span style="color: #007020; font-weight: bold">instance</span> <span style="color: #902000">Applicative</span> <span style="color: #902000">EditableListApp</span> <span style="color: #007020; font-weight: bold">where</span>
  pure <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">Done</span>
  f <span style="color: #666666">&lt;*&gt;</span> x <span style="color: #007020; font-weight: bold">=</span> f `<span style="color: #902000">Bind</span>` (<span style="color: #06287e">\</span>f&#39; <span style="color: #007020; font-weight: bold">-&gt;</span> x `<span style="color: #902000">Bind</span>` (<span style="color: #06287e">\</span>x&#39; <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Done</span> (f&#39; x&#39;)))

<span style="color: #007020; font-weight: bold">instance</span> <span style="color: #902000">Monad</span> <span style="color: #902000">EditableListApp</span> <span style="color: #007020; font-weight: bold">where</span>
  return <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">Done</span>
  (<span style="color: #666666">&gt;&gt;=</span>) <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">Bind</span>
</div>

<div id="source---operational-style---making-gadt-a-monadio" style="display: inline-block;"
><span style="color: #007020; font-weight: bold">instance</span> <span style="color: #902000">MonadIO</span> <span style="color: #902000">EditableListApp</span> <span style="color: #007020; font-weight: bold">where</span>
  liftIO <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">LiftIO</span>
</div>

<div id="source---operational-style---target-monad" style="display: inline-block;"
><span style="color: #007020; font-weight: bold">newtype</span> <span style="color: #902000">StateHolder</span> a <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">StateHolder</span> (<span style="color: #902000">StateT</span> (<span style="color: #902000">AppStateData</span> <span style="color: #902000">StateHolder</span>) <span style="color: #902000">IO</span> a)
  <span style="color: #007020; font-weight: bold">deriving</span> (<span style="color: #902000">Functor</span>, <span style="color: #902000">Applicative</span>, <span style="color: #902000">Monad</span>, <span style="color: #902000">MonadIO</span>)
</div>

<div id="source---operational-style---interpreter-function" style="display: inline-block;"
><span style="color: #06287e">interpret</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">EditableListApp</span> a <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">StateHolder</span> a
<span style="color: #06287e">interpret</span> <span style="color: #902000">GetList</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> rows <span style="color: #666666">&lt;$&gt;</span> get
<span style="color: #06287e">interpret</span> <span style="color: #902000">GetActiveCellY</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> activeCellY <span style="color: #666666">&lt;$&gt;</span> get
<span style="color: #06287e">interpret</span> <span style="color: #902000">GetLogs</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> debugMessages <span style="color: #666666">&lt;$&gt;</span> get

<span style="color: #06287e">interpret</span> (<span style="color: #902000">UpdateList</span> l) <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
  <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> modify <span style="color: #666666">$</span> <span style="color: #06287e">\</span>s <span style="color: #007020; font-weight: bold">-&gt;</span> s { rows <span style="color: #007020; font-weight: bold">=</span> l }
  reacts <span style="color: #007020; font-weight: bold">&lt;-</span> <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> (rowsListeners <span style="color: #666666">.</span> listeners) <span style="color: #666666">&lt;$&gt;</span> get
  forM_ reacts (<span style="color: #666666">$</span> l) <span style="color: #60a0b0; font-style: italic">-- same as forM_ reacts $ \react -&gt; react l</span>
<span style="color: #06287e">interpret</span> (<span style="color: #902000">UpdateActiveCellY</span> y) <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
  <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> modify <span style="color: #666666">$</span> <span style="color: #06287e">\</span>s <span style="color: #007020; font-weight: bold">-&gt;</span> s { activeCellY <span style="color: #007020; font-weight: bold">=</span> y }
  s <span style="color: #007020; font-weight: bold">&lt;-</span> <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> get
  <span style="color: #007020; font-weight: bold">let</span> reacts <span style="color: #007020; font-weight: bold">=</span> activeCellYListeners (listeners s)
  forM_ reacts (<span style="color: #666666">$</span> y) <span style="color: #60a0b0; font-style: italic">-- same as forM_ reacts $ \react -&gt; react y</span>
<span style="color: #06287e">interpret</span> (<span style="color: #902000">Log</span> msg) <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
  <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> modify <span style="color: #666666">$</span> <span style="color: #06287e">\</span>s <span style="color: #007020; font-weight: bold">-&gt;</span> s { debugMessages <span style="color: #007020; font-weight: bold">=</span> take debugLinesCount (msg<span style="color: #902000">:</span>(debugMessages s)) }
  logs <span style="color: #007020; font-weight: bold">&lt;-</span> <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> debugMessages <span style="color: #666666">&lt;$&gt;</span> get
  reacts <span style="color: #007020; font-weight: bold">&lt;-</span> <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> (debugMessagesListeners <span style="color: #666666">.</span> listeners) <span style="color: #666666">&lt;$&gt;</span> get
  forM_ reacts (<span style="color: #666666">$</span> logs) <span style="color: #60a0b0; font-style: italic">-- same as forM_ reacts $ \react -&gt; react logs</span>
<span style="color: #06287e">interpret</span> (<span style="color: #902000">Done</span> a) <span style="color: #007020; font-weight: bold">=</span> return a
<span style="color: #06287e">interpret</span> (<span style="color: #902000">Bind</span> g h) <span style="color: #007020; font-weight: bold">=</span> (interpret g) <span style="color: #666666">&gt;&gt;=</span> (interpret <span style="color: #666666">.</span> h)
<span style="color: #06287e">interpret</span> (<span style="color: #902000">LiftIO</span> a) <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
  v <span style="color: #007020; font-weight: bold">&lt;-</span> liftIO a
  return v
</div>

<div id="source---operational-style---performStateAction" style="display: inline-block;"
><span style="color: #06287e">performStateAction</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">AppStateData</span> <span style="color: #902000">StateHolder</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">StateHolder</span> a <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">IO</span> <span style="color: #007020">()</span>
<span style="color: #06287e">performStateAction</span> state (<span style="color: #902000">StateHolder</span> action) <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
  runStateT action state
  return <span style="color: #007020">()</span>
</div>

<span style="color: #06287e">debugLinesCount</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #40a070">20</span>

<div id="source---operational-style---fragment-of-main" style="display: inline-block;"
><span style="color: #06287e">main</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">IO</span> <span style="color: #007020">()</span>
<span style="color: #06287e">main</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
  hSetBuffering stdin <span style="color: #902000">NoBuffering</span>
  hSetBuffering stdout <span style="color: #902000">NoBuffering</span>
  hSetEcho stdin <span style="color: #902000">False</span>
  clearScreen
  <span style="color: #60a0b0; font-style: italic">-- performStateAction initialState (interpret (do ...))</span>
  performStateAction initialState <span style="color: #666666">$</span> interpret <span style="color: #666666">$</span> <span style="color: #007020; font-weight: bold">do</span>
    initRows
    loop
  <span style="color: #007020; font-weight: bold">where</span>
</div>
    xUpperLeft <span style="color: #007020; font-weight: bold">=</span> <span style="color: #40a070">0</span>
    yUpperLeft <span style="color: #007020; font-weight: bold">=</span> <span style="color: #40a070">0</span>
    columnCount <span style="color: #007020; font-weight: bold">=</span> <span style="color: #40a070">1</span>
    columnWidth <span style="color: #007020; font-weight: bold">=</span> <span style="color: #40a070">14</span>
    rowCount <span style="color: #007020; font-weight: bold">=</span> length initialRows

<div id="source---operational-style---initialState" style="display: inline-block;"
>    initialState <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">AppStateData</span> <span style="color: #902000">StateHolder</span>
    initialState <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">AppState</span> <span style="color: #902000">[]</span> <span style="color: #902000">Nothing</span> <span style="color: #902000">[]</span> initListeners
</div>

<div id="source---operational-style---initRows" style="display: inline-block;"
>    initRows <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">EditableListApp</span> <span style="color: #007020">()</span>
    initRows <span style="color: #007020; font-weight: bold">=</span> updateList initialRows
</div>

<div id="source---operational-style---initListeners" style="display: inline-block;"
>    initListeners <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">AppStateListenersData</span> <span style="color: #902000">StateHolder</span>
    <span style="color: #60a0b0; font-style: italic">-- initListeners =</span>
    <span style="color: #60a0b0; font-style: italic">--     addRowsListener (interpret . mainRowsListener)</span>
    <span style="color: #60a0b0; font-style: italic">--     (addActiveCellYListener (interpret . activeCellYListener)</span>
    <span style="color: #60a0b0; font-style: italic">--     (addDebugMessagesListener (interpret . debugMessagesListener)</span>
    <span style="color: #60a0b0; font-style: italic">--     (empty)))</span>
    initListeners <span style="color: #007020; font-weight: bold">=</span>
        addRowsListener (interpret <span style="color: #666666">.</span> mainRowsListener)
        <span style="color: #666666">$</span> addActiveCellYListener (interpret <span style="color: #666666">.</span> activeCellYListener)
        <span style="color: #666666">$</span> addDebugMessagesListener (interpret <span style="color: #666666">.</span> debugMessagesListener)
        <span style="color: #666666">$</span> empty
      <span style="color: #007020; font-weight: bold">where</span>
        empty <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">AppStateListeners</span> <span style="color: #902000">[]</span> <span style="color: #902000">[]</span> <span style="color: #902000">[]</span>

    mainRowsListener <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">RowData</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">EditableListApp</span> <span style="color: #007020">()</span>
    mainRowsListener rows <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
      activeCellCoords <span style="color: #007020; font-weight: bold">&lt;-</span> fmap (<span style="color: #06287e">\</span>y <span style="color: #007020; font-weight: bold">-&gt;</span> (<span style="color: #40a070">0</span>, y)) <span style="color: #666666">&lt;$&gt;</span> getActiveCellY
      liftIO <span style="color: #666666">$</span> showInGrid
                 xUpperLeft
                 yUpperLeft
                 columnCount
                 columnWidth
                 activeCellCoords
                 (map (<span style="color: #06287e">\</span>row <span style="color: #007020; font-weight: bold">-&gt;</span> [smth row]) rows)
      log <span style="color: #4070a0">&quot;updated rows&quot;</span>

    activeCellYListener <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">EditableListApp</span> <span style="color: #007020">()</span>
    activeCellYListener activeCellY <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
      <span style="color: #007020; font-weight: bold">let</span> activeCellCoords <span style="color: #007020; font-weight: bold">=</span> fmap (<span style="color: #06287e">\</span>y <span style="color: #007020; font-weight: bold">-&gt;</span> (<span style="color: #40a070">0</span>, y)) activeCellY
      liftIO <span style="color: #666666">$</span> drawGrid xUpperLeft yUpperLeft columnWidth columnCount rowCount
      <span style="color: #007020; font-weight: bold">case</span> activeCellCoords <span style="color: #007020; font-weight: bold">of</span>
        <span style="color: #902000">Nothing</span> <span style="color: #007020; font-weight: bold">-&gt;</span> return <span style="color: #007020">()</span>
        <span style="color: #902000">Just</span> coordsPair <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span>
          liftIO <span style="color: #666666">$</span> highlightCell xUpperLeft yUpperLeft columnWidth columnCount rowCount coordsPair
          log <span style="color: #4070a0">&quot;highlighted cell&quot;</span>

    debugMessagesListener <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">String</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">EditableListApp</span> <span style="color: #007020">()</span>
    debugMessagesListener debugMessages <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
      liftIO <span style="color: #666666">$</span> printFromBottom
                 xUpperLeft
                 (yUpperLeft<span style="color: #666666">+</span><span style="color: #40a070">12</span><span style="color: #666666">+</span>debugLinesCount)
                 debugMessages
</div>

<div id="source---operational-style---loop" style="display: inline-block;"
>    loop <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">EditableListApp</span> <span style="color: #007020">()</span>
    loop <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
      key <span style="color: #007020; font-weight: bold">&lt;-</span> liftIO <span style="color: #666666">$</span> getKey
      when (key <span style="color: #666666">/=</span> <span style="color: #4070a0">&quot;</span><span style="color: #4070a0; font-weight: bold">\ESC</span><span style="color: #4070a0">&quot;</span>) <span style="color: #666666">$</span> <span style="color: #007020; font-weight: bold">do</span>
        <span style="color: #007020; font-weight: bold">case</span> key <span style="color: #007020; font-weight: bold">of</span>
          <span style="color: #4070a0">&quot;</span><span style="color: #4070a0; font-weight: bold">\ESC</span><span style="color: #4070a0">[A&quot;</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span> <span style="color: #60a0b0; font-style: italic">-- up</span>
              activeCellY <span style="color: #007020; font-weight: bold">&lt;-</span> getActiveCellY
              <span style="color: #007020; font-weight: bold">let</span>
                newActiveCellY <span style="color: #007020; font-weight: bold">=</span>
                  <span style="color: #007020; font-weight: bold">case</span> activeCellY <span style="color: #007020; font-weight: bold">of</span>
                    <span style="color: #902000">Just</span> y <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Just</span> <span style="color: #666666">$</span> max <span style="color: #40a070">0</span> (y<span style="color: #666666">-</span><span style="color: #40a070">1</span>)
                    <span style="color: #902000">Nothing</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Just</span> <span style="color: #40a070">0</span>
              updateActiveCellY newActiveCellY
              log <span style="color: #666666">$</span> <span style="color: #4070a0">&quot;up, &quot;</span> <span style="color: #666666">++</span> show(newActiveCellY)
              loop
</div>
          <span style="color: #4070a0">&quot;</span><span style="color: #4070a0; font-weight: bold">\ESC</span><span style="color: #4070a0">[B&quot;</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span> <span style="color: #60a0b0; font-style: italic">-- down</span>
              activeCellY <span style="color: #007020; font-weight: bold">&lt;-</span> getActiveCellY
              <span style="color: #007020; font-weight: bold">let</span>
                newActiveCellY <span style="color: #007020; font-weight: bold">=</span>
                  <span style="color: #007020; font-weight: bold">case</span> activeCellY <span style="color: #007020; font-weight: bold">of</span>
                    <span style="color: #902000">Just</span> y <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Just</span> <span style="color: #666666">$</span> min (rowCount<span style="color: #666666">-</span><span style="color: #40a070">1</span>) (y<span style="color: #666666">+</span><span style="color: #40a070">1</span>)
                    <span style="color: #902000">Nothing</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Just</span> <span style="color: #40a070">0</span>
              updateActiveCellY newActiveCellY
              log <span style="color: #666666">$</span> <span style="color: #4070a0">&quot;down, &quot;</span> <span style="color: #666666">++</span> show(newActiveCellY)
              loop
          <span style="color: #4070a0">&quot;</span><span style="color: #4070a0; font-weight: bold">\n</span><span style="color: #4070a0">&quot;</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span> <span style="color: #60a0b0; font-style: italic">-- enter</span>
              activeCellY <span style="color: #007020; font-weight: bold">&lt;-</span> getActiveCellY
              rows <span style="color: #007020; font-weight: bold">&lt;-</span> getList
                
              <span style="color: #007020; font-weight: bold">let</span> 
                  eitherValue <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Either</span> <span style="color: #902000">String</span> <span style="color: #902000">String</span>
                  eitherValue <span style="color: #007020; font-weight: bold">=</span>
                    <span style="color: #007020; font-weight: bold">case</span> activeCellY <span style="color: #007020; font-weight: bold">of</span>
                      <span style="color: #902000">Nothing</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Left</span> <span style="color: #4070a0">&quot;there&#39;s no selected cell&quot;</span>
                      <span style="color: #902000">Just</span> cellIndex <span style="color: #007020; font-weight: bold">-&gt;</span>
                        <span style="color: #007020; font-weight: bold">if</span> cellIndex <span style="color: #666666">&lt;</span> <span style="color: #40a070">0</span> <span style="color: #666666">||</span> cellIndex <span style="color: #666666">&gt;=</span> (length rows)
                          <span style="color: #007020; font-weight: bold">then</span> <span style="color: #902000">Left</span> <span style="color: #666666">$</span> <span style="color: #4070a0">&quot;index out of bounds: &quot;</span> <span style="color: #666666">++</span> (show cellIndex)
                          <span style="color: #007020; font-weight: bold">else</span> <span style="color: #902000">Right</span> <span style="color: #666666">$</span> smth <span style="color: #666666">$</span> rows <span style="color: #666666">!!</span> cellIndex

                  showEditField <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">String</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">EditableListApp</span> <span style="color: #007020">()</span>
                  showEditField value <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
                    <span style="color: #007020; font-weight: bold">let</span>
                      txt <span style="color: #007020; font-weight: bold">=</span> <span style="color: #4070a0">&quot;edit cell value:&quot;</span>
                      lentxt <span style="color: #007020; font-weight: bold">=</span> length txt
                      yPos <span style="color: #007020; font-weight: bold">=</span> <span style="color: #40a070">0</span>
                      xPos <span style="color: #007020; font-weight: bold">=</span> (columnCount <span style="color: #666666">*</span> (columnWidth <span style="color: #666666">+</span> <span style="color: #40a070">1</span>)) <span style="color: #666666">+</span> <span style="color: #40a070">3</span>
                      replaceNth lst idx val <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">if</span> idx <span style="color: #666666">&lt;</span> <span style="color: #40a070">1</span> <span style="color: #007020; font-weight: bold">then</span> val<span style="color: #902000">:</span>(tail lst) <span style="color: #007020; font-weight: bold">else</span> (head lst) <span style="color: #902000">:</span> (replaceNth (tail lst) (idx <span style="color: #666666">-</span> <span style="color: #40a070">1</span>) val)
                    liftIO <span style="color: #666666">$</span> showInRectangle xPos yPos lentxt [txt, value]
                    key <span style="color: #007020; font-weight: bold">&lt;-</span> liftIO <span style="color: #666666">$</span> getKey
                    <span style="color: #007020; font-weight: bold">case</span> key <span style="color: #007020; font-weight: bold">of</span>
                      <span style="color: #4070a0">&quot;</span><span style="color: #4070a0; font-weight: bold">\n</span><span style="color: #4070a0">&quot;</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span>
                        <span style="color: #007020; font-weight: bold">case</span> activeCellY <span style="color: #007020; font-weight: bold">of</span>
                          <span style="color: #902000">Nothing</span> <span style="color: #007020; font-weight: bold">-&gt;</span> return <span style="color: #007020">()</span>
                          <span style="color: #902000">Just</span> cellIndex <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span>
                            liftIO <span style="color: #666666">$</span> clearRectangle xPos yPos lentxt <span style="color: #40a070">2</span>
                            rows <span style="color: #007020; font-weight: bold">&lt;-</span> getList
                            updateList <span style="color: #666666">$</span> replaceNth rows cellIndex (<span style="color: #902000">Row</span> value)
                            loop
                      <span style="color: #4070a0">&quot;</span><span style="color: #4070a0; font-weight: bold">\DEL</span><span style="color: #4070a0">&quot;</span> <span style="color: #007020; font-weight: bold">-&gt;</span> showEditField (<span style="color: #007020; font-weight: bold">if</span> (length value) <span style="color: #666666">==</span> <span style="color: #40a070">0</span> <span style="color: #007020; font-weight: bold">then</span> value <span style="color: #007020; font-weight: bold">else</span> init value)
                      c <span style="color: #007020; font-weight: bold">-&gt;</span> showEditField (value <span style="color: #666666">++</span> c)
              <span style="color: #007020; font-weight: bold">case</span> eitherValue <span style="color: #007020; font-weight: bold">of</span>
                <span style="color: #902000">Left</span> e <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span>
                  log <span style="color: #666666">$</span> <span style="color: #4070a0">&quot;error: &quot;</span> <span style="color: #666666">++</span> (show e)
                  loop
                <span style="color: #902000">Right</span> v <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span>
                  showEditField v
          <span style="color: #4070a0">&quot;q&quot;</span> <span style="color: #007020; font-weight: bold">-&gt;</span> return <span style="color: #007020">()</span>
          <span style="color: #007020; font-weight: bold">_</span> <span style="color: #007020; font-weight: bold">-&gt;</span> return <span style="color: #007020">()</span>

<span style="color: #06287e">getKey</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">IO</span> [<span style="color: #902000">Char</span>]
<span style="color: #06287e">getKey</span> <span style="color: #007020; font-weight: bold">=</span> reverse <span style="color: #666666">&lt;$&gt;</span> getKey&#39; <span style="color: #4070a0">&quot;&quot;</span>
  <span style="color: #007020; font-weight: bold">where</span>
  getKey&#39; chars <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
    char <span style="color: #007020; font-weight: bold">&lt;-</span> getChar
    more <span style="color: #007020; font-weight: bold">&lt;-</span> hReady stdin
    (<span style="color: #007020; font-weight: bold">if</span> more <span style="color: #007020; font-weight: bold">then</span> getKey&#39; <span style="color: #007020; font-weight: bold">else</span> return) (char<span style="color: #902000">:</span>chars)
</pre></div> <!-- end of source operational-style main -->













<!-- HTML generated using hilite.me --><div id="source---freer---main" style="display: none; background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #60a0b0; font-style: italic">{-# LANGUAGE GeneralizedNewtypeDeriving #-}</span>
<span style="color: #60a0b0; font-style: italic">{-# LANGUAGE FlexibleInstances #-}</span>
<span style="color: #60a0b0; font-style: italic">{-# LANGUAGE GADTs #-}</span>
<span style="color: #007020; font-weight: bold">module</span> <span style="color: #0e84b5; font-weight: bold">Main</span> <span style="color: #007020; font-weight: bold">where</span>

<span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">Control.Monad</span> (<span style="color: #06287e">when</span>, <span style="color: #06287e">forM_</span>)
<span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">Control.Exception</span> (<span style="color: #06287e">try</span>)
<span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">System.IO</span> (<span style="color: #06287e">stdin</span>, <span style="color: #06287e">stdout</span>, <span style="color: #06287e">hSetEcho</span>, <span style="color: #06287e">hSetBuffering</span>, <span style="color: #06287e">hReady</span>, <span style="color: #902000">BufferMode</span> (<span style="color: #902000">NoBuffering</span>) )
<span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">Control.Monad.State.Strict</span> (<span style="color: #902000">StateT</span>, <span style="color: #06287e">get</span>, <span style="color: #06287e">modify</span>, <span style="color: #06287e">runStateT</span>)
<span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">Control.Monad.IO.Class</span> (<span style="color: #902000">MonadIO</span>, <span style="color: #06287e">liftIO</span>)
<span style="color: #007020; font-weight: bold">import</span> <span style="color: #007020; font-weight: bold">qualified</span> <span style="color: #0e84b5; font-weight: bold">Data.Map</span> <span style="color: #007020; font-weight: bold">as</span> Map
<span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">ViewUtils</span> (<span style="color: #06287e">clearScreen</span>, <span style="color: #06287e">showInRectangle</span>, <span style="color: #06287e">clearRectangle</span>, <span style="color: #06287e">showInGrid</span>, <span style="color: #06287e">drawGrid</span>, <span style="color: #06287e">highlightCell</span>, <span style="color: #06287e">printFromBottom</span>)
<span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">FreerProgram</span> (<span style="color: #902000">Program</span>(<span style="color: #666666">..</span>), <span style="color: #06287e">foldFreer</span>)
<span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">Prelude</span> <span style="color: #007020; font-weight: bold">hiding</span> (<span style="color: #06287e">log</span>)

<span style="color: #007020; font-weight: bold">data</span> <span style="color: #902000">RowData</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">Row</span> { smth <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">String</span> } <span style="color: #007020; font-weight: bold">deriving</span> <span style="color: #902000">Eq</span>

<span style="color: #06287e">initialRows</span> <span style="color: #007020; font-weight: bold">=</span> [
  <span style="color: #902000">Row</span> <span style="color: #4070a0">&quot;something a&quot;</span>
  , <span style="color: #902000">Row</span> <span style="color: #4070a0">&quot;something b&quot;</span>
  , <span style="color: #902000">Row</span> <span style="color: #4070a0">&quot;something c&quot;</span>
  , <span style="color: #902000">Row</span> <span style="color: #4070a0">&quot;something d&quot;</span>
  , <span style="color: #902000">Row</span> <span style="color: #4070a0">&quot;something e&quot;</span>
  ]

<span style="color: #007020; font-weight: bold">data</span> <span style="color: #902000">AppStateData</span> m <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">AppState</span>
  { rows <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">RowData</span>]
  , activeCellY <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span>
  , debugMessages <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">String</span>]
  , listeners <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">AppStateListenersData</span> m
  }

<span style="color: #007020; font-weight: bold">data</span> <span style="color: #902000">AppStateListenersData</span> m <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">AppStateListeners</span>
  { rowsListeners <span style="color: #007020; font-weight: bold">::</span> [[<span style="color: #902000">RowData</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>]
  , activeCellYListeners <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span> <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>]
  , debugMessagesListeners <span style="color: #007020; font-weight: bold">::</span> [[<span style="color: #902000">String</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>]
  }

<span style="color: #06287e">addRowsListener</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Monad</span> m <span style="color: #007020; font-weight: bold">=&gt;</span> ([<span style="color: #902000">RowData</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>) <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span> m <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span> m
<span style="color: #06287e">addRowsListener</span> listener (<span style="color: #902000">AppStateListeners</span> rowsListeners _activeCellYListeners _debugMessagesListeners) <span style="color: #007020; font-weight: bold">=</span>
  <span style="color: #902000">AppStateListeners</span> (listener<span style="color: #902000">:</span>rowsListeners) _activeCellYListeners _debugMessagesListeners

<span style="color: #06287e">addActiveCellYListener</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Monad</span> m <span style="color: #007020; font-weight: bold">=&gt;</span> (<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span> <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>) <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span> m <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span> m
<span style="color: #06287e">addActiveCellYListener</span> listener (<span style="color: #902000">AppStateListeners</span> _rowsListeners activeCellYListeners _debugMessagesListeners) <span style="color: #007020; font-weight: bold">=</span>
  <span style="color: #902000">AppStateListeners</span> _rowsListeners (listener<span style="color: #902000">:</span>activeCellYListeners) _debugMessagesListeners

<span style="color: #06287e">addDebugMessagesListener</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Monad</span> m <span style="color: #007020; font-weight: bold">=&gt;</span> ([<span style="color: #902000">String</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>) <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span> m <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span> m
<span style="color: #06287e">addDebugMessagesListener</span> listener (<span style="color: #902000">AppStateListeners</span> _rowsListeners _activeCellYListeners debugMessagesListeners) <span style="color: #007020; font-weight: bold">=</span>
  <span style="color: #902000">AppStateListeners</span> _rowsListeners _activeCellYListeners (listener<span style="color: #902000">:</span>debugMessagesListeners)


<div id="source---freer---operations-as-gadt" style="display: inline-block;"
><span style="color: #007020; font-weight: bold">data</span> <span style="color: #902000">EditableListAppI</span> a <span style="color: #007020; font-weight: bold">where</span>
<div id="source---freer---getters-in-gadt" style="display: inline-block;"
>  <span style="color: #902000">GetList</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">EditableListAppI</span> [<span style="color: #902000">RowData</span>]
  <span style="color: #902000">GetActiveCellY</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">EditableListAppI</span> (<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span>)
  <span style="color: #902000">GetLogs</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">EditableListAppI</span> [<span style="color: #902000">String</span>]
</div>

<div id="source---freer---setters-in-gadt" style="display: inline-block;"
>  <span style="color: #902000">UpdateList</span> <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">RowData</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">EditableListAppI</span> <span style="color: #007020">()</span>
  <span style="color: #902000">UpdateActiveCellY</span> <span style="color: #007020; font-weight: bold">::</span> (<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span>) <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">EditableListAppI</span> <span style="color: #007020">()</span>
  <span style="color: #902000">Log</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">String</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">EditableListAppI</span> <span style="color: #007020">()</span>
</div>

  <span style="color: #902000">LiftIO</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">IO</span> b <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">EditableListAppI</span> b
</div>

<div id="source---freer---smart-constructors" style="display: inline-block;"
><span style="color: #06287e">getList</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Program</span> <span style="color: #902000">EditableListAppI</span> [<span style="color: #902000">RowData</span>]
<span style="color: #06287e">getList</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">Instr</span> <span style="color: #666666">$</span> <span style="color: #902000">GetList</span>

<span style="color: #06287e">getActiveCellY</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Program</span> <span style="color: #902000">EditableListAppI</span> (<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span>)
<span style="color: #06287e">getActiveCellY</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">Instr</span> <span style="color: #666666">$</span> <span style="color: #902000">GetActiveCellY</span>

<span style="color: #06287e">getLogs</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Program</span> <span style="color: #902000">EditableListAppI</span> [<span style="color: #902000">String</span>]
<span style="color: #06287e">getLogs</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">Instr</span> <span style="color: #666666">$</span> <span style="color: #902000">GetLogs</span>

<span style="color: #06287e">updateList</span> <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">RowData</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Program</span> <span style="color: #902000">EditableListAppI</span> <span style="color: #007020">()</span>
<span style="color: #06287e">updateList</span> x <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">Instr</span> <span style="color: #666666">.</span> <span style="color: #902000">UpdateList</span> <span style="color: #666666">$</span> x

<span style="color: #06287e">updateActiveCellY</span> <span style="color: #007020; font-weight: bold">::</span> (<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span>) <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Program</span> <span style="color: #902000">EditableListAppI</span> <span style="color: #007020">()</span>
<span style="color: #06287e">updateActiveCellY</span> y <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">Instr</span> <span style="color: #666666">.</span> <span style="color: #902000">UpdateActiveCellY</span> <span style="color: #666666">$</span> y

<span style="color: #06287e">log</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">String</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Program</span> <span style="color: #902000">EditableListAppI</span> <span style="color: #007020">()</span>
<span style="color: #06287e">log</span> msg <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">Instr</span> <span style="color: #666666">.</span> <span style="color: #902000">Log</span> <span style="color: #666666">$</span> msg
</div>

<div id="source---freer---monadio-instance" style="display: inline-block;"
><span style="color: #007020; font-weight: bold">instance</span> <span style="color: #902000">MonadIO</span> (<span style="color: #902000">Program</span> <span style="color: #902000">EditableListAppI</span>) <span style="color: #007020; font-weight: bold">where</span>
  liftIO <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">Instr</span> <span style="color: #666666">.</span> <span style="color: #902000">LiftIO</span>
</div>

<div id="source---freer---target-monad" style="display: inline-block;"
><span style="color: #007020; font-weight: bold">newtype</span> <span style="color: #902000">StateHolder</span> a <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">StateHolder</span> (<span style="color: #902000">StateT</span> (<span style="color: #902000">AppStateData</span> <span style="color: #902000">StateHolder</span>) <span style="color: #902000">IO</span> a)
  <span style="color: #007020; font-weight: bold">deriving</span> (<span style="color: #902000">Functor</span>, <span style="color: #902000">Applicative</span>, <span style="color: #902000">Monad</span>, <span style="color: #902000">MonadIO</span>)
</div>

<div id="source---freer---interpreter-function" style="display: inline-block;"
><span style="color: #06287e">interpret&#39;</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">EditableListAppI</span> a <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">StateHolder</span> a
<span style="color: #06287e">interpret&#39;</span> <span style="color: #902000">GetList</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> rows <span style="color: #666666">&lt;$&gt;</span> get
<span style="color: #06287e">interpret&#39;</span> <span style="color: #902000">GetActiveCellY</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> activeCellY <span style="color: #666666">&lt;$&gt;</span> get
<span style="color: #06287e">interpret&#39;</span> <span style="color: #902000">GetLogs</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> debugMessages <span style="color: #666666">&lt;$&gt;</span> get

<span style="color: #06287e">interpret&#39;</span> (<span style="color: #902000">UpdateList</span> l) <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
  <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> modify <span style="color: #666666">$</span> <span style="color: #06287e">\</span>s <span style="color: #007020; font-weight: bold">-&gt;</span> s { rows <span style="color: #007020; font-weight: bold">=</span> l }
  reacts <span style="color: #007020; font-weight: bold">&lt;-</span> <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> (rowsListeners <span style="color: #666666">.</span> listeners) <span style="color: #666666">&lt;$&gt;</span> get
  forM_ reacts (<span style="color: #666666">$</span> l) <span style="color: #60a0b0; font-style: italic">-- same as forM_ reacts $ \react -&gt; react l</span>
<span style="color: #06287e">interpret&#39;</span> (<span style="color: #902000">UpdateActiveCellY</span> y) <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
  <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> modify <span style="color: #666666">$</span> <span style="color: #06287e">\</span>s <span style="color: #007020; font-weight: bold">-&gt;</span> s { activeCellY <span style="color: #007020; font-weight: bold">=</span> y }
  s <span style="color: #007020; font-weight: bold">&lt;-</span> <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> get
  <span style="color: #007020; font-weight: bold">let</span> reacts <span style="color: #007020; font-weight: bold">=</span> activeCellYListeners (listeners s)
  forM_ reacts (<span style="color: #666666">$</span> y) <span style="color: #60a0b0; font-style: italic">-- same as forM_ reacts $ \react -&gt; react y</span>
<span style="color: #06287e">interpret&#39;</span> (<span style="color: #902000">Log</span> msg) <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
  <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> modify <span style="color: #666666">$</span> <span style="color: #06287e">\</span>s <span style="color: #007020; font-weight: bold">-&gt;</span> s { debugMessages <span style="color: #007020; font-weight: bold">=</span> take debugLinesCount (msg<span style="color: #902000">:</span>(debugMessages s)) }
  logs <span style="color: #007020; font-weight: bold">&lt;-</span> <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> debugMessages <span style="color: #666666">&lt;$&gt;</span> get
  reacts <span style="color: #007020; font-weight: bold">&lt;-</span> <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> (debugMessagesListeners <span style="color: #666666">.</span> listeners) <span style="color: #666666">&lt;$&gt;</span> get
  forM_ reacts (<span style="color: #666666">$</span> logs) <span style="color: #60a0b0; font-style: italic">-- same as forM_ reacts $ \react -&gt; react logs</span>
<span style="color: #06287e">interpret&#39;</span> (<span style="color: #902000">LiftIO</span> a) <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
  v <span style="color: #007020; font-weight: bold">&lt;-</span> liftIO a
  return v

<span style="color: #06287e">interpret</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Program</span> <span style="color: #902000">EditableListAppI</span> a <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">StateHolder</span> a
<span style="color: #06287e">interpret</span> <span style="color: #007020; font-weight: bold">=</span> foldFreer interpret&#39;
</div>

<span style="color: #06287e">performStateAction</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">AppStateData</span> <span style="color: #902000">StateHolder</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">StateHolder</span> a <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">IO</span> <span style="color: #007020">()</span>
<span style="color: #06287e">performStateAction</span> state (<span style="color: #902000">StateHolder</span> action) <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
  runStateT action state
  return <span style="color: #007020">()</span>

<span style="color: #06287e">debugLinesCount</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #40a070">20</span>

<span style="color: #06287e">main</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">IO</span> <span style="color: #007020">()</span>
<span style="color: #06287e">main</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
  hSetBuffering stdin <span style="color: #902000">NoBuffering</span>
  hSetBuffering stdout <span style="color: #902000">NoBuffering</span>
  hSetEcho stdin <span style="color: #902000">False</span>
  clearScreen
  <span style="color: #60a0b0; font-style: italic">--performStateAction initialState (interpret (do ...))</span>
  performStateAction initialState <span style="color: #666666">$</span> interpret <span style="color: #666666">$</span> <span style="color: #007020; font-weight: bold">do</span>
    initRows
    loop
  <span style="color: #007020; font-weight: bold">where</span>
    xUpperLeft <span style="color: #007020; font-weight: bold">=</span> <span style="color: #40a070">0</span>
    yUpperLeft <span style="color: #007020; font-weight: bold">=</span> <span style="color: #40a070">0</span>
    columnCount <span style="color: #007020; font-weight: bold">=</span> <span style="color: #40a070">1</span>
    columnWidth <span style="color: #007020; font-weight: bold">=</span> <span style="color: #40a070">14</span>
    rowCount <span style="color: #007020; font-weight: bold">=</span> length initialRows

    initialState <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">AppStateData</span> <span style="color: #902000">StateHolder</span>
    initialState <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">AppState</span> <span style="color: #902000">[]</span> <span style="color: #902000">Nothing</span> <span style="color: #902000">[]</span> initListeners

    initRows <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Program</span> <span style="color: #902000">EditableListAppI</span> <span style="color: #007020">()</span>
    initRows <span style="color: #007020; font-weight: bold">=</span> updateList initialRows

    initListeners <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">AppStateListenersData</span> <span style="color: #902000">StateHolder</span>
    <span style="color: #60a0b0; font-style: italic">-- initListeners =</span>
    <span style="color: #60a0b0; font-style: italic">--     addRowsListener (interpret . mainRowsListener)</span>
    <span style="color: #60a0b0; font-style: italic">--     (addActiveCellYListener (interpret . activeCellYListener)</span>
    <span style="color: #60a0b0; font-style: italic">--     (addDebugMessagesListener (interpret . debugMessagesListener)</span>
    <span style="color: #60a0b0; font-style: italic">--     (empty)))</span>
    initListeners <span style="color: #007020; font-weight: bold">=</span>
        addRowsListener (interpret <span style="color: #666666">.</span> mainRowsListener)
        <span style="color: #666666">$</span> addActiveCellYListener (interpret <span style="color: #666666">.</span> activeCellYListener)
        <span style="color: #666666">$</span> addDebugMessagesListener (interpret <span style="color: #666666">.</span> debugMessagesListener)
        <span style="color: #666666">$</span> empty
      <span style="color: #007020; font-weight: bold">where</span>
        empty <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">AppStateListeners</span> <span style="color: #902000">[]</span> <span style="color: #902000">[]</span> <span style="color: #902000">[]</span>

    <div class="source---freer---type-signatures-of-listeners-and-loop" style="display: inline;">mainRowsListener <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">RowData</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Program</span> <span style="color: #902000">EditableListAppI</span> <span style="color: #007020">()</span></div>
    mainRowsListener rows <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
      activeCellCoords <span style="color: #007020; font-weight: bold">&lt;-</span> fmap (<span style="color: #06287e">\</span>y <span style="color: #007020; font-weight: bold">-&gt;</span> (<span style="color: #40a070">0</span>, y)) <span style="color: #666666">&lt;$&gt;</span> getActiveCellY
      liftIO <span style="color: #666666">$</span> showInGrid
                 xUpperLeft
                 yUpperLeft
                 columnCount
                 columnWidth
                 activeCellCoords
                 (map (<span style="color: #06287e">\</span>row <span style="color: #007020; font-weight: bold">-&gt;</span> [smth row]) rows)
      log <span style="color: #4070a0">&quot;updated rows&quot;</span>

    <div class="source---freer---type-signatures-of-listeners-and-loop" style="display: inline;">activeCellYListener <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Program</span> <span style="color: #902000">EditableListAppI</span> <span style="color: #007020">()</span></div>
    activeCellYListener activeCellY <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
      <span style="color: #007020; font-weight: bold">let</span> activeCellCoords <span style="color: #007020; font-weight: bold">=</span> fmap (<span style="color: #06287e">\</span>y <span style="color: #007020; font-weight: bold">-&gt;</span> (<span style="color: #40a070">0</span>, y)) activeCellY
      liftIO <span style="color: #666666">$</span> drawGrid xUpperLeft yUpperLeft columnWidth columnCount rowCount
      <span style="color: #007020; font-weight: bold">case</span> activeCellCoords <span style="color: #007020; font-weight: bold">of</span>
        <span style="color: #902000">Nothing</span> <span style="color: #007020; font-weight: bold">-&gt;</span> return <span style="color: #007020">()</span>
        <span style="color: #902000">Just</span> coordsPair <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span>
          liftIO <span style="color: #666666">$</span> highlightCell xUpperLeft yUpperLeft columnWidth columnCount rowCount coordsPair
          log <span style="color: #4070a0">&quot;highlighted cell&quot;</span>

    <div class="source---freer---type-signatures-of-listeners-and-loop" style="display: inline;">debugMessagesListener <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">String</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Program</span> <span style="color: #902000">EditableListAppI</span> <span style="color: #007020">()</span></div>
    debugMessagesListener debugMessages <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
      liftIO <span style="color: #666666">$</span> printFromBottom
                 xUpperLeft
                 (yUpperLeft<span style="color: #666666">+</span><span style="color: #40a070">12</span><span style="color: #666666">+</span>debugLinesCount)
                 debugMessages

    <div class="source---freer---type-signatures-of-listeners-and-loop" style="display: inline;">loop <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Program</span> <span style="color: #902000">EditableListAppI</span> <span style="color: #007020">()</span></div>
    loop <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
      key <span style="color: #007020; font-weight: bold">&lt;-</span> liftIO <span style="color: #666666">$</span> getKey
      when (key <span style="color: #666666">/=</span> <span style="color: #4070a0">&quot;</span><span style="color: #4070a0; font-weight: bold">\ESC</span><span style="color: #4070a0">&quot;</span>) <span style="color: #666666">$</span> <span style="color: #007020; font-weight: bold">do</span>
        <span style="color: #007020; font-weight: bold">case</span> key <span style="color: #007020; font-weight: bold">of</span>
          <span style="color: #4070a0">&quot;</span><span style="color: #4070a0; font-weight: bold">\ESC</span><span style="color: #4070a0">[A&quot;</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span> <span style="color: #60a0b0; font-style: italic">-- up</span>
              activeCellY <span style="color: #007020; font-weight: bold">&lt;-</span> getActiveCellY
              <span style="color: #007020; font-weight: bold">let</span>
                newActiveCellY <span style="color: #007020; font-weight: bold">=</span>
                  <span style="color: #007020; font-weight: bold">case</span> activeCellY <span style="color: #007020; font-weight: bold">of</span>
                    <span style="color: #902000">Just</span> y <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Just</span> <span style="color: #666666">$</span> max <span style="color: #40a070">0</span> (y<span style="color: #666666">-</span><span style="color: #40a070">1</span>)
                    <span style="color: #902000">Nothing</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Just</span> <span style="color: #40a070">0</span>
              updateActiveCellY newActiveCellY
              log <span style="color: #666666">$</span> <span style="color: #4070a0">&quot;up, &quot;</span> <span style="color: #666666">++</span> show(newActiveCellY)
              loop
          <span style="color: #4070a0">&quot;</span><span style="color: #4070a0; font-weight: bold">\ESC</span><span style="color: #4070a0">[B&quot;</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span> <span style="color: #60a0b0; font-style: italic">-- down</span>
              activeCellY <span style="color: #007020; font-weight: bold">&lt;-</span> getActiveCellY
              <span style="color: #007020; font-weight: bold">let</span>
                newActiveCellY <span style="color: #007020; font-weight: bold">=</span>
                  <span style="color: #007020; font-weight: bold">case</span> activeCellY <span style="color: #007020; font-weight: bold">of</span>
                    <span style="color: #902000">Just</span> y <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Just</span> <span style="color: #666666">$</span> min (rowCount<span style="color: #666666">-</span><span style="color: #40a070">1</span>) (y<span style="color: #666666">+</span><span style="color: #40a070">1</span>)
                    <span style="color: #902000">Nothing</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Just</span> <span style="color: #40a070">0</span>
              updateActiveCellY newActiveCellY
              log <span style="color: #666666">$</span> <span style="color: #4070a0">&quot;down, &quot;</span> <span style="color: #666666">++</span> show(newActiveCellY)
              loop
          <span style="color: #4070a0">&quot;</span><span style="color: #4070a0; font-weight: bold">\n</span><span style="color: #4070a0">&quot;</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span> <span style="color: #60a0b0; font-style: italic">-- enter</span>
              activeCellY <span style="color: #007020; font-weight: bold">&lt;-</span> getActiveCellY
              rows <span style="color: #007020; font-weight: bold">&lt;-</span> getList
                
              <span style="color: #007020; font-weight: bold">let</span> 
                  eitherValue <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Either</span> <span style="color: #902000">String</span> <span style="color: #902000">String</span>
                  eitherValue <span style="color: #007020; font-weight: bold">=</span>
                    <span style="color: #007020; font-weight: bold">case</span> activeCellY <span style="color: #007020; font-weight: bold">of</span>
                      <span style="color: #902000">Nothing</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Left</span> <span style="color: #4070a0">&quot;there&#39;s no selected cell&quot;</span>
                      <span style="color: #902000">Just</span> cellIndex <span style="color: #007020; font-weight: bold">-&gt;</span>
                        <span style="color: #007020; font-weight: bold">if</span> cellIndex <span style="color: #666666">&lt;</span> <span style="color: #40a070">0</span> <span style="color: #666666">||</span> cellIndex <span style="color: #666666">&gt;=</span> (length rows)
                          <span style="color: #007020; font-weight: bold">then</span> <span style="color: #902000">Left</span> <span style="color: #666666">$</span> <span style="color: #4070a0">&quot;index out of bounds: &quot;</span> <span style="color: #666666">++</span> (show cellIndex)
                          <span style="color: #007020; font-weight: bold">else</span> <span style="color: #902000">Right</span> <span style="color: #666666">$</span> smth <span style="color: #666666">$</span> rows <span style="color: #666666">!!</span> cellIndex

                  showEditField <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">String</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Program</span> <span style="color: #902000">EditableListAppI</span> <span style="color: #007020">()</span>
                  showEditField value <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
                    <span style="color: #007020; font-weight: bold">let</span>
                      txt <span style="color: #007020; font-weight: bold">=</span> <span style="color: #4070a0">&quot;edit cell value:&quot;</span>
                      lentxt <span style="color: #007020; font-weight: bold">=</span> length txt
                      yPos <span style="color: #007020; font-weight: bold">=</span> <span style="color: #40a070">0</span>
                      xPos <span style="color: #007020; font-weight: bold">=</span> (columnCount <span style="color: #666666">*</span> (columnWidth <span style="color: #666666">+</span> <span style="color: #40a070">1</span>)) <span style="color: #666666">+</span> <span style="color: #40a070">3</span>
                      replaceNth lst idx val <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">if</span> idx <span style="color: #666666">&lt;</span> <span style="color: #40a070">1</span> <span style="color: #007020; font-weight: bold">then</span> val<span style="color: #902000">:</span>(tail lst) <span style="color: #007020; font-weight: bold">else</span> (head lst) <span style="color: #902000">:</span> (replaceNth (tail lst) (idx <span style="color: #666666">-</span> <span style="color: #40a070">1</span>) val)
                    liftIO <span style="color: #666666">$</span> showInRectangle xPos yPos lentxt [txt, value]
                    key <span style="color: #007020; font-weight: bold">&lt;-</span> liftIO <span style="color: #666666">$</span> getKey
                    <span style="color: #007020; font-weight: bold">case</span> key <span style="color: #007020; font-weight: bold">of</span>
                      <span style="color: #4070a0">&quot;</span><span style="color: #4070a0; font-weight: bold">\n</span><span style="color: #4070a0">&quot;</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span>
                        <span style="color: #007020; font-weight: bold">case</span> activeCellY <span style="color: #007020; font-weight: bold">of</span>
                          <span style="color: #902000">Nothing</span> <span style="color: #007020; font-weight: bold">-&gt;</span> return <span style="color: #007020">()</span>
                          <span style="color: #902000">Just</span> cellIndex <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span>
                            liftIO <span style="color: #666666">$</span> clearRectangle xPos yPos lentxt <span style="color: #40a070">2</span>
                            rows <span style="color: #007020; font-weight: bold">&lt;-</span> getList
                            updateList <span style="color: #666666">$</span> replaceNth rows cellIndex (<span style="color: #902000">Row</span> value)
                            loop
                      <span style="color: #4070a0">&quot;</span><span style="color: #4070a0; font-weight: bold">\DEL</span><span style="color: #4070a0">&quot;</span> <span style="color: #007020; font-weight: bold">-&gt;</span> showEditField (<span style="color: #007020; font-weight: bold">if</span> (length value) <span style="color: #666666">==</span> <span style="color: #40a070">0</span> <span style="color: #007020; font-weight: bold">then</span> value <span style="color: #007020; font-weight: bold">else</span> init value)
                      c <span style="color: #007020; font-weight: bold">-&gt;</span> showEditField (value <span style="color: #666666">++</span> c)
              <span style="color: #007020; font-weight: bold">case</span> eitherValue <span style="color: #007020; font-weight: bold">of</span>
                <span style="color: #902000">Left</span> e <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span>
                  log <span style="color: #666666">$</span> <span style="color: #4070a0">&quot;error: &quot;</span> <span style="color: #666666">++</span> (show e)
                  loop
                <span style="color: #902000">Right</span> v <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span>
                  showEditField v
          <span style="color: #4070a0">&quot;q&quot;</span> <span style="color: #007020; font-weight: bold">-&gt;</span> return <span style="color: #007020">()</span>
          <span style="color: #007020; font-weight: bold">_</span> <span style="color: #007020; font-weight: bold">-&gt;</span> return <span style="color: #007020">()</span>

<span style="color: #06287e">getKey</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">IO</span> [<span style="color: #902000">Char</span>]
<span style="color: #06287e">getKey</span> <span style="color: #007020; font-weight: bold">=</span> reverse <span style="color: #666666">&lt;$&gt;</span> getKey&#39; <span style="color: #4070a0">&quot;&quot;</span>
  <span style="color: #007020; font-weight: bold">where</span>
  getKey&#39; chars <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
    char <span style="color: #007020; font-weight: bold">&lt;-</span> getChar
    more <span style="color: #007020; font-weight: bold">&lt;-</span> hReady stdin
    (<span style="color: #007020; font-weight: bold">if</span> more <span style="color: #007020; font-weight: bold">then</span> getKey&#39; <span style="color: #007020; font-weight: bold">else</span> return) (char<span style="color: #902000">:</span>chars)
</pre></div>
<!-- end of source freer-monads main -->













    </div> <!-- end of column right -->














</body>
</html>
