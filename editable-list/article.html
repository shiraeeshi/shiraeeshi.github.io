<!DOCTYPE html>
<html>
  <head>
    <title>
      Console List GUI in Haskell
    </title>

    <style>
.column {
  float: left;
}

.left {
  width: 50%;
}

.right {
  width: 47%;
}

/* Clear floats after the columns */
.row:after {
  content: "";
  display: table;
  clear: both;
}
    </style>

    <style>

#text-wrapper, #code-wrapper {
  overflow-y: auto;
  height: 98vh;
}

#code-wrapper {
  position: relative;
  font-size: xx-small;
}

.code-fragment {
  cursor: pointer;
}

img.diagram {
  max-width: 100%;
  max-height: 100%;
  height: auto;
}

img.diagram.with-pointer {
  cursor: pointer;
}

    </style>

    <link rel="stylesheet" href="page-style.css">
    <script type="text/javascript" src="interactive-project-navigation.js"></script>
  </head>
  <body>
    <div class="row">
    <div id="text-wrapper" class="main-wrapper column left">


      <h2 class="centered">
        Console List GUI in Haskell
      </h2>

<p class="centered">
        <img src="editable-list-screen-recording.gif">
        </img>
      </p>

      <p>
Here is a question: which options do we have for designing (an architecture of) an application which shows a list of strings in console gui, allows to edit strings in an edit field that appears next to a list, and shows logs, and which design would you choose?
      </p>


      <p>
Let's play a game: there are some variations of console list application architecture listed in this article. If you come up with some new architecture, which is not listed in here, then I owe you an imaginary glass of beer. And if it is listed in the article, then you owe me one.
      </p>


      <p>
You have at your disposal functions that draw strings, rectangles and grids on the screen in console: https://gist.github.com/shiraeeshi/70e447fbbb5ae9a6ba1bf1c0c9bdd2cf
<br/>
Also the function to register key button press events is given: https://gist.github.com/shiraeeshi/6aa2055d840297b1d55fac2e11b72e12
      </p>

      <p>
You can copy-paste the above code into your project.
<br/>
Also you would need to add this dependency to the project:
<br/>
- ansi-terminal &gt;= 0.10.3
      </p>
      <p>

A more thorough definition of a program.
      </p>
      <p>

There is a list, we need to show it on screen, allow to select and edit a string.
<br/>
In order to select a string, a user presses "up" and "down" arrow keys, and then goes to edit mode by pressing "enter".
<br/>
In edit mode an edit field appears to the right of the list.
<br/>
After finishing editing, a user presses "enter" - an edit field becomes invisible, and we see a list with corresponding value refreshed.
<br/>
Below the list the logs are shown. In those logs we describe what was redrawn: whether it was the whole list, the grid or maybe a single row in a list.
      </p>
      <p>
Don't worry about adjusting the width of a list to the length of strings, you can use fixed width. Also don't worry about the height of a list or the height of the logs container, let's show 5 items in a list and you can use fixed height.
      </p>
      <p>
You can use a library or you can reinvent what the library does, it's up to you.
      </p>
      <p>
The idea of the game is that you put this article aside and start writing your version of console strings list, and after you finished that, come back to the article.
      </p>
      <p>

Good luck!
      </p>

<p class="centered section-delimiter">
      <a name="intro" class="inner-anchor grey">
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
      </a>
      </p>

      <p class="centered">
Background
      </p>
      <p>


8 months ago I wrote an article about console tetris that I wrote in haskell.
      </p>
      <p>

----------------------------------
      </p>

 <p>
(The introduction from the console-tetris article)
      </p>

 <p>
There's a tradition to print Hello World to the console when beginning learning a language. Let's call printing Hello World to the console a first level of interactivity. A next level is when a program gets an input from a user and prints the result to the console. Sounds similar to the way functions work.
      </p>

      <p>
One of the merits of a functional style is said to be the fact that functions don't produce side effects. Side effects have the potential to over-complicate the code, making it resemble a bowl of spagetti (it is called spagetti-code), and unwanted side effects are errors, bugs. When we use functions, we don't have side effects, so from the beginning we eliminate the possibility of introducing an unwanted side effect into the code.
      </p>

      <p>
Sounds convincing, but what does it look like in practice when we're dealing with something more sophisticated than Hello World or a console calculator?
      </p>

      <p>
We want to write something complex and intertwined in functional style and check if spagetti is going to get untangled because we used functions, and if so, what will it look like?
      </p>

      <p>
Are we going to write some UI or a server, or maybe an operation system kernel? It would be too far of a jump on a learning curve, which seems to be pretty steep in haskell's case. We got to flatten the learning curve.
      </p>
      <p>
It's got to be console application. But here is a thing: how are we going to test if functions help us untangle the code, given that console works similar to functions in line-by-line input-output mode?
      </p>

      <p>
This article helps us resolve the problem: http://eed3si9n.com/console-games-in-scala
      </p>
      <p>
It describes:
<br/>
 - control sequences of symbols that let us print in any location on screen, rather than line by line.
<br/>
 - how to read arrow button pressed events.
      </p>

      <p>
In this way it's possible to use console on a higher level of interactivity.
      </p>

      <p>
----------------------------------
      </p>
      <p>

I've been reading parconc and monadbook books during these 8 months.
<br/>
("Parallel and Concurrent Programming in Haskell" by Simon Marlow: https://www.oreilly.com/library/view/parallel-and-concurrent/9781449335939/ch01.html)
<br/>
("The book of monads" by Alejandro Serrano Mena)
      </p>
      <p>

Various designs I used listed in chronological order:
      </p>
      <p>

tetris (no observer, global redraw)
<br/>
observer on tvars (observer-by-stm-tvars-editable-list)
<br/>
global redraw and no observer (hs-editable-list-with-global-redraw-and-no-observer)
<br/>
observer in io monad (hs-editable-list-with-observer-primitive)
<br/>
monadic:
<br/>
&nbsp;-&nbsp;final style
<br/>
&nbsp;-&nbsp;initial style
<br/>
&nbsp;-&nbsp;free
<br/>
&nbsp;-&nbsp;operational style
<br/>
&nbsp;-&nbsp;freer
<br/>

      </p>
      <p>
      Various ways of creating custom monads are described in <a href="https://shiraeeshi.github.io/editable-list-as-custom-monad/article.html">another post</a>, I used final style in this post.
      </p>
      <p>


In the article about console tetris I wrote:
      </p>
      <p>

----------------------------------
      </p>

<p>
At this point in our coding journey we are reminded that we are coding in functional style with no side effects and with immutable structures.
<br/>
In java a timer could alter some object's state through side effects visible from other threads.
<br/>
But haskell challenges us to think about a puzzle.
<br/>
(If you know any interesting ways of solving this problem, let us know).
      </p>

      <p>
----------------------------------
      </p>
      <p>

I'm still playing with this puzzle and collecting various solutions to this problem, just need to clarify: there are side-effects in functional style.
      </p>
      <p>

Functional style has a broader meaning that the lack of side-effects: functional style is when the type system helps you to distinguish between side-effecting imperative code and a pure code without side-effects.
      </p>
      <p>

A program in functional style comprises of pure sub-systems, embedded in imperative framework. You either get that framework (pre-baked, so to speak) from somewhere, or you create it by yourself. Various ways of creating that framework are the subject of this post.
      </p>
      <p>

Why a list of strings?
      </p>
      <p>
I decided to formulate a task like this, because it is one of the simplest tasks with following characteristics:
<br/>
&nbsp;-&nbsp;it needs to manage some state.
<br/>
&nbsp;-&nbsp;it needs to show a gui.
<br/>
&nbsp;-&nbsp;we can use an observer pattern.

      </p>
      <p>
Actually, the part about using an observer pattern was the main motivation for experiments: I was wondering whether it is possible to translate the "observer" pattern, familiar from OOP, to the functional paradigm, and if possible, how to do that.
      </p>
      <p>
Perhaps some readers are convinced that we don't need observers in fp. If the reader has this opinion and knows how, without observers, to make some part of a system react to events emitted by other part - it would be interesting to read his comment or an article about that. And if the user decides to demonstrate the approach applied to showing a list of strings in console - that would be even better.
      </p>
      <p>

I think that we can use the console list of strings as a standart task, to demonstrate various approaches and designs. Examples: hello world, word count in map-reduce field ("WordCount is a simple application that counts the number of occurrences of each word in a given input set."). Other examples?
      </p>
      <p>
The point is that when someone (or you) is trying to explain some approach, a paradigm or a library, we can say: "ok, show us an example of console list of strings".
      </p>
      <p>

What other standart tasks can we come up with, to make them gradually more complex? For example, some application with gui or with no gui, which needs to manage more than one entities as a state. What if the listeners need to work in different contexts, different monads?
      </p>
      <p>

I need new ideas or a way of generating ideas.
      </p>
      <p>

questions:
<br/>
&nbsp;-&nbsp;how to visualize monads, transformers, etc. If we view monads as contexts, we can visualize them as rectangles, but some places are hard to visualize, for example, the relationships between monad actions and IO-actions. I created diagrams for this project, but I'm not sure if this approach of visualizing is going to scale to more complex architectures. Any ideas or recommendations?
<br/>
&nbsp;-&nbsp;new ideas of experiments. I heard about meta-tutorial and "What I wish I knew" page, I need something like that but little different: I imagine something like a tree (or a graph): the root is HelloWorld (or some expressions in repl), there are nodes like console calculator, console strings list, the deeper you go the more complex and specialized (or multi-specialized) the tasks become. The multithreading branch starts with a simple task, something like a multithreaded console strings list. And some nodes contain text that you don't understand the first time you read it, but after you've read some materials, you read the text again and understand it. Perhaps there are roadmaps like that somewhere in the internet, and if it doesn't exist yet, let's create it (but I hope it exists).
<br/>
&nbsp;-&nbsp;how does perform-recursive-monadic-loop work (see the readme in https://github.com/shiraeeshi/hs-perform-recursive-monadic-loop)



      </p>
      <p>





Let's start with data.
      </p>
      <p>
Representing a list in code and auxiliary code
      </p>
      <p>





Initial values in the list:
      </p>


<!-- HTML generated using hilite.me --><div id="code-fragment-initial-values-in-list" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #06287e">initialRows</span> <span style="color: #007020; font-weight: bold">=</span> [
  <span style="color: #902000">Row</span> <span style="color: #4070a0">&quot;something a&quot;</span>
  , <span style="color: #902000">Row</span> <span style="color: #4070a0">&quot;something b&quot;</span>
  , <span style="color: #902000">Row</span> <span style="color: #4070a0">&quot;something c&quot;</span>
  , <span style="color: #902000">Row</span> <span style="color: #4070a0">&quot;something d&quot;</span>
  , <span style="color: #902000">Row</span> <span style="color: #4070a0">&quot;something e&quot;</span>
  ]
</pre></div>

      <p>

A row is defined like this:
      </p>

<!-- HTML generated using hilite.me --><div id="code-fragment-row-definition" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #007020; font-weight: bold">data</span> <span style="color: #902000">RowData</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">Row</span> { smth <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">String</span> } <span style="color: #007020; font-weight: bold">deriving</span> <span style="color: #902000">Eq</span>
</pre></div>


      <p>


Some settings in main (needed for drawing on screen as in gui mode):
      </p>

<!-- HTML generated using hilite.me --><div id="code-fragment-some-settings-in-main" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%">  hSetBuffering stdin <span style="color: #902000">NoBuffering</span>
  hSetBuffering stdout <span style="color: #902000">NoBuffering</span>
  hSetEcho stdin <span style="color: #902000">False</span>
</pre></div>

      <p>


The getKey function reads key button press events from the terminal:
      </p>

<!-- HTML generated using hilite.me --><div id="code-fragment-getKey" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #06287e">getKey</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">IO</span> [<span style="color: #902000">Char</span>]
<span style="color: #06287e">getKey</span> <span style="color: #007020; font-weight: bold">=</span> reverse <span style="color: #666666">&lt;$&gt;</span> getKey&#39; <span style="color: #4070a0">&quot;&quot;</span>
  <span style="color: #007020; font-weight: bold">where</span>
  getKey&#39; chars <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
    char <span style="color: #007020; font-weight: bold">&lt;-</span> getChar
    more <span style="color: #007020; font-weight: bold">&lt;-</span> hReady stdin
    (<span style="color: #007020; font-weight: bold">if</span> more <span style="color: #007020; font-weight: bold">then</span> getKey&#39; <span style="color: #007020; font-weight: bold">else</span> return) (char<span style="color: #902000">:</span>chars)
</pre></div>


      <p>

Functions that draw on screen are contained in the ViewUtils module.
      </p>
      <p>

&nbsp; clearScreen
<br/>
&nbsp; showInRectangle
<br/>
&nbsp; clearRectangle
<br/>
&nbsp; showInGrid
<br/>
&nbsp; highlightCell
<br/>
&nbsp; printFromBottom

      </p>
      <p>

The drawGrid function was added later, it was extracted from showInGrid function. We need this function to not have to redraw all strings when the cursor of "selected row" moves up and down: we can redraw only the grid instead. Our goal is to redraw only those elements that need to be redrawn.
      </p>






















<p class="centered section-delimiter">
      <a name="global-redraw-and-no-observer" class="inner-anchor grey">
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
      </a>
      </p>
















      <p class="centered">
Global redraw and no observer
      </p>

      <p class="centered">
        <img id="diagram-global-redraw" class="diagram" src="diagram-global-redraw.png">
        </img>
      </p>


      <p>


In this approach a program essentially is nothing but a big loop, represented as a recursive function. A program's state is represented as parameters of that recursive function.
      </p>
      <p>





The main function invokes the loop:
      </p>


<!-- HTML generated using hilite.me --><div id="code-fragment-global-redraw-loop-definition" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%">    loop <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">RowData</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> (<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span>) <span style="color: #007020; font-weight: bold">-&gt;</span> [<span style="color: #902000">String</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">IO</span> <span style="color: #007020">()</span>
    loop rows activeCellY debugMessages <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span> <span style="color: #666666">...</span>
</pre></div>




      <p>
The loop function draws on screen, then reads the key press event from terminal and reacts to it by recursively calling itself with new parameters.
      </p>
      <p>




(By the way, I used this approach in console tetris. A need to periodically generate ticks adds to the complexity of a task there, but the main idea is the same.)
      </p>
      <p>





The problem with this approach is that the loop redraws the whole screen in every iteration, even if we can redraw only some parts of the screen.
      </p>




















<p class="centered section-delimiter">
      <a name="observer-on-tvars" class="inner-anchor grey">
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
      </a>
      </p>
















<p class="centered">
Observer on tvars
      </p>

      <p class="centered">
        <img id="diagram-tvars" class="diagram" src="diagram-tvars.png">
        </img>
      </p>

      <p>
Even though we don't really need multithreading in this application, my experiments with listeners started with this design that uses TVars.

      </p>
      <p>




I've been thinking about translating listeners to a functional paradigm, but had no idea how to do that, it was hard to imagine something other than a big recursive function that redraws the whole screen in each iteration. A chapter about STM and TVars in the parconc book helped to get out of that dead-end. It even literally uses the word "observer" couple of times - what could be more obvious hint than that!
      </p>





      <p>

----------------------------------
      </p>
      <p>

"No other thread can observe an intermediate state in which only some of the operations of the transaction have taken place."
      </p>
      <p>
"... operations that modify the state (would) have to know about the observers that need to act on changes."
      </p>
      <p>

----------------------------------
      </p>
      <p>








Here is how this design works:
<br/>
&nbsp;-&nbsp;all the fields that represent the application's state are wrapped in TVars.
<br/>
&nbsp;-&nbsp;each listener runs in its own thread as a loop, a recursive function that draws some part of a gui on screen, and then waits for the corresponding value (the observable) to change before moving to the next iteration.
<br/>
&nbsp;-&nbsp;new values to TVars get written from the main thread that reads button press events.
      </p>
      <p>






A data type that represents the state of the application:
      </p>
<!-- HTML generated using hilite.me --><div id="code-fragment---observer-on-tvars---state-adt" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #007020; font-weight: bold">data</span> <span style="color: #902000">AppStateData</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">AppState</span>
  { mainRows <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">TVar</span> [<span style="color: #902000">RowData</span>]
  , highlightedRowIndex <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">TVar</span> (<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span>)
  , debugMessages <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">TVar</span> [<span style="color: #902000">String</span>]
  , redrawLock <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">MVar</span> <span style="color: #007020">()</span> }
</pre></div>
      <p>

redrawLock and the bracketInLock function are needed to prevent threads from drawing simultaneously on console.
      </p>
      <p>






The main function performs following actions:
<br/>
&nbsp;-&nbsp;creates initial state
<br/>
&nbsp;-&nbsp;declares and starts listeners in their threads (one listener per TVar)
<br/>
&nbsp;-&nbsp;clears the screen
<br/>
&nbsp;-&nbsp;invokes the keepListeningToKeyPresses function
      </p>
      <p>

----------------------------------
      </p>
      <p>


 - creates initial state
      </p>
<!-- HTML generated using hilite.me --><div id="code-fragment---observer-on-tvars---initial-state" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%">  state<span style="color: #666666">@</span>(<span style="color: #902000">AppState</span> mainRowsTV highlightedRowIndexTV debugMessagesTV redrawLock) <span style="color: #007020; font-weight: bold">&lt;-</span> <span style="color: #007020; font-weight: bold">do</span>
    mainRows            <span style="color: #007020; font-weight: bold">&lt;-</span> atomically <span style="color: #666666">$</span> newTVar initialRows
    debugMessages       <span style="color: #007020; font-weight: bold">&lt;-</span> atomically <span style="color: #666666">$</span> newTVar (<span style="color: #902000">[]</span> <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">String</span>])
    highlightedRowIndex <span style="color: #007020; font-weight: bold">&lt;-</span> atomically <span style="color: #666666">$</span> newTVar <span style="color: #902000">Nothing</span>
    redrawLock <span style="color: #007020; font-weight: bold">&lt;-</span> newLock
    return <span style="color: #666666">$</span> <span style="color: #902000">AppState</span> mainRows highlightedRowIndex debugMessages redrawLock
</pre></div>
      <p>
----------------------------------
      </p>
      <p>

 - declares and starts listeners in their threads (one listener per TVar)
      </p>
      <p>


 - logs listener:
      </p>
<!-- HTML generated using hilite.me --><div id="code-fragment---observer-on-tvars---logs-listener" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%">  forkIO <span style="color: #666666">$</span> <span style="color: #007020; font-weight: bold">do</span>
    <span style="color: #007020; font-weight: bold">let</span> loop debugMessages <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
          bracketInLock redrawLock
            <span style="color: #666666">$</span> printFromBottom
                xUpperLeft
                (yUpperLeft<span style="color: #666666">+</span><span style="color: #40a070">12</span><span style="color: #666666">+</span>debugLinesCount)
                debugMessages
          newDebugMessages <span style="color: #007020; font-weight: bold">&lt;-</span> atomically <span style="color: #666666">$</span> <span style="color: #007020; font-weight: bold">do</span>
            newDebugMessages <span style="color: #007020; font-weight: bold">&lt;-</span> readTVar debugMessagesTV
            <span style="color: #007020; font-weight: bold">if</span> newDebugMessages <span style="color: #666666">==</span> debugMessages
              <span style="color: #007020; font-weight: bold">then</span> retry
              <span style="color: #007020; font-weight: bold">else</span> return newDebugMessages
          loop newDebugMessages
    debugMessages <span style="color: #007020; font-weight: bold">&lt;-</span> atomically <span style="color: #666666">$</span> readTVar debugMessagesTV
    loop debugMessages
</pre></div>
      <p>

 - the list listener:
      </p>
      <p>

(as opposed to the primitive proto-listeners approach, listeners can also change state (log) in addition to being able to draw on screen)
      </p>
<!-- HTML generated using hilite.me --><div id="code-fragment---observer-on-tvars---list-listener" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%">  forkIO <span style="color: #666666">$</span> <span style="color: #007020; font-weight: bold">do</span>
    <span style="color: #007020; font-weight: bold">let</span> loop rows <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
          activeCellY <span style="color: #007020; font-weight: bold">&lt;-</span> atomically <span style="color: #666666">$</span> readTVar highlightedRowIndexTV
          <span style="color: #007020; font-weight: bold">let</span> activeCellCoords <span style="color: #007020; font-weight: bold">=</span> fmap (<span style="color: #06287e">\</span>y <span style="color: #007020; font-weight: bold">-&gt;</span> (<span style="color: #40a070">0</span>, y)) activeCellY
          bracketInLock redrawLock
            <span style="color: #666666">$</span> showInGrid
                xUpperLeft
                yUpperLeft
                columnCount
                columnWidth
                activeCellCoords
                (map (<span style="color: #06287e">\</span>row <span style="color: #007020; font-weight: bold">-&gt;</span> [smth row]) rows)
          atomically <span style="color: #666666">$</span> <span style="color: #007020; font-weight: bold">do</span>
            debugMessages <span style="color: #007020; font-weight: bold">&lt;-</span> readTVar debugMessagesTV
            <span style="color: #007020; font-weight: bold">let</span> msg <span style="color: #007020; font-weight: bold">=</span> <span style="color: #4070a0">&quot;main rows listener: updated view&quot;</span>
            writeTVar debugMessagesTV <span style="color: #666666">$</span> take debugLinesCount (msg<span style="color: #902000">:</span>debugMessages)
          newMainRows <span style="color: #007020; font-weight: bold">&lt;-</span> atomically <span style="color: #666666">$</span> <span style="color: #007020; font-weight: bold">do</span>
            newMainRows <span style="color: #007020; font-weight: bold">&lt;-</span> readTVar mainRowsTV
            <span style="color: #007020; font-weight: bold">if</span> newMainRows <span style="color: #666666">==</span> rows
              <span style="color: #007020; font-weight: bold">then</span> retry
              <span style="color: #007020; font-weight: bold">else</span> return newMainRows
          loop newMainRows
    mainRows <span style="color: #007020; font-weight: bold">&lt;-</span> atomically <span style="color: #666666">$</span> <span style="color: #007020; font-weight: bold">do</span>
      rows <span style="color: #007020; font-weight: bold">&lt;-</span> readTVar mainRowsTV
      return rows
    loop mainRows
</pre></div>



      <p>
 - currently selected row listener:
      </p>
<!-- HTML generated using hilite.me --><div id="code-fragment---observer-on-tvars---active-cell-y-listener" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%">  forkIO <span style="color: #666666">$</span> <span style="color: #007020; font-weight: bold">do</span>
    <span style="color: #007020; font-weight: bold">let</span> loop activeCellY <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
          <span style="color: #007020; font-weight: bold">let</span> activeCellCoords <span style="color: #007020; font-weight: bold">=</span> fmap (<span style="color: #06287e">\</span>y <span style="color: #007020; font-weight: bold">-&gt;</span> (<span style="color: #40a070">0</span>, y)) activeCellY
          bracketInLock redrawLock
            <span style="color: #666666">$</span> <span style="color: #007020; font-weight: bold">do</span>
                drawGrid xUpperLeft yUpperLeft columnWidth columnCount rowCount
                <span style="color: #007020; font-weight: bold">case</span> activeCellCoords <span style="color: #007020; font-weight: bold">of</span>
                  <span style="color: #902000">Nothing</span> <span style="color: #007020; font-weight: bold">-&gt;</span> return <span style="color: #007020">()</span>
                  <span style="color: #902000">Just</span> coordsPair <span style="color: #007020; font-weight: bold">-&gt;</span> highlightCell xUpperLeft yUpperLeft columnWidth columnCount rowCount coordsPair
          atomically <span style="color: #666666">$</span> <span style="color: #007020; font-weight: bold">do</span>
            debugMessages <span style="color: #007020; font-weight: bold">&lt;-</span> readTVar debugMessagesTV
            <span style="color: #007020; font-weight: bold">let</span> msg <span style="color: #007020; font-weight: bold">=</span> <span style="color: #4070a0">&quot;selected cell listener: updated highlighted cell&quot;</span>
            writeTVar debugMessagesTV <span style="color: #666666">$</span> take debugLinesCount (msg<span style="color: #902000">:</span>debugMessages)
          newActiveCellY <span style="color: #007020; font-weight: bold">&lt;-</span> atomically <span style="color: #666666">$</span> <span style="color: #007020; font-weight: bold">do</span>
            newActiveCellY <span style="color: #007020; font-weight: bold">&lt;-</span> readTVar highlightedRowIndexTV
            <span style="color: #007020; font-weight: bold">if</span> newActiveCellY <span style="color: #666666">==</span> activeCellY
              <span style="color: #007020; font-weight: bold">then</span> retry
              <span style="color: #007020; font-weight: bold">else</span> return newActiveCellY
          loop newActiveCellY
    activeCellY <span style="color: #007020; font-weight: bold">&lt;-</span> atomically <span style="color: #666666">$</span> readTVar highlightedRowIndexTV
    loop activeCellY
</pre></div>




      <p>
----------------------------------
      </p>
      <p>

 - clears the screen
      </p>
      <p>

We need to acquire the lock before doing anything with the screen.
      </p>
<!-- HTML generated using hilite.me --><div id="code-fragment---observer-on-tvars---clear-screen" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%">  bracketInLock redrawLock clearScreen
</pre></div>
      <p>

----------------------------------
      </p>
      <p>

 - invokes the keepListeningToKeyPresses function
      </p>
      <p>

the keepListeningToKeyPresses function reads key press events (using getKey function) and reacts to them:
      </p>
<!-- HTML generated using hilite.me --><div id="code-fragment---observer-on-tvars---keepListeningToKeyPresses" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%">    keepListeningToKeyPresses state<span style="color: #666666">@</span>(<span style="color: #902000">AppState</span> mainRowsTV highlightedRowIndexTV debugMessagesTV _redrawLock) <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
      key <span style="color: #007020; font-weight: bold">&lt;-</span> getKey
      when (key <span style="color: #666666">/=</span> <span style="color: #4070a0">&quot;</span><span style="color: #4070a0; font-weight: bold">\ESC</span><span style="color: #4070a0">&quot;</span>) <span style="color: #666666">$</span> <span style="color: #007020; font-weight: bold">do</span>
        <span style="color: #007020; font-weight: bold">case</span> key <span style="color: #007020; font-weight: bold">of</span>
          <span style="color: #4070a0">&quot;</span><span style="color: #4070a0; font-weight: bold">\ESC</span><span style="color: #4070a0">[A&quot;</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span> <span style="color: #60a0b0; font-style: italic">-- up</span>
            atomically <span style="color: #666666">$</span> <span style="color: #007020; font-weight: bold">do</span>
              activeCellY <span style="color: #007020; font-weight: bold">&lt;-</span> readTVar highlightedRowIndexTV
              debugRows <span style="color: #007020; font-weight: bold">&lt;-</span> readTVar debugMessagesTV
              <span style="color: #007020; font-weight: bold">let</span> newActiveCellY <span style="color: #007020; font-weight: bold">=</span>
                    <span style="color: #007020; font-weight: bold">case</span> activeCellY <span style="color: #007020; font-weight: bold">of</span>
                      <span style="color: #902000">Just</span> y <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Just</span> <span style="color: #666666">$</span> max <span style="color: #40a070">0</span> (y<span style="color: #666666">-</span><span style="color: #40a070">1</span>)
                      <span style="color: #902000">Nothing</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Just</span> <span style="color: #40a070">0</span>
                  debugRow <span style="color: #007020; font-weight: bold">=</span> <span style="color: #4070a0">&quot;up, &quot;</span> <span style="color: #666666">++</span> show(newActiveCellY)
                  newDebugRows <span style="color: #007020; font-weight: bold">=</span> take debugLinesCount (debugRow<span style="color: #902000">:</span>debugRows)
              writeTVar highlightedRowIndexTV newActiveCellY
              writeTVar debugMessagesTV newDebugRows
            keepListeningToKeyPresses state
</pre></div>
      <p>

For example, the "up" arrow button handler writes new values to TVars and performs a recursive call to keepListeningToKeyPresses.
      </p>




















<p class="centered section-delimiter">
      <a name="observer-in-io-monad" class="inner-anchor grey">
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
      </a>
      </p>
















<p class="centered">
Observer in io monad
      </p>

      <p class="centered">
        <img id="diagram-primitive-observer-in-io" class="diagram" src="primitive-observer-in-io.png">
        </img>
      </p>


      <p>
Let's try to add something like a primitive proto-listener: because it is primitive, it will not run automatically, we will have to invoke it manually.
      </p>
      <p>



In addition to the fields that represent application's state we create another field and a data type that store listeners.
      </p>


<!-- HTML generated using hilite.me --><div id="code-fragment---observer-primitive---state-adt" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #007020; font-weight: bold">data</span> <span style="color: #902000">AppStateData</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">AppState</span>
  { rows <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">RowData</span>]
  , activeCellY <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span>
  , debugMessages <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">String</span>]
  , listeners <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">AppStateListenersData</span>
  }

<span style="color: #007020; font-weight: bold">data</span> <span style="color: #902000">AppStateListenersData</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">AppStateListeners</span>
  { rowsListeners <span style="color: #007020; font-weight: bold">::</span> [[<span style="color: #902000">RowData</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">IO</span> <span style="color: #007020">()</span>]
  , activeCellYListeners <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">IO</span> <span style="color: #007020">()</span>]
  , debugMessagesListeners <span style="color: #007020; font-weight: bold">::</span> [[<span style="color: #902000">String</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">IO</span> <span style="color: #007020">()</span>]
  }
</pre></div>


      <p>

Some helper functions to add listeners:
      </p>



<!-- HTML generated using hilite.me --><div id="code-fragment---observer-primitive---add-listeners" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #06287e">addRowsListener</span> <span style="color: #007020; font-weight: bold">::</span> ([<span style="color: #902000">RowData</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">IO</span> <span style="color: #007020">()</span>) <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span>
<span style="color: #06287e">addActiveCellYListener</span> <span style="color: #007020; font-weight: bold">::</span> (<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">IO</span> <span style="color: #007020">()</span>) <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span>
<span style="color: #06287e">addDebugMessagesListener</span> <span style="color: #007020; font-weight: bold">::</span> ([<span style="color: #902000">String</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">IO</span> <span style="color: #007020">()</span>) <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span>
</pre></div>


      <p>

The main function does the following:
<br/>
&nbsp;-&nbsp;creates initial state (and listeners)
<br/>
&nbsp;-&nbsp;clears the screen
<br/>
&nbsp;-&nbsp;in order to show the list for the first time, invokes the list listener
<br/>
&nbsp;-&nbsp;calls the loop function
      </p>
      <p>

----------------------------------
      </p>
      <p>

 - creates initial state (and listeners)
      </p>
      <p>


Listeners call functions from the ViewUtils module, which draw on screen. Notice how we don't log any messages from listeners, I write about it later in the section that lists some of the drawbacks of this approach.
      </p>









<!-- HTML generated using hilite.me --><div id="code-fragment---observer-primitive---initListeners-invokation" class="code-fragment" style="margin-bottom: 20px; background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%">  <span style="color: #007020; font-weight: bold">let</span> appState <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">AppState</span> initialRows <span style="color: #902000">Nothing</span> <span style="color: #902000">[]</span> initListeners
</pre></div>



<!-- HTML generated using hilite.me --><div id="code-fragment---observer-primitive---listeners" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"
><pre style="margin: 0; line-height: 125%">    initListeners <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">AppStateListenersData</span>
    <span style="color: #60a0b0; font-style: italic">-- initListeners =</span>
    <span style="color: #60a0b0; font-style: italic">--     addRowsListener mainRowsListener</span>
    <span style="color: #60a0b0; font-style: italic">--     (addActiveCellYListener activeCellYListener</span>
    <span style="color: #60a0b0; font-style: italic">--     (addDebugMessagesListener debugMessagesListener</span>
    <span style="color: #60a0b0; font-style: italic">--     (empty)))</span>
    initListeners <span style="color: #007020; font-weight: bold">=</span>
        addRowsListener mainRowsListener
        <span style="color: #666666">$</span> addActiveCellYListener activeCellYListener
        <span style="color: #666666">$</span> addDebugMessagesListener debugMessagesListener
        <span style="color: #666666">$</span> empty
      <span style="color: #007020; font-weight: bold">where</span>
        empty <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">AppStateListeners</span> <span style="color: #902000">[]</span> <span style="color: #902000">[]</span> <span style="color: #902000">[]</span>

    mainRowsListener <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">RowData</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">IO</span> <span style="color: #007020">()</span>
    mainRowsListener rows <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
      showInGrid
        xUpperLeft
        yUpperLeft
        columnCount
        columnWidth
        <span style="color: #902000">Nothing</span>
        (map (<span style="color: #06287e">\</span>row <span style="color: #007020; font-weight: bold">-&gt;</span> [smth row]) rows)

    activeCellYListener <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">IO</span> <span style="color: #007020">()</span>
    activeCellYListener activeCellY <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
      <span style="color: #007020; font-weight: bold">let</span> activeCellCoords <span style="color: #007020; font-weight: bold">=</span> fmap (<span style="color: #06287e">\</span>y <span style="color: #007020; font-weight: bold">-&gt;</span> (<span style="color: #40a070">0</span>, y)) activeCellY
      drawGrid xUpperLeft yUpperLeft columnWidth columnCount rowCount
      <span style="color: #007020; font-weight: bold">case</span> activeCellCoords <span style="color: #007020; font-weight: bold">of</span>
        <span style="color: #902000">Nothing</span> <span style="color: #007020; font-weight: bold">-&gt;</span> return <span style="color: #007020">()</span>
        <span style="color: #902000">Just</span> coordsPair <span style="color: #007020; font-weight: bold">-&gt;</span> highlightCell xUpperLeft yUpperLeft columnWidth columnCount rowCount coordsPair

    debugMessagesListener <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">String</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">IO</span> <span style="color: #007020">()</span>
    debugMessagesListener debugMessages <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
      printFromBottom
        xUpperLeft
        (yUpperLeft<span style="color: #666666">+</span><span style="color: #40a070">12</span><span style="color: #666666">+</span>debugLinesCount)
        debugMessages
</pre></div>





      <p>
----------------------------------
      </p>
      <p>

 - clears the screen
      </p>


<!-- HTML generated using hilite.me --><div id="code-fragment---observer-primitive---clearScreen" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%">  clearScreen
</pre></div>



      <p>
----------------------------------
      </p>
      <p>

 - in order to show the list for the first time, invokes the list listener
      </p>
      <p>

Since our recursive function doesn't redraw the whole screen in each iteration now, but redraws only those parts that were changed after reacting to key press events, we need to invoke the list listeners manually because if we didn't do that, the program would show us an empty screen and wait for the first key press event.
      </p>


<!-- HTML generated using hilite.me --><div id="code-fragment---observer-primitive---initial-listener-call" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%">  forM_ (rowsListeners (listeners appState)) <span style="color: #666666">$</span> <span style="color: #06287e">\</span>listener <span style="color: #007020; font-weight: bold">-&gt;</span> listener (rows appState)
</pre></div>



      <p>

----------------------------------
      </p>
      <p>

 - calls the loop function
      </p>




<!-- HTML generated using hilite.me --><div id="code-fragment---observer-primitive---loop-invokation" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%">  loop appState
</pre></div>




      <p>
The loop function reads the key press event and reacts to it (in this example and in later examples similar to this one, only the "up" button handler is shown):
      </p>




<!-- HTML generated using hilite.me --><div id="code-fragment---observer-primitive---loop-definition" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%">    loop <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">AppStateData</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">IO</span> <span style="color: #007020">()</span>
    loop appState<span style="color: #666666">@</span>(<span style="color: #902000">AppState</span> rows activeCellY debugMessages listenersHolder) <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
      key <span style="color: #007020; font-weight: bold">&lt;-</span> getKey
      when (key <span style="color: #666666">/=</span> <span style="color: #4070a0">&quot;</span><span style="color: #4070a0; font-weight: bold">\ESC</span><span style="color: #4070a0">&quot;</span>) <span style="color: #666666">$</span> <span style="color: #007020; font-weight: bold">do</span>
        <span style="color: #007020; font-weight: bold">case</span> key <span style="color: #007020; font-weight: bold">of</span>
          <span style="color: #4070a0">&quot;</span><span style="color: #4070a0; font-weight: bold">\ESC</span><span style="color: #4070a0">[A&quot;</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span> <span style="color: #60a0b0; font-style: italic">-- up</span>
            <span style="color: #007020; font-weight: bold">let</span> newActiveCellY <span style="color: #007020; font-weight: bold">=</span>
                  <span style="color: #007020; font-weight: bold">case</span> activeCellY <span style="color: #007020; font-weight: bold">of</span>
                    <span style="color: #902000">Just</span> y <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Just</span> <span style="color: #666666">$</span> max <span style="color: #40a070">0</span> (y<span style="color: #666666">-</span><span style="color: #40a070">1</span>)
                    <span style="color: #902000">Nothing</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Just</span> <span style="color: #40a070">0</span>
                debugRow <span style="color: #007020; font-weight: bold">=</span> <span style="color: #4070a0">&quot;up, &quot;</span> <span style="color: #666666">++</span> show(newActiveCellY)
                newDebugRows <span style="color: #007020; font-weight: bold">=</span> take debugLinesCount (debugRow<span style="color: #902000">:</span>debugMessages)
            forM_ (activeCellYListeners listenersHolder) <span style="color: #666666">$</span> <span style="color: #06287e">\</span>listener <span style="color: #007020; font-weight: bold">-&gt;</span> listener newActiveCellY
            forM_ (debugMessagesListeners listenersHolder) <span style="color: #666666">$</span> <span style="color: #06287e">\</span>listener <span style="color: #007020; font-weight: bold">-&gt;</span> listener newDebugRows
            loop (<span style="color: #902000">AppState</span> rows newActiveCellY newDebugRows listenersHolder)
</pre></div>






      <p>
Problems with this approach:
<br/>
&nbsp;-&nbsp;the point of observers is to be able to change a state and to rely on the system that will invoke observers automatically, but here we invoke them manually
<br/>
&nbsp;-&nbsp;we don't have access to the whole state, only to some part of it that the observer observes (we can fix that by passing a whole state as an additional parameter to the observer)
<br/>
&nbsp;-&nbsp;we can't log from listeners, because logging changes state (we can fix that by making observers return a new version of a state, but how do we invoke listeners that need to react to changes made by other listeners?)
      </p>



































<p class="centered section-delimiter">
      <a name="observer-in-custom-monad" class="inner-anchor grey">
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
      </a>
      </p>
















<p class="centered">
Observer in custom monad
      </p>

      <p class="centered">
        <img id="diagram-observer-in-custom-monad" class="diagram" src="final-style-monad.png">
        </img>
      </p>




      <p>
One of the approaches that don't have drawbacks of the primitive proto-listener approach is creating a custom monad for our operations. In the previous approach a list observer had a type [RowData] -&gt; IO (), now it's going to have a type (Monad m, EditableListApp m) =&gt; [RowData] -&gt; m (), it means that previously we invoked our listeners directly in IO monad, but now we're going to invoke them in the context of some abstract monad with the EditableListApp interface.
      </p>
      <p>






Data types that hold the state and listeners look like this. They are parameterized by the type of the monad that we're going to use as a context for running listeners.
      </p>






<!-- HTML generated using hilite.me --><div id="code-fragment---observer-in-custom-monad---state-adt" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #007020; font-weight: bold">data</span> <span style="color: #902000">AppStateData</span> m <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">AppState</span>
  { rows <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">RowData</span>]
  , activeCellY <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span>
  , debugMessages <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">String</span>]
  , listeners <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">AppStateListenersData</span> m
  }

<span style="color: #007020; font-weight: bold">data</span> <span style="color: #902000">AppStateListenersData</span> m <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">AppStateListeners</span>
  { rowsListeners <span style="color: #007020; font-weight: bold">::</span> [[<span style="color: #902000">RowData</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>]
  , activeCellYListeners <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span> <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>]
  , debugMessagesListeners <span style="color: #007020; font-weight: bold">::</span> [[<span style="color: #902000">String</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>]
  }
</pre></div>






      <p>








Helper functions that add listeners:
      </p>





<!-- HTML generated using hilite.me --><div id="code-fragment---observer-in-custom-monad---adding-listeners" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #06287e">addRowsListener</span> <span style="color: #007020; font-weight: bold">::</span> (<span style="color: #902000">Monad</span> m, <span style="color: #902000">EditableListApp</span> m) <span style="color: #007020; font-weight: bold">=&gt;</span> ([<span style="color: #902000">RowData</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>) <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span> m <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span> m
<span style="color: #06287e">addActiveCellYListener</span> <span style="color: #007020; font-weight: bold">::</span> (<span style="color: #902000">Monad</span> m, <span style="color: #902000">EditableListApp</span> m) <span style="color: #007020; font-weight: bold">=&gt;</span> (<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span> <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>) <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span> m <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span> m
<span style="color: #06287e">addDebugMessagesListener</span> <span style="color: #007020; font-weight: bold">::</span> (<span style="color: #902000">Monad</span> m, <span style="color: #902000">EditableListApp</span> m) <span style="color: #007020; font-weight: bold">=&gt;</span> ([<span style="color: #902000">String</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>) <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span> m <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span> m
</pre></div>






      <p>

These functions declare that the m type should be a monad and should be an instance of EditableListApp typeclass. That's our custom monad.
      </p>
      <p>


You might wonder why we didn't add (Monad m, EditableListApp m) constraints to the AppStateData and AppStateListenersData data types and not just to functions that add listeners. The answer is I don't know how to do that, and since the code works without those constraints I'm not sure whether we should do that at all.
      </p>
      <p>









Creating a custom monad
      </p>
      <p>
(We can create monads using various approaches, or styles. The style described here is called final style.)
      </p>
      <p>



Creating a custom monad is like creating a new sub-language inside a language.
      </p>
      <p>




In order to create a language we need a syntax and semantics.
<br/>
Syntax is a structure of our instructions.
<br/>
Semantics is how we interpret that structure.
      </p>
      <p>





To put it more bluntly, we need to define words of our new language and a dictionary to translate to other languages.
<br/>
(It means that we have a lexicon and syntax on one side, and semantics, or interpretation, on the other side)
      </p>
      <p>





On the other hand, it looks like a good old story about an interface and an implementation, so familiar to us from OOP.
      </p>
      <p>








We define a typeclass that declares monad's functions (new words of our new language):
      </p>




<!-- HTML generated using hilite.me --><div id="code-fragment---observer-in-custom-monad---descriptive-adt" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #007020; font-weight: bold">class</span> <span style="color: #902000">EditableListApp</span> m <span style="color: #007020; font-weight: bold">where</span>
  getList <span style="color: #007020; font-weight: bold">::</span> m [<span style="color: #902000">RowData</span>]
  getActiveCellY <span style="color: #007020; font-weight: bold">::</span> m (<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span>)
  getLogs <span style="color: #007020; font-weight: bold">::</span> m [<span style="color: #902000">String</span>]

  updateList <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">RowData</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>
  updateActiveCellY <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span> <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>
  log <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">String</span> <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>
</pre></div>





      <p>
What do the signatures of the functions we just listed mean?
      </p>
      <p>

Operations that return results, return results in the context of m monad:
      </p>





<!-- HTML generated using hilite.me --><div id="code-fragment---observer-in-custom-monad---descriptive-adt-getters" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%">  getList <span style="color: #007020; font-weight: bold">::</span> m [<span style="color: #902000">RowData</span>]
  getActiveCellY <span style="color: #007020; font-weight: bold">::</span> m (<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span>)
  getLogs <span style="color: #007020; font-weight: bold">::</span> m [<span style="color: #902000">String</span>]
</pre></div>





      <p>
Operations that perform effects, perform those effects in the context of m monad:
      </p>




<!-- HTML generated using hilite.me --><div id="code-fragment---observer-in-custom-monad---descriptive-adt-setters" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%">  updateList <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">RowData</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>
  updateActiveCellY <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span> <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>
  log <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">String</span> <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>
</pre></div>





      <p>
Interpretation
      </p>

      <p class="centered">
        <img id="diagram-target-monad" class="diagram" src="StateHolder.png">
        </img>
      </p>
      <p>


We need another language to translate our words to. Here it is: the IO monad wrapped (or transformed) with StateT monad transformer. We're going to interpret actions from the custom monad to this monad:
      </p>





<!-- HTML generated using hilite.me --><div id="code-fragment---observer-in-custom-monad---target-monad" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #007020; font-weight: bold">newtype</span> <span style="color: #902000">StateHolder</span> a <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">StateHolder</span> (<span style="color: #902000">StateT</span> (<span style="color: #902000">AppStateData</span> <span style="color: #902000">StateHolder</span>) <span style="color: #902000">IO</span> a)
  <span style="color: #007020; font-weight: bold">deriving</span> (<span style="color: #902000">Functor</span>, <span style="color: #902000">Applicative</span>, <span style="color: #902000">Monad</span>, <span style="color: #902000">MonadIO</span>)
</pre></div>






      <p>
The interpretation (looks more like a definition of words) is declared as an instance of a typeclass:
      </p>








<!-- HTML generated using hilite.me --><div id="code-fragment---observer-in-custom-monad---target-monad-instance-of-descriptive-monad" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #007020; font-weight: bold">instance</span> <span style="color: #902000">EditableListApp</span> <span style="color: #902000">StateHolder</span> <span style="color: #007020; font-weight: bold">where</span>
  getList <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> rows <span style="color: #666666">&lt;$&gt;</span> get
  getActiveCellY <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> activeCellY <span style="color: #666666">&lt;$&gt;</span> get
  getLogs <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> debugMessages <span style="color: #666666">&lt;$&gt;</span> get

  updateList l <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
    <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> modify <span style="color: #666666">$</span> <span style="color: #06287e">\</span>s <span style="color: #007020; font-weight: bold">-&gt;</span> s { rows <span style="color: #007020; font-weight: bold">=</span> l }
    reacts <span style="color: #007020; font-weight: bold">&lt;-</span> <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> (rowsListeners <span style="color: #666666">.</span> listeners) <span style="color: #666666">&lt;$&gt;</span> get
    forM_ reacts (<span style="color: #666666">$</span> l) <span style="color: #60a0b0; font-style: italic">-- same as forM_ reacts $ \react -&gt; react l</span>
  updateActiveCellY y <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
    <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> modify <span style="color: #666666">$</span> <span style="color: #06287e">\</span>s <span style="color: #007020; font-weight: bold">-&gt;</span> s { activeCellY <span style="color: #007020; font-weight: bold">=</span> y }
    s <span style="color: #007020; font-weight: bold">&lt;-</span> <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> get
    <span style="color: #007020; font-weight: bold">let</span> reacts <span style="color: #007020; font-weight: bold">=</span> activeCellYListeners (listeners s)
    forM_ reacts (<span style="color: #666666">$</span> y) <span style="color: #60a0b0; font-style: italic">-- same as forM_ reacts $ \react -&gt; react y</span>
  log msg <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
    <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> modify <span style="color: #666666">$</span> <span style="color: #06287e">\</span>s <span style="color: #007020; font-weight: bold">-&gt;</span> s { debugMessages <span style="color: #007020; font-weight: bold">=</span> take debugLinesCount (msg<span style="color: #902000">:</span>(debugMessages s)) }
    logs <span style="color: #007020; font-weight: bold">&lt;-</span> <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> debugMessages <span style="color: #666666">&lt;$&gt;</span> get
    reacts <span style="color: #007020; font-weight: bold">&lt;-</span> <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> (debugMessagesListeners <span style="color: #666666">.</span> listeners) <span style="color: #666666">&lt;$&gt;</span> get
    forM_ reacts (<span style="color: #666666">$</span> logs) <span style="color: #60a0b0; font-style: italic">-- same as forM_ reacts $ \react -&gt; react logs</span>
</pre></div>







      <p>
From the OOP perspective this design resembles an interface and an implementation, from our linguistic analogy perspective it looks like a dictionary or an interpreter that helps us translate (interpret) operations from the language of one monad (let's call it a descriptive monad) to the language of another monad (let's call it a target monad).
      </p>
      <p>








The performStateAction function translates the actions further to the IO monads language. We can imagine that it takes actions described in StateT monad's context and invokes them in the IO monad's context (actually, it doesn't really invoke them in IO-context, but merely translates them to IO-context, although I'm not sure about whether it invokes them or not. See my question about the perform-recursive-monadic-loop example):
      </p>






<!-- HTML generated using hilite.me --><div id="code-fragment---observer-in-custom-monad---performStateAction" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #06287e">performStateAction</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">AppStateData</span> <span style="color: #902000">StateHolder</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">StateHolder</span> a <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">IO</span> <span style="color: #007020">()</span>
<span style="color: #06287e">performStateAction</span> state (<span style="color: #902000">StateHolder</span> action) <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
  runStateT action state
  return <span style="color: #007020">()</span>
</pre></div>







      <p>
The main function clears the screen, creates an initial state (and listeners), invokes, wrapping with performStateAction function call, the initRows and the loop function:
      </p>







<!-- HTML generated using hilite.me --><div id="code-fragment---observer-in-custom-monad---main-func" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #06287e">main</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">IO</span> <span style="color: #007020">()</span>
<span style="color: #06287e">main</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
  hSetBuffering stdin <span style="color: #902000">NoBuffering</span>
  hSetBuffering stdout <span style="color: #902000">NoBuffering</span>
  hSetEcho stdin <span style="color: #902000">False</span>
  clearScreen
  performStateAction initialState <span style="color: #666666">$</span> <span style="color: #007020; font-weight: bold">do</span>
    initRows
    loop
  <span style="color: #007020; font-weight: bold">where</span> <span style="color: #666666">...</span>
</pre></div>








      <p>
There is one thing in the performStateAction function's behavior that is not clear to me: seems like it doesn't wait for the loop function to return from recursion and runs the runStateT function on it's result, which shouldn't be ready yet because we're still in the recursion. How does that work?
      </p>
      <p>


I've isolated a minimalistic example of this behavior in this project: perform-recursive-monadic-loop (https://github.com/shiraeeshi/hs-perform-recursive-monadic-loop).
      </p>
      <p>

----------------------------------
      </p>
      <p>

 - creating an initial state
      </p>



<!-- HTML generated using hilite.me --><div id="code-fragment---observer-in-custom-monad---initialState" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%">    initialState <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">AppStateData</span> <span style="color: #902000">StateHolder</span>
    initialState <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">AppState</span> <span style="color: #902000">[]</span> <span style="color: #902000">Nothing</span> <span style="color: #902000">[]</span> initListeners
</pre></div>




      <p>
----------------------------------
      </p>
      <p>

 - creating listeners:
      </p>









<!-- HTML generated using hilite.me --><div id="code-fragment---observer-in-custom-monad---creating-listeners" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%">    initListeners <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">AppStateListenersData</span> <span style="color: #902000">StateHolder</span>
    <span style="color: #60a0b0; font-style: italic">-- initListeners =</span>
    <span style="color: #60a0b0; font-style: italic">--     addRowsListener mainRowsListener</span>
    <span style="color: #60a0b0; font-style: italic">--     (addActiveCellYListener activeCellYListener</span>
    <span style="color: #60a0b0; font-style: italic">--     (addDebugMessagesListener debugMessagesListener</span>
    <span style="color: #60a0b0; font-style: italic">--     (empty)))</span>
    initListeners <span style="color: #007020; font-weight: bold">=</span>
        addRowsListener mainRowsListener
        <span style="color: #666666">$</span> addActiveCellYListener activeCellYListener
        <span style="color: #666666">$</span> addDebugMessagesListener debugMessagesListener
        <span style="color: #666666">$</span> empty
      <span style="color: #007020; font-weight: bold">where</span>
        empty <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">AppStateListeners</span> <span style="color: #902000">[]</span> <span style="color: #902000">[]</span> <span style="color: #902000">[]</span>

    mainRowsListener <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">RowData</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">StateHolder</span> <span style="color: #007020">()</span>
    mainRowsListener rows <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
      activeCellCoords <span style="color: #007020; font-weight: bold">&lt;-</span> fmap (<span style="color: #06287e">\</span>y <span style="color: #007020; font-weight: bold">-&gt;</span> (<span style="color: #40a070">0</span>, y)) <span style="color: #666666">&lt;$&gt;</span> getActiveCellY
      liftIO <span style="color: #666666">$</span> showInGrid
                 xUpperLeft
                 yUpperLeft
                 columnCount
                 columnWidth
                 activeCellCoords
                 (map (<span style="color: #06287e">\</span>row <span style="color: #007020; font-weight: bold">-&gt;</span> [smth row]) rows)
      log <span style="color: #4070a0">&quot;updated rows&quot;</span>

    activeCellYListener <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">StateHolder</span> <span style="color: #007020">()</span>
    activeCellYListener activeCellY <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
      <span style="color: #007020; font-weight: bold">let</span> activeCellCoords <span style="color: #007020; font-weight: bold">=</span> fmap (<span style="color: #06287e">\</span>y <span style="color: #007020; font-weight: bold">-&gt;</span> (<span style="color: #40a070">0</span>, y)) activeCellY
      liftIO <span style="color: #666666">$</span> drawGrid xUpperLeft yUpperLeft columnWidth columnCount rowCount
      <span style="color: #007020; font-weight: bold">case</span> activeCellCoords <span style="color: #007020; font-weight: bold">of</span>
        <span style="color: #902000">Nothing</span> <span style="color: #007020; font-weight: bold">-&gt;</span> return <span style="color: #007020">()</span>
        <span style="color: #902000">Just</span> coordsPair <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span>
          liftIO <span style="color: #666666">$</span> highlightCell xUpperLeft yUpperLeft columnWidth columnCount rowCount coordsPair
          log <span style="color: #4070a0">&quot;highlighted cell&quot;</span>

    debugMessagesListener <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">String</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">StateHolder</span> <span style="color: #007020">()</span>
    debugMessagesListener debugMessages <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
      liftIO <span style="color: #666666">$</span> printFromBottom
                 xUpperLeft
                 (yUpperLeft<span style="color: #666666">+</span><span style="color: #40a070">12</span><span style="color: #666666">+</span>debugLinesCount)
                 debugMessages
</pre></div>










      <p>
----------------------------------
      </p>
      <p>

 - the strings list initialization:
      </p>




<!-- HTML generated using hilite.me --><div id="code-fragment---observer-in-custom-monad---initRows" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%">    initRows <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">StateHolder</span> <span style="color: #007020">()</span>
    initRows <span style="color: #007020; font-weight: bold">=</span> updateList initialRows
</pre></div>





      <p>

When initializing the list, we invoke updateList function, which in turn invokes its listeners.

      </p>
      <p>
----------------------------------
      </p>
      <p>

 - the loop function:
      </p>
      <p>

The loop function doesn't take any parameters, because the state is passed implicitly through the context, the context here is StateHolder monad.
      </p>
      <p>

Since the loop function is defined in the StateHolder monad's context, not in IO context, we can't directly invoke IO actions from here, but we made StateHolder an instance of MonadIO, so we can invoke IO actions using liftIO function.
      </p>






<!-- HTML generated using hilite.me --><div id="code-fragment---observer-in-custom-monad---loop" class="code-fragment" style="background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%">    loop <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">StateHolder</span> <span style="color: #007020">()</span>
    loop <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
      key <span style="color: #007020; font-weight: bold">&lt;-</span> liftIO <span style="color: #666666">$</span> getKey
      when (key <span style="color: #666666">/=</span> <span style="color: #4070a0">&quot;</span><span style="color: #4070a0; font-weight: bold">\ESC</span><span style="color: #4070a0">&quot;</span>) <span style="color: #666666">$</span> <span style="color: #007020; font-weight: bold">do</span>
        <span style="color: #007020; font-weight: bold">case</span> key <span style="color: #007020; font-weight: bold">of</span>
          <span style="color: #4070a0">&quot;</span><span style="color: #4070a0; font-weight: bold">\ESC</span><span style="color: #4070a0">[A&quot;</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span> <span style="color: #60a0b0; font-style: italic">-- up</span>
              activeCellY <span style="color: #007020; font-weight: bold">&lt;-</span> getActiveCellY
              <span style="color: #007020; font-weight: bold">let</span>
                newActiveCellY <span style="color: #007020; font-weight: bold">=</span>
                  <span style="color: #007020; font-weight: bold">case</span> activeCellY <span style="color: #007020; font-weight: bold">of</span>
                    <span style="color: #902000">Just</span> y <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Just</span> <span style="color: #666666">$</span> max <span style="color: #40a070">0</span> (y<span style="color: #666666">-</span><span style="color: #40a070">1</span>)
                    <span style="color: #902000">Nothing</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Just</span> <span style="color: #40a070">0</span>
              updateActiveCellY newActiveCellY
              log <span style="color: #666666">$</span> <span style="color: #4070a0">&quot;up, &quot;</span> <span style="color: #666666">++</span> show(newActiveCellY)
              loop
</pre></div>






    </div> <!-- end of column left -->



    <div id="code-wrapper" class="column right">

<div style="font-size: large; padding: 20px; font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji;">
  <p>
  The code will be shown here.
  </p>
  <p>
  Elements on the diagram and code fragments are clickable. A code fragment is going to be highlighted here when clicked.
  </p>
</div>

<!-- HTML generated using hilite.me --><div id="source---global-redraw-and-no-observer---main" style="display: none; background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #007020; font-weight: bold">module</span> <span style="color: #0e84b5; font-weight: bold">Main</span> <span style="color: #007020; font-weight: bold">where</span>

<span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">Control.Monad</span> (<span style="color: #06287e">when</span>)
<span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">Control.Exception</span> (<span style="color: #06287e">try</span>)
<span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">System.IO</span> (<span style="color: #06287e">stdin</span>, <span style="color: #06287e">stdout</span>, <span style="color: #06287e">hSetEcho</span>, <span style="color: #06287e">hSetBuffering</span>, <span style="color: #06287e">hReady</span>, <span style="color: #902000">BufferMode</span> (<span style="color: #902000">NoBuffering</span>) )
<span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">ViewUtils</span> (<span style="color: #06287e">clearScreen</span>, <span style="color: #06287e">showInRectangle</span>, <span style="color: #06287e">clearRectangle</span>, <span style="color: #06287e">showInGrid</span>, <span style="color: #06287e">highlightCell</span>, <span style="color: #06287e">printFromBottom</span>)

<div id="source-raw-definition" style="display: inline-block;"><span style="color: #007020; font-weight: bold">data</span> <span style="color: #902000">RowData</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">Row</span> { smth <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">String</span> } <span style="color: #007020; font-weight: bold">deriving</span> <span style="color: #902000">Eq</span>
</div>

<div id="source-initial-values-in-list" style="display: inline-block;"><span style="color: #06287e">initialRows</span> <span style="color: #007020; font-weight: bold">=</span> [
  <span style="color: #902000">Row</span> <span style="color: #4070a0">&quot;something a&quot;</span>
  , <span style="color: #902000">Row</span> <span style="color: #4070a0">&quot;something b&quot;</span>
  , <span style="color: #902000">Row</span> <span style="color: #4070a0">&quot;something c&quot;</span>
  , <span style="color: #902000">Row</span> <span style="color: #4070a0">&quot;something d&quot;</span>
  , <span style="color: #902000">Row</span> <span style="color: #4070a0">&quot;something e&quot;</span>
  ]
</div>

<span style="color: #06287e">main</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">IO</span> <span style="color: #007020">()</span>
<span style="color: #06287e">main</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
<div id="source-some-settings-in-main" style="display: inline-block;">  hSetBuffering stdin <span style="color: #902000">NoBuffering</span>
  hSetBuffering stdout <span style="color: #902000">NoBuffering</span>
  hSetEcho stdin <span style="color: #902000">False</span>
</div>
  loop <div id="source---global-redraw-and-no-observer---initial-state" style="display: inline;">initialRows <span style="color: #902000">Nothing</span> <span style="color: #902000">[]</span></div>
  <span style="color: #007020; font-weight: bold">where</span>
    xUpperLeft <span style="color: #007020; font-weight: bold">=</span> <span style="color: #40a070">0</span>
    yUpperLeft <span style="color: #007020; font-weight: bold">=</span> <span style="color: #40a070">0</span>
    columnCount <span style="color: #007020; font-weight: bold">=</span> <span style="color: #40a070">1</span>
    columnWidth <span style="color: #007020; font-weight: bold">=</span> <span style="color: #40a070">14</span>
    rowCount <span style="color: #007020; font-weight: bold">=</span> length initialRows
    debugLinesCount <span style="color: #007020; font-weight: bold">=</span> <span style="color: #40a070">20</span>


<div id="source-global-redraw-loop-definition" style="display: inline-block;">    loop <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">RowData</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> (<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span>) <span style="color: #007020; font-weight: bold">-&gt;</span> [<span style="color: #902000">String</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">IO</span> <span style="color: #007020">()</span>
    loop rows activeCellY debugMessages <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
</div>
<div id="source---global-redraw-and-no-observer---draw-on-screen" style="display: inline-block;"
>      clearScreen
      <span style="color: #007020; font-weight: bold">let</span> activeCellCoords <span style="color: #007020; font-weight: bold">=</span> fmap (<span style="color: #06287e">\</span>y <span style="color: #007020; font-weight: bold">-&gt;</span> (<span style="color: #40a070">0</span>, y)) activeCellY
      showInGrid
        xUpperLeft
        yUpperLeft
        columnCount
        columnWidth
        activeCellCoords
        (map (<span style="color: #06287e">\</span>row <span style="color: #007020; font-weight: bold">-&gt;</span> [smth row]) rows)
      <span style="color: #007020; font-weight: bold">case</span> activeCellCoords <span style="color: #007020; font-weight: bold">of</span>
        <span style="color: #902000">Nothing</span> <span style="color: #007020; font-weight: bold">-&gt;</span> return <span style="color: #007020">()</span>
        <span style="color: #902000">Just</span> coordsPair <span style="color: #007020; font-weight: bold">-&gt;</span> highlightCell xUpperLeft yUpperLeft columnWidth columnCount rowCount coordsPair
      printFromBottom
        xUpperLeft
        (yUpperLeft<span style="color: #666666">+</span><span style="color: #40a070">12</span><span style="color: #666666">+</span>debugLinesCount)
        debugMessages
</div>
<div id="source---global-redraw-and-no-observer---getKey-invokation" style="display: inline;"
>      key <span style="color: #007020; font-weight: bold">&lt;-</span> getKey
</div>
      when (key <span style="color: #666666">/=</span> <span style="color: #4070a0">&quot;</span><span style="color: #4070a0; font-weight: bold">\ESC</span><span style="color: #4070a0">&quot;</span>) <span style="color: #666666">$</span> <span style="color: #007020; font-weight: bold">do</span>
<div id="source---global-redraw-and-no-observer---case-key-of" style="display: inline;"
>        <span style="color: #007020; font-weight: bold">case</span> key <span style="color: #007020; font-weight: bold">of</span>
</div>
          <div class="source---global-redraw-and-no-observer---case-key-up-down-enter" style="display: inline;"><span style="color: #4070a0">&quot;</span><span style="color: #4070a0; font-weight: bold">\ESC</span><span style="color: #4070a0">[A&quot;</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span> <span style="color: #60a0b0; font-style: italic">-- up</span></div>
            <span style="color: #007020; font-weight: bold">let</span> newActiveCellY <span style="color: #007020; font-weight: bold">=</span>
                  <span style="color: #007020; font-weight: bold">case</span> activeCellY <span style="color: #007020; font-weight: bold">of</span>
                    <span style="color: #902000">Just</span> y <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Just</span> <span style="color: #666666">$</span> max <span style="color: #40a070">0</span> (y<span style="color: #666666">-</span><span style="color: #40a070">1</span>)
                    <span style="color: #902000">Nothing</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Just</span> <span style="color: #40a070">0</span>
                debugRow <span style="color: #007020; font-weight: bold">=</span> <span style="color: #4070a0">&quot;up, &quot;</span> <span style="color: #666666">++</span> show(newActiveCellY)
                newDebugRows <span style="color: #007020; font-weight: bold">=</span> take debugLinesCount (debugRow<span style="color: #902000">:</span>debugMessages)
            loop <span class="source---global-redraw-and-no-observer---new-state">rows newActiveCellY newDebugRows</span>
          <div class="source---global-redraw-and-no-observer---case-key-up-down-enter" style="display: inline;"><span style="color: #4070a0">&quot;</span><span style="color: #4070a0; font-weight: bold">\ESC</span><span style="color: #4070a0">[B&quot;</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span> <span style="color: #60a0b0; font-style: italic">-- down</span></div>
            <span style="color: #007020; font-weight: bold">let</span> newActiveCellY <span style="color: #007020; font-weight: bold">=</span>
                  <span style="color: #007020; font-weight: bold">case</span> activeCellY <span style="color: #007020; font-weight: bold">of</span>
                    <span style="color: #902000">Just</span> y <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Just</span> <span style="color: #666666">$</span> min (rowCount<span style="color: #666666">-</span><span style="color: #40a070">1</span>) (y<span style="color: #666666">+</span><span style="color: #40a070">1</span>)
                    <span style="color: #902000">Nothing</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Just</span> <span style="color: #40a070">0</span>
                debugRow <span style="color: #007020; font-weight: bold">=</span> <span style="color: #4070a0">&quot;down, &quot;</span> <span style="color: #666666">++</span> show(newActiveCellY)
                newDebugRows <span style="color: #007020; font-weight: bold">=</span> take debugLinesCount (debugRow<span style="color: #902000">:</span>debugMessages)
            loop <span class="source---global-redraw-and-no-observer---new-state">rows newActiveCellY newDebugRows</span>
          <div class="source---global-redraw-and-no-observer---case-key-up-down-enter" style="display: inline;"><span style="color: #4070a0">&quot;</span><span style="color: #4070a0; font-weight: bold">\n</span><span style="color: #4070a0">&quot;</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span> <span style="color: #60a0b0; font-style: italic">-- enter</span></div>
            <span style="color: #007020; font-weight: bold">let</span> eitherValue <span style="color: #007020; font-weight: bold">=</span>
                  <span style="color: #007020; font-weight: bold">case</span> activeCellY <span style="color: #007020; font-weight: bold">of</span>
                    <span style="color: #902000">Nothing</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Left</span> <span style="color: #4070a0">&quot;there&#39;s no selected cell&quot;</span>
                    <span style="color: #902000">Just</span> cellIndex <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span>
                      <span style="color: #007020; font-weight: bold">if</span> cellIndex <span style="color: #666666">&lt;</span> <span style="color: #40a070">0</span> <span style="color: #666666">||</span> cellIndex <span style="color: #666666">&gt;=</span> (length rows)
                        <span style="color: #007020; font-weight: bold">then</span> <span style="color: #902000">Left</span> <span style="color: #666666">$</span> <span style="color: #4070a0">&quot;index out of bounds: &quot;</span> <span style="color: #666666">++</span> (show cellIndex)
                        <span style="color: #007020; font-weight: bold">else</span> <span style="color: #902000">Right</span> <span style="color: #666666">$</span> smth <span style="color: #666666">$</span> rows <span style="color: #666666">!!</span> cellIndex
            <span style="color: #007020; font-weight: bold">let</span> 

              showEditField value <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
                <span style="color: #007020; font-weight: bold">let</span>
                  txt <span style="color: #007020; font-weight: bold">=</span> <span style="color: #4070a0">&quot;edit cell value:&quot;</span>
                  lentxt <span style="color: #007020; font-weight: bold">=</span> length txt
                  yPos <span style="color: #007020; font-weight: bold">=</span> <span style="color: #40a070">0</span>
                  xPos <span style="color: #007020; font-weight: bold">=</span> (columnCount <span style="color: #666666">*</span> (columnWidth <span style="color: #666666">+</span> <span style="color: #40a070">1</span>)) <span style="color: #666666">+</span> <span style="color: #40a070">3</span>
                  replaceNth lst idx val <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">if</span> idx <span style="color: #666666">&lt;</span> <span style="color: #40a070">1</span> <span style="color: #007020; font-weight: bold">then</span> val<span style="color: #902000">:</span>(tail lst) <span style="color: #007020; font-weight: bold">else</span> (head lst) <span style="color: #902000">:</span> (replaceNth (tail lst) (idx <span style="color: #666666">-</span> <span style="color: #40a070">1</span>) val)
                showInRectangle xPos yPos lentxt [txt, value]
                key <span style="color: #007020; font-weight: bold">&lt;-</span> getKey
                <span style="color: #007020; font-weight: bold">case</span> key <span style="color: #007020; font-weight: bold">of</span>
                  <span style="color: #4070a0">&quot;</span><span style="color: #4070a0; font-weight: bold">\n</span><span style="color: #4070a0">&quot;</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span>
                    <span style="color: #007020; font-weight: bold">case</span> activeCellY <span style="color: #007020; font-weight: bold">of</span>
                      <span style="color: #902000">Nothing</span> <span style="color: #007020; font-weight: bold">-&gt;</span> return <span style="color: #007020">()</span>
                      <span style="color: #902000">Just</span> cellIndex <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span>
                        clearRectangle xPos yPos lentxt <span style="color: #40a070">2</span>
                        <span style="color: #007020; font-weight: bold">let</span> newRows <span style="color: #007020; font-weight: bold">=</span> replaceNth rows cellIndex (<span style="color: #902000">Row</span> value)
                        loop <span class="source---global-redraw-and-no-observer---new-state">newRows activeCellY debugMessages</span>
                  <span style="color: #4070a0">&quot;</span><span style="color: #4070a0; font-weight: bold">\DEL</span><span style="color: #4070a0">&quot;</span> <span style="color: #007020; font-weight: bold">-&gt;</span> showEditField (<span style="color: #007020; font-weight: bold">if</span> (length value) <span style="color: #666666">==</span> <span style="color: #40a070">0</span> <span style="color: #007020; font-weight: bold">then</span> value <span style="color: #007020; font-weight: bold">else</span> init value)
                  c <span style="color: #007020; font-weight: bold">-&gt;</span> showEditField (value <span style="color: #666666">++</span> c)
            <span style="color: #007020; font-weight: bold">case</span> eitherValue <span style="color: #007020; font-weight: bold">of</span>
              <span style="color: #902000">Left</span> e <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span>
                <span style="color: #007020; font-weight: bold">let</span> msg <span style="color: #007020; font-weight: bold">=</span> <span style="color: #4070a0">&quot;error: &quot;</span> <span style="color: #666666">++</span> (show e)
                loop rows activeCellY <span style="color: #666666">$</span> take debugLinesCount (msg<span style="color: #902000">:</span>debugMessages)
              <span style="color: #902000">Right</span> v <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span>
                showEditField v
<div id="source---global-redraw-and-no-observer---case-key-otherwise" style="display: inline-block;"
>          <span style="color: #4070a0">&quot;q&quot;</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <div class="source---global-redraw-and-no-observer---exit" style="display: inline;">return <span style="color: #007020">()</span></div>
          <span style="color: #007020; font-weight: bold">_</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <div class="source---global-redraw-and-no-observer---exit" style="display: inline;">return <span style="color: #007020">()</span></div>
</div>

<div id="source-getKey" style="display: inline-block;"><span style="color: #06287e">getKey</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">IO</span> [<span style="color: #902000">Char</span>]
<span style="color: #06287e">getKey</span> <span style="color: #007020; font-weight: bold">=</span> reverse <span style="color: #666666">&lt;$&gt;</span> getKey&#39; <span style="color: #4070a0">&quot;&quot;</span>
  <span style="color: #007020; font-weight: bold">where</span>
  getKey&#39; chars <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
    char <span style="color: #007020; font-weight: bold">&lt;-</span> getChar
    more <span style="color: #007020; font-weight: bold">&lt;-</span> hReady stdin
    (<span style="color: #007020; font-weight: bold">if</span> more <span style="color: #007020; font-weight: bold">then</span> getKey&#39; <span style="color: #007020; font-weight: bold">else</span> return) (char<span style="color: #902000">:</span>chars)
</div>
</pre></div> <!-- end of source global-redraw-and-no-observer main -->












<!-- HTML generated using hilite.me --><div id="source---observer-on-tvars---main" style="display: none; background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #007020; font-weight: bold">module</span> <span style="color: #0e84b5; font-weight: bold">Main</span> <span style="color: #007020; font-weight: bold">where</span>

<span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">System.IO</span> (<span style="color: #06287e">stdin</span>, <span style="color: #06287e">stdout</span>, <span style="color: #06287e">hSetEcho</span>, <span style="color: #06287e">hSetBuffering</span>, <span style="color: #06287e">hReady</span>, <span style="color: #902000">BufferMode</span> (<span style="color: #902000">NoBuffering</span>) )
<span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">ViewUtils</span> (<span style="color: #06287e">clearScreen</span>, <span style="color: #06287e">showInRectangle</span>, <span style="color: #06287e">clearRectangle</span>, <span style="color: #06287e">showInGrid</span>, <span style="color: #06287e">drawGrid</span>, <span style="color: #06287e">highlightCell</span>, <span style="color: #06287e">printFromBottom</span>)
<span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">Control.Monad</span> (<span style="color: #06287e">when</span>)
<span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">Control.Concurrent.STM.TVar</span> (<span style="color: #902000">TVar</span>, <span style="color: #06287e">newTVar</span>, <span style="color: #06287e">readTVar</span>, <span style="color: #06287e">writeTVar</span>)
<span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">Control.Concurrent.MVar</span> (<span style="color: #902000">MVar</span>, <span style="color: #06287e">newEmptyMVar</span>, <span style="color: #06287e">takeMVar</span>, <span style="color: #06287e">putMVar</span>)
<span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">Control.Monad.STM</span> (<span style="color: #902000">STM</span>, <span style="color: #06287e">atomically</span>, <span style="color: #06287e">retry</span>, <span style="color: #06287e">throwSTM</span>)
<span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">Control.Concurrent</span> (<span style="color: #06287e">forkIO</span>)
<span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">Control.Exception</span> (<span style="color: #902000">Exception</span>, <span style="color: #902000">ErrorCall</span>(<span style="color: #902000">ErrorCall</span>), <span style="color: #06287e">bracket</span>, <span style="color: #06287e">try</span>)

<span style="color: #007020; font-weight: bold">data</span> <span style="color: #902000">RowData</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">Row</span> { smth <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">String</span> } <span style="color: #007020; font-weight: bold">deriving</span> <span style="color: #902000">Eq</span>

<span style="color: #06287e">initialRows</span> <span style="color: #007020; font-weight: bold">=</span> [
  <span style="color: #902000">Row</span> <span style="color: #4070a0">&quot;something a&quot;</span>
  , <span style="color: #902000">Row</span> <span style="color: #4070a0">&quot;something b&quot;</span>
  , <span style="color: #902000">Row</span> <span style="color: #4070a0">&quot;something c&quot;</span>
  , <span style="color: #902000">Row</span> <span style="color: #4070a0">&quot;something d&quot;</span>
  , <span style="color: #902000">Row</span> <span style="color: #4070a0">&quot;something e&quot;</span>
  ]

<div id="source---observer-on-tvars---state-adt" style="display: inline-block;"><span style="color: #007020; font-weight: bold">data</span> <span style="color: #902000">AppStateData</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">AppState</span>
  { <div id="source---observer-on-tvars---main-rows-tvar" style="display: inline;">mainRows <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">TVar</span> [<span style="color: #902000">RowData</span>]</div>
  , <div id="source---observer-on-tvars---highlighted-row-index-tvar" style="display: inline;">highlightedRowIndex <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">TVar</span> (<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span>)</div>
  , <div id="source---observer-on-tvars---debug-messages-tvar" style="display: inline;">debugMessages <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">TVar</span> [<span style="color: #902000">String</span>]</div>
  , redrawLock <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">MVar</span> <span style="color: #007020">()</span> }
</div>

<span style="color: #06287e">newLock</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">IO</span> (<span style="color: #902000">MVar</span> <span style="color: #007020">()</span>)
<span style="color: #06287e">newLock</span> <span style="color: #007020; font-weight: bold">=</span> newEmptyMVar

<span style="color: #06287e">lock</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">MVar</span> <span style="color: #007020">()</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">IO</span> <span style="color: #007020">()</span>
<span style="color: #06287e">lock</span> v <span style="color: #007020; font-weight: bold">=</span> putMVar v <span style="color: #007020">()</span>

<span style="color: #06287e">unlock</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">MVar</span> <span style="color: #007020">()</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">IO</span> <span style="color: #007020">()</span>
<span style="color: #06287e">unlock</span> v <span style="color: #007020; font-weight: bold">=</span> takeMVar v

<span style="color: #06287e">bracketInLock</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">MVar</span> <span style="color: #007020">()</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">IO</span> <span style="color: #007020">()</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">IO</span> <span style="color: #007020">()</span>
<span style="color: #06287e">bracketInLock</span> l action <span style="color: #007020; font-weight: bold">=</span>
  bracket
    (lock l)
    (<span style="color: #06287e">\</span><span style="color: #007020; font-weight: bold">_</span> <span style="color: #007020; font-weight: bold">-&gt;</span> unlock l)
    <span style="color: #666666">$</span> <span style="color: #06287e">\</span><span style="color: #007020; font-weight: bold">_</span> <span style="color: #007020; font-weight: bold">-&gt;</span> action

<span style="color: #06287e">main</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">IO</span> <span style="color: #007020">()</span>
<span style="color: #06287e">main</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
  hSetBuffering stdin <span style="color: #902000">NoBuffering</span>
  hSetBuffering stdout <span style="color: #902000">NoBuffering</span>
  hSetEcho stdin <span style="color: #902000">False</span>
<div id="source---observer-on-tvars---initial-state" style="display: inline-block;">  state<span style="color: #666666">@</span>(<span style="color: #902000">AppState</span> mainRowsTV highlightedRowIndexTV debugMessagesTV redrawLock) <span style="color: #007020; font-weight: bold">&lt;-</span> <span style="color: #007020; font-weight: bold">do</span>
    mainRows            <span style="color: #007020; font-weight: bold">&lt;-</span> atomically <span style="color: #666666">$</span> newTVar initialRows
    debugMessages       <span style="color: #007020; font-weight: bold">&lt;-</span> atomically <span style="color: #666666">$</span> newTVar (<span style="color: #902000">[]</span> <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">String</span>])
    highlightedRowIndex <span style="color: #007020; font-weight: bold">&lt;-</span> atomically <span style="color: #666666">$</span> newTVar <span style="color: #902000">Nothing</span>
    redrawLock <span style="color: #007020; font-weight: bold">&lt;-</span> newLock
    return <span style="color: #666666">$</span> <span style="color: #902000">AppState</span> mainRows highlightedRowIndex debugMessages redrawLock
</div>
<div id="source---observer-on-tvars---list-listener" style="display: inline-block;">  forkIO <span style="color: #666666">$</span> <span style="color: #007020; font-weight: bold">do</span>
    <span style="color: #007020; font-weight: bold">let</span> loop rows <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
          activeCellY <span style="color: #007020; font-weight: bold">&lt;-</span> atomically <span style="color: #666666">$</span> readTVar highlightedRowIndexTV
          <span style="color: #007020; font-weight: bold">let</span> activeCellCoords <span style="color: #007020; font-weight: bold">=</span> fmap (<span style="color: #06287e">\</span>y <span style="color: #007020; font-weight: bold">-&gt;</span> (<span style="color: #40a070">0</span>, y)) activeCellY
<div id="source---observer-on-tvars---main-rows-listener-draw" style="display: inline-block;"
>          bracketInLock redrawLock
            <span style="color: #666666">$</span> showInGrid
                xUpperLeft
                yUpperLeft
                columnCount
                columnWidth
                activeCellCoords
                (map (<span style="color: #06287e">\</span>row <span style="color: #007020; font-weight: bold">-&gt;</span> [smth row]) rows)
</div>
          atomically <span style="color: #666666">$</span> <span style="color: #007020; font-weight: bold">do</span>
            debugMessages <span style="color: #007020; font-weight: bold">&lt;-</span> readTVar debugMessagesTV
            <span style="color: #007020; font-weight: bold">let</span> msg <span style="color: #007020; font-weight: bold">=</span> <span style="color: #4070a0">&quot;main rows listener: updated view&quot;</span>
            <div id="source---observer-on-tvars---main-rows-listener-log" style="display: inline;">writeTVar debugMessagesTV <span style="color: #666666">$</span> take debugLinesCount (msg<span style="color: #902000">:</span>debugMessages)</div>
          newMainRows <span style="color: #007020; font-weight: bold">&lt;-</span> atomically <span style="color: #666666">$</span> <span style="color: #007020; font-weight: bold">do</span>
            newMainRows <span style="color: #007020; font-weight: bold">&lt;-</span> readTVar mainRowsTV
            <span style="color: #007020; font-weight: bold">if</span> newMainRows <span style="color: #666666">==</span> rows
              <span style="color: #007020; font-weight: bold">then</span> retry
              <div id="source---observer-on-tvars---triggering-main-rows-listener" style="display: inline;"><span style="color: #007020; font-weight: bold">else</span> return newMainRows</div>
          loop newMainRows
    mainRows <span style="color: #007020; font-weight: bold">&lt;-</span> atomically <span style="color: #666666">$</span> <span style="color: #007020; font-weight: bold">do</span>
      rows <span style="color: #007020; font-weight: bold">&lt;-</span> readTVar mainRowsTV
      return rows
    loop mainRows
</div>
<div id="source---observer-on-tvars---active-cell-y-listener" style="display: inline-block;">  forkIO <span style="color: #666666">$</span> <span style="color: #007020; font-weight: bold">do</span>
    <span style="color: #007020; font-weight: bold">let</span> loop activeCellY <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
          <span style="color: #007020; font-weight: bold">let</span> activeCellCoords <span style="color: #007020; font-weight: bold">=</span> fmap (<span style="color: #06287e">\</span>y <span style="color: #007020; font-weight: bold">-&gt;</span> (<span style="color: #40a070">0</span>, y)) activeCellY
<div id="source---observer-on-tvars---active-cell-y-listener-draw" style="display: inline-block;"
>          bracketInLock redrawLock
            <span style="color: #666666">$</span> <span style="color: #007020; font-weight: bold">do</span>
                drawGrid xUpperLeft yUpperLeft columnWidth columnCount rowCount
                <span style="color: #007020; font-weight: bold">case</span> activeCellCoords <span style="color: #007020; font-weight: bold">of</span>
                  <span style="color: #902000">Nothing</span> <span style="color: #007020; font-weight: bold">-&gt;</span> return <span style="color: #007020">()</span>
                  <span style="color: #902000">Just</span> coordsPair <span style="color: #007020; font-weight: bold">-&gt;</span> highlightCell xUpperLeft yUpperLeft columnWidth columnCount rowCount coordsPair
</div>
          atomically <span style="color: #666666">$</span> <span style="color: #007020; font-weight: bold">do</span>
            debugMessages <span style="color: #007020; font-weight: bold">&lt;-</span> readTVar debugMessagesTV
            <span style="color: #007020; font-weight: bold">let</span> msg <span style="color: #007020; font-weight: bold">=</span> <span style="color: #4070a0">&quot;selected cell listener: updated highlighted cell&quot;</span>
            <div id="source---observer-on-tvars---active-cell-y-listener-log" style="display: inline;">writeTVar debugMessagesTV <span style="color: #666666">$</span> take debugLinesCount (msg<span style="color: #902000">:</span>debugMessages)</div>
          newActiveCellY <span style="color: #007020; font-weight: bold">&lt;-</span> atomically <span style="color: #666666">$</span> <span style="color: #007020; font-weight: bold">do</span>
            newActiveCellY <span style="color: #007020; font-weight: bold">&lt;-</span> readTVar highlightedRowIndexTV
            <span style="color: #007020; font-weight: bold">if</span> newActiveCellY <span style="color: #666666">==</span> activeCellY
              <span style="color: #007020; font-weight: bold">then</span> retry
              <div id="source---observer-on-tvars---triggering-highlighted-cell-listener" style="display: inline;"><span style="color: #007020; font-weight: bold">else</span> return newActiveCellY</div>
          loop newActiveCellY
    activeCellY <span style="color: #007020; font-weight: bold">&lt;-</span> atomically <span style="color: #666666">$</span> readTVar highlightedRowIndexTV
    loop activeCellY
</div>
<div id="source---observer-on-tvars---logs-listener" style="display: inline-block;">  forkIO <span style="color: #666666">$</span> <span style="color: #007020; font-weight: bold">do</span>
    <span style="color: #007020; font-weight: bold">let</span> loop debugMessages <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
<div id="source---observer-on-tvars---debug-messages-listener-draw" style="display: inline-block;"
>          bracketInLock redrawLock
            <span style="color: #666666">$</span> printFromBottom
                xUpperLeft
                (yUpperLeft<span style="color: #666666">+</span><span style="color: #40a070">12</span><span style="color: #666666">+</span>debugLinesCount)
                debugMessages
</div>
          newDebugMessages <span style="color: #007020; font-weight: bold">&lt;-</span> atomically <span style="color: #666666">$</span> <span style="color: #007020; font-weight: bold">do</span>
            newDebugMessages <span style="color: #007020; font-weight: bold">&lt;-</span> readTVar debugMessagesTV
            <span style="color: #007020; font-weight: bold">if</span> newDebugMessages <span style="color: #666666">==</span> debugMessages
              <span style="color: #007020; font-weight: bold">then</span> retry
              <div id="source---observer-on-tvars---triggering-debug-messages-listener" style="display: inline;"><span style="color: #007020; font-weight: bold">else</span> return newDebugMessages</div>
          loop newDebugMessages
    debugMessages <span style="color: #007020; font-weight: bold">&lt;-</span> atomically <span style="color: #666666">$</span> readTVar debugMessagesTV
    loop debugMessages
</div>
      
  <span id="source---observer-on-tvars---clear-screen">bracketInLock redrawLock clearScreen</span>

  keepListeningToKeyPresses state
  <span style="color: #007020; font-weight: bold">where</span>
    xUpperLeft <span style="color: #007020; font-weight: bold">=</span> <span style="color: #40a070">0</span>
    yUpperLeft <span style="color: #007020; font-weight: bold">=</span> <span style="color: #40a070">0</span>
    columnCount <span style="color: #007020; font-weight: bold">=</span> <span style="color: #40a070">1</span>
    columnWidth <span style="color: #007020; font-weight: bold">=</span> <span style="color: #40a070">14</span>
    rowCount <span style="color: #007020; font-weight: bold">=</span> length initialRows
    debugLinesCount <span style="color: #007020; font-weight: bold">=</span> <span style="color: #40a070">20</span>
    showEditField appState<span style="color: #666666">@</span>(<span style="color: #902000">AppState</span> mainRowsTV highlightedRowIndexTV _debugMessagesTV redrawLock) value <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
      <span style="color: #007020; font-weight: bold">let</span>
        txt <span style="color: #007020; font-weight: bold">=</span> <span style="color: #4070a0">&quot;edit cell value:&quot;</span>
        lentxt <span style="color: #007020; font-weight: bold">=</span> length txt
        yPos <span style="color: #007020; font-weight: bold">=</span> <span style="color: #40a070">0</span>
        xPos <span style="color: #007020; font-weight: bold">=</span> (columnCount <span style="color: #666666">*</span> (columnWidth <span style="color: #666666">+</span> <span style="color: #40a070">1</span>)) <span style="color: #666666">+</span> <span style="color: #40a070">3</span>
        replaceNth lst idx val <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">if</span> idx <span style="color: #666666">&lt;</span> <span style="color: #40a070">1</span> <span style="color: #007020; font-weight: bold">then</span> val<span style="color: #902000">:</span>(tail lst) <span style="color: #007020; font-weight: bold">else</span> (head lst) <span style="color: #902000">:</span> (replaceNth (tail lst) (idx <span style="color: #666666">-</span> <span style="color: #40a070">1</span>) val)
      showInRectangle xPos yPos lentxt [txt, value]
      key <span style="color: #007020; font-weight: bold">&lt;-</span> getKey
      <span style="color: #007020; font-weight: bold">case</span> key <span style="color: #007020; font-weight: bold">of</span>
        <span style="color: #4070a0">&quot;</span><span style="color: #4070a0; font-weight: bold">\n</span><span style="color: #4070a0">&quot;</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span>
          atomically <span style="color: #666666">$</span> <span style="color: #007020; font-weight: bold">do</span>
            maybeCellIndex <span style="color: #007020; font-weight: bold">&lt;-</span> readTVar highlightedRowIndexTV
            rows <span style="color: #007020; font-weight: bold">&lt;-</span> readTVar mainRowsTV
            <span style="color: #007020; font-weight: bold">case</span> maybeCellIndex <span style="color: #007020; font-weight: bold">of</span>
              <span style="color: #902000">Nothing</span> <span style="color: #007020; font-weight: bold">-&gt;</span> return <span style="color: #007020">()</span>
              <span style="color: #902000">Just</span> cellIndex <span style="color: #007020; font-weight: bold">-&gt;</span> <div id="source---observer-on-tvars---write2tvar-main-rows-from-enter-key-press" style="display: inline;">writeTVar mainRowsTV <span style="color: #666666">$</span> replaceNth rows cellIndex (<span style="color: #902000">Row</span> value)</div>
          bracketInLock redrawLock <span style="color: #666666">$</span> clearRectangle xPos yPos lentxt <span style="color: #40a070">2</span>
          keepListeningToKeyPresses appState
        <span style="color: #4070a0">&quot;</span><span style="color: #4070a0; font-weight: bold">\DEL</span><span style="color: #4070a0">&quot;</span> <span style="color: #007020; font-weight: bold">-&gt;</span> showEditField appState (<span style="color: #007020; font-weight: bold">if</span> (length value) <span style="color: #666666">==</span> <span style="color: #40a070">0</span> <span style="color: #007020; font-weight: bold">then</span> value <span style="color: #007020; font-weight: bold">else</span> init value)
        c <span style="color: #007020; font-weight: bold">-&gt;</span> showEditField appState (value <span style="color: #666666">++</span> c)
<div id="source---observer-on-tvars---keepListeningToKeyPresses" style="display: inline-block;"
>    <div id="source---observer-on-tvars---keepListeningToKeyPresses-definition-line" style="display: inline;">keepListeningToKeyPresses state<span style="color: #666666">@</span>(<span style="color: #902000">AppState</span> mainRowsTV highlightedRowIndexTV debugMessagesTV _redrawLock) <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span></div>
      <div id="source---observer-on-tvars---getKey" style="display: inline;">key <span style="color: #007020; font-weight: bold">&lt;-</span> getKey</div>
      when (key <span style="color: #666666">/=</span> <span style="color: #4070a0">&quot;</span><span style="color: #4070a0; font-weight: bold">\ESC</span><span style="color: #4070a0">&quot;</span>) <span style="color: #666666">$</span> <span style="color: #007020; font-weight: bold">do</span>
        <div id="source---observer-on-tvars---case-key-of" style="display: inline;"><span style="color: #007020; font-weight: bold">case</span> key <span style="color: #007020; font-weight: bold">of</span></div>
          <div id="source---observer-on-tvars---case-key-up" style="display: inline;"><span style="color: #4070a0">&quot;</span><span style="color: #4070a0; font-weight: bold">\ESC</span><span style="color: #4070a0">[A&quot;</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span> <span style="color: #60a0b0; font-style: italic">-- up</span></div>
            atomically <span style="color: #666666">$</span> <span style="color: #007020; font-weight: bold">do</span>
              activeCellY <span style="color: #007020; font-weight: bold">&lt;-</span> readTVar highlightedRowIndexTV
              debugRows <span style="color: #007020; font-weight: bold">&lt;-</span> readTVar debugMessagesTV
              <span style="color: #007020; font-weight: bold">let</span> newActiveCellY <span style="color: #007020; font-weight: bold">=</span>
                    <span style="color: #007020; font-weight: bold">case</span> activeCellY <span style="color: #007020; font-weight: bold">of</span>
                      <span style="color: #902000">Just</span> y <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Just</span> <span style="color: #666666">$</span> max <span style="color: #40a070">0</span> (y<span style="color: #666666">-</span><span style="color: #40a070">1</span>)
                      <span style="color: #902000">Nothing</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Just</span> <span style="color: #40a070">0</span>
                  debugRow <span style="color: #007020; font-weight: bold">=</span> <span style="color: #4070a0">&quot;up, &quot;</span> <span style="color: #666666">++</span> show(newActiveCellY)
                  newDebugRows <span style="color: #007020; font-weight: bold">=</span> take debugLinesCount (debugRow<span style="color: #902000">:</span>debugRows)
              <div id="source---observer-on-tvars---write2tvar-active-cell-y-from-up-key-press" style="display: inline;">writeTVar highlightedRowIndexTV newActiveCellY</div>
              <div id="source---observer-on-tvars---write2tvar-debug-messages-from-up-key-press" style="display: inline;">writeTVar debugMessagesTV newDebugRows</div>
            keepListeningToKeyPresses state
</div>
          <div id="source---observer-on-tvars---case-key-down" style="display: inline;"><span style="color: #4070a0">&quot;</span><span style="color: #4070a0; font-weight: bold">\ESC</span><span style="color: #4070a0">[B&quot;</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span> <span style="color: #60a0b0; font-style: italic">-- down</span></div>
            atomically <span style="color: #666666">$</span> <span style="color: #007020; font-weight: bold">do</span>
              activeCellY <span style="color: #007020; font-weight: bold">&lt;-</span> readTVar highlightedRowIndexTV
              debugRows <span style="color: #007020; font-weight: bold">&lt;-</span> readTVar debugMessagesTV
              <span style="color: #007020; font-weight: bold">let</span> newActiveCellY <span style="color: #007020; font-weight: bold">=</span>
                    <span style="color: #007020; font-weight: bold">case</span> activeCellY <span style="color: #007020; font-weight: bold">of</span>
                      <span style="color: #902000">Just</span> y <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Just</span> <span style="color: #666666">$</span> min (rowCount<span style="color: #666666">-</span><span style="color: #40a070">1</span>) (y<span style="color: #666666">+</span><span style="color: #40a070">1</span>)
                      <span style="color: #902000">Nothing</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Just</span> <span style="color: #40a070">0</span>
                  debugRow <span style="color: #007020; font-weight: bold">=</span> <span style="color: #4070a0">&quot;down, &quot;</span> <span style="color: #666666">++</span> show(newActiveCellY)
                  newDebugRows <span style="color: #007020; font-weight: bold">=</span> take debugLinesCount (debugRow<span style="color: #902000">:</span>debugRows)
              <div id="source---observer-on-tvars---write2tvar-active-cell-y-from-down-key-press" style="display: inline;">writeTVar highlightedRowIndexTV newActiveCellY</div>
              <div id="source---observer-on-tvars---write2tvar-debug-messages-from-down-key-press" style="display: inline;">writeTVar debugMessagesTV newDebugRows</div>
            keepListeningToKeyPresses state
          <div id="source---observer-on-tvars---case-key-enter" style="display: inline;"><span style="color: #4070a0">&quot;</span><span style="color: #4070a0; font-weight: bold">\n</span><span style="color: #4070a0">&quot;</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span> <span style="color: #60a0b0; font-style: italic">-- enter</span></div>
            <span style="color: #60a0b0; font-style: italic">--eitherValue &lt;- try $ atomically $ do</span>
            eitherValue <span style="color: #007020; font-weight: bold">&lt;-</span> (try <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">IO</span> <span style="color: #902000">String</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">IO</span> (<span style="color: #902000">Either</span> <span style="color: #902000">ErrorCall</span> <span style="color: #902000">String</span>)) <span style="color: #666666">$</span> atomically <span style="color: #666666">$</span> <span style="color: #007020; font-weight: bold">do</span>
              maybeCellIndex <span style="color: #007020; font-weight: bold">&lt;-</span> readTVar highlightedRowIndexTV
              rows <span style="color: #007020; font-weight: bold">&lt;-</span> readTVar mainRowsTV
              <span style="color: #007020; font-weight: bold">case</span> maybeCellIndex <span style="color: #007020; font-weight: bold">of</span>
                <span style="color: #902000">Nothing</span> <span style="color: #007020; font-weight: bold">-&gt;</span> throwSTM (<span style="color: #902000">ErrorCall</span> <span style="color: #4070a0">&quot;there&#39;s no selected cell&quot;</span>)
                <span style="color: #902000">Just</span> cellIndex <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span>
                  <span style="color: #007020; font-weight: bold">if</span> cellIndex <span style="color: #666666">&lt;</span> <span style="color: #40a070">0</span> <span style="color: #666666">||</span> cellIndex <span style="color: #666666">&gt;=</span> (length rows)
                    <span style="color: #007020; font-weight: bold">then</span> throwSTM (<span style="color: #902000">ErrorCall</span> <span style="color: #666666">$</span> <span style="color: #4070a0">&quot;index out of bounds: &quot;</span> <span style="color: #666666">++</span> (show cellIndex))
                    <span style="color: #007020; font-weight: bold">else</span> return <span style="color: #666666">$</span> smth <span style="color: #666666">$</span> rows <span style="color: #666666">!!</span> cellIndex
            <span style="color: #007020; font-weight: bold">case</span> eitherValue <span style="color: #007020; font-weight: bold">of</span>
              <span style="color: #902000">Left</span> e <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span>
                atomically <span style="color: #666666">$</span> <span style="color: #007020; font-weight: bold">do</span>
                  debugMessages <span style="color: #007020; font-weight: bold">&lt;-</span> readTVar debugMessagesTV
                  <span style="color: #007020; font-weight: bold">let</span> msg <span style="color: #007020; font-weight: bold">=</span> <span style="color: #4070a0">&quot;error: &quot;</span> <span style="color: #666666">++</span> (show e)
                  <div id="source---observer-on-tvars---write2tvar-debug-messages-from-enter-key-press" style="display: inline;">writeTVar debugMessagesTV <span style="color: #666666">$</span> take debugLinesCount (msg<span style="color: #902000">:</span>debugMessages)</div>
                keepListeningToKeyPresses state
              <span style="color: #902000">Right</span> v <span style="color: #007020; font-weight: bold">-&gt;</span> showEditField state v
<div id="source---observer-on-tvars---case-key-otherwise" style="display: inline-block;"
>          <span style="color: #4070a0">&quot;q&quot;</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <div class="source---observer-on-tvars---exit" style="display: inline;">return <span style="color: #007020">()</span></div>
          <span style="color: #007020; font-weight: bold">_</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <div class="source---observer-on-tvars---exit" style="display: inline;">return <span style="color: #007020">()</span></div>
</div>

<span style="color: #06287e">getKey</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">IO</span> [<span style="color: #902000">Char</span>]
<span style="color: #06287e">getKey</span> <span style="color: #007020; font-weight: bold">=</span> reverse <span style="color: #666666">&lt;$&gt;</span> getKey&#39; <span style="color: #4070a0">&quot;&quot;</span>
  <span style="color: #007020; font-weight: bold">where</span>
  getKey&#39; chars <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
    char <span style="color: #007020; font-weight: bold">&lt;-</span> getChar
    more <span style="color: #007020; font-weight: bold">&lt;-</span> hReady stdin
    (<span style="color: #007020; font-weight: bold">if</span> more <span style="color: #007020; font-weight: bold">then</span> getKey&#39; <span style="color: #007020; font-weight: bold">else</span> return) (char<span style="color: #902000">:</span>chars)
</pre></div> <!-- end of source observer-on-tvars main -->











<!-- HTML generated using hilite.me --><div id="source---observer-primitive---main" style="display: none; background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #007020; font-weight: bold">module</span> <span style="color: #0e84b5; font-weight: bold">Main</span> <span style="color: #007020; font-weight: bold">where</span>

<span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">Control.Monad</span> (<span style="color: #06287e">when</span>, <span style="color: #06287e">forM_</span>)
<span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">Control.Exception</span> (<span style="color: #06287e">try</span>)
<span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">System.IO</span> (<span style="color: #06287e">stdin</span>, <span style="color: #06287e">stdout</span>, <span style="color: #06287e">hSetEcho</span>, <span style="color: #06287e">hSetBuffering</span>, <span style="color: #06287e">hReady</span>, <span style="color: #902000">BufferMode</span> (<span style="color: #902000">NoBuffering</span>) )
<span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">ViewUtils</span> (<span style="color: #06287e">clearScreen</span>, <span style="color: #06287e">showInRectangle</span>, <span style="color: #06287e">clearRectangle</span>, <span style="color: #06287e">showInGrid</span>, <span style="color: #06287e">drawGrid</span>, <span style="color: #06287e">highlightCell</span>, <span style="color: #06287e">printFromBottom</span>)

<span style="color: #007020; font-weight: bold">data</span> <span style="color: #902000">RowData</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">Row</span> { smth <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">String</span> } <span style="color: #007020; font-weight: bold">deriving</span> <span style="color: #902000">Eq</span>

<span style="color: #06287e">initialRows</span> <span style="color: #007020; font-weight: bold">=</span> [
  <span style="color: #902000">Row</span> <span style="color: #4070a0">&quot;something a&quot;</span>
  , <span style="color: #902000">Row</span> <span style="color: #4070a0">&quot;something b&quot;</span>
  , <span style="color: #902000">Row</span> <span style="color: #4070a0">&quot;something c&quot;</span>
  , <span style="color: #902000">Row</span> <span style="color: #4070a0">&quot;something d&quot;</span>
  , <span style="color: #902000">Row</span> <span style="color: #4070a0">&quot;something e&quot;</span>
  ]

<div id="source---observer-primitive---state-adt" style="display: inline-block;"><span style="color: #007020; font-weight: bold">data</span> <span style="color: #902000">AppStateData</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">AppState</span>
  { rows <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">RowData</span>]
  , activeCellY <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span>
  , debugMessages <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">String</span>]
  , listeners <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">AppStateListenersData</span>
  }

<span style="color: #007020; font-weight: bold">data</span> <span style="color: #902000">AppStateListenersData</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">AppStateListeners</span>
  { rowsListeners <span style="color: #007020; font-weight: bold">::</span> [[<span style="color: #902000">RowData</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">IO</span> <span style="color: #007020">()</span>]
  , activeCellYListeners <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">IO</span> <span style="color: #007020">()</span>]
  , debugMessagesListeners <span style="color: #007020; font-weight: bold">::</span> [[<span style="color: #902000">String</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">IO</span> <span style="color: #007020">()</span>]
  }
</div>

<div id="source---observer-primitive---add-listeners" style="display: inline-block;"><span style="color: #06287e">addRowsListener</span> <span style="color: #007020; font-weight: bold">::</span> ([<span style="color: #902000">RowData</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">IO</span> <span style="color: #007020">()</span>) <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span>
</div>
<span style="color: #06287e">addRowsListener</span> listener (<span style="color: #902000">AppStateListeners</span> rowsListeners _activeCellYListeners _debugMessagesListeners) <span style="color: #007020; font-weight: bold">=</span>
  <span style="color: #902000">AppStateListeners</span> (listener<span style="color: #902000">:</span>rowsListeners) _activeCellYListeners _debugMessagesListeners

<span style="color: #06287e">addActiveCellYListener</span> <span style="color: #007020; font-weight: bold">::</span> (<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">IO</span> <span style="color: #007020">()</span>) <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span>
<span style="color: #06287e">addActiveCellYListener</span> listener (<span style="color: #902000">AppStateListeners</span> _rowsListeners activeCellYListeners _debugMessagesListeners) <span style="color: #007020; font-weight: bold">=</span>
  <span style="color: #902000">AppStateListeners</span> _rowsListeners (listener<span style="color: #902000">:</span>activeCellYListeners) _debugMessagesListeners

<span style="color: #06287e">addDebugMessagesListener</span> <span style="color: #007020; font-weight: bold">::</span> ([<span style="color: #902000">String</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">IO</span> <span style="color: #007020">()</span>) <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span>
<span style="color: #06287e">addDebugMessagesListener</span> listener (<span style="color: #902000">AppStateListeners</span> _rowsListeners _activeCellYListeners debugMessagesListeners) <span style="color: #007020; font-weight: bold">=</span>
  <span style="color: #902000">AppStateListeners</span> _rowsListeners _activeCellYListeners (listener<span style="color: #902000">:</span>debugMessagesListeners)

<span style="color: #06287e">main</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">IO</span> <span style="color: #007020">()</span>
<span style="color: #06287e">main</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
  hSetBuffering stdin <span style="color: #902000">NoBuffering</span>
  hSetBuffering stdout <span style="color: #902000">NoBuffering</span>
  hSetEcho stdin <span style="color: #902000">False</span>
  <div id="source---observer-primitive---initListeners-invokation" style="display: inline;"><span style="color: #007020; font-weight: bold">let</span> appState <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">AppState</span> initialRows <span style="color: #902000">Nothing</span> <span style="color: #902000">[]</span> initListeners
</div>
  <span id="source---observer-primitive---clearScreen">clearScreen</span>
<div id="source---observer-primitive---initial-listener-call" style="display: inline-block;">  forM_ (rowsListeners (listeners appState)) <span style="color: #666666">$</span> <span style="color: #06287e">\</span>listener <span style="color: #007020; font-weight: bold">-&gt;</span> listener (rows appState)
</div>
  <span id="source---observer-primitive---loop-invokation">loop appState</span>
  <span style="color: #007020; font-weight: bold">where</span>
    xUpperLeft <span style="color: #007020; font-weight: bold">=</span> <span style="color: #40a070">0</span>
    yUpperLeft <span style="color: #007020; font-weight: bold">=</span> <span style="color: #40a070">0</span>
    columnCount <span style="color: #007020; font-weight: bold">=</span> <span style="color: #40a070">1</span>
    columnWidth <span style="color: #007020; font-weight: bold">=</span> <span style="color: #40a070">14</span>
    rowCount <span style="color: #007020; font-weight: bold">=</span> length initialRows
    debugLinesCount <span style="color: #007020; font-weight: bold">=</span> <span style="color: #40a070">20</span>

<div id="source---observer-primitive---listeners" style="display: inline-block;"
>    initListeners <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">AppStateListenersData</span>
    <span style="color: #60a0b0; font-style: italic">-- initListeners =</span>
    <span style="color: #60a0b0; font-style: italic">--     addRowsListener mainRowsListener</span>
    <span style="color: #60a0b0; font-style: italic">--     (addActiveCellYListener activeCellYListener</span>
    <span style="color: #60a0b0; font-style: italic">--     (addDebugMessagesListener debugMessagesListener</span>
    <span style="color: #60a0b0; font-style: italic">--     (empty)))</span>
    initListeners <span style="color: #007020; font-weight: bold">=</span>
        addRowsListener mainRowsListener
        <span style="color: #666666">$</span> addActiveCellYListener activeCellYListener
        <span style="color: #666666">$</span> addDebugMessagesListener debugMessagesListener
        <span style="color: #666666">$</span> empty
      <span style="color: #007020; font-weight: bold">where</span>
        empty <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">AppStateListeners</span> <span style="color: #902000">[]</span> <span style="color: #902000">[]</span> <span style="color: #902000">[]</span>

    mainRowsListener <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">RowData</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">IO</span> <span style="color: #007020">()</span>
    mainRowsListener rows <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
      showInGrid
        xUpperLeft
        yUpperLeft
        columnCount
        columnWidth
        <span style="color: #902000">Nothing</span>
        (map (<span style="color: #06287e">\</span>row <span style="color: #007020; font-weight: bold">-&gt;</span> [smth row]) rows)

    activeCellYListener <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">IO</span> <span style="color: #007020">()</span>
    activeCellYListener activeCellY <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
      <span style="color: #007020; font-weight: bold">let</span> activeCellCoords <span style="color: #007020; font-weight: bold">=</span> fmap (<span style="color: #06287e">\</span>y <span style="color: #007020; font-weight: bold">-&gt;</span> (<span style="color: #40a070">0</span>, y)) activeCellY
      drawGrid xUpperLeft yUpperLeft columnWidth columnCount rowCount
      <span style="color: #007020; font-weight: bold">case</span> activeCellCoords <span style="color: #007020; font-weight: bold">of</span>
        <span style="color: #902000">Nothing</span> <span style="color: #007020; font-weight: bold">-&gt;</span> return <span style="color: #007020">()</span>
        <span style="color: #902000">Just</span> coordsPair <span style="color: #007020; font-weight: bold">-&gt;</span> highlightCell xUpperLeft yUpperLeft columnWidth columnCount rowCount coordsPair

    debugMessagesListener <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">String</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">IO</span> <span style="color: #007020">()</span>
    debugMessagesListener debugMessages <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
      printFromBottom
        xUpperLeft
        (yUpperLeft<span style="color: #666666">+</span><span style="color: #40a070">12</span><span style="color: #666666">+</span>debugLinesCount)
        debugMessages
</div>

<div id="source---observer-primitive---loop-definition" style="display: inline-block;"
><div id="source---observer-primitive---loop-definition-2-lines" style="display: inline-block;">    loop <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">AppStateData</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">IO</span> <span style="color: #007020">()</span>
    loop appState<span style="color: #666666">@</span>(<span style="color: #902000">AppState</span> rows activeCellY debugMessages listenersHolder) <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span></div>
      <div id="source---observer-primitive---getKey" style="display: inline;">key <span style="color: #007020; font-weight: bold">&lt;-</span> getKey</div>
      when (key <span style="color: #666666">/=</span> <span style="color: #4070a0">&quot;</span><span style="color: #4070a0; font-weight: bold">\ESC</span><span style="color: #4070a0">&quot;</span>) <span style="color: #666666">$</span> <span style="color: #007020; font-weight: bold">do</span>
        <div id="source---observer-primitive---case-key-of" style="display: inline;"><span style="color: #007020; font-weight: bold">case</span> key <span style="color: #007020; font-weight: bold">of</span></div>
          <div id="source---observer-primitive---case-key-up" class="source---observer-primitive---case-key-up-down-enter" style="display: inline;"><span style="color: #4070a0">&quot;</span><span style="color: #4070a0; font-weight: bold">\ESC</span><span style="color: #4070a0">[A&quot;</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span> <span style="color: #60a0b0; font-style: italic">-- up</span></div>
            <span style="color: #007020; font-weight: bold">let</span> newActiveCellY <span style="color: #007020; font-weight: bold">=</span>
                  <span style="color: #007020; font-weight: bold">case</span> activeCellY <span style="color: #007020; font-weight: bold">of</span>
                    <span style="color: #902000">Just</span> y <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Just</span> <span style="color: #666666">$</span> max <span style="color: #40a070">0</span> (y<span style="color: #666666">-</span><span style="color: #40a070">1</span>)
                    <span style="color: #902000">Nothing</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Just</span> <span style="color: #40a070">0</span>
                debugRow <span style="color: #007020; font-weight: bold">=</span> <span style="color: #4070a0">&quot;up, &quot;</span> <span style="color: #666666">++</span> show(newActiveCellY)
                newDebugRows <span style="color: #007020; font-weight: bold">=</span> take debugLinesCount (debugRow<span style="color: #902000">:</span>debugMessages)
            <div id="source---observer-primitive---invoke-active-cell-y-listeners-from-up-key-press" class="source---observer-primitive---invoke-listeners" style="display: inline;">forM_ (activeCellYListeners listenersHolder) <span style="color: #666666">$</span> <span style="color: #06287e">\</span>listener <span style="color: #007020; font-weight: bold">-&gt;</span> listener newActiveCellY</div>
            <div id="source---observer-primitive---invoke-debug-messages-listeners-from-up-key-press" class="source---observer-primitive---invoke-listeners" style="display: inline;">forM_ (debugMessagesListeners listenersHolder) <span style="color: #666666">$</span> <span style="color: #06287e">\</span>listener <span style="color: #007020; font-weight: bold">-&gt;</span> listener newDebugRows</div>
            loop <div class="source---observer-primitive---new-state" style="display: inline;">(<span style="color: #902000">AppState</span> rows newActiveCellY newDebugRows listenersHolder)</div>
</div>
          <div id="source---observer-primitive---case-key-down" class="source---observer-primitive---case-key-up-down-enter" style="display: inline;"><span style="color: #4070a0">&quot;</span><span style="color: #4070a0; font-weight: bold">\ESC</span><span style="color: #4070a0">[B&quot;</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span> <span style="color: #60a0b0; font-style: italic">-- down</span></div>
            <span style="color: #007020; font-weight: bold">let</span> newActiveCellY <span style="color: #007020; font-weight: bold">=</span>
                  <span style="color: #007020; font-weight: bold">case</span> activeCellY <span style="color: #007020; font-weight: bold">of</span>
                    <span style="color: #902000">Just</span> y <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Just</span> <span style="color: #666666">$</span> min (rowCount<span style="color: #666666">-</span><span style="color: #40a070">1</span>) (y<span style="color: #666666">+</span><span style="color: #40a070">1</span>)
                    <span style="color: #902000">Nothing</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Just</span> <span style="color: #40a070">0</span>
                debugRow <span style="color: #007020; font-weight: bold">=</span> <span style="color: #4070a0">&quot;down, &quot;</span> <span style="color: #666666">++</span> show(newActiveCellY)
                newDebugRows <span style="color: #007020; font-weight: bold">=</span> take debugLinesCount (debugRow<span style="color: #902000">:</span>debugMessages)
            <div id="source---observer-primitive---invoke-active-cell-y-listeners-from-down-key-press" class="source---observer-primitive---invoke-listeners" style="display: inline;">forM_ (activeCellYListeners listenersHolder) <span style="color: #666666">$</span> <span style="color: #06287e">\</span>listener <span style="color: #007020; font-weight: bold">-&gt;</span> listener newActiveCellY</div>
            <div id="source---observer-primitive---invoke-debug-messages-listeners-from-down-key-press" class="source---observer-primitive---invoke-listeners" style="display: inline;">forM_ (debugMessagesListeners listenersHolder) <span style="color: #666666">$</span> <span style="color: #06287e">\</span>listener <span style="color: #007020; font-weight: bold">-&gt;</span> listener newDebugRows</div>
            loop <div class="source---observer-primitive---new-state" style="display: inline;">(<span style="color: #902000">AppState</span> rows newActiveCellY newDebugRows listenersHolder)</div>
          <div id="source---observer-primitive---case-key-enter" class="source---observer-primitive---case-key-up-down-enter" style="display: inline;"><span style="color: #4070a0">&quot;</span><span style="color: #4070a0; font-weight: bold">\n</span><span style="color: #4070a0">&quot;</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span> <span style="color: #60a0b0; font-style: italic">-- enter</span></div>
            <span style="color: #007020; font-weight: bold">let</span> eitherValue <span style="color: #007020; font-weight: bold">=</span>
                  <span style="color: #007020; font-weight: bold">case</span> activeCellY <span style="color: #007020; font-weight: bold">of</span>
                    <span style="color: #902000">Nothing</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Left</span> <span style="color: #4070a0">&quot;there&#39;s no selected cell&quot;</span>
                    <span style="color: #902000">Just</span> cellIndex <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span>
                      <span style="color: #007020; font-weight: bold">if</span> cellIndex <span style="color: #666666">&lt;</span> <span style="color: #40a070">0</span> <span style="color: #666666">||</span> cellIndex <span style="color: #666666">&gt;=</span> (length rows)
                        <span style="color: #007020; font-weight: bold">then</span> <span style="color: #902000">Left</span> <span style="color: #666666">$</span> <span style="color: #4070a0">&quot;index out of bounds: &quot;</span> <span style="color: #666666">++</span> (show cellIndex)
                        <span style="color: #007020; font-weight: bold">else</span> <span style="color: #902000">Right</span> <span style="color: #666666">$</span> smth <span style="color: #666666">$</span> rows <span style="color: #666666">!!</span> cellIndex
            <span style="color: #007020; font-weight: bold">let</span> 

              showEditField value <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
                <span style="color: #007020; font-weight: bold">let</span>
                  txt <span style="color: #007020; font-weight: bold">=</span> <span style="color: #4070a0">&quot;edit cell value:&quot;</span>
                  lentxt <span style="color: #007020; font-weight: bold">=</span> length txt
                  yPos <span style="color: #007020; font-weight: bold">=</span> <span style="color: #40a070">0</span>
                  xPos <span style="color: #007020; font-weight: bold">=</span> (columnCount <span style="color: #666666">*</span> (columnWidth <span style="color: #666666">+</span> <span style="color: #40a070">1</span>)) <span style="color: #666666">+</span> <span style="color: #40a070">3</span>
                  replaceNth lst idx val <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">if</span> idx <span style="color: #666666">&lt;</span> <span style="color: #40a070">1</span> <span style="color: #007020; font-weight: bold">then</span> val<span style="color: #902000">:</span>(tail lst) <span style="color: #007020; font-weight: bold">else</span> (head lst) <span style="color: #902000">:</span> (replaceNth (tail lst) (idx <span style="color: #666666">-</span> <span style="color: #40a070">1</span>) val)
                showInRectangle xPos yPos lentxt [txt, value]
                key <span style="color: #007020; font-weight: bold">&lt;-</span> getKey
                <span style="color: #007020; font-weight: bold">case</span> key <span style="color: #007020; font-weight: bold">of</span>
                  <span style="color: #4070a0">&quot;</span><span style="color: #4070a0; font-weight: bold">\n</span><span style="color: #4070a0">&quot;</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span>
                    <span style="color: #007020; font-weight: bold">case</span> activeCellY <span style="color: #007020; font-weight: bold">of</span>
                      <span style="color: #902000">Nothing</span> <span style="color: #007020; font-weight: bold">-&gt;</span> return <span style="color: #007020">()</span>
                      <span style="color: #902000">Just</span> cellIndex <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span>
                        clearRectangle xPos yPos lentxt <span style="color: #40a070">2</span>
                        <span style="color: #007020; font-weight: bold">let</span>
                          newRows <span style="color: #007020; font-weight: bold">=</span> replaceNth rows cellIndex (<span style="color: #902000">Row</span> value)
                          msg <span style="color: #007020; font-weight: bold">=</span> <span style="color: #4070a0">&quot;updated rows&quot;</span>
                          newDebugRows <span style="color: #007020; font-weight: bold">=</span> take debugLinesCount (msg<span style="color: #902000">:</span>debugMessages)
                        <div id="source---observer-primitive---invoke-main-rows-listeners-from-enter-key-press" class="source---observer-primitive---invoke-listeners" style="display: inline;">forM_ (rowsListeners listenersHolder) <span style="color: #666666">$</span> <span style="color: #06287e">\</span>listener <span style="color: #007020; font-weight: bold">-&gt;</span> listener newRows</div>
                        <div id="source---observer-primitive---invoke-debug-messages-listeners-from-enter-key-press" class="source---observer-primitive---invoke-listeners" style="display: inline;">forM_ (debugMessagesListeners listenersHolder) <span style="color: #666666">$</span> <span style="color: #06287e">\</span>listener <span style="color: #007020; font-weight: bold">-&gt;</span> listener newDebugRows</div>
                        loop <div class="source---observer-primitive---new-state" style="display: inline;">(<span style="color: #902000">AppState</span> newRows <span style="color: #902000">Nothing</span> newDebugRows listenersHolder)</div>
                  <span style="color: #4070a0">&quot;</span><span style="color: #4070a0; font-weight: bold">\DEL</span><span style="color: #4070a0">&quot;</span> <span style="color: #007020; font-weight: bold">-&gt;</span> showEditField (<span style="color: #007020; font-weight: bold">if</span> (length value) <span style="color: #666666">==</span> <span style="color: #40a070">0</span> <span style="color: #007020; font-weight: bold">then</span> value <span style="color: #007020; font-weight: bold">else</span> init value)
                  c <span style="color: #007020; font-weight: bold">-&gt;</span> showEditField (value <span style="color: #666666">++</span> c)
            <span style="color: #007020; font-weight: bold">case</span> eitherValue <span style="color: #007020; font-weight: bold">of</span>
              <span style="color: #902000">Left</span> e <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span>
                <span style="color: #007020; font-weight: bold">let</span> msg <span style="color: #007020; font-weight: bold">=</span> <span style="color: #4070a0">&quot;error: &quot;</span> <span style="color: #666666">++</span> (show e)
                <span style="color: #007020; font-weight: bold">let</span> newDebugRows <span style="color: #007020; font-weight: bold">=</span> take debugLinesCount (msg<span style="color: #902000">:</span>debugMessages)
                <div id="source---observer-primitive---invoke-debug-messages-listeners-from-enter-key-press-when-error" class="source---observer-primitive---invoke-listeners" style="display: inline;">forM_ (debugMessagesListeners listenersHolder) <span style="color: #666666">$</span> <span style="color: #06287e">\</span>listener <span style="color: #007020; font-weight: bold">-&gt;</span> listener newDebugRows</div>
                loop <div class="source---observer-primitive---new-state" style="display: inline;">(<span style="color: #902000">AppState</span> rows activeCellY newDebugRows listenersHolder)</div>
              <span style="color: #902000">Right</span> v <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span>
                showEditField v
<div id="source---observer-primitive---otherwise" style="display: inline-block;"
>          <span style="color: #4070a0">&quot;q&quot;</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <div class="source---observer-primitive---exit" style="display: inline;">return <span style="color: #007020">()</span></div>
          <span style="color: #007020; font-weight: bold">_</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <div class="source---observer-primitive---exit" style="display: inline;">return <span style="color: #007020">()</span></div>
</div>

<span style="color: #06287e">getKey</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">IO</span> [<span style="color: #902000">Char</span>]
<span style="color: #06287e">getKey</span> <span style="color: #007020; font-weight: bold">=</span> reverse <span style="color: #666666">&lt;$&gt;</span> getKey&#39; <span style="color: #4070a0">&quot;&quot;</span>
  <span style="color: #007020; font-weight: bold">where</span>
  getKey&#39; chars <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
    char <span style="color: #007020; font-weight: bold">&lt;-</span> getChar
    more <span style="color: #007020; font-weight: bold">&lt;-</span> hReady stdin
    (<span style="color: #007020; font-weight: bold">if</span> more <span style="color: #007020; font-weight: bold">then</span> getKey&#39; <span style="color: #007020; font-weight: bold">else</span> return) (char<span style="color: #902000">:</span>chars)
  </pre></div> <!-- end of source observer-primitive main -->








<!-- HTML generated using hilite.me --><div id="source---observer-in-custom-monad---main" style="display: none; background: #f0f0f0; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #60a0b0; font-style: italic">{-# LANGUAGE  GeneralizedNewtypeDeriving #-}</span>
<span style="color: #007020; font-weight: bold">module</span> <span style="color: #0e84b5; font-weight: bold">Main</span> <span style="color: #007020; font-weight: bold">where</span>

<span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">Control.Monad</span> (<span style="color: #06287e">when</span>, <span style="color: #06287e">forM_</span>)
<span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">Control.Exception</span> (<span style="color: #06287e">try</span>)
<span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">System.IO</span> (<span style="color: #06287e">stdin</span>, <span style="color: #06287e">stdout</span>, <span style="color: #06287e">hSetEcho</span>, <span style="color: #06287e">hSetBuffering</span>, <span style="color: #06287e">hReady</span>, <span style="color: #902000">BufferMode</span> (<span style="color: #902000">NoBuffering</span>) )
<span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">Control.Monad.State.Strict</span> (<span style="color: #902000">StateT</span>, <span style="color: #06287e">get</span>, <span style="color: #06287e">modify</span>, <span style="color: #06287e">runStateT</span>)
<span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">Control.Monad.IO.Class</span> (<span style="color: #902000">MonadIO</span>, <span style="color: #06287e">liftIO</span>)
<span style="color: #007020; font-weight: bold">import</span> <span style="color: #007020; font-weight: bold">qualified</span> <span style="color: #0e84b5; font-weight: bold">Data.Map</span> <span style="color: #007020; font-weight: bold">as</span> Map
<span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">ViewUtils</span> (<span style="color: #06287e">clearScreen</span>, <span style="color: #06287e">showInRectangle</span>, <span style="color: #06287e">clearRectangle</span>, <span style="color: #06287e">showInGrid</span>, <span style="color: #06287e">drawGrid</span>, <span style="color: #06287e">highlightCell</span>, <span style="color: #06287e">printFromBottom</span>)
<span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">Prelude</span> <span style="color: #007020; font-weight: bold">hiding</span> (<span style="color: #06287e">log</span>)

<span style="color: #007020; font-weight: bold">data</span> <span style="color: #902000">RowData</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">Row</span> { smth <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">String</span> } <span style="color: #007020; font-weight: bold">deriving</span> <span style="color: #902000">Eq</span>

<span style="color: #06287e">initialRows</span> <span style="color: #007020; font-weight: bold">=</span> [
  <span style="color: #902000">Row</span> <span style="color: #4070a0">&quot;something a&quot;</span>
  , <span style="color: #902000">Row</span> <span style="color: #4070a0">&quot;something b&quot;</span>
  , <span style="color: #902000">Row</span> <span style="color: #4070a0">&quot;something c&quot;</span>
  , <span style="color: #902000">Row</span> <span style="color: #4070a0">&quot;something d&quot;</span>
  , <span style="color: #902000">Row</span> <span style="color: #4070a0">&quot;something e&quot;</span>
  ]

<div id="source---observer-in-custom-monad---state-adt" style="display: inline-block;"><div id="source---observer-in-custom-monad---AppStateData" style="display: inline-block;"><span style="color: #007020; font-weight: bold">data</span> <span style="color: #902000">AppStateData</span> m <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">AppState</span>
  { <div id="source---observer-in-custom-monad---main-rows-field" style="display: inline;">rows <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">RowData</span>]</div>
  , <div id="source---observer-in-custom-monad---highlighted-row-index-field" style="display: inline;">activeCellY <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span></div>
  , <div id="source---observer-in-custom-monad---debug-messages-field" style="display: inline;">debugMessages <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">String</span>]</div>
  , <div id="source---observer-in-custom-monad---listeners-field" style="display: inline;">listeners <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">AppStateListenersData</span> m</div>
  }
</div>

<span style="color: #007020; font-weight: bold">data</span> <span style="color: #902000">AppStateListenersData</span> m <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">AppStateListeners</span>
  { <div id="source---observer-in-custom-monad---rowsListeners" style="display: inline;">rowsListeners <span style="color: #007020; font-weight: bold">::</span> [[<span style="color: #902000">RowData</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>]</div>
  , <div id="source---observer-in-custom-monad---activeCellYListeners" style="display: inline;">activeCellYListeners <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span> <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>]</div>
  , <div id="source---observer-in-custom-monad---debugMessagesListeners" style="display: inline;">debugMessagesListeners <span style="color: #007020; font-weight: bold">::</span> [[<span style="color: #902000">String</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>]</div>
  }
</div>

<div id="source---observer-in-custom-monad---adding-listeners" style="display: inline-block;"><span style="color: #06287e">addRowsListener</span> <span style="color: #007020; font-weight: bold">::</span> (<span style="color: #902000">Monad</span> m, <span style="color: #902000">EditableListApp</span> m) <span style="color: #007020; font-weight: bold">=&gt;</span> ([<span style="color: #902000">RowData</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>) <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span> m <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span> m
</div>
<span style="color: #06287e">addRowsListener</span> listener (<span style="color: #902000">AppStateListeners</span> rowsListeners _activeCellYListeners _debugMessagesListeners) <span style="color: #007020; font-weight: bold">=</span>
  <span style="color: #902000">AppStateListeners</span> (listener<span style="color: #902000">:</span>rowsListeners) _activeCellYListeners _debugMessagesListeners

<span style="color: #06287e">addActiveCellYListener</span> <span style="color: #007020; font-weight: bold">::</span> (<span style="color: #902000">Monad</span> m, <span style="color: #902000">EditableListApp</span> m) <span style="color: #007020; font-weight: bold">=&gt;</span> (<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span> <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>) <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span> m <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span> m
<span style="color: #06287e">addActiveCellYListener</span> listener (<span style="color: #902000">AppStateListeners</span> _rowsListeners activeCellYListeners _debugMessagesListeners) <span style="color: #007020; font-weight: bold">=</span>
  <span style="color: #902000">AppStateListeners</span> _rowsListeners (listener<span style="color: #902000">:</span>activeCellYListeners) _debugMessagesListeners

<span style="color: #06287e">addDebugMessagesListener</span> <span style="color: #007020; font-weight: bold">::</span> (<span style="color: #902000">Monad</span> m, <span style="color: #902000">EditableListApp</span> m) <span style="color: #007020; font-weight: bold">=&gt;</span> ([<span style="color: #902000">String</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>) <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span> m <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">AppStateListenersData</span> m
<span style="color: #06287e">addDebugMessagesListener</span> listener (<span style="color: #902000">AppStateListeners</span> _rowsListeners _activeCellYListeners debugMessagesListeners) <span style="color: #007020; font-weight: bold">=</span>
  <span style="color: #902000">AppStateListeners</span> _rowsListeners _activeCellYListeners (listener<span style="color: #902000">:</span>debugMessagesListeners)

<div id="source---observer-in-custom-monad---descriptive-adt" style="display: inline-block;"><span style="color: #007020; font-weight: bold">class</span> <span style="color: #902000">EditableListApp</span> m <span style="color: #007020; font-weight: bold">where</span>
  <div id="source---observer-in-custom-monad---descriptive-adt-getters" style="display: inline-block;">  getList <span style="color: #007020; font-weight: bold">::</span> m [<span style="color: #902000">RowData</span>]
  getActiveCellY <span style="color: #007020; font-weight: bold">::</span> m (<span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span>)
  getLogs <span style="color: #007020; font-weight: bold">::</span> m [<span style="color: #902000">String</span>]</div>

  <div id="source---observer-in-custom-monad---descriptive-adt-setters" style="display: inline-block;">  updateList <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">RowData</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>
  updateActiveCellY <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span> <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span>
  log <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">String</span> <span style="color: #007020; font-weight: bold">-&gt;</span> m <span style="color: #007020">()</span></div>
</div>

<div id="source---observer-in-custom-monad---target-monad" style="display: inline-block;"><span style="color: #007020; font-weight: bold">newtype</span> <span style="color: #902000">StateHolder</span> a <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">StateHolder</span> (<span style="color: #902000">StateT</span> (<span style="color: #902000">AppStateData</span> <span style="color: #902000">StateHolder</span>) <span style="color: #902000">IO</span> a)
  <span style="color: #007020; font-weight: bold">deriving</span> (<span style="color: #902000">Functor</span>, <span style="color: #902000">Applicative</span>, <span style="color: #902000">Monad</span>, <span style="color: #902000">MonadIO</span>)
</div>

<div id="source---observer-in-custom-monad---target-monad-instance-of-descriptive-monad" style="display: inline-block;"><span style="color: #007020; font-weight: bold">instance</span> <span style="color: #902000">EditableListApp</span> <span style="color: #902000">StateHolder</span> <span style="color: #007020; font-weight: bold">where</span>
  <div id="source---observer-in-custom-monad---getList" style="display: inline;">getList <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> rows <span style="color: #666666">&lt;$&gt;</span> get</div>
  <div id="source---observer-in-custom-monad---getActiveCellY" style="display: inline;">getActiveCellY <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> activeCellY <span style="color: #666666">&lt;$&gt;</span> get</div>
  <div id="source---observer-in-custom-monad---getLogs" style="display: inline;">getLogs <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> debugMessages <span style="color: #666666">&lt;$&gt;</span> get</div>

<div id="source---observer-in-custom-monad---updateList" style="display: inline-block;"
>  updateList l <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
    <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> modify <span style="color: #666666">$</span> <span style="color: #06287e">\</span>s <span style="color: #007020; font-weight: bold">-&gt;</span> s { rows <span style="color: #007020; font-weight: bold">=</span> l }
    reacts <span style="color: #007020; font-weight: bold">&lt;-</span> <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> (rowsListeners <span style="color: #666666">.</span> listeners) <span style="color: #666666">&lt;$&gt;</span> get
    <div id="source---observer-in-custom-monad---triggering-main-rows-listener" style="display: inline;">forM_ reacts (<span style="color: #666666">$</span> l)</div> <span style="color: #60a0b0; font-style: italic">-- same as forM_ reacts $ \react -&gt; react l</span>
</div>
<div id="source---observer-in-custom-monad---updateActiveCellY" style="display: inline-block;"
>  updateActiveCellY y <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
    <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> modify <span style="color: #666666">$</span> <span style="color: #06287e">\</span>s <span style="color: #007020; font-weight: bold">-&gt;</span> s { activeCellY <span style="color: #007020; font-weight: bold">=</span> y }
    s <span style="color: #007020; font-weight: bold">&lt;-</span> <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> get
    <span style="color: #007020; font-weight: bold">let</span> reacts <span style="color: #007020; font-weight: bold">=</span> activeCellYListeners (listeners s)
    <div id="source---observer-in-custom-monad---triggering-highlighted-cell-listener" style="display: inline;">forM_ reacts (<span style="color: #666666">$</span> y)</div> <span style="color: #60a0b0; font-style: italic">-- same as forM_ reacts $ \react -&gt; react y</span>
</div>
<div id="source---observer-in-custom-monad---log" style="display: inline-block;"
>  log msg <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
    <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> modify <span style="color: #666666">$</span> <span style="color: #06287e">\</span>s <span style="color: #007020; font-weight: bold">-&gt;</span> s { debugMessages <span style="color: #007020; font-weight: bold">=</span> take debugLinesCount (msg<span style="color: #902000">:</span>(debugMessages s)) }
    logs <span style="color: #007020; font-weight: bold">&lt;-</span> <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> debugMessages <span style="color: #666666">&lt;$&gt;</span> get
    reacts <span style="color: #007020; font-weight: bold">&lt;-</span> <span style="color: #902000">StateHolder</span> <span style="color: #666666">$</span> (debugMessagesListeners <span style="color: #666666">.</span> listeners) <span style="color: #666666">&lt;$&gt;</span> get
    <div id="source---observer-in-custom-monad---triggering-debug-messages-listener" style="display: inline;">forM_ reacts (<span style="color: #666666">$</span> logs)</div> <span style="color: #60a0b0; font-style: italic">-- same as forM_ reacts $ \react -&gt; react logs</span>
</div>
</div>

<div id="source---observer-in-custom-monad---performStateAction" style="display: inline-block;"><span style="color: #06287e">performStateAction</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">AppStateData</span> <span style="color: #902000">StateHolder</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">StateHolder</span> a <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">IO</span> <span style="color: #007020">()</span>
<span style="color: #06287e">performStateAction</span> state (<span style="color: #902000">StateHolder</span> action) <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
  runStateT action state
  return <span style="color: #007020">()</span>
</div>

<span style="color: #06287e">debugLinesCount</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #40a070">20</span>

<div id="source---observer-in-custom-monad---main-func" style="display: inline-block;"><span style="color: #06287e">main</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">IO</span> <span style="color: #007020">()</span>
<span style="color: #06287e">main</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
  hSetBuffering stdin <span style="color: #902000">NoBuffering</span>
  hSetBuffering stdout <span style="color: #902000">NoBuffering</span>
  hSetEcho stdin <span style="color: #902000">False</span>
  clearScreen
  performStateAction initialState <span style="color: #666666">$</span> <span style="color: #007020; font-weight: bold">do</span>
    initRows
    loop
  <span style="color: #007020; font-weight: bold">where</span>
</div>
    xUpperLeft <span style="color: #007020; font-weight: bold">=</span> <span style="color: #40a070">0</span>
    yUpperLeft <span style="color: #007020; font-weight: bold">=</span> <span style="color: #40a070">0</span>
    columnCount <span style="color: #007020; font-weight: bold">=</span> <span style="color: #40a070">1</span>
    columnWidth <span style="color: #007020; font-weight: bold">=</span> <span style="color: #40a070">14</span>
    rowCount <span style="color: #007020; font-weight: bold">=</span> length initialRows

<div id="source---observer-in-custom-monad---initialState" style="display: inline-block;">    initialState <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">AppStateData</span> <span style="color: #902000">StateHolder</span>
    initialState <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">AppState</span> <span style="color: #902000">[]</span> <span style="color: #902000">Nothing</span> <span style="color: #902000">[]</span> initListeners
</div>

<div id="source---observer-in-custom-monad---initRows" style="display: inline-block;">    initRows <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">StateHolder</span> <span style="color: #007020">()</span>
    initRows <span style="color: #007020; font-weight: bold">=</span> updateList initialRows
</div>

<div id="source---observer-in-custom-monad---creating-listeners" style="display: inline-block;">    initListeners <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">AppStateListenersData</span> <span style="color: #902000">StateHolder</span>
    <span style="color: #60a0b0; font-style: italic">-- initListeners =</span>
    <span style="color: #60a0b0; font-style: italic">--     addRowsListener mainRowsListener</span>
    <span style="color: #60a0b0; font-style: italic">--     (addActiveCellYListener activeCellYListener</span>
    <span style="color: #60a0b0; font-style: italic">--     (addDebugMessagesListener debugMessagesListener</span>
    <span style="color: #60a0b0; font-style: italic">--     (empty)))</span>
    initListeners <span style="color: #007020; font-weight: bold">=</span>
        addRowsListener mainRowsListener
        <span style="color: #666666">$</span> addActiveCellYListener activeCellYListener
        <span style="color: #666666">$</span> addDebugMessagesListener debugMessagesListener
        <span style="color: #666666">$</span> empty
      <span style="color: #007020; font-weight: bold">where</span>
        empty <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">AppStateListeners</span> <span style="color: #902000">[]</span> <span style="color: #902000">[]</span> <span style="color: #902000">[]</span>

<div id="source---observer-in-custom-monad---list-listener" style="display: inline-block;"
>    mainRowsListener <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">RowData</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">StateHolder</span> <span style="color: #007020">()</span>
    mainRowsListener rows <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
      activeCellCoords <span style="color: #007020; font-weight: bold">&lt;-</span> fmap (<span style="color: #06287e">\</span>y <span style="color: #007020; font-weight: bold">-&gt;</span> (<span style="color: #40a070">0</span>, y)) <span style="color: #666666">&lt;$&gt;</span> getActiveCellY
<div id="source---observer-in-custom-monad---main-rows-listener-draw" style="display: inline-block;"
>      liftIO <span style="color: #666666">$</span> showInGrid
                 xUpperLeft
                 yUpperLeft
                 columnCount
                 columnWidth
                 activeCellCoords
                 (map (<span style="color: #06287e">\</span>row <span style="color: #007020; font-weight: bold">-&gt;</span> [smth row]) rows)
</div>
      <div id="source---observer-in-custom-monad---main-rows-listener-log" style="display: inline;">log <span style="color: #4070a0">&quot;updated rows&quot;</span></div>
</div>

<div id="source---observer-in-custom-monad---active-cell-y-listener" style="display: inline-block;"
>    activeCellYListener <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Maybe</span> <span style="color: #902000">Int</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">StateHolder</span> <span style="color: #007020">()</span>
    activeCellYListener activeCellY <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
      <span style="color: #007020; font-weight: bold">let</span> activeCellCoords <span style="color: #007020; font-weight: bold">=</span> fmap (<span style="color: #06287e">\</span>y <span style="color: #007020; font-weight: bold">-&gt;</span> (<span style="color: #40a070">0</span>, y)) activeCellY
      <div class="source---observer-in-custom-monad---active-cell-y-listener-draw" style="display: inline;">liftIO <span style="color: #666666">$</span> drawGrid xUpperLeft yUpperLeft columnWidth columnCount rowCount</div>
      <span style="color: #007020; font-weight: bold">case</span> activeCellCoords <span style="color: #007020; font-weight: bold">of</span>
        <span style="color: #902000">Nothing</span> <span style="color: #007020; font-weight: bold">-&gt;</span> return <span style="color: #007020">()</span>
        <span style="color: #902000">Just</span> coordsPair <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span>
          <div class="source---observer-in-custom-monad---active-cell-y-listener-draw" style="display: inline;">liftIO <span style="color: #666666">$</span> highlightCell xUpperLeft yUpperLeft columnWidth columnCount rowCount coordsPair</div>
          <div id="source---observer-in-custom-monad---active-cell-y-listener-log" style="display: inline;">log <span style="color: #4070a0">&quot;highlighted cell&quot;</span></div>
</div>

<div id="source---observer-in-custom-monad---logs-listener" style="display: inline-block;"
>    debugMessagesListener <span style="color: #007020; font-weight: bold">::</span> [<span style="color: #902000">String</span>] <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">StateHolder</span> <span style="color: #007020">()</span>
    debugMessagesListener debugMessages <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
<div id="source---observer-in-custom-monad---debug-messages-listener-draw" style="display: inline-block;"
>      liftIO <span style="color: #666666">$</span> printFromBottom
                 xUpperLeft
                 (yUpperLeft<span style="color: #666666">+</span><span style="color: #40a070">12</span><span style="color: #666666">+</span>debugLinesCount)
                 debugMessages
</div>
</div>
</div>

<div id="source---observer-in-custom-monad---loop" style="display: inline-block;"><div id="source---observer-in-custom-monad---loop-definition-2-lines" style="display: inline-block;">    loop <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">StateHolder</span> <span style="color: #007020">()</span>
    loop <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
</div>
      <div id="source---observer-in-custom-monad---getKey" style="display: inline;">key <span style="color: #007020; font-weight: bold">&lt;-</span> liftIO <span style="color: #666666">$</span> getKey</div>
      when (key <span style="color: #666666">/=</span> <span style="color: #4070a0">&quot;</span><span style="color: #4070a0; font-weight: bold">\ESC</span><span style="color: #4070a0">&quot;</span>) <span style="color: #666666">$</span> <span style="color: #007020; font-weight: bold">do</span>
        <div id="source---observer-in-custom-monad---case-key-of" style="display: inline;"><span style="color: #007020; font-weight: bold">case</span> key <span style="color: #007020; font-weight: bold">of</span></div>
          <div id="source---observer-in-custom-monad---case-key-up" style="display: inline;"><span style="color: #4070a0">&quot;</span><span style="color: #4070a0; font-weight: bold">\ESC</span><span style="color: #4070a0">[A&quot;</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span> <span style="color: #60a0b0; font-style: italic">-- up</span></div>
              activeCellY <span style="color: #007020; font-weight: bold">&lt;-</span> getActiveCellY
              <span style="color: #007020; font-weight: bold">let</span>
                newActiveCellY <span style="color: #007020; font-weight: bold">=</span>
                  <span style="color: #007020; font-weight: bold">case</span> activeCellY <span style="color: #007020; font-weight: bold">of</span>
                    <span style="color: #902000">Just</span> y <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Just</span> <span style="color: #666666">$</span> max <span style="color: #40a070">0</span> (y<span style="color: #666666">-</span><span style="color: #40a070">1</span>)
                    <span style="color: #902000">Nothing</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Just</span> <span style="color: #40a070">0</span>
              <div id="source---observer-in-custom-monad---write2field-active-cell-y-from-up-key-press" style="display: inline;">updateActiveCellY newActiveCellY</div>
              <div id="source---observer-in-custom-monad---write2field-debug-messages-from-up-key-press" style="display: inline;">log <span style="color: #666666">$</span> <span style="color: #4070a0">&quot;up, &quot;</span> <span style="color: #666666">++</span> show(newActiveCellY)</div>
              loop
</div>
          <div id="source---observer-in-custom-monad---case-key-down" style="display: inline;"><span style="color: #4070a0">&quot;</span><span style="color: #4070a0; font-weight: bold">\ESC</span><span style="color: #4070a0">[B&quot;</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span> <span style="color: #60a0b0; font-style: italic">-- down</span></div>
              activeCellY <span style="color: #007020; font-weight: bold">&lt;-</span> getActiveCellY
              <span style="color: #007020; font-weight: bold">let</span>
                newActiveCellY <span style="color: #007020; font-weight: bold">=</span>
                  <span style="color: #007020; font-weight: bold">case</span> activeCellY <span style="color: #007020; font-weight: bold">of</span>
                    <span style="color: #902000">Just</span> y <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Just</span> <span style="color: #666666">$</span> min (rowCount<span style="color: #666666">-</span><span style="color: #40a070">1</span>) (y<span style="color: #666666">+</span><span style="color: #40a070">1</span>)
                    <span style="color: #902000">Nothing</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Just</span> <span style="color: #40a070">0</span>
              <div id="source---observer-in-custom-monad---write2field-active-cell-y-from-down-key-press" style="display: inline;">updateActiveCellY newActiveCellY</div>
              <div id="source---observer-in-custom-monad---write2field-debug-messages-from-down-key-press" style="display: inline;">log <span style="color: #666666">$</span> <span style="color: #4070a0">&quot;down, &quot;</span> <span style="color: #666666">++</span> show(newActiveCellY)</div>
              loop
          <div id="source---observer-in-custom-monad---case-key-enter" style="display: inline;"><span style="color: #4070a0">&quot;</span><span style="color: #4070a0; font-weight: bold">\n</span><span style="color: #4070a0">&quot;</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span> <span style="color: #60a0b0; font-style: italic">-- enter</span></div>
              activeCellY <span style="color: #007020; font-weight: bold">&lt;-</span> getActiveCellY
              rows <span style="color: #007020; font-weight: bold">&lt;-</span> getList
                
              <span style="color: #007020; font-weight: bold">let</span>
                  eitherValue <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">Either</span> <span style="color: #902000">String</span> <span style="color: #902000">String</span>
                  eitherValue <span style="color: #007020; font-weight: bold">=</span>
                    <span style="color: #007020; font-weight: bold">case</span> activeCellY <span style="color: #007020; font-weight: bold">of</span>
                      <span style="color: #902000">Nothing</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Left</span> <span style="color: #4070a0">&quot;there&#39;s no selected cell&quot;</span>
                      <span style="color: #902000">Just</span> cellIndex <span style="color: #007020; font-weight: bold">-&gt;</span>
                        <span style="color: #007020; font-weight: bold">if</span> cellIndex <span style="color: #666666">&lt;</span> <span style="color: #40a070">0</span> <span style="color: #666666">||</span> cellIndex <span style="color: #666666">&gt;=</span> (length rows)
                          <span style="color: #007020; font-weight: bold">then</span> <span style="color: #902000">Left</span> <span style="color: #666666">$</span> <span style="color: #4070a0">&quot;index out of bounds: &quot;</span> <span style="color: #666666">++</span> (show cellIndex)
                          <span style="color: #007020; font-weight: bold">else</span> <span style="color: #902000">Right</span> <span style="color: #666666">$</span> smth <span style="color: #666666">$</span> rows <span style="color: #666666">!!</span> cellIndex

                  showEditField <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">String</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">StateHolder</span> <span style="color: #007020">()</span>
                  showEditField value <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
                    <span style="color: #007020; font-weight: bold">let</span>
                      txt <span style="color: #007020; font-weight: bold">=</span> <span style="color: #4070a0">&quot;edit cell value:&quot;</span>
                      lentxt <span style="color: #007020; font-weight: bold">=</span> length txt
                      yPos <span style="color: #007020; font-weight: bold">=</span> <span style="color: #40a070">0</span>
                      xPos <span style="color: #007020; font-weight: bold">=</span> (columnCount <span style="color: #666666">*</span> (columnWidth <span style="color: #666666">+</span> <span style="color: #40a070">1</span>)) <span style="color: #666666">+</span> <span style="color: #40a070">3</span>
                      replaceNth lst idx val <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">if</span> idx <span style="color: #666666">&lt;</span> <span style="color: #40a070">1</span> <span style="color: #007020; font-weight: bold">then</span> val<span style="color: #902000">:</span>(tail lst) <span style="color: #007020; font-weight: bold">else</span> (head lst) <span style="color: #902000">:</span> (replaceNth (tail lst) (idx <span style="color: #666666">-</span> <span style="color: #40a070">1</span>) val)
                    liftIO <span style="color: #666666">$</span> showInRectangle xPos yPos lentxt [txt, value]
                    key <span style="color: #007020; font-weight: bold">&lt;-</span> liftIO <span style="color: #666666">$</span> getKey
                    <span style="color: #007020; font-weight: bold">case</span> key <span style="color: #007020; font-weight: bold">of</span>
                      <span style="color: #4070a0">&quot;</span><span style="color: #4070a0; font-weight: bold">\n</span><span style="color: #4070a0">&quot;</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span>
                        <span style="color: #007020; font-weight: bold">case</span> activeCellY <span style="color: #007020; font-weight: bold">of</span>
                          <span style="color: #902000">Nothing</span> <span style="color: #007020; font-weight: bold">-&gt;</span> return <span style="color: #007020">()</span>
                          <span style="color: #902000">Just</span> cellIndex <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span>
                            liftIO <span style="color: #666666">$</span> clearRectangle xPos yPos lentxt <span style="color: #40a070">2</span>
                            rows <span style="color: #007020; font-weight: bold">&lt;-</span> getList
                            <div id="source---observer-in-custom-monad---write2field-main-rows-from-enter-key-press" style="display: inline;">updateList <span style="color: #666666">$</span> replaceNth rows cellIndex (<span style="color: #902000">Row</span> value)</div>
                            loop
                      <span style="color: #4070a0">&quot;</span><span style="color: #4070a0; font-weight: bold">\DEL</span><span style="color: #4070a0">&quot;</span> <span style="color: #007020; font-weight: bold">-&gt;</span> showEditField (<span style="color: #007020; font-weight: bold">if</span> (length value) <span style="color: #666666">==</span> <span style="color: #40a070">0</span> <span style="color: #007020; font-weight: bold">then</span> value <span style="color: #007020; font-weight: bold">else</span> init value)
                      c <span style="color: #007020; font-weight: bold">-&gt;</span> showEditField (value <span style="color: #666666">++</span> c)
              <span style="color: #007020; font-weight: bold">case</span> eitherValue <span style="color: #007020; font-weight: bold">of</span>
                <span style="color: #902000">Left</span> e <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span>
                  <div id="source---observer-in-custom-monad---write2field-debug-messages-from-enter-key-press" style="display: inline;">log <span style="color: #666666">$</span> <span style="color: #4070a0">&quot;error: &quot;</span> <span style="color: #666666">++</span> (show e)</div>
                  loop
                <span style="color: #902000">Right</span> v <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #007020; font-weight: bold">do</span>
                  showEditField v
<div id="source---observer-in-custom-monad---case-key-otherwise" style="display: inline-block;"
>          <span style="color: #4070a0">&quot;q&quot;</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <div class="source---observer-in-custom-monad---exit" style="display: inline;">return <span style="color: #007020">()</span></div>
          <span style="color: #007020; font-weight: bold">_</span> <span style="color: #007020; font-weight: bold">-&gt;</span> <div class="source---observer-in-custom-monad---exit" style="display: inline;">return <span style="color: #007020">()</span></div>
</div>

<span style="color: #06287e">getKey</span> <span style="color: #007020; font-weight: bold">::</span> <span style="color: #902000">IO</span> [<span style="color: #902000">Char</span>]
<span style="color: #06287e">getKey</span> <span style="color: #007020; font-weight: bold">=</span> reverse <span style="color: #666666">&lt;$&gt;</span> getKey&#39; <span style="color: #4070a0">&quot;&quot;</span>
  <span style="color: #007020; font-weight: bold">where</span>
  getKey&#39; chars <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">do</span>
    char <span style="color: #007020; font-weight: bold">&lt;-</span> getChar
    more <span style="color: #007020; font-weight: bold">&lt;-</span> hReady stdin
    (<span style="color: #007020; font-weight: bold">if</span> more <span style="color: #007020; font-weight: bold">then</span> getKey&#39; <span style="color: #007020; font-weight: bold">else</span> return) (char<span style="color: #902000">:</span>chars)
  </pre></div> <!-- end of source observer-in-custom-monad main -->








    </div> <!-- end of column right -->














    </div>
  </body>
</html>

